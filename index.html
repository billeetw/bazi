<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸€èµ·å‡ºä¾†ç© Â· 2026 æˆ°ç•¥å°èˆª</title>

  <!-- Tailwind (é–‹ç™¼éšæ®µç”¨ CDNï¼Œæ­£å¼å¯ä»¥æ”¹æˆ CLI/PostCSS) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 100%);
      color: #e2e8f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }
    .glass {
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .bazi-char {
      font-size: 1.9rem;
      font-weight: 900;
      line-height: 1.1;
    }
    .wuxing-æœ¨ { background:#22c55e; }
    .wuxing-ç« { background:#f97373; }
    .wuxing-åœŸ { background:#eab308; }
    .wuxing-é‡‘ { background:#e5e7eb; }
    .wuxing-æ°´ { background:#3b82f6; }

    /* ==== ç´«å¾® 12 å®®æ ¼æ¨£å¼ ==== */

    /* æ˜Ÿæ›œæ–‡å­—äº”è¡Œé¡è‰² */
    .star-wx-æœ¨ {
      color: #86efac;
      text-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
    }
    .star-wx-ç« {
      color: #fca5a5;
      text-shadow: 0 0 5px rgba(239, 68, 68, 0.5);
    }
    .star-wx-åœŸ {
      color: #fde047;
      text-shadow: 0 0 5px rgba(234, 179, 8, 0.5);
    }
    .star-wx-é‡‘ {
      color: #e2e8f0;
      text-shadow: 0 0 5px rgba(248, 250, 252, 0.6);
    }
    .star-wx-æ°´ {
      color: #93c5fd;
      text-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
    }

    .zw-grid-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 8px;
      width: 100%;
      max-width: 520px;
      aspect-ratio: 1/1;
      margin: 0 auto;
    }
    .zw-palace {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.85rem;
      padding: 8px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .zw-palace:hover {
      transform: translateY(-2px);
      border-color: rgba(248, 250, 252, 0.85);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.7);
    }

    /* å®®ä½äº”è¡Œå…‰æšˆ */
    .zw-palace::before {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      width: 150%; height: 150%;
      transform: translate(-50%, -50%);
      opacity: 0;
      transition: opacity 0.5s ease;
      z-index: -1;
      pointer-events: none;
    }
    [class*="palace-glow-"]::before { opacity: 1; }
    .palace-glow-æœ¨::before {
      background: radial-gradient(circle, rgba(34, 197, 94, 0.18) 0%, transparent 70%);
    }
    .palace-glow-ç«::before {
      background: radial-gradient(circle, rgba(239, 68, 68, 0.20) 0%, transparent 70%);
    }
    .palace-glow-åœŸ::before {
      background: radial-gradient(circle, rgba(234, 179, 8, 0.20) 0%, transparent 70%);
    }
    .palace-glow-é‡‘::before {
      background: radial-gradient(circle, rgba(248, 250, 252, 0.18) 0%, transparent 70%);
    }
    .palace-glow-æ°´::before {
      background: radial-gradient(circle, rgba(59, 130, 246, 0.20) 0%, transparent 70%);
    }
    .zw-palace-key {
      border-color: rgba(251, 191, 36, 0.8);
      box-shadow: inset 0 0 16px rgba(251, 191, 36, 0.25);
    }

    .zw-center-block {
      grid-area: 2 / 2 / 4 / 4;
      background: radial-gradient(circle, #1e293b 35%, #020617 100%);
      border: 1px dashed rgba(148, 163, 184, 0.5);
      border-radius: 1.1rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 12px;
      z-index: 10;
    }

    .nav-bar {
      background: linear-gradient(90deg, #ef4444, #f97316, #ef4444);
      color: #fff;
      padding: 10px 16px;
      position: sticky;
      top: 0;
      z-index: 40;
      box-shadow: 0 4px 20px rgba(220, 38, 38, 0.6);
    }

    @media (max-width: 375px) {
      .zw-palace {
        padding: 6px;
      }
      .zw-palace span {
        font-size: 11px;
      }
    }
  </style>
</head>

<body class="pb-12">

  <!-- NAV -->
  <div class="nav-bar flex items-center justify-between">
    <div class="font-black tracking-widest text-xs">ä¸€èµ·å‡ºä¾†ç© Â· 2026 æˆ°ç•¥å°èˆª</div>
    <div class="flex gap-3 text-[11px]">
      <a href="#inputSection" class="hover:underline">è¼¸å…¥</a>
      <a href="#baziSection" class="hover:underline">å…«å­—</a>
      <a href="#ziweiSection" class="hover:underline">ç´«å¾®</a>
      <a href="#liuyueSection" class="hover:underline">æµæœˆ</a>
      <a href="#consultSection" class="hover:underline">è«®è©¢</a>
    </div>
  </div>

  <main class="max-w-4xl mx-auto px-4 pt-6 space-y-8">

    <header class="text-center space-y-1">
      <p class="text-[11px] uppercase tracking-[0.3em] text-slate-500">2026 Strategic Map</p>
      <h1 class="text-3xl md:text-4xl font-black tracking-tight">2026 æµå¹´æˆ°ç•¥å ±å‘Š</h1>
      <p class="text-sm text-slate-400 mt-1">ç”¨å…«å­—ï¼‹ç´«å¾®ï¼ŒæŠŠä½ çš„ 2026 åšæˆå¯åŸ·è¡Œçš„è¡Œå‹•ç¯€å¥ã€‚</p>
    </header>

    <!-- è¼¸å…¥ -->
    <section id="inputSection" class="glass rounded-2xl p-6 md:p-7">
      <h2 class="font-black text-lg mb-4">â‘  è¼¸å…¥å‡ºç”Ÿè³‡è¨Š</h2>

      <div class="grid grid-cols-3 gap-2 mb-3">
        <select id="birthYear" class="bg-slate-900/70 border border-slate-700 rounded-lg px-2 py-2 text-sm"></select>
        <select id="birthMonth" class="bg-slate-900/70 border border-slate-700 rounded-lg px-2 py-2 text-sm" onchange="updateDays()"></select>
        <select id="birthDay" class="bg-slate-900/70 border border-slate-700 rounded-lg px-2 py-2 text-sm"></select>
      </div>

      <div class="grid grid-cols-2 gap-2 mb-4">
        <select id="birthHour" class="bg-slate-900/70 border border-slate-700 rounded-lg px-2 py-2 text-sm"></select>
        <select id="birthMinute" class="bg-slate-900/70 border border-slate-700 rounded-lg px-2 py-2 text-sm"></select>
      </div>

      <button
        id="btnLaunch"
        onclick="launch()"
        class="w-full bg-amber-400 text-black py-3 rounded-xl font-black text-sm tracking-wide shadow-lg shadow-amber-500/30 hover:bg-amber-300 transition">
        ç”Ÿæˆæˆ‘çš„ 2026 æˆ°ç•¥
      </button>

      <p id="hint" class="text-[11px] text-slate-400 mt-3 italic min-h-[1.2em]"></p>
    </section>

    <!-- å ±å‘Š -->
    <section id="report" class="space-y-8 hidden">

      <!-- å››æŸ± -->
      <section id="baziSection" class="glass rounded-2xl p-6 md:p-7">
        <h2 class="font-black mb-4 text-lg">â‘¡ å…«å­—å››æŸ±ï¼ˆé¡¯ç¤ºç”¨ï¼‰</h2>
        <div class="grid grid-cols-4 text-center gap-3">
          <div>
            <div class="text-[10px] text-slate-500 mb-1 tracking-[0.2em] uppercase">å¹´æŸ±</div>
            <div id="yG" class="bazi-char"></div>
            <div id="yZ" class="text-sm text-slate-300"></div>
          </div>
          <div>
            <div class="text-[10px] text-slate-500 mb-1 tracking-[0.2em] uppercase">æœˆæŸ±</div>
            <div id="mG" class="bazi-char"></div>
            <div id="mZ" class="text-sm text-slate-300"></div>
          </div>
          <div>
            <div class="text-[10px] text-slate-500 mb-1 tracking-[0.2em] uppercase">æ—¥æŸ±</div>
            <div id="dG" class="bazi-char text-amber-300"></div>
            <div id="dZ" class="text-sm text-slate-300"></div>
          </div>
          <div>
            <div class="text-[10px] text-slate-500 mb-1 tracking-[0.2em] uppercase">æ™‚æŸ±</div>
            <div id="hG" class="bazi-char"></div>
            <div id="hZ" class="text-sm text-slate-300"></div>
          </div>
        </div>
      </section>

      <!-- äº”è¡Œ -->
      <section class="glass rounded-2xl p-6 md:p-7">
        <h2 class="font-black mb-4 text-lg">â‘¢ äº”è¡Œèƒ½é‡çµæ§‹</h2>

        <div class="mb-4">
          <div class="text-[11px] text-slate-400 mb-1">è¡¨å±¤èƒ½é‡ï¼ˆå¤©å¹²è¨ˆæ•¸ï¼‰</div>
          <div id="surfaceWx" class="space-y-2"></div>
        </div>

        <div>
          <div class="text-[11px] text-slate-400 mb-1">å¯¦æˆ°èƒ½é‡ï¼ˆå¤©å¹²ï¼‹è—å¹²ï¼‹æœˆä»¤åŠ æ¬Šï¼‰</div>
          <div id="strategicWx" class="space-y-2"></div>
        </div>
      </section>

      <!-- ç´«å¾® -->
      <section id="ziweiSection" class="glass rounded-2xl p-6 md:p-7">
        <h2 class="font-black mb-3 text-lg">â‘£ ç´«å¾®å‘½ç›¤ 12 å®®ç¸½è¦½</h2>
        <p id="ziweiInfo" class="text-[12px] text-slate-400 mb-4">
          å‘½ç›¤ä»¥ã€Œå‘½å®®ï¼å®˜ç¥¿å®®ï¼è²¡å¸›å®®ã€ç‚ºä¸»è»¸ï¼Œå…ˆç”¨ä¸»æ˜Ÿï¼‹äº”è¡Œèƒ½é‡å‘ˆç¾ï¼›ä¹‹å¾Œå¯ä»¥æ¥å®Œæ•´æ˜Ÿæ›œè³‡æ–™ã€‚
        </p>

        <div id="ziweiGrid" class="zw-grid-container">
          <div class="col-span-4 flex items-center justify-center text-xs text-slate-500">
            ï¼ˆç›®å‰å°šæœªå–å¾—ç´«å¾®è³‡æ–™ï¼Œä¹‹å¾Œå¯æ¥ iztro å®Œæ•´å‘½ç›¤ï¼‰
          </div>
        </div>
      </section>

      <!-- æµæœˆ -->
      <section id="liuyueSection" class="glass rounded-2xl p-6 md:p-7">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-black text-lg">â‘¤ 2026 ç¯€æ°£æµæœˆç¯€å¥</h2>
          <span class="text-[11px] text-slate-400">ğŸŸ¢ ç©©é€²ï½œğŸ”´ å£“åŠ›</span>
        </div>
        <div id="monthGrid" class="space-y-2"></div>
      </section>

      <!-- æˆ°ç•¥è§£è®€ -->
      <section id="analysisSection" class="glass rounded-2xl p-6 md:p-7">
        <h2 class="font-black mb-3 text-lg">â‘¥ æˆ°ç•¥è§£è®€ï¼ˆå…ˆç”¨ fallbackï¼‰</h2>
        <div id="analysisBox" class="space-y-2 text-sm text-slate-200"></div>
      </section>

      <!-- è«®è©¢ CTA -->
      <section id="consultSection" class="glass rounded-2xl p-6 md:p-7 border border-amber-400/40">
        <h2 class="font-black mb-3 text-lg text-amber-300">â‘¦ æƒ³æŠŠé€™ä»½æˆ°ç•¥è®Šæˆ 50 é äººç”Ÿä½¿ç”¨èªªæ˜æ›¸ï¼Ÿ</h2>
        <p class="text-sm text-slate-200 mb-4 leading-relaxed">
          å¦‚æœä½ å¸Œæœ›æˆ‘æŠŠä½ çš„å‘½æ ¼çµ„æˆã€äººç”Ÿå¤§é‹ã€æµå¹´æµæœˆã€ç”Ÿæ¶¯è¦åŠƒå’Œæœ€é©åˆè‡ªå·±çš„äººç”Ÿç¯€å¥ï¼Œ
          åšæˆå¯ä¿ç”¨ä¸€ç”Ÿçš„ 50 é äººç”Ÿä½¿ç”¨èªªæ˜æ›¸ï¼Œæ­¡è¿é ç´„ç·šä¸Šè«®è©¢ã€‚
        </p>
        <a
          href="https://forms.gle/UVCSq1udEC549gzYA"
          target="_blank"
          class="inline-flex items-center justify-center px-4 py-2.5 rounded-xl bg-amber-400 text-black font-bold text-sm shadow-lg shadow-amber-500/40 hover:bg-amber-300 transition">
          é ç´„èˆ‡æä¼¯å½¥è€å¸«è«®è©¢
        </a>
      </section>
    </section>

  </main>

<script>
/* ========= åŸºæœ¬è¨­å®š ========= */
const API_BASE = "https://17gonplay-api.billeetw.workers.dev";

/* ========= äº”è¡Œ Bar ========= */
function renderBar(id, data, max) {
  const box = document.getElementById(id);
  if (!box || !data) return;
  box.innerHTML = "";
  ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(e => {
    const v = Number(data?.[e] || 0);
    const w = max ? Math.max(2, (v / max) * 100) : 0;
    box.innerHTML += `
      <div class="mb-1">
        <div class="flex justify-between text-[11px]">
          <span>${e}</span>
          <span>${v.toFixed(1)}</span>
        </div>
        <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
          <div class="h-full wuxing-${e}" style="width:${w}%"></div>
        </div>
      </div>
    `;
  });
}

/* ========= ç´«å¾®æ–¹ç›¤ï¼ˆ12 å®®ï¼‰ ========= */

const PALACE_ORDER = ["å‘½å®®","å…„å¼Ÿ","å¤«å¦»","å­å¥³","è²¡å¸›","ç–¾å„","é·ç§»","åƒ•å½¹","å®˜ç¥¿","ç”°å®…","ç¦å¾·","çˆ¶æ¯"];
const gridAreas = [
  "1/1/2/2","1/2/2/3","1/3/2/4","1/4/2/5", // ä¸Šï¼šå·³ åˆ æœª ç”³
  "2/4/3/5","3/4/4/5","4/4/5/5",           // å³ï¼šé…‰ æˆŒ äº¥
  "4/3/5/4","4/2/5/3","4/1/5/2",           // ä¸‹ï¼šå­ ä¸‘ å¯…
  "3/1/4/2","2/1/3/2"                      // å·¦ï¼šå¯ è¾°
];

// 14 ä¸»æ˜Ÿäº”è¡Œå°ç…§è¡¨ï¼ˆå¯ä»¥å†è£œï¼‰
const STAR_WUXING_MAP = {
  "ç´«å¾®":"åœŸ","å¤©æ©Ÿ":"æœ¨","å¤ªé™½":"ç«","æ­¦æ›²":"é‡‘","å¤©åŒ":"æ°´",
  "å»‰è²":"ç«","å¤©åºœ":"åœŸ","å¤ªé™°":"æ°´","è²ªç‹¼":"æœ¨","å·¨é–€":"æ°´",
  "å¤©ç›¸":"æ°´","å¤©æ¢":"åœŸ","ä¸ƒæ®º":"é‡‘","ç ´è»":"æ°´"
};

// æŠŠå¯èƒ½æ˜¯è‹±æ–‡ key çš„è³‡æ–™ï¼Œè½‰æˆä»¥ä¸­æ–‡å®®åç‚º key
function normalizeZiweiMainStars(ziwei) {
  const raw = ziwei?.mainStars || {};
  const out = { ...raw };

  // è‹¥å·²æœ‰ä¸­æ–‡ keyï¼ŒåŸæ¨£ä¿ç•™ï¼›å¦å¤–è£œ mapping
  if (!out["å‘½å®®"] && raw.minggong) out["å‘½å®®"] = raw.minggong;
  if (!out["å®˜ç¥¿"] && raw.career)  out["å®˜ç¥¿"] = raw.career;
  if (!out["è²¡å¸›"] && raw.wealth)  out["è²¡å¸›"] = raw.wealth;

  return out;
}

function renderZiwei(ziwei) {
  const container = document.getElementById("ziweiGrid");
  const info = document.getElementById("ziweiInfo");
  if (!container || !info) return;

  // æ²’è³‡æ–™ï¼šé¡¯ç¤º fallback
  if (!ziwei || ziwei.version !== "ziwei_features_v1") {
    container.className = "zw-grid-container";
    container.innerHTML = `
      <div class="col-span-4 flex items-center justify-center text-xs text-slate-500 text-center px-4">
        ï¼ˆç›®å‰å°šæœªå–å¾—ç´«å¾®è³‡æ–™ï¼Œæš«ä»¥å…«å­—ç‚ºä¸»ï¼›æ¥ä¸Š iztro å¾Œï¼Œé€™è£¡æœƒé¡¯ç¤ºå®Œæ•´ 12 å®®å‘½ç›¤ã€‚ï¼‰
      </div>
    `;
    info.innerText = "ç›®å‰åƒ…ä½¿ç”¨å…«å­—è³‡æ–™ç”¢å‡º 2026 æˆ°ç•¥ï¼›ä¹‹å¾Œæ¥ä¸Šç´«å¾®å‘½ç›¤å¾Œï¼Œé€™è£¡æœƒé¡¯ç¤ºä¸»æ˜Ÿï¼‹äº”è¡Œèƒ½é‡çš„ 12 å®®æ ¼ã€‚";
    return;
  }

  const mainStarsData = normalizeZiweiMainStars(ziwei);

  container.className = "zw-grid-container";
  container.innerHTML = "";
  info.innerText = "å‘½ç›¤ä»¥ã€Œå‘½å®®ï¼å®˜ç¥¿å®®ï¼è²¡å¸›å®®ã€ç‚ºä¸»è»¸ï¼Œæ­é…ä¸»æ˜Ÿäº”è¡Œç™¼å…‰ï¼Œè®“ä½ ä¸€çœ¼çœ‹å‡ºäº‹æ¥­èˆ‡è²¡å¯Œèƒ½é‡èšç„¦åœ¨å“ªè£¡ã€‚";

  PALACE_ORDER.forEach((name, idx) => {
    const starsList = Array.isArray(mainStarsData[name]) ? mainStarsData[name] : [];
    const isKey = ["å‘½å®®","å®˜ç¥¿","è²¡å¸›"].includes(name);

    let starsHtml = "";
    let palaceMainElement = "";

    if (starsList.length > 0) {
      starsHtml = starsList.map((starName, i) => {
        const wx = STAR_WUXING_MAP[starName] || "";
        if (i === 0 && wx) palaceMainElement = wx;
        return `<span class="${wx ? "star-wx-" + wx : ""}">${starName}</span>`;
      }).join("<br>");
    } else {
      starsHtml = `<span class="text-slate-600 text-[11px] italic">ç©ºå®®</span>`;
    }

    const glowClass = palaceMainElement ? `palace-glow-${palaceMainElement}` : "";

    container.innerHTML += `
      <div class="zw-palace ${isKey ? "zw-palace-key" : ""} ${glowClass}" style="grid-area:${gridAreas[idx]}">
        <div class="text-[10px] font-bold text-slate-500 mb-1">${name}</div>
        <div class="text-[13px] font-black leading-snug">
          ${starsHtml}
        </div>
      </div>
    `;
  });

  // ä¸­å¿ƒå€åŸŸ
  container.innerHTML += `
    <div class="zw-center-block">
      <div class="text-[10px] text-slate-500 uppercase tracking-[0.25em] font-bold mb-1">Destiny Core</div>
      <div class="text-amber-300 font-black text-xl tracking-widest">
        ${ziwei.core?.minggong || "â€”"}
      </div>
      <div class="mt-2 flex flex-wrap gap-1 justify-center">
        <span class="px-2 py-0.5 rounded-full border border-slate-700 bg-slate-900/60 text-[10px] text-slate-300">
          èº«å®®ï¼š${ziwei.core?.shengong || "â€”"}
        </span>
        <span class="px-2 py-0.5 rounded-full border border-slate-700 bg-slate-900/60 text-[10px] text-slate-300">
          ${ziwei.core?.wuxingju || "â€”"}å±€
        </span>
      </div>
    </div>
  `;
}

/* ========= ä¸»æµç¨‹ ========= */

async function launch() {
  const btn = document.getElementById("btnLaunch");
  await calculate(btn);
}

async function calculate(btnEl) {
  const btn = btnEl || document.getElementById("btnLaunch");
  const hint = document.getElementById("hint");
  const report = document.getElementById("report");

  const vy   = Number(document.getElementById("birthYear").value);
  const vm   = Number(document.getElementById("birthMonth").value);
  const vd   = Number(document.getElementById("birthDay").value);
  const vh   = Number(document.getElementById("birthHour").value);
  const vmin = Number(document.getElementById("birthMinute").value);

  const originalText = btn ? btn.innerText : "";

  try {
    if (![vy, vm, vd, vh, vmin].every(n => Number.isFinite(n))) {
      throw new Error("è«‹å…ˆé¸å¥½å®Œæ•´çš„å‡ºç”Ÿå¹´æœˆæ—¥èˆ‡æ™‚é–“");
    }

    if (btn) {
      btn.disabled = true;
      btn.innerText = "è¨ˆç®—ä¸­...";
      btn.classList.add("opacity-60","cursor-not-allowed");
    }
    if (hint) {
      hint.innerText = "æ­£åœ¨è®€å–æ˜Ÿè±¡è³‡æ–™èˆ‡æˆ°ç•¥åƒæ•¸ï¼Œè«‹ç¨å€™ç´„ 1â€“2 ç§’â€¦";
    }

    const body = {
      year: vy,
      month: vm,
      day: vd,
      hour: vh,
      minute: vmin,
    };

    // å¦‚æœä½ å‰é¢æœ‰ç®—å¥½ç´«å¾®ï¼Œå¯å°‡çµæœå¡åœ¨ window.__ziwei ä¸Š
    if (window.__ziwei && window.__ziwei.version === "ziwei_features_v1") {
      body.ziwei = window.__ziwei;
    }

    const resp = await fetch(`${API_BASE}/compute/all`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });

    if (!resp.ok) {
      const txt = await resp.text().catch(() => "");
      throw new Error(`API HTTP ${resp.status} ${txt || ""}`.trim());
    }

    const payload = await resp.json();

    // debug ç”¨ï¼šéš¨æ™‚åœ¨ console çœ‹ contract
    window.__payload = payload;
    window.__contract = payload?.features;

    if (!payload?.ok) {
      throw new Error(payload?.error || "API å›å‚³éŒ¯èª¤");
    }

    const contract = payload.features;
    const bazi = contract?.bazi;
    const ziwei = contract?.ziwei;

    if (!contract || contract.version !== "strategic_features_v1") {
      throw new Error("contract æ ¼å¼ä¸æ­£ç¢ºï¼ˆfeatures.version != strategic_features_v1ï¼‰");
    }
    if (!bazi) {
      throw new Error("contract.bazi ç¼ºå¤±ï¼ˆå¾Œç«¯æ‡‰è©²ä¸€å®šè¦æœ‰å…«å­—è³‡æ–™ï¼‰");
    }

    /* === å››æŸ± === */
    const disp = bazi.display || {};
    document.getElementById("yG").innerText = disp.yG || "";
    document.getElementById("yZ").innerText = disp.yZ || "";
    document.getElementById("mG").innerText = disp.mG || "";
    document.getElementById("mZ").innerText = disp.mZ || "";
    document.getElementById("dG").innerText = disp.dG || "";
    document.getElementById("dZ").innerText = disp.dZ || "";
    document.getElementById("hG").innerText = disp.hG || "";
    document.getElementById("hZ").innerText = disp.hZ || "";

    /* === äº”è¡Œ === */
    renderBar("surfaceWx", bazi.wuxing?.surface, 4);
    renderBar("strategicWx", bazi.wuxing?.strategic, bazi.wuxing?.maxStrategic || 1);

    /* === æµæœˆ === */
    const bounds = bazi.liuyue2026?.bounds || [];
    const monthGrid = document.getElementById("monthGrid");
    const redMonths = [];

    monthGrid.innerHTML = "";
    if (bounds.length) {
      bounds.forEach(b => {
        const isRed = b.light === "RED";
        if (isRed) redMonths.push(b.gz);
        monthGrid.innerHTML += `
          <div class="p-4 rounded-2xl border-l-4 ${isRed ? "border-red-500 bg-red-500/10" : "border-emerald-400 bg-emerald-400/10"} flex items-center justify-between">
            <div>
              <div class="font-bold text-sm text-slate-100">
                ${b.gz}
                <span class="text-[10px] text-slate-300 ml-1">${b.range || ""}</span>
              </div>
              <div class="text-[11px] text-slate-200 mt-1">
                æœ¬æ°£ï¼š${b.ssBranch || ""} ï½œ å¹²ï¼š${b.ssStem || ""}
              </div>
            </div>
            <div class="text-[11px] font-bold px-2.5 py-1 rounded-full bg-slate-950/70 text-slate-100">
              ${isRed ? "ğŸ”´ å£“åŠ›" : "ğŸŸ¢ ç©©é€²"}
            </div>
          </div>
        `;
      });
    } else {
      monthGrid.innerHTML = `<div class="text-xs text-slate-400 italic">ï¼ˆæš«ç„¡æµæœˆè³‡æ–™ï¼‰</div>`;
    }

    /* === ç´«å¾®æ–¹ç›¤ === */
    renderZiwei(ziwei);

    /* === æˆ°ç•¥è§£è®€ fallback === */
    const analysisBox = document.getElementById("analysisBox");
    const dominant = (bazi.tenGod?.dominant || "").trim() || "æœªå®š";
    const dmElement = bazi.dmElement || "ç«";

    const redText = redMonths.length
      ? `å£“åŠ›æœˆï¼š${redMonths.join("ã€")}ã€‚é€™å¹¾å€‹æœˆå„ªå…ˆã€Œå®ˆè¦å‰‡ã€ï¼Œä¸ç¡¬è¡ï¼Œé¿å…åœ¨é«˜å£“æœŸåŒæ™‚é–‹å¤ªå¤šæ–°æˆ°ç·šã€‚`
      : "ä»Šå¹´å£“åŠ›æœˆåå°‘ï¼Œå¯ä»¥ç©©ç©©æ¨é€²ï¼ŒæŠŠç¯€å¥è¨‚å¥½ã€é‡è¤‡åŸ·è¡Œã€‚";

    analysisBox.innerHTML = `
      <p>ä½ çš„æ—¥ä¸»äº”è¡Œä¸»å ´æ˜¯ã€Œ<b>${dmElement}</b>ã€ï¼Œ2026 å¹´åº¦ä¸»è»¸åå‘ã€Œ<b>${dominant}</b>ã€ã€‚</p>
      <p>${redText}</p>
      <p>å»ºè­°ç­–ç•¥ï¼šæŠŠç›®æ¨™æ•¸é‡å…ˆæ¸›å°‘ï¼Œæ”¹æˆå›ºå®šç¯€å¥çš„å°æ­¥å‰é€²ã€‚å£“åŠ›æœˆå®ˆä½ç¾æœ‰ç›¤é¢ï¼Œç©©å®šæœˆå†æ¨æ–°çš„å°ˆæ¡ˆèˆ‡çªç ´ã€‚</p>
      <p class="text-[11px] text-slate-400 mt-2">
        ï¼ˆä¹‹å¾Œå¯ä»¥ç”¨ /render/report æŠŠé€™æ®µæ”¹æˆå®Œæ•´ AI æ•˜äº‹å ±å‘Šï¼‰
      </p>
    `;

    if (report) {
      report.classList.remove("hidden");
      report.scrollIntoView({ behavior: "smooth", block: "start" });
    }
    if (hint) hint.innerText = "";

  } catch (e) {
    console.error(e);
    if (hint) {
      hint.innerText = "ç³»çµ±å¿™ç¢Œä¸­æˆ–ç¶²è·¯ä¸ç©©ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚";
    }
    alert("è¨ˆç®—å¤±æ•—ï¼š" + (e?.message || e));
    const report = document.getElementById("report");
    if (report) report.classList.add("hidden");
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerText = originalText;
      btn.classList.remove("opacity-60","cursor-not-allowed");
    }
  }
}

/* ========= æ—¥æœŸé¸å–® ========= */
function initSelectors() {
  const y = document.getElementById("birthYear");
  const m = document.getElementById("birthMonth");
  const d = document.getElementById("birthDay");
  const h = document.getElementById("birthHour");
  const min = document.getElementById("birthMinute");
  if (!y || !m || !d || !h || !min) return;

  for (let i = 2026; i >= 1940; i--) {
    y.add(new Option(i + " å¹´", i));
  }
  for (let i = 1; i <= 12; i++) {
    m.add(new Option(i + " æœˆ", i));
  }
  for (let i = 0; i < 24; i++) {
    const label = String(i).padStart(2,"0") + " æ™‚";
    h.add(new Option(label, i));
  }
  ["00","15","30","45"].forEach(v => {
    min.add(new Option(v + " åˆ†", v));
  });

  y.value = "1990";
  m.value = "1";
  h.value = "12";
  min.value = "00";

  updateDays();
}

function updateDays() {
  const y = document.getElementById("birthYear");
  const m = document.getElementById("birthMonth");
  const d = document.getElementById("birthDay");
  if (!y || !m || !d) return;

  const year = parseInt(y.value, 10);
  const month = parseInt(m.value, 10);
  const cur = d.value;

  d.innerHTML = "";
  const days = new Date(year, month, 0).getDate();
  for (let i = 1; i <= days; i++) {
    const opt = new Option(i + " æ—¥", i);
    if (String(i) === String(cur) || (!cur && i === 1)) opt.selected = true;
    d.add(opt);
  }
  // é‚Šç•Œä¿è­·ï¼šå¦‚æœåŸæœ¬é¸ 29 æ—¥ä½†ç¾åœ¨åªæœ‰ 28 å¤©ï¼Œè‡ªå‹•è·³å›æœ€å¾Œä¸€å¤©
  if (Number(cur) > days) d.value = String(days);
}

document.addEventListener("DOMContentLoaded", initSelectors);
</script>
</body>
</html>
