<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2026 æˆ°ç•¥å°èˆªï½œä¸€èµ·å‡ºä¾†ç©</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <style>
    body { background:#0b0e14; color:#e2e8f0; font-family: system-ui,-apple-system; }
    .glass { background: rgba(255,255,255,.04); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.08); }
    .bazi-char { font-size:1.8rem; font-weight:900; }
    .wuxing-æœ¨{background:#2ecc71}.wuxing-ç«{background:#e74c3c}
    .wuxing-åœŸ{background:#f1c40f}.wuxing-é‡‘{background:#ced4da}
    .wuxing-æ°´{background:#3498db}
  </style>
</head>

<body class="p-4">

<h1 class="text-3xl font-black text-center mb-6">2026 æµå¹´æˆ°ç•¥å ±å‘Š</h1>

<!-- è¼¸å…¥ -->
<div class="glass p-6 rounded-xl max-w-xl mx-auto mb-10">
  <div class="grid grid-cols-3 gap-2 mb-3">
    <select id="birthYear" class="bg-black/40 p-2 rounded"></select>
    <select id="birthMonth" class="bg-black/40 p-2 rounded" onchange="updateDays()"></select>
    <select id="birthDay" class="bg-black/40 p-2 rounded"></select>
  </div>
  <div class="grid grid-cols-2 gap-2 mb-4">
    <select id="birthHour" class="bg-black/40 p-2 rounded"></select>
    <select id="birthMinute" class="bg-black/40 p-2 rounded"></select>
  </div>
  <button onclick="launch()" class="w-full bg-amber-500 text-black py-3 rounded font-black">
    ç”Ÿæˆæˆ‘çš„ 2026 æˆ°ç•¥
  </button>
</div>

<!-- å ±å‘Š -->
<div id="report" class="hidden max-w-xl mx-auto space-y-10">

  <!-- å››æŸ± -->
  <div class="glass p-6 rounded-xl">
    <div class="grid grid-cols-4 text-center">
      <div><div id="yG" class="bazi-char"></div><div id="yZ"></div></div>
      <div><div id="mG" class="bazi-char"></div><div id="mZ"></div></div>
      <div><div id="dG" class="bazi-char text-amber-400"></div><div id="dZ"></div></div>
      <div><div id="hG" class="bazi-char"></div><div id="hZ"></div></div>
    </div>
  </div>

  <!-- äº”è¡Œ -->
  <div class="glass p-6 rounded-xl">
    <h2 class="font-black mb-3">äº”è¡Œèƒ½é‡</h2>
    <div id="surfaceWx" class="space-y-2 mb-4"></div>
    <div id="strategicWx" class="space-y-2"></div>
  </div>

  <!-- æµæœˆ -->
  <div class="glass p-6 rounded-xl">
    <h2 class="font-black mb-3">2026 æµæœˆç¯€å¥</h2>
    <div id="monthGrid" class="space-y-2"></div>
  </div>

  <!-- åˆ†æ -->
  <div class="glass p-6 rounded-xl">
    <h2 class="font-black mb-3">æˆ°ç•¥è§£è®€</h2>
    <div id="analysisBox" class="space-y-2"></div>
  </div>

</div>

<script>
/* ========= åŸºæœ¬è¨­å®š ========= */
const API_BASE = "https://17gonplay-api.billeetw.workers.dev";

/* ========= å·¥å…· ========= */
function renderBar(id, data, max){
  const box = document.getElementById(id);
  box.innerHTML="";
  ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(e=>{
    const v=Number(data[e]||0);
    const w=max?Math.max(2,(v/max)*100):0;
    box.innerHTML+=`
      <div>
        <div class="flex justify-between text-xs"><span>${e}</span><span>${v.toFixed(1)}</span></div>
        <div class="h-2 bg-white/10 rounded">
          <div class="h-full wuxing-${e}" style="width:${w}%"></div>
        </div>
      </div>`;
  });
}

/* ========= ä¸»æµç¨‹ ========= */

  function launch() {
  const loading = document.getElementById("loading");
  if (loading) loading.style.display = "flex";

  // å°å»¶é²è®“ loading å‹•ç•«çœ‹å¾—åˆ°
  setTimeout(() => {
    if (loading) loading.style.display = "none";
    calculate();
  }, 650);
}

async function calculate() {
  const vy = parseInt(document.getElementById("birthYear")?.value, 10);
  const vm = parseInt(document.getElementById("birthMonth")?.value, 10);
  const vd = parseInt(document.getElementById("birthDay")?.value, 10);
  const vh = parseInt(document.getElementById("birthHour")?.value, 10);
  const vmin = parseInt(document.getElementById("birthMinute")?.value, 10);

  try {
    // 0) é˜²å‘†
    if (![vy, vm, vd, vh, vmin].every((n) => Number.isFinite(n))) {
      throw new Error("è«‹å…ˆé¸å¥½å‡ºç”Ÿå¹´æœˆæ—¥èˆ‡æ™‚é–“");
    }

    // 1) èµ° Phase 0 contractï¼šåªæ‰“ /compute/all
    const resp = await fetch(`${API_BASE}/compute/all`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ year: vy, month: vm, day: vd, hour: vh, minute: vmin }),
    });

    if (!resp.ok) {
      const txt = await resp.text().catch(() => "");
      throw new Error(`API HTTP ${resp.status} ${txt || ""}`.trim());
    }

    const payload = await resp.json();
    if (!payload?.ok) throw new Error(payload?.error || "API error");

    // payload = { ok:true, features: StrategicFeaturesV1 }
    const contract = payload.features;
    if (!contract || contract.version !== "strategic_features_v1") {
      throw new Error("contract æ ¼å¼ä¸æ­£ç¢ºï¼ˆfeatures.version != strategic_features_v1ï¼‰");
    }

    const bazi = contract.bazi;
    if (!bazi) throw new Error("contract.bazi ä¸å­˜åœ¨ï¼ˆå¾Œç«¯ Phase 0 æ‡‰è©²ä¸€å®šè¦æœ‰ï¼‰");

    // 2) ï¼ˆå¯é¸ï¼‰judge/mergeï¼šå¤±æ•—ä¹Ÿä¸å½±éŸ¿ç•«é¢
    let judge = null;
    try {
      const jResp = await fetch(`${API_BASE}/judge/merge`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ features: contract }),
      });
      const j = await jResp.json().catch(() => null);
      if (j && j.ok) judge = j;
    } catch (_) {}

    // 3) å››æŸ±æ¸²æŸ“ï¼šå¾ bazi çš„ pillarsï¼ˆPhase 0 contract å…§æ²’æœ‰ pillarsï¼Œæ‰€ä»¥æˆ‘å€‘ç”¨ compute/bazi è£œä¸€ä»½ displayï¼‰
    // âœ… æœ€ä½³åšæ³•ï¼šPhase 0 contract ä¹Ÿå¸¶ pillarsï¼Œä½†ä½ ç¾åœ¨ Phase 0 åªå› features
    // æ‰€ä»¥é€™è£¡ç”¨ /compute/bazi è£œã€Œé¡¯ç¤ºç”¨ã€è³‡æ–™ï¼ˆä¸å½±éŸ¿æ ¸å¿ƒç®—æ³•ï¼‰
    const dispResp = await fetch(`${API_BASE}/compute/bazi`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ year: vy, month: vm, day: vd, hour: vh, minute: vmin }),
    });
    const disp = await dispResp.json();
    if (!disp?.ok) throw new Error(disp?.error || "compute/bazi errorï¼ˆé¡¯ç¤ºç”¨ï¼‰");

    const dm = disp.pillars?.dm; // "ä¸™"
    const bY = disp.pillars?.year;
    const bM = disp.pillars?.month;
    const bD = disp.pillars?.day;
    const bH = disp.pillars?.time;

    // 3a) æ¸²æŸ“å››æŸ±å­—
    document.getElementById("yG").innerText = bY?.[0] || "";
    document.getElementById("yZ").innerText = bY?.[1] || "";
    document.getElementById("mG").innerText = bM?.[0] || "";
    document.getElementById("mZ").innerText = bM?.[1] || "";
    document.getElementById("dG").innerText = bD?.[0] || "";
    document.getElementById("dZ").innerText = bD?.[1] || "";
    document.getElementById("hG").innerText = bH?.[0] || "";
    document.getElementById("hZ").innerText = bH?.[1] || "";

    // 3b) åç¥é¡¯ç¤ºï¼ˆå‰ç«¯ getSS åªåƒ dm + æŸ±å­—ï¼Œä¸å†èµ·ç›¤ï¼‰
    const mSSZ = (dm && bM?.[1]) ? getSS(dm, bM[1]) : (bazi?.tenGod?.dominant || "");
    document.getElementById("ySG").innerText = (dm && bY?.[0]) ? getSS(dm, bY[0]) : "";
    document.getElementById("ySZ").innerText = (dm && bY?.[1]) ? getSS(dm, bY[1]) : "";
    document.getElementById("mSG").innerText = (dm && bM?.[0]) ? getSS(dm, bM[0]) : "";
    document.getElementById("mSZ").innerText = mSSZ || "";
    document.getElementById("hSG").innerText = (dm && bH?.[0]) ? getSS(dm, bH[0]) : "";
    document.getElementById("hSZ").innerText = (dm && bH?.[1]) ? getSS(dm, bH[1]) : "";

    // 4) äº”è¡Œ barsï¼šå®Œå…¨åƒ contract.bazi.wuxing
    if (!bazi.wuxing?.surface || !bazi.wuxing?.strategic) {
      throw new Error("bazi.wuxing ç¼ºè³‡æ–™ï¼ˆsurface/strategicï¼‰");
    }
    renderBar("surfaceWx", bazi.wuxing.surface, 4);
    renderBar("strategicWx", bazi.wuxing.strategic, bazi.wuxing.maxStrategic || 1);

    // 5) æµæœˆï¼šå®Œå…¨åƒ contract.bazi.liuyue2026.boundsï¼ˆä½ çœ‹åˆ° 12 å°±æ˜¯é€™è£¡ï¼‰
    const bounds = bazi.liuyue2026?.bounds;
    const mGrid = document.getElementById("monthGrid");
    if (!mGrid) throw new Error("#monthGrid ä¸å­˜åœ¨");

    mGrid.innerHTML = "";
    const redM = [];

    if (Array.isArray(bounds) && bounds.length) {
      bounds.forEach((b) => {
        const isRed = b.light === "RED";
        if (isRed) redM.push(b.gz);

        mGrid.innerHTML += `
          <div class="glass p-5 rounded-2xl border-l-4 ${
            isRed ? "border-red-500 bg-red-500/5" : "border-emerald-500 bg-emerald-500/5"
          } flex justify-between items-center w-full">
            <div class="text-left">
              <p class="font-black text-base">${b.gz}
                <span class="text-[9px] font-normal text-slate-500 ml-1 uppercase">${b.range || ""}</span>
              </p>
              <p class="text-[10px] text-slate-400 mt-1 font-bold italic">æœ¬æ°£æˆ°ç•¥ï¼š${b.ssBranch || ""}</p>
            </div>
            <span class="text-[10px] font-bold px-3 py-1 rounded-lg bg-white/10 tracking-widest">
              ${isRed ? "ğŸ”´ å£“åŠ›" : "ğŸŸ¢ ç©©é€²"}
            </span>
          </div>
        `;
      });
    } else {
      // æ²’ bounds ä¹Ÿä¸è¦è®“é é¢ç©ºç™½
      mGrid.innerHTML = `<div class="text-[12px] text-slate-400 italic">ï¼ˆå°šæœªå–å¾—æµæœˆè³‡æ–™ï¼‰</div>`;
    }

    // 6) å¹´åº¦æˆ°ç•¥æ–¹é‡ï¼šå…ˆç”¨ dominant + judgeï¼ˆæœ‰å°±åŠ æ–™ï¼‰
    const dominant = (bazi.tenGod?.dominant || "").trim() || "æœªå®š";
    const strategyBox = document.getElementById("strategyBox");
    if (strategyBox) {
      const judgeHint = judge?.result?.theme ? `<div class="text-[11px] text-slate-400 mt-2">${judge.result.theme}</div>` : "";
      strategyBox.innerHTML = `<p class="font-black text-amber-500 text-2xl mb-2 tracking-tighter">å¹´åº¦ä¸»è»¸ï¼š${dominant}</p>${judgeHint}`;
    }

    // 7) å‘½ç›¤åˆ†æï¼šä½ ç¾åœ¨ Phase 0 é‚„æ²’ä¸Š /render/reportï¼Œæ‰€ä»¥é€™è£¡çµ¦ã€Œä¸ç©ºç™½ã€çš„ fallback
    const analysisBox = document.getElementById("analysisBox");
    if (analysisBox) {
      const dmElement = bazi.dmElement || "ç«";
      const lacks = (judge?.result?.hints?.lacks || []).join("ã€");
      const strengths = (judge?.result?.hints?.strengths || []).join("ã€");
      const redText = redM.length ? `å£“åŠ›æœˆï¼š${redM.join("ã€")}ï¼ˆå…ˆå®ˆè¦å‰‡ï¼Œä¸ç¡¬ç¢°ï¼‰` : "ä»Šå¹´å£“åŠ›æœˆåå°‘ï¼Œå¯ä»¥ç©©ç©©æ¨é€²ã€‚";

      analysisBox.innerHTML = `
        <div class="space-y-2">
          <p>ä½ çš„æ—¥ä¸»äº”è¡Œä¸»å ´æ˜¯ã€Œ${dmElement}ã€ï¼Œä»Šå¹´æ ¸å¿ƒç­–ç•¥èªè¨€åå‘ã€Œ${dominant}ã€ã€‚</p>
          <p>${redText}</p>
          <p>${lacks ? `çµæ§‹ç¼ºå£ï¼š${lacks}ï¼ˆè£œé€™å€‹ï¼Œäººç”Ÿæœƒé †å¾ˆå¤šï¼‰` : "çµæ§‹ç¼ºå£ï¼šç›®å‰ä¸æ˜é¡¯ï¼ˆè³‡æ–™å®Œæ•´åº¦è‰¯å¥½ï¼‰"}</p>
          <p>${strengths ? `çµæ§‹å¼·é …ï¼š${strengths}ï¼ˆæŠŠå¼·é …åšæˆåˆ¶åº¦è¼¸å‡ºï¼‰` : "çµæ§‹å¼·é …ï¼šå…ˆæŠŠä½ æœ€é †çš„èƒ½åŠ›å¯«æˆ SOP"}</p>
          <p class="text-[11px] text-slate-400 mt-3">ï¼ˆPhase 1ï¼šé€™æ®µä¹‹å¾Œæœƒæ”¹æˆ render/report çš„å®Œæ•´æ•˜äº‹è¼¸å‡ºï¼‰</p>
        </div>
      `;
    }

    // 8) Archetype
    const archetypes = {
      "å‚·å®˜": "å…§å®¹é©å‘½å®¶",
      "é£Ÿç¥": "ç”Ÿæ´»ç”¢å“ç¶“ç†",
      "æ­£è²¡": "ç²¾æº–åŸ·è¡Œè€…",
      "åè²¡": "è³‡æºæ•´åˆå•†",
      "æ­£å®˜": "ç§©åºå®ˆè­·è€…",
      "ä¸ƒæ®º": "é‚Šéš›ç ´å±€è€…",
      "æ­£å°": "æ™ºæ…§å°å¸«",
      "åå°": "éˆé­‚å¥‡æ‰",
      "æ¯”è‚©": "æ„å¿—å‹æ¨æ‰‹",
      "åŠ«è²¡": "äººè„ˆé–‹æ‹“è€…",
    };
    document.getElementById("archetype").innerText = archetypes[dominant] || "å¹³è¡¡è§€å¯Ÿè€…";

    // 9) åˆ†äº«æ–‡å­—ï¼šæ°¸é ä¸ä¾è³´ profile
    window.shareText =
      (analysisBox && analysisBox.innerText && analysisBox.innerText.trim()) ||
      `ã€ä¸€èµ·å‡ºä¾†ç©ã€‚2026 æ·±åº¦æˆ°ç•¥å ±å‘Šã€‘å¹´åº¦ä¸»è»¸ï¼š${dominant}`;

    // 10) é¡¯ç¤ºå ±å‘Šå€
    document.getElementById("report").classList.remove("hidden");
    document.getElementById("report").scrollIntoView({ behavior: "smooth", block: "start" });
  } catch (e) {
    console.error(e);
    alert("è¨ˆç®—å¤±æ•—ï¼š" + (e?.message || e));
  }
}

  /* äº”è¡Œ */
  renderBar("surfaceWx",data.features.wuxing.surface,4);
  renderBar("strategicWx",data.features.wuxing.strategic,data.features.wuxing.maxStrategic);

  /* æµæœˆ */
  monthGrid.innerHTML="";
  data.features.liuyue2026.bounds.forEach(b=>{
    const red=b.light==="RED";
    monthGrid.innerHTML+=`
      <div class="p-3 rounded border-l-4 ${red?"border-red-500":"border-emerald-500"} bg-black/20">
        <div class="font-bold">${b.gz} <span class="text-xs text-slate-400">${b.range}</span></div>
        <div class="text-xs">${red?"ğŸ”´ å£“åŠ›":"ğŸŸ¢ ç©©é€²"}ï½œ${b.ssBranch}</div>
      </div>`;
  });

  /* åˆ†æï¼ˆç©©å®š fallbackï¼‰ */
  const redMonths=data.features.liuyue2026.bounds.filter(x=>x.light==="RED").map(x=>x.gz);
  analysisBox.innerHTML=`
    <p>ä½ çš„ä¸»è»¸åç¥æ˜¯ã€Œ${data.features.tenGod.dominant}ã€ã€‚</p>
    <p>2026 é—œéµåœ¨ã€Œå…ˆç«‹è¦å‰‡ï¼Œå†æ¨é€²ã€ã€‚</p>
    <p>å£“åŠ›æœˆï¼š${redMonths.join("ã€")||"ç„¡"}ã€‚</p>
    <p>ç­–ç•¥ï¼šæ¸›å°‘åŒæ™‚æ¨é€²çš„æˆ°ç·šï¼ŒæŠŠç¯€å¥å›ºå®šã€‚</p>`;

  report.classList.remove("hidden");
}

/* ========= UI ========= */
function initSelectors(){
  for(let i=2026;i>=1940;i--) birthYear.add(new Option(i,i));
  for(let i=1;i<=12;i++) birthMonth.add(new Option(i,i));
  for(let i=0;i<24;i++) birthHour.add(new Option(i,i));
  ["00","15","30","45"].forEach(v=>birthMinute.add(new Option(v,v)));
  birthYear.value=1990; birthMonth.value=1; birthHour.value=12;
  updateDays();
}
function updateDays(){
  birthDay.innerHTML="";
  const d=new Date(birthYear.value,birthMonth.value,0).getDate();
  for(let i=1;i<=d;i++) birthDay.add(new Option(i,i));
}
document.addEventListener("DOMContentLoaded",initSelectors);
</script>
</body>
</html>
















