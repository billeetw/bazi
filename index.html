<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:title" content="2026 æˆ°ç•¥å°èˆªï¼šç”Ÿå­˜æ¼”ç®—æ³•ï¼ˆå°ˆæ¥­æ ¡æº–æœ€çµ‚ç‰ˆï¼‰" />
  <meta property="og:description" content="é€™ä¸æ˜¯ç®—å‘½ï¼Œæ˜¯å¦³ 2026 çš„æˆ°ç•¥é…ç½®ã€‚è§£ç¢¼è—å¹²æ¬Šé‡ã€é›™æ¨™ç±¤å¹´åº¦æˆ°ç•¥èˆ‡å£“åŠ›é˜²ç·šï¼" />
  <title>2026 æˆ°ç•¥å°èˆª | ä¸€èµ·å‡ºä¾†ç© å°ˆæ¥­æ ¡æº–æœ€çµ‚ç‰ˆ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background: #0b0e14; color: #e2e8f0; overflow-x: hidden; }
    .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
    .gold-text { background: linear-gradient(135deg, #d4af37 0%, #f3e5ab 50%, #aa8a2e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .wuxing-æœ¨ { background: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.2); }
    .wuxing-ç« { background: #e74c3c; box-shadow: 0 0 10px rgba(231, 76, 60, 0.2); }
    .wuxing-åœŸ { background: #f1c40f; box-shadow: 0 0 10px rgba(241, 196, 15, 0.2); }
    .wuxing-é‡‘ { background: #ced4da; box-shadow: 0 0 10px rgba(206, 212, 218, 0.2); }
    .wuxing-æ°´ { background: #3498db; box-shadow: 0 0 10px rgba(52, 152, 219, 0.2); }
    .bazi-char { font-size: 1.8rem; font-weight: 900; line-height: 1.1; }
    .shishen-tag { font-size: 10px; padding: 2px 4px; border-radius: 4px; background: rgba(255,255,255,0.08); color: #aaa; margin-top: 2px; }
    #loading { position: fixed; inset: 0; background: #0b0e14; z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
    .ring { width: 60px; height: 60px; border: 4px solid rgba(212,175,55,0.1); border-top: 4px solid #d4af37; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .archetype-badge { background: linear-gradient(45deg, #1e293b, #0f172a); border: 1px solid #d4af37; border-radius: 99px; padding: 6px 20px; font-weight: 900; font-size: 16px; display: inline-block; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2); }
    select {
      -webkit-appearance: none; appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1em; padding-right: 2rem !important;
    }
    @keyframes pulse-red { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    .vibrant-bar { animation: pulse-red 2s infinite ease-in-out; }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center p-0 pb-24 text-center">

  <div id="loading">
    <div class="ring mb-6"></div>
    <p class="gold-text font-black tracking-[0.3em] text-lg animate-pulse">æ­£åœ¨ç²¾ç®—æ²³åœ–æ´›æ›¸èˆ‡æ¬Šé‡èƒ½é‡...</p>
  </div>

  <div class="w-full bg-gradient-to-r from-red-600 via-orange-600 to-red-600 py-5 px-6 text-white sticky top-0 z-50 shadow-[0_4px_20px_rgba(220,38,38,0.5)] cursor-pointer hover:brightness-110 transition-all border-b border-white/20">
    <a href="https://www.youtube.com/@billeetw1" target="_blank" class="block w-full">
      <span class="text-base md:text-xl font-black tracking-tight vibrant-bar inline-block text-center mx-auto">
        ã€è·Ÿæä¼¯å½¥ä¸€èµ·å‡ºä¾†ç©ã€ 2026 ä½ çš„ç”Ÿå­˜æˆ°ç•¥ ğŸš€
        <span class="ml-2 bg-yellow-400 text-red-700 px-3 py-1 rounded-full text-xs md:text-sm font-black shadow-lg text-center inline-block">
          é»æ“Šè¨‚é–±éš¨æ™‚æ¥å—æ–°æƒ…å ±ï¼
        </span>
      </span>
    </a>
  </div>

  <div class="w-full max-w-xl mx-auto flex flex-col items-center p-4">
    <div class="my-8 px-4">
      <h1 class="text-3xl md:text-4xl font-black gold-text mb-3 tracking-tighter leading-tight text-center">
        ä¸€èµ·å‡ºä¾†ç©<br class="md:hidden" /> æ˜“ç¶“å››æŸ±æµå¹´æ·±åº¦è§£æ
      </h1>
      <p class="text-slate-500 text-xs tracking-[0.4em] font-bold uppercase italic text-center mx-auto">Advanced Metaphysical Algorithm</p>

      <div class="mt-6 flex items-center justify-center space-x-2 bg-slate-800/40 px-4 py-2 rounded-full border border-white/5 mx-auto w-fit">
        <span class="flex h-2 w-2 relative">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span class="relative h-2 w-2 rounded-full bg-green-500"></span>
        </span>
        <p class="text-[11px] font-bold text-slate-400 tracking-wider">
          ç›®å‰å·²æœ‰ <span id="userCounter" class="text-amber-400 font-black text-sm mx-1">5,001</span> ä½é ˜å–æˆ°ç•¥å ±å‘Š
        </p>
      </div>
    </div>

    <div class="glass p-8 rounded-[2.5rem] shadow-2xl border-t-2 border-amber-500/20 mb-10 w-full">
      <div class="space-y-8">
        <div>
          <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest mb-4 text-center">é¸æ“‡æ‚¨çš„å‡ºç”Ÿæ—¥æœŸ (å…¬æ›†)</label>
          <div class="grid grid-cols-3 gap-3">
            <select id="birthYear" class="bg-slate-800/60 border border-slate-700 rounded-2xl px-3 py-4 text-white text-center text-sm focus:outline-none focus:border-amber-500 transition-all"></select>
            <select id="birthMonth" class="bg-slate-800/60 border border-slate-700 rounded-2xl px-3 py-4 text-white text-center text-sm focus:outline-none focus:border-amber-500 transition-all" onchange="updateDays()"></select>
            <select id="birthDay" class="bg-slate-800/60 border border-slate-700 rounded-2xl px-3 py-4 text-white text-center text-sm focus:outline-none focus:border-amber-500 transition-all"></select>
          </div>
        </div>

        <div>
          <label class="block text-[11px] font-black text-slate-400 uppercase tracking-widest mb-4 text-center">é¸æ“‡å‡ºç”Ÿæ™‚é–“</label>
          <div class="grid grid-cols-2 gap-3">
            <select id="birthHour" class="bg-slate-800/60 border border-slate-700 rounded-2xl px-3 py-4 text-white text-center text-sm focus:outline-none focus:border-amber-500"></select>
            <select id="birthMinute" class="bg-slate-800/60 border border-slate-700 rounded-2xl px-3 py-4 text-white text-center text-sm focus:outline-none focus:border-amber-500"></select>
          </div>
        </div>

        <button onclick="launch()" class="w-full bg-gradient-to-r from-amber-500 to-yellow-600 text-slate-900 font-black py-6 rounded-2xl text-lg md:text-xl shadow-[0_10px_30px_rgba(245,158,11,0.3)] hover:scale-[1.02] active:scale-[0.98] transition-all tracking-widest leading-tight uppercase">
          ç”Ÿæˆå°ˆå±¬æ–¼æˆ‘çš„ 2026 æµå¹´æˆ°ç•¥å ±å‘Š
        </button>
      </div>
    </div>

    <div id="report" class="hidden space-y-10 w-full animate-in fade-in slide-in-from-bottom-10 duration-1000 flex flex-col items-center">

      <div id="archetype" class="archetype-badge gold-text mb-2 tracking-tighter italic"></div>

      <div class="w-full">
        <h2 class="text-xs font-black text-slate-500 mb-6 tracking-[0.2em] uppercase text-center mx-auto">â¶ æ²³åœ–æ™‚ç©ºåº§æ¨™ (å››æŸ±å‘½ç›¤)</h2>
        <div class="grid grid-cols-4 gap-2 px-1">
          <div class="glass py-5 rounded-2xl flex flex-col items-center">
            <p class="text-[10px] text-slate-600 mb-2 font-bold uppercase">å¹´</p>
            <div id="yG" class="bazi-char"></div><div id="yZ" class="bazi-char"></div>
            <div id="ySG" class="shishen-tag"></div><div id="ySZ" class="shishen-tag opacity-40 italic text-[8px]"></div>
          </div>

          <div class="glass py-5 rounded-2xl flex flex-col items-center border border-white/5">
            <p class="text-[10px] text-slate-600 mb-2 font-bold uppercase">æœˆ</p>
            <div id="mG" class="bazi-char"></div><div id="mZ" class="bazi-char"></div>
            <div id="mSG" class="shishen-tag"></div><div id="mSZ" class="shishen-tag opacity-40 italic text-[8px]"></div>
          </div>

          <div class="glass py-5 rounded-2xl flex flex-col items-center border-2 border-amber-500/30 bg-amber-500/5">
            <p class="text-[10px] text-amber-500 mb-2 font-black uppercase tracking-tighter">æ—¥</p>
            <div id="dG" class="bazi-char text-amber-500"></div><div id="dZ" class="bazi-char text-amber-500"></div>
            <div class="shishen-tag text-amber-600 font-bold border-amber-900/50 uppercase">å‘½ä¸»</div>
          </div>

          <div class="glass py-5 rounded-2xl flex flex-col items-center">
            <p class="text-[10px] text-slate-600 mb-2 font-bold uppercase">æ™‚</p>
            <div id="hG" class="bazi-char text-slate-200"></div><div id="hZ" class="bazi-char text-slate-200"></div>
            <div id="hSG" class="shishen-tag"></div><div id="hSZ" class="shishen-tag opacity-40 italic text-[8px]"></div>
          </div>
        </div>
        <p class="text-[9px] text-slate-500 mt-3 italic text-right px-2 tracking-tight w-full">â€» åœ°æ”¯é¡¯ç¤ºæœ¬æ°£åç¥ä»¥ä¿æŒå¯è®€æ€§</p>
      </div>

      <div class="glass p-8 rounded-[2.5rem] shadow-xl w-full">
        <h2 class="text-xs font-black gold-text mb-6 tracking-widest uppercase text-center mx-auto">â· äº”è¡Œèƒ½é‡æ·±åº¦æ¼”ç®—æ³•</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
          <div>
            <p class="text-[10px] font-black text-slate-500 mb-4 uppercase flex items-center"><i class="fas fa-eye mr-2"></i> è¡¨å±¤èƒ½é‡ (å¤©å¹²å­—æ•¸)</p>
            <div id="surfaceWx" class="space-y-3"></div>
          </div>

          <div>
            <p class="text-[10px] font-black text-amber-500 mb-4 uppercase flex items-center"><i class="fas fa-shield-alt mr-2"></i> å¯¦æˆ°èƒ½é‡ (å¤©å¹²+è—å¹²+æœˆä»¤)</p>
            <div id="strategicWx" class="space-y-3"></div>
          </div>
        </div>

        <div class="mt-8 p-5 bg-slate-800/40 rounded-3xl text-[11px] text-slate-400 border border-white/5 leading-relaxed italic text-left">
          <p class="font-bold text-slate-300 mb-2 uppercase">ğŸ›¡ï¸ æ¼”ç®—æ³•èªªæ˜ï¼š</p>
          è¡¨å±¤=å¤©å¹²çµ±è¨ˆï¼›å¯¦æˆ°=å¤©å¹²+è—å¹²+æœˆä»¤åŠ æ¬Šï¼ˆå¾Œç«¯è¨ˆç®—å›å‚³ï¼‰ã€‚
        </div>
      </div>

      <div class="glass p-10 rounded-[2.5rem] border-t-4 border-amber-500 shadow-2xl w-full bg-gradient-to-b from-slate-900/50 to-transparent">
        <h2 class="text-xs font-black gold-text mb-4 uppercase tracking-[0.2em] text-center mx-auto">â¸ 2026 å¹´åº¦æˆ°ç•¥æ–¹é‡</h2>
        <div id="strategyBox" class="text-sm text-slate-200 leading-relaxed text-center italic"></div>
      </div>

      <div class="w-full px-2">
        <h2 class="text-xs font-black text-slate-500 mb-6 tracking-[0.2em] uppercase text-center mx-auto">â¹ 2026 ç¯€æ°£æµæœˆåŸ·è¡Œç¯€å¥ (ä¸‰è‰²ç‡ˆ)</h2>
        <div id="monthGrid" class="grid grid-cols-1 gap-3.5"></div>
        <p class="text-[9px] text-slate-600 mt-4 italic text-center uppercase tracking-widest mx-auto">â€» æœ¬è¡¨æ¡ç¯€æ°£æœˆå€é–“ï¼ˆå¾Œç«¯å›å‚³ boundsï¼‰</p>
      </div>

      <div class="glass p-10 rounded-[2.5rem] shadow-2xl w-full bg-gradient-to-b from-slate-900/40 to-transparent">
        <h2 class="text-xs font-black gold-text mb-4 uppercase tracking-[0.2em] text-center mx-auto">âº å‘½ç›¤åˆ†æ ä½ çš„äººç”Ÿä½¿ç”¨èªªæ˜</h2>
        <div id="analysisBox" class="text-sm text-slate-200 leading-relaxed text-left italic space-y-2"></div>
      </div>

      <div class="glass p-10 rounded-[3rem] text-center border-2 border-dashed border-amber-500/20 bg-slate-900/60 w-full mb-12 flex flex-col items-center">
        <h3 class="gold-text text-2xl font-black mb-4 tracking-tighter italic text-center mx-auto">ã€Œå¦³ä¸æ˜¯åœ¨ç®—å‘½ï¼Œæ˜¯åœ¨é‡å¯« 2026ã€‚ã€</h3>
        <div class="flex flex-col gap-4 w-full px-2">
          <button onclick="copyText()" class="w-full bg-gradient-to-r from-amber-500 to-yellow-600 text-slate-900 font-black py-5 rounded-2xl text-lg shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center">
            <i class="far fa-copy mr-2"></i> ä¸€éµè¤‡è£½ã€æ·±åº¦æˆ°ç•¥ã€‘æ–‡æ¡ˆ
          </button>
          <a href="https://www.facebook.com/bill17gonplay/" target="_blank" class="w-full bg-[#1877F2] text-white py-4 rounded-2xl font-bold flex items-center justify-center text-sm shadow-lg mx-auto">
            <i class="fab fa-facebook-f mr-2"></i> å‰å¾€è‡‰æ›¸åƒèˆ‡æˆ°ç•¥å¯¦é©—
          </a>
        </div>
      </div>

    </div>
  </div>

  <div id="copyToast" class="fixed bottom-12 bg-amber-500 text-slate-900 px-8 py-4 rounded-full font-black text-sm shadow-2xl opacity-0 transition-opacity duration-300 pointer-events-none z-[2001] flex items-center transition-all">
    <i class="fas fa-check-circle mr-2"></i> å°ˆæ¥­æ ¡æº–ç‰ˆæˆ°ç•¥æ–‡æ¡ˆå·²è¤‡è£½
  </div>

  <script>
    // âœ… æ”¹æˆä½ è‡ªå·±çš„ Worker ç¶²å€
    const API_BASE = "https://17gonplay-api.billeetw.workers.dev";

    // ===== å‰ç«¯ä»ä¿ç•™åç¥/æ•˜äº‹å·¥å…·ï¼ˆä¸è² è²¬èµ·ç›¤ï¼‰=====
    const ELEMENTS = {"ç”²":"æœ¨","ä¹™":"æœ¨","ä¸™":"ç«","ä¸":"ç«","æˆŠ":"åœŸ","å·±":"åœŸ","åºš":"é‡‘","è¾›":"é‡‘","å£¬":"æ°´","ç™¸":"æ°´",
      "å­":"æ°´","ä¸‘":"åœŸ","å¯…":"æœ¨","å¯":"æœ¨","è¾°":"åœŸ","å·³":"ç«","åˆ":"ç«","æœª":"åœŸ","ç”³":"é‡‘","é…‰":"é‡‘","æˆŒ":"åœŸ","äº¥":"æ°´"};
    const STEM_POLARITY = {"ç”²":"é™½","ä¹™":"é™°","ä¸™":"é™½","ä¸":"é™°","æˆŠ":"é™½","å·±":"é™°","åºš":"é™½","è¾›":"é™°","å£¬":"é™½","ç™¸":"é™°"};
    const SHISHEN_MAP = {
      "åŒé¡": {"åŒ":"æ¯”è‚©","ç•°":"åŠ«è²¡"},
      "ç”Ÿè€…": {"åŒ":"é£Ÿç¥","ç•°":"å‚·å®˜"},
      "å‰‹è€…": {"åŒ":"åè²¡","ç•°":"æ­£è²¡"},
      "å¾Œç”Ÿè€…": {"åŒ":"åå°","ç•°":"æ­£å°"},
      "å¾Œå‰‹è€…": {"åŒ":"ä¸ƒæ®º","ç•°":"æ­£å®˜"}
    };
    const CANGGAN_DATA = {
      "å­": {"ç™¸": 1.0},
      "ä¸‘": {"å·±": 0.6, "ç™¸": 0.3, "è¾›": 0.1},
      "å¯…": {"ç”²": 0.6, "ä¸™": 0.3, "æˆŠ": 0.1},
      "å¯": {"ä¹™": 1.0},
      "è¾°": {"æˆŠ": 0.6, "ä¹™": 0.3, "ç™¸": 0.1},
      "å·³": {"ä¸™": 0.6, "åºš": 0.3, "æˆŠ": 0.1},
      "åˆ": {"ä¸": 0.7, "å·±": 0.3},
      "æœª": {"å·±": 0.6, "ä¸": 0.3, "ä¹™": 0.1},
      "ç”³": {"åºš": 0.6, "å£¬": 0.3, "æˆŠ": 0.1},
      "é…‰": {"è¾›": 1.0},
      "æˆŒ": {"æˆŠ": 0.6, "è¾›": 0.3, "ä¸": 0.1},
      "äº¥": {"å£¬": 0.7, "ç”²": 0.3}
    };

    function getBranchMainStem(zhi) {
      const cg = CANGGAN_DATA[zhi];
      if (!cg) return null;
      let bestStem = null, bestW = -1;
      for (const s in cg) { if (cg[s] > bestW) { bestW = cg[s]; bestStem = s; } }
      return bestStem;
    }
    function normalizeToStem(x) { if (!x) return null; if (STEM_POLARITY[x]) return x; return getBranchMainStem(x); }
    function getSS(dm, target) {
      const sDm = normalizeToStem(dm), sTarget = normalizeToStem(target);
      if (!sDm || !sTarget) return "";
      const de = ELEMENTS[sDm], te = ELEMENTS[sTarget];
      const isS = (STEM_POLARITY[sDm] === STEM_POLARITY[sTarget]) ? "åŒ" : "ç•°";
      const gen = {"æœ¨":"ç«","ç«":"åœŸ","åœŸ":"é‡‘","é‡‘":"æ°´","æ°´":"æœ¨"};
      const ctrl = {"æœ¨":"åœŸ","åœŸ":"æ°´","æ°´":"ç«","ç«":"é‡‘","é‡‘":"æœ¨"};
      if (de === te) return SHISHEN_MAP["åŒé¡"][isS];
      if (gen[de] === te) return SHISHEN_MAP["ç”Ÿè€…"][isS];
      if (ctrl[de] === te) return SHISHEN_MAP["å‰‹è€…"][isS];
      if (gen[te] === de) return SHISHEN_MAP["å¾Œç”Ÿè€…"][isS];
      if (ctrl[te] === de) return SHISHEN_MAP["å¾Œå‰‹è€…"][isS];
      return "";
    }

    // âœ… è®“ renderBar åœ¨ console ä¹Ÿèƒ½ç”¨ï¼ˆä¸è¦å†å‡ºç¾ renderBar undefinedï¼‰
    function formatVal(v) {
      const x = Number(v || 0);
      if (x > 0 && x < 0.05) return "<0.1";
      return x.toFixed(1);
    }
    function renderBar(id, wxData, max) {
      const box = document.getElementById(id);
      if (!box) return;
      box.innerHTML = "";
      ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(e => {
        const raw = Number(wxData?.[e] || 0);
        const pct = max > 0 ? (raw / max) * 100 : 0;
        const width = (raw > 0 && pct < 2) ? 2 : pct;
        box.innerHTML += `
          <div class="space-y-1 w-full text-left">
            <div class="flex justify-between text-[9px] font-bold"><span>${e}</span><span>${formatVal(raw)}</span></div>
            <div class="h-1.5 bg-white/5 rounded-full overflow-hidden">
              <div class="h-full wuxing-${e}" style="width:${Math.max(0, Math.min(100, width))}%"></div>
            </div>
          </div>`;
      });
    }

    // ===== fallback æ•˜äº‹ï¼ˆå¾Œç«¯é‚„æ²’ render/report æ™‚ä¹Ÿä¸æœƒç©ºç™½ï¼‰=====
    function buildFallbackNarrative({ dmElement, strategicWx, dominantSS, redMonths }) {
      const lines = [];
      lines.push(`ä½ å±¬æ–¼ã€Œ${dmElement}ã€ä¸»å ´çš„äººï¼Œåšäº‹é ç›´è¦ºèˆ‡ç¯€å¥ã€‚`);
      lines.push(`ä½ ä»Šå¹´çš„ä¸»è»¸åå‘ã€Œ${dominantSS || "æœªå®š"}ã€ï¼Œé—œéµåœ¨ï¼šå…ˆç«‹è¦å‰‡ï¼Œå†å‡ºæ‰‹ã€‚`);
      if (Array.isArray(redMonths) && redMonths.length) lines.push(`å£“åŠ›æœˆï¼š${redMonths.join("ã€")}ï¼ˆé€™äº›æœˆå…ˆå®ˆä½ï¼Œä¸è¦ç¡¬è¡ï¼‰ã€‚`);
      lines.push(`ç­–ç•¥ï¼šæŠŠè¡Œå‹•æ‹†å°ï¼ŒæŠŠäº¤ä»˜å¯«æˆæ¸…å–®ï¼ŒæŠŠç¯€å¥å›ºå®šã€‚`);
      return lines;
    }

    function launch() {
      document.getElementById('loading').style.display = 'flex';
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        calculate();
      }, 900);
    }
    const API_BASE = "https://17gonplay-api.billeetw.workers.dev";
    async function calculate() {
      const vy = parseInt(document.getElementById('birthYear').value, 10);
      const vm = parseInt(document.getElementById('birthMonth').value, 10);
      const vd = parseInt(document.getElementById('birthDay').value, 10);
      const vh = parseInt(document.getElementById('birthHour').value, 10);
      const vmin = parseInt(document.getElementById('birthMinute').value, 10);

      try {
        // 1) èµ·ç›¤ï¼šå¾Œç«¯
        const resp = await fetch(`${API_BASE}/compute/bazi`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ year: vy, month: vm, day: vd, hour: vh, minute: vmin })
        });

        if (!resp.ok) {
          const txt = await resp.text().catch(() => "");
          throw new Error(`API HTTP ${resp.status} ${txt || ""}`.trim());
        }

        const data = await resp.json();
        if (!data.ok) throw new Error(data.error || "API error");

        // 2) åˆ¤æ–·ï¼šjudge/mergeï¼ˆæœ‰å°±ç”¨ï¼Œæ²’æœ‰ä¹Ÿä¸æœƒæ­»ï¼‰
        let judge = null;
        try {
          const judgeResp = await fetch(`${API_BASE}/judge/merge`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });
          const j = await judgeResp.json().catch(() => null);
          if (j && j.ok) judge = j;
        } catch (_) {}

        // 3) æ•˜äº‹ï¼šrender/reportï¼ˆæœ‰å°±ç”¨ï¼›æ²’æœ‰å°± fallbackï¼‰
        let report = null;
        try {
          const reportResp = await fetch(`${API_BASE}/render/report`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ...data, judge })
          });
          const r = await reportResp.json().catch(() => null);
          if (r && r.ok) report = r;
        } catch (_) {}

        // ====== 4) æ¸²æŸ“å››æŸ± ======
        const bY = data.pillars.year;
        const bM = data.pillars.month;
        const bD = data.pillars.day;
        const bH = data.pillars.time;
        const dm = data.pillars.dm;

        document.getElementById('yG').innerText = bY[0]; document.getElementById('yZ').innerText = bY[1];
        document.getElementById('mG').innerText = bM[0]; document.getElementById('mZ').innerText = bM[1];
        document.getElementById('dG').innerText = bD[0]; document.getElementById('dZ').innerText = bD[1];
        document.getElementById('hG').innerText = bH[0]; document.getElementById('hZ').innerText = bH[1];

        const mSSZ = getSS(dm, bM[1]);
        document.getElementById('ySG').innerText = getSS(dm, bY[0]); document.getElementById('ySZ').innerText = getSS(dm, bY[1]);
        document.getElementById('mSG').innerText = getSS(dm, bM[0]); document.getElementById('mSZ').innerText = mSSZ;
        document.getElementById('hSG').innerText = getSS(dm, bH[0]); document.getElementById('hSZ').innerText = getSS(dm, bH[1]);

        // ====== 5) äº”è¡Œ barsï¼šåƒå¾Œç«¯ features ======
        const surface = data.features?.wuxing?.surface;
        const strategic = data.features?.wuxing?.strategic;
        const maxStrat = data.features?.wuxing?.maxStrategic || 1;

        if (surface && strategic) {
          renderBar('surfaceWx', surface, 4);
          renderBar('strategicWx', strategic, maxStrat);
        } else {
          throw new Error("features.wuxing missing");
        }

        // ====== 6) æµæœˆç‡ˆè™Ÿï¼šåƒå¾Œç«¯ bounds ======
        const bounds = data.features?.liuyue2026?.bounds;
        const mGrid = document.getElementById('monthGrid');
        mGrid.innerHTML = '';
        const redM = [];

        if (Array.isArray(bounds)) {
          bounds.forEach(b => {
            const isRed = b.light === "RED";
            if (isRed) redM.push(b.gz);
            mGrid.innerHTML += `
              <div class="glass p-5 rounded-2xl border-l-4 ${isRed ? 'border-red-500 bg-red-500/5' : 'border-emerald-500 bg-emerald-500/5'} flex justify-between items-center w-full">
                <div class="text-left">
                  <p class="font-black text-base">${b.gz}
                    <span class="text-[9px] font-normal text-slate-500 ml-1 uppercase">${b.range || ""}</span>
                  </p>
                  <p class="text-[10px] text-slate-400 mt-1 font-bold italic">æœ¬æ°£æˆ°ç•¥ï¼š${b.ssBranch || ""}</p>
                </div>
                <span class="text-[10px] font-bold px-3 py-1 rounded-lg bg-white/10 tracking-widest">${isRed ? 'ğŸ”´ å£“åŠ›' : 'ğŸŸ¢ ç©©é€²'}</span>
              </div>`;
          });
        }

        // ====== 7) strategy + analysisï¼šå„ªå…ˆç”¨å¾Œç«¯ reportï¼Œæ²’æœ‰å°± fallback ======
        if (report?.strategyHtml) {
          document.getElementById('strategyBox').innerHTML = report.strategyHtml;
        } else {
          document.getElementById('strategyBox').innerHTML = `<p>å¹´åº¦ä¸»è»¸ï¼š${mSSZ || "æœªå®š"}</p>`;
        }

        if (report?.html) {
          document.getElementById('analysisBox').innerHTML = report.html;
        } else {
          const dmElement = data.features?.dmElement || ELEMENTS[dm];
          const lines = buildFallbackNarrative({ dmElement, strategicWx: strategic, dominantSS: mSSZ, redMonths: redM });
          document.getElementById('analysisBox').innerHTML = `<div class="space-y-2">${lines.map(x => `<p>${x}</p>`).join("")}</div>`;
        }

        // ====== 8) Archetype ======
        const archetypes = {"å‚·å®˜":"å…§å®¹é©å‘½å®¶","é£Ÿç¥":"ç”Ÿæ´»ç”¢å“ç¶“ç†","æ­£è²¡":"ç²¾æº–åŸ·è¡Œè€…","åè²¡":"è³‡æºæ•´åˆå•†","æ­£å®˜":"ç§©åºå®ˆè­·è€…","ä¸ƒæ®º":"é‚Šéš›ç ´å±€è€…","æ­£å°":"æ™ºæ…§å°å¸«","åå°":"éˆé­‚å¥‡æ‰","æ¯”è‚©":"æ„å¿—å‹æ¨æ‰‹","åŠ«è²¡":"äººè„ˆé–‹æ‹“è€…"};
        document.getElementById('archetype').innerText = archetypes[mSSZ] || "å¹³è¡¡è§€å¯Ÿè€…";

        // âœ… shareText æ°¸é å®‰å…¨ï¼ˆä¸ä¾è³´ profileï¼‰
        window.shareText = report?.text
          || document.getElementById('analysisBox')?.innerText
          || "è«‹å…ˆç”Ÿæˆå ±å‘Šå†è¤‡è£½ã€‚";

        document.getElementById('report').classList.remove('hidden');
        document.getElementById('report').scrollIntoView({ behavior: 'smooth', block: 'start' });

      } catch (e) {
        console.error(e);
        alert("è¨ˆç®—å¤±æ•—ï¼š" + (e?.message || e));
      }
    }

    function initSelectors() {
      const y = document.getElementById('birthYear'), m = document.getElementById('birthMonth'), d = document.getElementById('birthDay'),
            h = document.getElementById('birthHour'), min = document.getElementById('birthMinute');

      for (let i = 2026; i >= 1940; i--) { const o = new Option(i + " å¹´", i); if (i === 1990) o.selected = true; y.add(o); }
      for (let i = 1; i <= 12; i++) m.add(new Option(i + " æœˆ", i));
      for (let i = 0; i <= 23; i++) { const o = new Option(String(i).padStart(2, '0') + " æ™‚", i); if (i === 12) o.selected = true; h.add(o); }
      ["00","15","30","45"].forEach(v => min.add(new Option(v + " åˆ†", v)));

      updateDays();

      let c = parseInt(localStorage.getItem('fCount'), 10) || 5001;
      function t() {
        c += Math.floor(Math.random() * 3) + 1;
        document.getElementById('userCounter').innerText = c.toLocaleString();
        localStorage.setItem('fCount', c);
        setTimeout(t, 5000);
      }
      t();
    }

    function updateDays() {
      const y = parseInt(document.getElementById('birthYear').value, 10);
      const m = parseInt(document.getElementById('birthMonth').value, 10);
      const d = document.getElementById('birthDay');
      const days = new Date(y, m, 0).getDate();
      const cur = d.value;
      d.innerHTML = '';
      for (let i = 1; i <= days; i++) {
        const o = new Option(i + " æ—¥", i);
        if (String(i) === String(cur) || (!cur && i === 1)) o.selected = true;
        d.add(o);
      }
    }

    async function copyText() {
      const text = window.shareText || "è«‹å…ˆç”Ÿæˆå ±å‘Šå†è¤‡è£½ã€‚";
      const t = document.getElementById("copyToast");
      try {
        await navigator.clipboard.writeText(text);
        t.classList.remove('opacity-0'); t.classList.add('opacity-100');
        setTimeout(() => { t.classList.add('opacity-0'); t.classList.remove('opacity-100'); }, 2500);
      } catch (e) {
        const el = document.createElement('textarea');
        el.value = text;
        document.body.appendChild(el);
        el.select();
        try { document.execCommand('copy'); } catch (_) {}
        document.body.removeChild(el);
        t.classList.remove('opacity-0'); t.classList.add('opacity-100');
        setTimeout(() => { t.classList.add('opacity-0'); t.classList.remove('opacity-100'); }, 2500);
      }
    }

    document.addEventListener('DOMContentLoaded', initSelectors);
  </script>
</body>
</html>














