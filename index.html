<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2026 æˆ°ç•¥å°èˆªï½œä¸€èµ·å‡ºä¾†ç©</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background:#0b0e14;
      color:#e2e8f0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    .glass {
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.08);
    }
    .bazi-char {
      font-size:1.8rem;
      font-weight:900;
      line-height:1.1;
    }
    .wuxing-æœ¨{background:#2ecc71}
    .wuxing-ç«{background:#e74c3c}
    .wuxing-åœŸ{background:#f1c40f}
    .wuxing-é‡‘{background:#ced4da}
    .wuxing-æ°´{background:#3498db}
  </style>
</head>

<body class="p-4">
  <h1 class="text-3xl font-black text-center mb-6">2026 æµå¹´æˆ°ç•¥å ±å‘Š</h1>

  <!-- è¼¸å…¥ -->
  <div class="glass p-6 rounded-xl max-w-xl mx-auto mb-10">
    <div class="grid grid-cols-3 gap-2 mb-3">
      <select id="birthYear" class="bg-black/40 p-2 rounded"></select>
      <select id="birthMonth" class="bg-black/40 p-2 rounded"></select>
      <select id="birthDay" class="bg-black/40 p-2 rounded"></select>
    </div>
    <div class="grid grid-cols-2 gap-2 mb-4">
      <select id="birthHour" class="bg-black/40 p-2 rounded"></select>
      <select id="birthMinute" class="bg-black/40 p-2 rounded"></select>
    </div>
    <button id="btnLaunch" class="w-full bg-amber-500 text-black py-3 rounded font-black">
      ç”Ÿæˆæˆ‘çš„ 2026 æˆ°ç•¥
    </button>

    <p id="hint" class="text-xs text-slate-400 mt-3 italic"></p>
  </div>

  <!-- å ±å‘Š -->
  <div id="report" class="hidden max-w-xl mx-auto space-y-10">

    <!-- å››æŸ± -->
    <div class="glass p-6 rounded-xl">
      <h2 class="font-black mb-3">å››æŸ±ï¼ˆé¡¯ç¤ºç”¨ï¼‰</h2>
      <div class="grid grid-cols-4 text-center">
        <div>
          <div id="yG" class="bazi-char"></div>
          <div id="yZ" class="text-sm text-slate-300"></div>
        </div>
        <div>
          <div id="mG" class="bazi-char"></div>
          <div id="mZ" class="text-sm text-slate-300"></div>
        </div>
        <div>
          <div id="dG" class="bazi-char text-amber-400"></div>
          <div id="dZ" class="text-sm text-slate-300"></div>
        </div>
        <div>
          <div id="hG" class="bazi-char"></div>
          <div id="hZ" class="text-sm text-slate-300"></div>
        </div>
      </div>
      <div id="meta" class="text-[11px] text-slate-500 mt-3"></div>
    </div>

    <!-- äº”è¡Œ -->
    <div class="glass p-6 rounded-xl">
      <h2 class="font-black mb-3">äº”è¡Œèƒ½é‡</h2>

      <div class="text-xs text-slate-400 mb-2">è¡¨å±¤ï¼ˆå¤©å¹²è¨ˆæ•¸ï¼‰</div>
      <div id="surfaceWx" class="space-y-2 mb-5"></div>

      <div class="text-xs text-slate-400 mb-2">å¯¦æˆ°ï¼ˆå¤©å¹²+è—å¹²+æœˆä»¤åŠ æ¬Šï¼‰</div>
      <div id="strategicWx" class="space-y-2"></div>
    </div>

    <!-- æµæœˆ -->
    <div class="glass p-6 rounded-xl">
      <h2 class="font-black mb-3">2026 æµæœˆç¯€å¥ï¼ˆ12ï¼‰</h2>
      <div id="monthGrid" class="space-y-2"></div>
    </div>

    <!-- åˆ†æ -->
    <div class="glass p-6 rounded-xl">
      <h2 class="font-black mb-3">æˆ°ç•¥è§£è®€ï¼ˆfallbackï¼‰</h2>
      <div id="analysisBox" class="space-y-2 text-sm text-slate-200"></div>
    </div>

  </div>

  <script>
    /* ========= åŸºæœ¬è¨­å®š ========= */
    const API_BASE = "https://17gonplay-api.billeetw.workers.dev";

    /* ========= å·¥å…·ï¼šäº”è¡Œæ¢ ========= */
    function renderBar(id, data, max) {
      const box = document.getElementById(id);
      if (!box) return;
      box.innerHTML = "";
      ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(e => {
        const v = Number(data?.[e] || 0);
        const w = max ? Math.max(2, (v / max) * 100) : 0;
        box.innerHTML += `
          <div class="mb-1">
            <div class="flex justify-between text-xs">
              <span>${e}</span>
              <span>${v.toFixed(1)}</span>
            </div>
            <div class="h-2 bg-white/10 rounded overflow-hidden">
              <div class="h-full wuxing-${e}" style="width:${w}%"></div>
            </div>
          </div>
        `;
      });
    }

    /* ========= ä¸»æµç¨‹ï¼šåªæ‰“ /compute/all ========= */
    async function calculate() {
      const vy   = parseInt(document.getElementById("birthYear")?.value, 10);
      const vm   = parseInt(document.getElementById("birthMonth")?.value, 10);
      const vd   = parseInt(document.getElementById("birthDay")?.value, 10);
      const vh   = parseInt(document.getElementById("birthHour")?.value, 10);
      const vmin = parseInt(document.getElementById("birthMinute")?.value, 10);

      try {
        if (![vy, vm, vd, vh, vmin].every(n => Number.isFinite(n))) {
          throw new Error("è«‹å…ˆé¸å¥½å‡ºç”Ÿå¹´æœˆæ—¥èˆ‡æ™‚é–“");
        }

        const hint = document.getElementById("hint");
        if (hint) {
          hint.textContent = "è¨ˆç®—ä¸­â€¦ï¼ˆå‘¼å« /compute/allï¼‰";
        }

        // âœ… åªæ‰“ /compute/allï¼Œæ‹¿ StrategicFeaturesV1 contract
        const resp = await fetch(`${API_BASE}/compute/all`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ year: vy, month: vm, day: vd, hour: vh, minute: vmin }),
        });

        if (!resp.ok) {
          const txt = await resp.text().catch(() => "");
          throw new Error(`API HTTP ${resp.status} ${txt || ""}`.trim());
        }

        const payload = await resp.json();
        if (!payload?.ok) throw new Error(payload?.error || "API error");

        // çµ¦ä½  console debug ç”¨
        window.__payload  = payload;
        window.__contract = payload.features;

        const contract = payload.features;
        if (!contract || contract.version !== "strategic_features_v1") {
          throw new Error("contract æ ¼å¼ä¸æ­£ç¢ºï¼ˆfeatures.version != strategic_features_v1ï¼‰");
        }

        const bazi = contract.bazi;
        if (!bazi) throw new Error("contract.bazi ä¸å­˜åœ¨ï¼ˆPhase 0 ä¸€å®šè¦æœ‰ï¼‰");

        /* === 1) å››æŸ±ï¼šç›´æ¥åƒ contract.bazi.display / pillars === */
        const disp = bazi.display || {};
        document.getElementById("yG").innerText = disp.yG || "";
        document.getElementById("yZ").innerText = disp.yZ || "";
        document.getElementById("mG").innerText = disp.mG || "";
        document.getElementById("mZ").innerText = disp.mZ || "";
        document.getElementById("dG").innerText = disp.dG || "";
        document.getElementById("dZ").innerText = disp.dZ || "";
        document.getElementById("hG").innerText = disp.hG || "";
        document.getElementById("hZ").innerText = disp.hZ || "";

        const meta = document.getElementById("meta");
        if (meta && bazi.pillars) {
          meta.textContent = `å¹´æŸ±ï¼š${bazi.pillars.year}ã€€æœˆæŸ±ï¼š${bazi.pillars.month}ã€€æ—¥æŸ±ï¼š${bazi.pillars.day}ã€€æ™‚æŸ±ï¼š${bazi.pillars.time}`;
        }

        /* === 2) äº”è¡Œï¼šå®Œå…¨åƒ contract.bazi.wuxing === */
        if (!bazi.wuxing?.surface || !bazi.wuxing?.strategic) {
          throw new Error("bazi.wuxing ç¼ºè³‡æ–™");
        }
        renderBar("surfaceWx",   bazi.wuxing.surface,   4);
        renderBar("strategicWx", bazi.wuxing.strategic, bazi.wuxing.maxStrategic || 1);

        /* === 3) 2026 æµæœˆï¼šåƒ contract.bazi.liuyue2026.bounds === */
        const bounds = bazi.liuyue2026?.bounds || [];
        const mGrid  = document.getElementById("monthGrid");
        mGrid.innerHTML = "";

        const redMonths = [];

        if (bounds.length) {
          bounds.forEach(b => {
            const isRed = b.light === "RED";
            if (isRed) redMonths.push(b.gz);

            mGrid.innerHTML += `
              <div class="p-3 rounded border-l-4 ${isRed ? "border-red-500 bg-red-500/10" : "border-emerald-500 bg-emerald-500/10"}">
                <div class="font-bold">
                  ${b.gz}
                  <span class="text-xs text-slate-400 ml-1">${b.range || ""}</span>
                </div>
                <div class="text-xs text-slate-300 mt-1">
                  ${isRed ? "ğŸ”´ å£“åŠ›" : "ğŸŸ¢ ç©©é€²"} ï½œ æœ¬æ°£ï¼š${b.ssBranch || ""}
                </div>
              </div>
            `;
          });
        } else {
          mGrid.innerHTML = `<div class="text-xs text-slate-400 italic">ï¼ˆæš«ç„¡æµæœˆè³‡æ–™ï¼‰</div>`;
        }

        /* === 4) æˆ°ç•¥è§£è®€ fallbackï¼ˆä¸ç”¨ render/report ä¹Ÿä¸æœƒç©ºç™½ï¼‰ === */
        const analysisBox = document.getElementById("analysisBox");
        const dominant  = (bazi.tenGod?.dominant || "").trim() || "æœªå®š";
        const dmElement = bazi.dmElement || "ç«";

        const redText = redMonths.length
          ? `å£“åŠ›æœˆï¼š${redMonths.join("ã€")}ï¼ˆé€™äº›æœˆå…ˆå®ˆè¦å‰‡ï¼Œä¸è¦ç¡¬è¡ï¼‰ã€‚`
          : "ä»Šå¹´å£“åŠ›æœˆåå°‘ï¼Œå¯ä»¥ç©©ç©©æ¨é€²ã€‚";

        analysisBox.innerHTML = `
          <p>ä½ çš„æ—¥ä¸»äº”è¡Œä¸»å ´æ˜¯ã€Œ${dmElement}ã€ï¼Œ2026 å¹´çš„ä¸»è»¸èªè¨€åå‘ã€Œ${dominant}ã€ã€‚</p>
          <p>${redText}</p>
          <p>ç­–ç•¥ï¼šæŠŠåŒæ™‚é€²è¡Œçš„æˆ°ç·šè®Šå°‘ï¼ŒæŠŠæµç¨‹å¯«æˆæ¸…å–®ï¼Œå£“åŠ›æœˆå„ªå…ˆå®ˆä½æ—¢æœ‰ç›¤é¢ï¼Œéå£“åŠ›æœˆå†æ¨é€²æ–°å°ˆæ¡ˆã€‚</p>
          <p class="text-[11px] text-slate-400 mt-2">
            ï¼ˆç›®å‰æ˜¯ contract fallback ç‰ˆæœ¬ï¼Œä¹‹å¾Œä½ è¦å†æ¥ /render/reportï¼Œæˆ‘å€‘å¯ä»¥æŠŠé€™æ®µæ›æˆå®Œæ•´ AI æ•˜äº‹ï¼‰
          </p>
        `;

        if (hint) {
          hint.textContent = `å·²å®Œæˆè¨ˆç®—ï¼ˆå£“åŠ›æœˆï¼š${redMonths.length} / 12ï¼‰`;
        }

        // é¡¯ç¤ºå ±å‘Š
        document.getElementById("report").classList.remove("hidden");
        document.getElementById("report").scrollIntoView({ behavior:"smooth", block:"start" });
      } catch (e) {
        console.error(e);
        alert("è¨ˆç®—å¤±æ•—ï¼š" + (e?.message || e));
        const hint = document.getElementById("hint");
        if (hint) hint.textContent = "ç™¼ç”ŸéŒ¯èª¤ï¼Œå¯æŒ‰ F12 æŸ¥çœ‹ console è©³ç´°è¨Šæ¯ã€‚";
      }
    }

    /* ========= UIï¼šæ—¥æœŸé¸å–® ========= */
    function updateDays() {
      const y = document.getElementById("birthYear");
      const m = document.getElementById("birthMonth");
      const d = document.getElementById("birthDay");
      if (!y || !m || !d) return;

      const year  = parseInt(y.value, 10);
      const month = parseInt(m.value, 10);
      if (!Number.isFinite(year) || !Number.isFinite(month)) return;

      const current = d.value;
      d.innerHTML = "";
      const days = new Date(year, month, 0).getDate();
      for (let i = 1; i <= days; i++) {
        const opt = new Option(i + " æ—¥", i);
        if (String(i) === String(current) || (!current && i === 1)) opt.selected = true;
        d.add(opt);
      }
    }

    function initSelectors() {
      const y   = document.getElementById("birthYear");
      const m   = document.getElementById("birthMonth");
      const d   = document.getElementById("birthDay");
      const h   = document.getElementById("birthHour");
      const min = document.getElementById("birthMinute");
      const btn = document.getElementById("btnLaunch");
      if (!y || !m || !d || !h || !min || !btn) return;

      // å¹´ä»½ï¼š2026 -> 1940
      for (let i = 2026; i >= 1940; i--) {
        y.add(new Option(i + " å¹´", i));
      }
      // æœˆ
      for (let i = 1; i <= 12; i++) {
        m.add(new Option(i + " æœˆ", i));
      }
      // æ™‚
      for (let i = 0; i < 24; i++) {
        const label = String(i).padStart(2,"0") + " æ™‚";
        h.add(new Option(label, i));
      }
      // åˆ†
      ["00","15","30","45"].forEach(v => {
        min.add(new Option(v + " åˆ†", v));
      });

      // é è¨­å€¼
      y.value   = "1990";
      m.value   = "1";
      h.value   = "12";
      min.value = "00";
      updateDays();

      // äº‹ä»¶ç¶å®š
      m.addEventListener("change", updateDays);
      y.addEventListener("change", updateDays);
      btn.addEventListener("click", () => { calculate(); });
    }

    document.addEventListener("DOMContentLoaded", initSelectors);
  </script>
</body>
</html>
















