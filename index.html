<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2026 æˆ°ç•¥å°èˆªï½œä¸€èµ·å‡ºä¾†ç©</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background:#050814;
      color:#e2e8f0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Noto Sans TC",sans-serif;
    }
    .glass {
      background: rgba(15,23,42,0.85);
      backdrop-filter: blur(14px);
      border:1px solid rgba(148,163,184,0.35);
    }
    .bazi-char {
      font-size:1.8rem;
      font-weight:900;
      line-height:1.1;
    }
    .wuxing-æœ¨ { background:#22c55e; }
    .wuxing-ç« { background:#ef4444; }
    .wuxing-åœŸ { background:#eab308; }
    .wuxing-é‡‘ { background:#e5e7eb; }
    .wuxing-æ°´ { background:#3b82f6; }
    .wuxing-æœ¨,.wuxing-ç«,.wuxing-åœŸ,.wuxing-é‡‘,.wuxing-æ°´{
      box-shadow:0 0 16px rgba(248,250,252,0.28);
    }

    /* ç´«å¾®åœ“ç›¤ */
    .zw-ring {
      position:relative;
      width:100%;
      max-width:480px;
      aspect-ratio:1/1;
      margin:0 auto;
    }
    .zw-palace {
      position:absolute;
      width:22%;
      height:22%;
      border-radius:1rem;
      border:1px solid rgba(148,163,184,0.6);
      background:radial-gradient(circle at top,#020617,#020617 40%,#020617);
      padding:0.35rem 0.4rem;
      font-size:0.65rem;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      transition:all .25s ease;
      overflow:hidden;
    }
    .zw-palace-key {
      border-color:rgba(250,204,21,0.95);
      box-shadow:0 0 24px rgba(250,204,21,0.4);
      background:radial-gradient(circle at top,#1c1917,#020617 55%);
    }
    .zw-palace:hover {
      transform:translate(-50%,-50%) scale(1.05);
      border-color:rgba(248,250,252,0.9);
      z-index:20;
    }
    .zw-center {
      position:absolute;
      inset:25%;
      border-radius:999px;
      border:1px dashed rgba(148,163,184,0.6);
      background:radial-gradient(circle at top,#020617,#020617 60%,#020617);
      padding:0.9rem;
      display:flex;
      flex-direction:column;
      justify-content:center;
      text-align:center;
      font-size:0.75rem;
    }
    .zw-dot {
      position:absolute;
      inset:8%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.25);
      pointer-events:none;
    }

    html {
      scroll-behavior:smooth;
    }
  </style>
</head>

<body class="min-h-screen">

  <!-- top nav -->
  <header class="sticky top-0 z-40 bg-gradient-to-r from-slate-950/95 via-slate-900/95 to-slate-950/95 border-b border-slate-800/80 backdrop-blur">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-amber-400 text-slate-950 font-black text-xs">ç©</span>
        <div class="text-xs leading-tight">
          <div class="font-bold tracking-[0.22em] text-slate-300 uppercase">2026 Strategic Map</div>
          <div class="text-[11px] text-slate-500">è·Ÿæä¼¯å½¥ä¸€èµ·å‡ºä¾†ç©</div>
        </div>
      </div>
      <nav class="hidden md:flex items-center gap-4 text-xs text-slate-300">
        <a href="#sec-bazi" class="hover:text-amber-400">å…«å­—æµå¹´</a>
        <a href="#sec-ziwei" class="hover:text-amber-400">ç´«å¾®èˆªåœ–</a>
        <a href="#sec-liuyue" class="hover:text-amber-400">2026 æµæœˆ</a>
        <a href="#sec-analysis" class="hover:text-amber-400">æˆ°ç•¥è§£è®€</a>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 pb-24 space-y-8">

    <!-- title & intro -->
    <section class="space-y-3">
      <p class="text-[11px] tracking-[0.35em] uppercase text-slate-500 font-bold">2026 æˆ°ç•¥å°èˆª</p>
      <h1 class="text-3xl md:text-4xl font-black tracking-tight">
        æ˜“ç¶“å››æŸ± Ã— ç´«å¾®æ–—æ•¸<br class="md:hidden" />
        <span class="text-amber-300">é›™å¼•æ“äººç”Ÿæˆ°ç•¥åœ–</span>
      </h1>
      <p class="text-sm text-slate-400 max-w-2xl">
        è¼¸å…¥ä½ çš„å‡ºç”Ÿè³‡è¨Šï¼Œæˆ‘æœƒå…ˆç”¨å…«å­—ç®—å‡º 2026 äº”è¡Œèˆ‡æµæœˆç¯€å¥ï¼Œå†ç”¨ç´«å¾®æŠŠ 12 å®®äººç”Ÿç›¤å±•é–‹ï¼Œ
        åšæˆä¸€å¼µå¯ä»¥ç›´æ¥æ‹¿å»è¦åŠƒä¸€å¹´çš„ã€Œè¡Œå‹•è—åœ–ã€ã€‚
      </p>
    </section>

    <!-- input -->
    <section class="glass rounded-3xl p-6 md:p-7 space-y-4">
      <h2 class="text-sm font-bold text-slate-200 mb-1">1. è¼¸å…¥ä½ çš„å‡ºç”Ÿè³‡è¨Š</h2>
      <div class="grid grid-cols-3 gap-2 text-sm">
        <select id="birthYear" class="bg-slate-950/70 border border-slate-700 rounded-2xl px-3 py-2.5"></select>
        <select id="birthMonth" class="bg-slate-950/70 border border-slate-700 rounded-2xl px-3 py-2.5"></select>
        <select id="birthDay" class="bg-slate-950/70 border border-slate-700 rounded-2xl px-3 py-2.5"></select>
      </div>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <select id="birthHour" class="bg-slate-950/70 border border-slate-700 rounded-2xl px-3 py-2.5"></select>
        <select id="birthMinute" class="bg-slate-950/70 border border-slate-700 rounded-2xl px-3 py-2.5"></select>
      </div>
      <button id="btnLaunch" class="mt-2 w-full bg-gradient-to-r from-amber-400 to-yellow-500 text-slate-950 font-black py-3.5 rounded-2xl text-sm tracking-[0.25em] uppercase">
        ç”Ÿæˆæˆ‘çš„ 2026 æˆ°ç•¥
      </button>
      <p id="hint" class="text-[11px] text-slate-500 mt-2 italic"></p>
    </section>

    <!-- report -->
    <section id="report" class="space-y-10 hidden">

      <!-- BAZI -->
      <section id="sec-bazi" class="space-y-4">
        <h2 class="text-xs font-bold tracking-[0.3em] text-slate-400 uppercase">2. å…«å­—æµå¹´åº§æ¨™</h2>

        <!-- å››æŸ± -->
        <div class="glass rounded-3xl p-5 md:p-6">
          <div class="grid grid-cols-4 gap-2 text-center">
            <div class="space-y-1">
              <div class="text-[10px] text-slate-500 tracking-[0.3em] uppercase">å¹´</div>
              <div id="yG" class="bazi-char"></div>
              <div id="yZ" class="text-sm text-slate-300"></div>
            </div>
            <div class="space-y-1">
              <div class="text-[10px] text-slate-500 tracking-[0.3em] uppercase">æœˆ</div>
              <div id="mG" class="bazi-char"></div>
              <div id="mZ" class="text-sm text-slate-300"></div>
            </div>
            <div class="space-y-1">
              <div class="text-[10px] text-amber-400 tracking-[0.3em] uppercase">æ—¥</div>
              <div id="dG" class="bazi-char text-amber-300"></div>
              <div id="dZ" class="text-sm text-amber-200"></div>
            </div>
            <div class="space-y-1">
              <div class="text-[10px] text-slate-500 tracking-[0.3em] uppercase">æ™‚</div>
              <div id="hG" class="bazi-char"></div>
              <div id="hZ" class="text-sm text-slate-300"></div>
            </div>
          </div>
          <div id="meta" class="text-[11px] text-slate-500 mt-3"></div>
        </div>

        <!-- äº”è¡Œ -->
        <div class="glass rounded-3xl p-5 md:p-6">
          <div class="flex flex-col md:flex-row gap-6">
            <div class="flex-1">
              <div class="text-[11px] text-slate-400 mb-2 uppercase tracking-[0.25em]">è¡¨å±¤äº”è¡Œï¼ˆå¤©å¹²ï¼‰</div>
              <div id="surfaceWx" class="space-y-2"></div>
            </div>
            <div class="flex-1">
              <div class="text-[11px] text-slate-400 mb-2 uppercase tracking-[0.25em]">å¯¦æˆ°äº”è¡Œï¼ˆå¤©å¹²ï¼‹è—å¹²ï¼‹æœˆä»¤ï¼‰</div>
              <div id="strategicWx" class="space-y-2"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ZIWEI 12 å®® åœ“ç›¤ -->
      <section id="sec-ziwei" class="space-y-4">
        <h2 class="text-xs font-bold tracking-[0.3em] text-slate-400 uppercase">3. ç´«å¾® 12 å®®èˆªåœ–</h2>

        <div class="glass rounded-3xl p-5 md:p-6 flex flex-col md:flex-row gap-6 items-stretch">
          <div class="flex-1">
            <div id="ziweiRing" class="zw-ring"></div>
          </div>
          <div class="w-full md:w-64 space-y-4 text-sm">
            <div class="border border-slate-700/80 rounded-2xl p-3.5 bg-slate-950/70">
              <div class="text-[11px] text-slate-400 tracking-[0.28em] uppercase mb-1.5">ç´«å¾®æ ¸å¿ƒè¨­å®š</div>
              <div id="ziweiCore" class="space-y-1"></div>
            </div>
            <div class="border border-slate-700/80 rounded-2xl p-3.5 bg-slate-950/70">
              <div class="text-[11px] text-slate-400 tracking-[0.28em] uppercase mb-1.5">è¡Œç‚ºå‚¾å‘é›·é”</div>
              <div id="ziweiTend" class="space-y-1"></div>
            </div>
            <div class="border border-slate-700/80 rounded-2xl p-3.5 bg-slate-950/70">
              <div class="text-[11px] text-slate-400 tracking-[0.28em] uppercase mb-1.5">é—œéµå®®ä½ä¸»æ˜Ÿ</div>
              <div id="ziweiStars" class="space-y-1"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- æµæœˆ -->
      <section id="sec-liuyue" class="space-y-4">
        <h2 class="text-xs font-bold tracking-[0.3em] text-slate-400 uppercase">4. 2026 ç¯€æ°£æµæœˆç¯€å¥</h2>
        <div class="glass rounded-3xl p-5 md:p-6">
          <div id="monthGrid" class="space-y-2"></div>
          <p class="mt-3 text-[11px] text-slate-500">
            â€» æ¡ç¯€æ°£æœˆå€é–“ï¼ˆç´„æ¯æœˆ 4 è™Ÿåˆ‡æ›ï¼‰ï¼Œç´…ç‡ˆæœˆå…ˆå®ˆä½ï¼Œå†è«‡çªç ´ã€‚
          </p>
        </div>
      </section>

      <!-- æˆ°ç•¥è§£è®€ -->
      <section id="sec-analysis" class="space-y-4">
        <h2 class="text-xs font-bold tracking-[0.3em] text-slate-400 uppercase">5. 2026 æˆ°ç•¥è§£è®€</h2>
        <div class="glass rounded-3xl p-5 md:p-6">
          <div id="analysisBox" class="space-y-2 text-sm text-slate-200"></div>
        </div>
      </section>

      <!-- è«®è©¢ CTA -->
      <section class="glass rounded-3xl p-6 md:p-7 border border-amber-400/40 bg-gradient-to-br from-amber-500/10 via-slate-950 to-slate-950">
        <h3 class="text-lg md:text-xl font-black mb-3 text-amber-300">
          å¦‚æœä½ æƒ³æŠŠé€™å¼µæˆ°ç•¥åœ–ï¼Œåšæˆã€Œå¯ä»¥ä¿ç”¨ä¸€ç”Ÿã€çš„èªªæ˜æ›¸â€¦
        </h3>
        <p class="text-sm text-slate-200 mb-4 leading-relaxed">
          å¦‚æœä½ å¸Œæœ›æˆ‘æŠŠä½ çš„å‘½æ ¼çµ„æˆã€äººç”Ÿå¤§é‹ã€æµå¹´æµæœˆã€ç”Ÿæ¶¯è¦åŠƒå’Œæœ€é©åˆè‡ªå·±çš„äººç”Ÿç¯€å¥ï¼Œ
          åšæˆå¯ä¿ç”¨ä¸€ç”Ÿçš„ 50 é äººç”Ÿä½¿ç”¨èªªæ˜æ›¸ï¼Œæ­¡è¿é ç´„ç·šä¸Šè«®è©¢ã€‚
        </p>
        <a href="https://forms.gle/UVCSq1udEC549gzYA" target="_blank"
           class="inline-flex items-center justify-center px-5 py-3 rounded-2xl bg-amber-400 text-slate-950 text-sm font-black tracking-[0.2em] uppercase shadow-lg hover:brightness-110">
          é ç´„èˆ‡æä¼¯å½¥è€å¸«è«®è©¢
        </a>
      </section>

    </section>
  </main>

<script>
const API_BASE = "https://17gonplay-api.billeetw.workers.dev";

/* ========= äº”è¡Œ bar ========= */
function renderBar(id, data, max) {
  const box = document.getElementById(id);
  if (!box) return;
  box.innerHTML = "";
  ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(e => {
    const v = Number(data?.[e] || 0);
    const w = max ? Math.max(2, (v / max) * 100) : 0;
    box.innerHTML += `
      <div class="mb-1">
        <div class="flex justify-between text-[11px] text-slate-300">
          <span>${e}</span>
          <span>${v.toFixed(1)}</span>
        </div>
        <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
          <div class="h-full wuxing-${e}" style="width:${w}%"></div>
        </div>
      </div>
    `;
  });
}

/* ========= ç´«å¾®åœ“ç›¤ ========= */
const PALACE_ORDER = [
  "å‘½å®®","å…„å¼Ÿ","å¤«å¦»","å­å¥³","è²¡å¸›","ç–¾å„",
  "é·ç§»","åƒ•å½¹","å®˜ç¥¿","ç”°å®…","ç¦å¾·","çˆ¶æ¯"
];

function renderZiwei(ziwei) {
  const ring = document.getElementById("ziweiRing");
  const coreBox = document.getElementById("ziweiCore");
  const tendBox = document.getElementById("ziweiTend");
  const starBox = document.getElementById("ziweiStars");
  if (!ring || !ziwei) {
    if (ring) ring.innerHTML = `<div class="w-full h-full flex items-center justify-center text-xs text-slate-500">ï¼ˆå°šæœªå–å¾—ç´«å¾®è³‡æ–™ï¼‰</div>`;
    return;
  }

  ring.innerHTML = "";
  const starsMap = {
    "å‘½å®®": ziwei.mainStars?.minggong || [],
    "å®˜ç¥¿": ziwei.mainStars?.career || [],
    "è²¡å¸›": ziwei.mainStars?.wealth || [],
  };

  PALACE_ORDER.forEach((name, idx) => {
    const angleDeg = -90 + idx * 30; // å¾ä¸Šæ–¹é–‹å§‹ï¼Œé †æ™‚é‡
    const rad = angleDeg * Math.PI / 180;
    const radius = 40; // ç™¾åˆ†æ¯”
    const cx = 50, cy = 50;
    const x = cx + radius * Math.cos(rad);
    const y = cy + radius * Math.sin(rad);

    const list = starsMap[name] || [];
    const isKey = list.length > 0 || name === "å‘½å®®";

    const starsHtml = list.length
      ? `<div class="mt-0.5 text-[10px] text-amber-200 leading-snug">${list.join("ã€")}</div>`
      : `<div class="mt-0.5 text-[10px] text-slate-500/80">ï¼ˆæš«ç„¡ä¸»æ˜Ÿï¼‰</div>`;

    ring.innerHTML += `
      <div class="zw-palace ${isKey ? "zw-palace-key" : ""}"
           style="top:${y}%;left:${x}%;transform:translate(-50%,-50%);">
        <div class="flex items-center justify-between">
          <span class="text-[9px] tracking-[0.25em] text-slate-400 uppercase">${name}</span>
          ${isKey ? `<span class="text-[9px] px-1.5 py-0.5 rounded-full bg-amber-400/20 text-amber-200">Key</span>` : ""}
        </div>
        ${starsHtml}
      </div>
    `;
  });

  // ä¸­å¿ƒåœˆ
  const riskMap = {
    high: "é¢¨éšªåé«˜ï¼šé©åˆå‰µæ¥­ï¼è½‰å‹ï¼Œä½†è¦ç•™æ„é«”åŠ›èˆ‡é‚Šç•Œã€‚",
    mid:  "é¢¨éšªä¸­åº¦ï¼šå¯åœ¨ç©©å®šä¸­è¨­è¨ˆå°å¯¦é©—ï¼Œé‚Šèµ°é‚Šæ ¡æ­£ã€‚",
    low:  "é¢¨éšªåä½ï¼šé©åˆé•·ç·šç¶“ç‡Ÿã€ç©©ç´®ç©©æ‰“çš„å¸ƒå±€ã€‚",
  };
  const authMap = {
    strong: "æ¬Šå¨æ„Ÿå¼·ï¼šé©åˆå¸¶é ˜åœ˜éšŠèˆ‡è¨­è¨ˆåˆ¶åº¦ã€‚",
    mid:    "æ¬Šå¨æ„Ÿä¸­ï¼šç”¨å°ˆæ¥­èªªè©±ï¼Œæ¯”è·ç¨±æ›´æœ‰åŠ›ã€‚",
    weak:   "æ¬Šå¨æ„ŸæŸ”ï¼šèµ°é™ªä¼´å‹ï¼é¡§å•å‹è·¯ç·šæ›´é †æ‰‹ã€‚",
  };
  const mobMap = {
    high: "æ´»å‹•åŠ›é«˜ï¼šå¤šåŸå¸‚ã€å¤šå ´æ™¯åˆ‡æ›éƒ½æ’å¾—ä½ã€‚",
    mid:  "æ´»å‹•åŠ›ä¸­ï¼šå®‰æ’ç¯€å¥åˆ†æ˜çš„ç§»å‹•æœ€èˆ’æœã€‚",
    low:  "æ´»å‹•åŠ›ä½ï¼šå›ºå®šæ“šé»ã€æ·±è€•ä¸€åœ°æ›´æœ‰å„ªå‹¢ã€‚",
  };

  ring.innerHTML += `
    <div class="zw-dot"></div>
    <div class="zw-center">
      <div class="text-[11px] tracking-[0.28em] text-slate-400 uppercase mb-1">Zi Wei Core</div>
      <div class="text-sm text-amber-200 font-semibold mb-1">
        å‘½å®®ï¼š${ziwei.core?.minggong || "â€”"}
      </div>
      <div class="text-[11px] text-slate-400">
        èº«å®®ï¼š${ziwei.core?.shengong || "â€”"}ï½œäº”è¡Œå±€ï¼š${ziwei.core?.wuxingju || "â€”"}
      </div>
    </div>
  `;

  // å³å´æ–‡å­—å€
  if (coreBox) {
    coreBox.innerHTML = `
      <p>å‘½å®®ï¼š<span class="text-amber-200 font-semibold">${ziwei.core?.minggong || "â€”"}</span></p>
      <p>èº«å®®ï¼š${ziwei.core?.shengong || "â€”"}</p>
      <p>äº”è¡Œå±€ï¼š${ziwei.core?.wuxingju || "â€”"}</p>
    `;
  }
  if (tendBox) {
    const t = ziwei.tendencies || {};
    tendBox.innerHTML = `
      <p>é¢¨éšªå‚¾å‘ï¼š<span class="text-amber-200">${t.risk || "â€”"}</span></p>
      <p class="text-[11px] text-slate-400 mb-1">${riskMap[t.risk] || ""}</p>
      <p>æ¬Šå¨æ„Ÿï¼š<span class="text-amber-200">${t.authority || "â€”"}</span></p>
      <p class="text-[11px] text-slate-400 mb-1">${authMap[t.authority] || ""}</p>
      <p>ç§»å‹•åŠ›ï¼š<span class="text-amber-200">${t.mobility || "â€”"}</span></p>
      <p class="text-[11px] text-slate-400">${mobMap[t.mobility] || ""}</p>
    `;
  }
  if (starBox) {
    starBox.innerHTML = `
      <p>å‘½å®®ä¸»æ˜Ÿï¼š${(ziwei.mainStars?.minggong || []).join("ã€") || "â€”"}</p>
      <p>äº‹æ¥­å®®ä¸»æ˜Ÿï¼š${(ziwei.mainStars?.career || []).join("ã€") || "â€”"}</p>
      <p>è²¡å¸›å®®ä¸»æ˜Ÿï¼š${(ziwei.mainStars?.wealth || []).join("ã€") || "â€”"}</p>
    `;
  }
}

/* ========= ä¸»æµç¨‹ï¼šæ‰“ /compute/all ========= */
async function calculate() {
  const vy   = parseInt(document.getElementById("birthYear")?.value, 10);
  const vm   = parseInt(document.getElementById("birthMonth")?.value, 10);
  const vd   = parseInt(document.getElementById("birthDay")?.value, 10);
  const vh   = parseInt(document.getElementById("birthHour")?.value, 10);
  const vmin = parseInt(document.getElementById("birthMinute")?.value, 10);

  try {
    if (![vy, vm, vd, vh, vmin].every(n => Number.isFinite(n))) {
      throw new Error("è«‹å…ˆé¸å¥½å‡ºç”Ÿå¹´æœˆæ—¥èˆ‡æ™‚é–“");
    }

    document.getElementById("hint").innerText = "è¨ˆç®—ä¸­ï¼Œå¤§ç´„ 1 ç§’â€¦";

    const resp = await fetch(`${API_BASE}/compute/all`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ year: vy, month: vm, day: vd, hour: vh, minute: vmin }),
    });

    if (!resp.ok) {
      const txt = await resp.text().catch(() => "");
      throw new Error(`API HTTP ${resp.status} ${txt || ""}`.trim());
    }

    const payload = await resp.json();
    if (!payload?.ok) throw new Error(payload?.error || "API error");

    // debug ç”¨
    window.__payload = payload;
    const contract = payload.features;
    window.__contract = contract;

    if (!contract || contract.version !== "strategic_features_v1") {
      throw new Error("features.version != strategic_features_v1");
    }

    const bazi = contract.bazi;
    const ziwei = contract.ziwei;

    if (!bazi) throw new Error("contract.bazi ä¸å­˜åœ¨");

    // å››æŸ±
    const disp = bazi.display || {};
    document.getElementById("yG").innerText = disp.yG || "";
    document.getElementById("yZ").innerText = disp.yZ || "";
    document.getElementById("mG").innerText = disp.mG || "";
    document.getElementById("mZ").innerText = disp.mZ || "";
    document.getElementById("dG").innerText = disp.dG || "";
    document.getElementById("dZ").innerText = disp.dZ || "";
    document.getElementById("hG").innerText = disp.hG || "";
    document.getElementById("hZ").innerText = disp.hZ || "";
    document.getElementById("meta").innerText =
      `Solar: ${payload.meta?.solarText || ""}ï½œLunar: ${payload.meta?.lunarText || ""}`;

    // äº”è¡Œ
    renderBar("surfaceWx",   bazi.wuxing?.surface,   4);
    renderBar("strategicWx", bazi.wuxing?.strategic, bazi.wuxing?.maxStrategic || 1);

    // æµæœˆ
    const bounds = bazi.liuyue2026?.bounds || [];
    const mGrid  = document.getElementById("monthGrid");
    const redMonths = [];
    mGrid.innerHTML = "";
    if (bounds.length) {
      bounds.forEach((b) => {
        const isRed = b.light === "RED";
        if (isRed) redMonths.push(b.gz);
        mGrid.innerHTML += `
          <div class="flex items-center justify-between p-3 rounded-2xl bg-slate-950/70 border-l-4 ${isRed ? "border-red-500" : "border-emerald-500"}">
            <div>
              <div class="font-semibold text-sm">
                ${b.gz}
                <span class="ml-1 text-[11px] text-slate-400">${b.range || ""}</span>
              </div>
              <div class="text-[11px] text-slate-400 mt-0.5">æœ¬æ°£ï¼š${b.ssBranch || "â€”"}</div>
            </div>
            <span class="text-[11px] px-2.5 py-1 rounded-full bg-white/5">
              ${isRed ? "ğŸ”´ å£“åŠ›" : "ğŸŸ¢ ç©©é€²"}
            </span>
          </div>
        `;
      });
    } else {
      mGrid.innerHTML = `<div class="text-xs text-slate-400 italic">ï¼ˆæš«ç„¡æµæœˆè³‡æ–™ï¼‰</div>`;
    }

    // ç´«å¾®åœ“ç›¤
    renderZiwei(ziwei);

    // æˆ°ç•¥è§£è®€ï¼ˆç°¡å–® fallbackï¼‰
    const analysisBox = document.getElementById("analysisBox");
    const dominant = (bazi.tenGod?.dominant || "").trim() || "æœªå®š";
    const dmElement = bazi.dmElement || "ç«";

    const redText = redMonths.length
      ? `å£“åŠ›æœˆï¼š${redMonths.join("ã€")}ï¼ˆé€™äº›æœˆå…ˆå®ˆè¦å‰‡ï¼Œä¸è¦ç¡¬è¡ï¼‰ã€‚`
      : "ä»Šå¹´å£“åŠ›æœˆåå°‘ï¼Œå¯ä»¥ç©©ç©©æ¨é€²ã€‚";

    analysisBox.innerHTML = `
      <p>ä½ çš„æ—¥ä¸»äº”è¡Œä¸»å ´æ˜¯ã€Œ${dmElement}ã€ï¼Œ2026 å¹´åº¦ä¸»è»¸åå‘ã€Œ${dominant}ã€ã€‚</p>
      <p>${redText}</p>
      <p>ç´«å¾®ç›¤æœƒå‘Šè¨´ä½ ï¼šå“ªå¹¾å€‹å®®ä½æ˜¯ä»Šå¹´çœŸæ­£è¦ã€Œä¸Šå ´ã€çš„èˆå°ï¼›
         å…«å­—å‰‡è² è²¬å®šç¾©ç¯€å¥èˆ‡å£“åŠ›é»ã€‚</p>
      <p>æŠŠé€™å…©å€‹ç³»çµ±ç–Šèµ·ä¾†ï¼Œä½ å°±èƒ½åœ¨å°çš„å®®ä½ã€å°çš„æœˆä»½ï¼Œç”¨å°çš„å¼·åº¦å‡ºæ‰‹ã€‚</p>
      <p class="text-[11px] text-slate-500 mt-2">
        ï¼ˆä¹‹å¾Œå¯ä»¥å†æ¥ /render/reportï¼ŒæŠŠé€™æ®µæ›æˆå®Œæ•´ AI æ•˜äº‹ç‰ˆï¼‰
      </p>
    `;

    // é¡¯ç¤ºå ±å‘Š
    document.getElementById("report").classList.remove("hidden");
    document.getElementById("hint").innerText = "";
    document.getElementById("sec-bazi").scrollIntoView({ behavior:"smooth", block:"start" });

  } catch (e) {
    console.error(e);
    document.getElementById("hint").innerText = "";
    alert("è¨ˆç®—å¤±æ•—ï¼š" + (e?.message || e));
  }
}

/* ========= UIï¼šæ—¥æœŸé¸å–® ========= */
function initSelectors() {
  const y   = document.getElementById("birthYear");
  const m   = document.getElementById("birthMonth");
  const d   = document.getElementById("birthDay");
  const h   = document.getElementById("birthHour");
  const min = document.getElementById("birthMinute");
  if (!y || !m || !d || !h || !min) return;

  for (let i = 2026; i >= 1940; i--) {
    y.add(new Option(i + " å¹´", i));
  }
  for (let i = 1; i <= 12; i++) {
    m.add(new Option(i + " æœˆ", i));
  }
  for (let i = 0; i < 24; i++) {
    const label = String(i).padStart(2,"0") + " æ™‚";
    h.add(new Option(label, i));
  }
  ["00","15","30","45"].forEach(v => {
    min.add(new Option(v + " åˆ†", v));
  });

  y.value   = "1990";
  m.value   = "1";
  h.value   = "12";
  min.value = "00";
  updateDays();

  m.addEventListener("change", updateDays);
  y.addEventListener("change", updateDays);

  document.getElementById("btnLaunch")?.addEventListener("click", () => {
    calculate();
  });
}

function updateDays() {
  const y = document.getElementById("birthYear");
  const m = document.getElementById("birthMonth");
  const d = document.getElementById("birthDay");
  if (!y || !m || !d) return;

  const year  = parseInt(y.value, 10);
  const month = parseInt(m.value, 10);
  const current = d.value;

  d.innerHTML = "";
  const days = new Date(year, month, 0).getDate();
  for (let i = 1; i <= days; i++) {
    const opt = new Option(i + " æ—¥", i);
    if (String(i) === String(current) || (!current && i === 1)) opt.selected = true;
    d.add(opt);
  }
}

document.addEventListener("DOMContentLoaded", initSelectors);
</script>

</body>
</html>
