<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2026 æˆ°ç•¥å°èˆªï½œä¸€èµ·å‡ºä¾†ç©</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#0b0e14; color:#e2e8f0; font-family: system-ui,-apple-system; }
    .glass { background: rgba(255,255,255,.04); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.08); }
    .bazi-char { font-size:1.8rem; font-weight:900; line-height:1.1; }
    .wuxing-æœ¨{background:#2ecc71}.wuxing-ç«{background:#e74c3c}
    .wuxing-åœŸ{background:#f1c40f}.wuxing-é‡‘{background:#ced4da}
    .wuxing-æ°´{background:#3498db}
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="p-4">
  <div class="max-w-xl mx-auto">
    <header class="mb-6 text-center">
      <h1 class="text-3xl font-black tracking-tight">2026 æµå¹´æˆ°ç•¥å ±å‘Š</h1>
      <p class="text-xs text-slate-400 mt-2">å·¥ç¨‹ç‰ˆï¼ˆcontract-onlyï¼‰ï½œè³‡æ–™ä¾†æºï¼š/compute/all</p>
    </header>

    <!-- è¼¸å…¥ -->
    <section class="glass p-6 rounded-xl mb-8">
      <div class="grid grid-cols-3 gap-2 mb-3">
        <select id="birthYear" class="bg-black/40 p-2 rounded"></select>
        <select id="birthMonth" class="bg-black/40 p-2 rounded"></select>
        <select id="birthDay" class="bg-black/40 p-2 rounded"></select>
      </div>
      <div class="grid grid-cols-2 gap-2 mb-4">
        <select id="birthHour" class="bg-black/40 p-2 rounded"></select>
        <select id="birthMinute" class="bg-black/40 p-2 rounded"></select>
      </div>

      <button id="btnLaunch" class="w-full bg-amber-500 text-black py-3 rounded font-black hover:brightness-110 active:brightness-95 transition">
        ç”Ÿæˆæˆ‘çš„ 2026 æˆ°ç•¥
      </button>

      <div class="mt-3 flex items-center justify-between gap-3">
        <div id="status" class="text-xs text-slate-400 italic"></div>
        <button id="btnDebug" class="text-xs text-slate-300 underline decoration-slate-600 hover:decoration-slate-300">
          é¡¯ç¤º Debug è³‡è¨Š
        </button>
      </div>

      <div id="debugBox" class="hidden mt-3 text-[11px] text-slate-400 mono whitespace-pre-wrap bg-black/30 border border-white/10 rounded p-3"></div>
    </section>

    <!-- å ±å‘Š -->
    <section id="report" class="hidden space-y-6 pb-8">

      <!-- å››æŸ± -->
      <div class="glass p-6 rounded-xl">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-black">å››æŸ±ï¼ˆé¡¯ç¤ºç”¨ï¼‰</h2>
          <div id="meta" class="text-[11px] text-slate-500"></div>
        </div>

        <div class="grid grid-cols-4 text-center gap-2">
          <div class="bg-black/20 rounded p-3">
            <div class="text-[11px] text-slate-400 mb-2">å¹´</div>
            <div id="yG" class="bazi-char"></div>
            <div id="yZ" class="text-sm text-slate-300"></div>
          </div>
          <div class="bg-black/20 rounded p-3">
            <div class="text-[11px] text-slate-400 mb-2">æœˆ</div>
            <div id="mG" class="bazi-char"></div>
            <div id="mZ" class="text-sm text-slate-300"></div>
          </div>
          <div class="bg-black/20 rounded p-3 border border-amber-500/30">
            <div class="text-[11px] text-amber-400 mb-2 font-bold">æ—¥</div>
            <div id="dG" class="bazi-char text-amber-400"></div>
            <div id="dZ" class="text-sm text-slate-300"></div>
          </div>
          <div class="bg-black/20 rounded p-3">
            <div class="text-[11px] text-slate-400 mb-2">æ™‚</div>
            <div id="hG" class="bazi-char"></div>
            <div id="hZ" class="text-sm text-slate-300"></div>
          </div>
        </div>
      </div>

      <!-- äº”è¡Œ -->
      <div class="glass p-6 rounded-xl">
        <h2 class="font-black mb-3">äº”è¡Œèƒ½é‡</h2>

        <div class="text-xs text-slate-400 mb-2">è¡¨å±¤ï¼ˆå¤©å¹²è¨ˆæ•¸ï¼‰</div>
        <div id="surfaceWx" class="space-y-2 mb-5"></div>

        <div class="text-xs text-slate-400 mb-2">å¯¦æˆ°ï¼ˆå¤©å¹²+è—å¹²+æœˆä»¤åŠ æ¬Šï¼‰</div>
        <div id="strategicWx" class="space-y-2"></div>
      </div>

      <!-- æµæœˆ -->
      <div class="glass p-6 rounded-xl">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-black">2026 æµæœˆç¯€å¥ï¼ˆ12ï¼‰</h2>
          <div id="boundsCount" class="text-[11px] text-slate-500"></div>
        </div>
        <div id="monthGrid" class="space-y-2"></div>
      </div>

      <!-- åˆ†æ -->
      <div class="glass p-6 rounded-xl">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-black">æˆ°ç•¥è§£è®€ï¼ˆfallbackï¼‰</h2>
          <button id="btnCopy" class="text-xs bg-white/10 hover:bg-white/15 px-3 py-1.5 rounded font-bold">
            ä¸€éµè¤‡è£½
          </button>
        </div>

        <div id="analysisBox" class="space-y-2 text-sm text-slate-200"></div>

        <div id="copyToast" class="hidden mt-3 text-xs text-amber-300">
          âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿
        </div>
      </div>

      <!-- ç”¢å“é–‰ç’° CTA -->
      <div class="glass p-6 rounded-xl">
        <h2 class="font-black mb-2">ä¸‹ä¸€æ­¥ï¼šæŠŠç­–ç•¥è®Šæˆç¾å¯¦</h2>
        <p class="text-sm text-slate-300 leading-relaxed">
          å¦‚æœä½ å¸Œæœ›æˆ‘æŠŠä½ çš„ã€Œå¹´åº¦ä¸»è»¸ã€å£“åŠ›æœˆç¯€å¥ã€è³‡æºé…ç½®ã€åšæˆå¯åŸ·è¡Œçš„è¨ˆåŠƒè¡¨ï¼Œæˆ‘å»ºè­°ç›´æ¥é ç´„è«®è©¢ï¼Œè®“ç­–ç•¥è½åœ°æˆ SOPã€‚
        </p>

        <a
          class="mt-4 block w-full text-center bg-emerald-400 text-black py-3 rounded font-black hover:brightness-110 active:brightness-95 transition"
          href="https://forms.gle/UVCSq1udEC549gzYA"
          target="_blank"
          rel="noopener noreferrer"
        >
          èˆ‡æä¼¯å½¥è€å¸«è«®è©¢ï¼ˆå¡«è¡¨é ç´„ï¼‰
        </a>

        <p class="text-[11px] text-slate-500 mt-3">
          * æœƒé–‹æ–°è¦–çª—ï¼ˆGoogle è¡¨å–®ï¼‰
        </p>
      </div>

    </section>

    <footer class="text-center text-[11px] text-slate-500 mt-8 pb-6">
      Â© 17gonplay â€” contract-first / maintainable build
    </footer>
  </div>

<script>
/* ========= åŸºæœ¬è¨­å®š ========= */
const API_BASE = "https://17gonplay-api.billeetw.workers.dev";

/* ========= å°å·¥å…· ========= */
function $(id){ return document.getElementById(id); }
function setStatus(msg){ const el = $("status"); if (el) el.textContent = msg || ""; }
function show(el, on){ if (!el) return; el.classList.toggle("hidden", !on); }

function renderBar(id, data, max) {
  const box = $(id);
  if (!box) return;
  box.innerHTML = "";
  ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(e => {
    const v = Number(data?.[e] || 0);
    const w = max ? Math.max(2, (v / max) * 100) : 0;
    box.innerHTML += `
      <div>
        <div class="flex justify-between text-xs">
          <span>${e}</span>
          <span>${v.toFixed(1)}</span>
        </div>
        <div class="h-2 bg-white/10 rounded overflow-hidden">
          <div class="h-full wuxing-${e}" style="width:${Math.min(100, Math.max(0, w))}%"></div>
        </div>
      </div>
    `;
  });
}

/* ========= UIï¼šæ—¥æœŸé¸å–® ========= */
function initSelectors() {
  const y = $("birthYear"), m = $("birthMonth"), d = $("birthDay"), h = $("birthHour"), min = $("birthMinute");
  if (!y || !m || !d || !h || !min) return;

  y.innerHTML = ""; m.innerHTML = ""; d.innerHTML = ""; h.innerHTML = ""; min.innerHTML = "";

  for (let i = 2026; i >= 1940; i--) y.add(new Option(i + " å¹´", i));
  for (let i = 1; i <= 12; i++) m.add(new Option(i + " æœˆ", i));
  for (let i = 0; i < 24; i++) h.add(new Option(String(i).padStart(2,"0") + " æ™‚", i));
  ["00","15","30","45"].forEach(v => min.add(new Option(v + " åˆ†", v)));

  y.value = "1990";
  m.value = "1";
  h.value = "12";
  min.value = "00";

  updateDays();
}

function updateDays() {
  const y = $("birthYear"), m = $("birthMonth"), d = $("birthDay");
  if (!y || !m || !d) return;

  const year = parseInt(y.value, 10);
  const month = parseInt(m.value, 10);
  const current = d.value;

  d.innerHTML = "";
  const days = new Date(year, month, 0).getDate();
  for (let i = 1; i <= days; i++) {
    const opt = new Option(i + " æ—¥", i);
    if (String(i) === String(current) || (!current && i === 1)) opt.selected = true;
    d.add(opt);
  }
}

/* ========= ä¸»æµç¨‹ï¼šcontract-first ========= */
async function calculate() {
  const vy = parseInt($("birthYear")?.value, 10);
  const vm = parseInt($("birthMonth")?.value, 10);
  const vd = parseInt($("birthDay")?.value, 10);
  const vh = parseInt($("birthHour")?.value, 10);
  const vmin = parseInt($("birthMinute")?.value, 10);

  try {
    if (![vy, vm, vd, vh, vmin].every(n => Number.isFinite(n))) {
      throw new Error("è«‹å…ˆé¸å¥½å‡ºç”Ÿå¹´æœˆæ—¥èˆ‡æ™‚é–“");
    }

    setStatus("æ­£åœ¨å‘¼å« /compute/all â€¦");
    show($("report"), false);

    const resp = await fetch(`${API_BASE}/compute/all`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ year: vy, month: vm, day: vd, hour: vh, minute: vmin }),
    });

    if (!resp.ok) {
      const txt = await resp.text().catch(() => "");
      throw new Error(`API HTTP ${resp.status} ${txt || ""}`.trim());
    }

    const payload = await resp.json();
    if (!payload?.ok) throw new Error(payload?.error || "API error");

    // âœ… Debug å…¨åŸŸï¼šconsole æ°¸é æŸ¥å¾—åˆ°
    window.__payload = payload;
    window.__contract = payload?.features;
    window.__bazi = payload?.features?.bazi;
    window.__bounds = payload?.features?.bazi?.liuyue2026?.bounds;

    const contract = payload.features;
    if (!contract || contract.version !== "strategic_features_v1") {
      throw new Error("contract æ ¼å¼ä¸æ­£ç¢ºï¼ˆfeatures.version != strategic_features_v1ï¼‰");
    }

    const bazi = contract.bazi;
    if (!bazi) throw new Error("contract.bazi ä¸å­˜åœ¨ï¼ˆå¾Œç«¯ Phase 0 æ‡‰è©²ä¸€å®šè¦æœ‰ï¼‰");

    /* 1) å››æŸ±ï¼ˆdisplayï¼‰ */
    const disp = bazi.display;
    if (!disp) throw new Error("contract.bazi.display ä¸å­˜åœ¨ï¼ˆè«‹ç¢ºèªå¾Œç«¯å·²æŠŠ display å¡é€² contractï¼‰");

    $("yG").innerText = disp.yG || "";
    $("yZ").innerText = disp.yZ || "";
    $("mG").innerText = disp.mG || "";
    $("mZ").innerText = disp.mZ || "";
    $("dG").innerText = disp.dG || "";
    $("dZ").innerText = disp.dZ || "";
    $("hG").innerText = disp.hG || "";
    $("hZ").innerText = disp.hZ || "";

    const metaTxt = `è¼¸å…¥ï¼š${vy}-${String(vm).padStart(2,"0")}-${String(vd).padStart(2,"0")} ${String(vh).padStart(2,"0")}:${String(vmin).padStart(2,"0")}`;
    $("meta").textContent = metaTxt;

    /* 2) äº”è¡Œ */
    if (!bazi.wuxing?.surface || !bazi.wuxing?.strategic) throw new Error("bazi.wuxing ç¼ºè³‡æ–™");
    renderBar("surfaceWx", bazi.wuxing.surface, 4);
    renderBar("strategicWx", bazi.wuxing.strategic, bazi.wuxing.maxStrategic || 1);

    /* 3) æµæœˆ */
    const bounds = bazi.liuyue2026?.bounds || [];
    $("boundsCount").textContent = `bounds: ${bounds.length}`;

    const monthGrid = $("monthGrid");
    monthGrid.innerHTML = "";
    const redMonths = [];

    if (bounds.length) {
      bounds.forEach(b => {
        const isRed = b.light === "RED";
        if (isRed) redMonths.push(b.gz);

        monthGrid.innerHTML += `
          <div class="p-3 rounded border border-white/10 border-l-4 ${isRed ? "border-l-red-500 bg-red-500/10" : "border-l-emerald-500 bg-emerald-500/10"}">
            <div class="font-bold">
              ${b.gz}
              <span class="text-xs text-slate-400 ml-1">${b.range || ""}</span>
            </div>
            <div class="text-xs text-slate-300 mt-1">
              ${isRed ? "ğŸ”´ å£“åŠ›" : "ğŸŸ¢ ç©©é€²"} ï½œ æœ¬æ°£ï¼š${b.ssBranch || ""}
            </div>
          </div>
        `;
      });
    } else {
      monthGrid.innerHTML = `<div class="text-xs text-slate-400 italic">ï¼ˆæš«ç„¡æµæœˆè³‡æ–™ï¼‰</div>`;
    }

    /* 4) judge/mergeï¼ˆå¯é¸ï¼‰ */
    let judge = null;
    try {
      setStatus("æ­£åœ¨å‘¼å« /judge/mergeï¼ˆå¯é¸ï¼‰â€¦");
      const jResp = await fetch(`${API_BASE}/judge/merge`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ features: contract }),
      });
      const j = await jResp.json().catch(() => null);
      if (j && j.ok) judge = j;
    } catch (_) {
      // ignore
    }
    window.__judge = judge;

    /* 5) fallback åˆ†æ */
    const dominant = (bazi.tenGod?.dominant || "").trim() || "æœªå®š";
    const dmElement = bazi.dmElement || "â€”";

    const redText = redMonths.length
      ? `å£“åŠ›æœˆï¼š${redMonths.join("ã€")}ï¼ˆé€™äº›æœˆå…ˆå®ˆè¦å‰‡ï¼Œä¸è¦ç¡¬è¡ï¼‰ã€‚`
      : "ä»Šå¹´å£“åŠ›æœˆåå°‘ï¼Œå¯ä»¥ç©©ç©©æ¨é€²ã€‚";

    const theme = judge?.result?.theme ? `\n\nï¼ˆjudgeï¼‰${judge.result.theme}` : "";

    const analysis = [
      `ä½ çš„æ—¥ä¸»äº”è¡Œä¸»å ´æ˜¯ã€Œ${dmElement}ã€ï¼Œå¹´åº¦ä¸»è»¸åå‘ã€Œ${dominant}ã€ã€‚`,
      redText,
      "ç­–ç•¥ï¼šæŠŠè¡Œå‹•æ‹†å°ã€ç›®æ¨™è®Šå°‘ã€ç¯€å¥å›ºå®šï¼›å£“åŠ›æœˆå„ªå…ˆå®ˆä½ç¾æœ‰ç›¤é¢ã€‚",
      theme
    ].filter(Boolean).join("\n");

    const box = $("analysisBox");
    box.innerHTML = analysis
      .split("\n")
      .map(line => `<p>${escapeHtml(line)}</p>`)
      .join("");

    window.__shareText = analysis;

    setStatus("å®Œæˆ âœ…");
    show($("report"), true);
    $("report").scrollIntoView({ behavior:"smooth", block:"start" });

  } catch (e) {
    console.error(e);
    setStatus("");
    alert("è¨ˆç®—å¤±æ•—ï¼š" + (e?.message || e));
  }
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ========= äº‹ä»¶ç¶å®š ========= */
document.addEventListener("DOMContentLoaded", () => {
  initSelectors();

  $("birthMonth")?.addEventListener("change", updateDays);
  $("birthYear")?.addEventListener("change", updateDays);

  $("btnLaunch")?.addEventListener("click", calculate);

  $("btnCopy")?.addEventListener("click", async () => {
    const text = window.__shareText || $("analysisBox")?.innerText || "";
    try {
      await navigator.clipboard.writeText(text);
      show($("copyToast"), true);
      setTimeout(() => show($("copyToast"), false), 2000);
    } catch {
      alert("è¤‡è£½å¤±æ•—ï¼ˆç€è¦½å™¨ä¸å…è¨±å‰ªè²¼ç°¿ï¼‰ã€‚ä½ å¯ä»¥æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½ã€‚");
    }
  });

  $("btnDebug")?.addEventListener("click", () => {
    const box = $("debugBox");
    const on = box.classList.contains("hidden");
    show(box, on);
    if (on) {
      const out = {
        api: API_BASE,
        hasPayload: Boolean(window.__payload),
        featuresVersion: window.__contract?.version || null,
        hasBazi: Boolean(window.__contract?.bazi),
        boundsLength: window.__bounds?.length ?? null,
        judge: window.__judge?.ok ? "ok" : null,
      };
      box.textContent = JSON.stringify(out, null, 2);
    }
  });
});
</script>
</body>
</html>

















