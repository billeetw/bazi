<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2026 æˆ°ç•¥æŒ‡æ®ä¸­å¿ƒï½œä¸€èµ·å‡ºä¾†ç©</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- iztro å‰ç«¯ç‰ˆï¼ˆæ”¾åœ¨ public/ åŒå±¤å°±ç”¨ ./iztro.min.jsï¼‰-->
  <script src="iztro.min.js"></script>

  <style>
    body {
      background: radial-gradient(circle at top, #020617 0, #020617 55%, #000 100%);
      color: #e2e8f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }
    .glass {
      background: rgba(15,23,42,0.92);
      backdrop-filter: blur(18px);
      border-radius: 1.25rem;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 24px 60px rgba(15,23,42,0.85);
    }
    .bazi-char {
      font-size: 1.9rem;
      font-weight: 900;
      line-height: 1.05;
      letter-spacing: .06em;
    }
    .section-subtitle {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #94a3b8;
    }
    /* Nav bar */
    .nav-bar {
      background: linear-gradient(90deg,#ef4444,#f97316,#ef4444);
      color:#fff;
      padding:10px 16px;
      position:sticky;
      top:0;
      z-index:40;
      box-shadow:0 4px 20px rgba(220,38,38,0.7);
    }
    .nav-link {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.18em;
      opacity:.75;
    }
    .nav-link:hover { opacity:1; }

    /* äº”è¡Œæ¢ */
    .wuxing-æœ¨{background:#22c55e}
    .wuxing-ç«{background:#ef4444}
    .wuxing-åœŸ{background:#eab308}
    .wuxing-é‡‘{background:#e5e7eb}
    .wuxing-æ°´{background:#3b82f6}

    /* ç´«å¾®å‘½ç›¤ 12 å®®æ ¼ */
    .zw-grid-container {
      display:grid;
      grid-template-columns:repeat(4,1fr);
      grid-template-rows:repeat(4,1fr);
      gap:10px;
      width:100%;
      max-width:540px;
      aspect-ratio:1/1;
      margin:0 auto;
    }
    .zw-palace {
      background:rgba(15,23,42,0.96);
      border-radius:0.95rem;
      border:1px solid rgba(148,163,184,0.35);
      padding:10px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transition:all .25s ease;
    }
    .zw-palace:hover {
      border-color:rgba(251,191,36,0.9);
      box-shadow:0 10px 30px rgba(15,23,42,0.9);
      transform:translateY(-1px);
    }
    .zw-palace.is-active {
      border-color:#fbbf24;
      box-shadow:0 0 24px rgba(251,191,36,0.75);
      transform:scale(1.02);
      z-index:10;
    }
    .zw-palace.is-related {
      border-color:rgba(251,191,36,0.4);
      background:radial-gradient(circle at top,rgba(251,191,36,0.12),rgba(15,23,42,0.96));
    }

    .zw-palace::before {
      content:'';
      position:absolute;
      top:50%;left:50%;
      width:160%;height:160%;
      transform:translate(-50%,-50%);
      opacity:0;
      transition:opacity .4s ease;
      pointer-events:none;
      z-index:-1;
    }
    [class*="palace-glow-"]::before { opacity:1; }
    .palace-glow-æœ¨::before{background:radial-gradient(circle,rgba(34,197,94,0.18) 0,transparent 70%)}
    .palace-glow-ç«::before{background:radial-gradient(circle,rgba(239,68,68,0.2) 0,transparent 70%)}
    .palace-glow-åœŸ::before{background:radial-gradient(circle,rgba(234,179,8,0.2) 0,transparent 70%)}
    .palace-glow-é‡‘::before{background:radial-gradient(circle,rgba(248,250,252,0.18) 0,transparent 70%)}
    .palace-glow-æ°´::before{background:radial-gradient(circle,rgba(59,130,246,0.2) 0,transparent 70%)}

    .star-wx-æœ¨{color:#86efac;text-shadow:0 0 5px rgba(34,197,94,0.65);}
    .star-wx-ç«{color:#fca5a5;text-shadow:0 0 5px rgba(239,68,68,0.7);}
    .star-wx-åœŸ{color:#fde047;text-shadow:0 0 5px rgba(234,179,8,0.7);}
    .star-wx-é‡‘{color:#e2e8f0;text-shadow:0 0 5px rgba(248,250,252,0.8);}
    .star-wx-æ°´{color:#93c5fd;text-shadow:0 0 5px rgba(59,130,246,0.7);}

    .zw-center-block {
      grid-area:2 / 2 / 4 / 4;
      border-radius:1.4rem;
      border:1px dashed rgba(148,163,184,0.6);
      background:radial-gradient(circle at center,#020617 0,#020617 52%,#000 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:12px;
    }

    .month-dot {width:7px;height:7px;border-radius:999px;display:inline-block;margin-right:6px;}
    .bg-red-light{background:#ef4444;box-shadow:0 0 8px #ef4444;}
    .bg-green-light{background:#22c55e;box-shadow:0 0 8px #22c55e;}

    .tactical-alert {
      border-left-width:4px;
      padding:10px 12px;
      border-radius:0 10px 10px 0;
      background:rgba(15,23,42,0.9);
      border-color:#fbbf24;
      font-size:11px;
    }

    @media (max-width: 768px) {
      .bazi-char { font-size: 1.6rem; }
    }
  </style>
</head>

<body class="min-h-screen pb-16">

  <!-- NAV -->
  <header class="nav-bar flex items-center justify-between">
    <div class="flex flex-col">
      <span class="font-black tracking-[0.22em] text-[10px] uppercase">ä¸€èµ·å‡ºä¾†ç© Â· Strategic Hub</span>
      <span class="text-[10px] opacity-80 mt-0.5">2026 ä¸™åˆå¹´ Â· æµå¹´æŒ‡æ®ä¸­å¿ƒ</span>
    </div>
    <nav class="hidden md:flex gap-4">
      <a href="#workspace" class="nav-link">ç¸½è¦½</a>
      <a href="#baziSection" class="nav-link">å…«å­— Â· äº”è¡Œ</a>
      <a href="#ziweiSection" class="nav-link">ç´«å¾®å‘½ç›¤</a>
      <a href="#monthsSection" class="nav-link">2026 æµæœˆ</a>
      <a href="#consultSection" class="nav-link">è«®è©¢</a>
    </nav>
  </header>

  <main class="max-w-6xl mx-auto px-4 md:px-6 pt-6 space-y-8">

    <!-- Intro -->
    <section class="text-center md:text-left">
      <p class="section-subtitle mb-1">2026 Strategic Astrolabe</p>
      <h1 class="text-3xl md:text-5xl font-black tracking-tight mb-2">
        2026 æˆ°ç•¥æŒ‡æ®ä¸­å¿ƒ
      </h1>
      <p class="text-sm text-slate-400 max-w-2xl">
        è¼¸å…¥ä½ çš„å‡ºç”Ÿæ™‚é–“ï¼Œç³»çµ±æœƒåŒæ­¥å…«å­—äº”è¡Œã€2026 æµæœˆç´…ç¶ ç‡ˆï¼Œä»¥åŠç´«å¾®å‘½ç›¤åäºŒå®®ï¼Œç”¨ã€Œæˆ°ç•¥åœ°åœ–ã€çœ‹æ‡‚ä»Šå¹´æ€éº¼èµ°æœ€é †ã€‚
      </p>
    </section>

    <!-- Input card -->
    <section id="inputSection" class="glass p-5 md:p-6 max-w-2xl mx-auto space-y-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="section-subtitle mb-1">Step 1 Â· Birth Data</div>
          <h2 class="font-bold text-lg">è¼¸å…¥ä½ çš„å‡ºç”Ÿè³‡æ–™</h2>
        </div>
        <p class="text-[10px] text-slate-400 text-right">
          æœ¬ç‰ˆåŒæ­¥ï¼šå…«å­—ï¼‹ç´«å¾®å‘½ç›¤<br/>é‹ç®—éƒ½åœ¨ä½ ç€è¦½å™¨å…§å®Œæˆ
        </p>
      </div>

      <div class="grid grid-cols-3 gap-2">
        <select id="birthYear" class="bg-slate-950/60 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select>
        <select id="birthMonth" class="bg-slate-950/60 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select>
        <select id="birthDay" class="bg-slate-950/60 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <select id="birthHour" class="bg-slate-950/60 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select>
        <select id="birthMinute" class="bg-slate-950/60 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select>
      </div>

      <button
        id="btnLaunch"
        class="w-full bg-amber-500 text-black py-3 rounded-xl font-black text-sm tracking-[0.22em] uppercase hover:bg-amber-400 active:scale-[0.98] transition"
      >
        å•Ÿå‹• 2026 æˆ°ç•¥æ¨¡æ“¬
      </button>

      <p id="hint" class="text-[11px] text-slate-400 italic min-h-[1.2em] text-center"></p>
    </section>

    <!-- Workspace -->
    <section id="workspace" class="space-y-10 hidden">

      <!-- Bazi + Wuxing -->
      <section id="baziSection" class="glass p-6 md:p-8 space-y-6">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <div>
            <div class="section-subtitle mb-1">Four Pillars Â· Five Elements</div>
            <h2 class="font-bold text-lg">å…«å­— Â· äº”è¡Œæˆ°åŠ›ç¸½è¦½</h2>
          </div>
          <div id="birthSummary" class="text-[11px] text-slate-400"></div>
        </div>

        <!-- å››æŸ± -->
        <div id="pillarsRow" class="grid grid-cols-4 gap-4 text-center">
          <div>
            <div class="bazi-char" id="yG"></div>
            <div class="text-sm text-slate-300" id="yZ"></div>
            <div class="text-[10px] text-slate-500 mt-1">å¹´æŸ±</div>
          </div>
          <div>
            <div class="bazi-char" id="mG"></div>
            <div class="text-sm text-slate-300" id="mZ"></div>
            <div class="text-[10px] text-slate-500 mt-1">æœˆæŸ±</div>
          </div>
          <div>
            <div class="bazi-char text-amber-400" id="dG"></div>
            <div class="text-sm text-slate-300" id="dZ"></div>
            <div class="text-[10px] text-amber-300 mt-1">æ—¥ä¸»</div>
          </div>
          <div>
            <div class="bazi-char" id="hG"></div>
            <div class="text-sm text-slate-300" id="hZ"></div>
            <div class="text-[10px] text-slate-500 mt-1">æ™‚æŸ±</div>
          </div>
        </div>

        <!-- äº”è¡Œæ¢ -->
        <div class="grid md:grid-cols-2 gap-8 mt-3">
          <div>
            <h3 class="text-xs font-bold text-slate-400 mb-3 tracking-[0.16em] uppercase">
              å¯¦æˆ°çµæ§‹ Â· äº”è¡ŒåŠ æ¬Šï¼ˆå«è—å¹²ï¼‰
            </h3>
            <div id="strategicWx" class="space-y-2"></div>
          </div>
          <div>
            <h3 class="text-xs font-bold text-slate-400 mb-3 tracking-[0.16em] uppercase">äº”è¡Œèªªæ˜ï¼ˆè³‡æ–™åº«ï¼‹é è¨­ï¼‰</h3>
            <div id="wuxingLegend" class="space-y-3 text-[11px] leading-relaxed"></div>
          </div>
        </div>

        <div id="tenGodAdvice" class="mt-5 p-4 rounded-xl border border-amber-500/50 bg-amber-500/5 text-[12px] text-amber-100 leading-relaxed"></div>
      </section>

      <!-- Ziwei + detail -->
      <section id="ziweiSection" class="grid lg:grid-cols-[minmax(0,1.1fr),minmax(0,0.9fr)] gap-8">
        <div class="glass p-6 md:p-8 space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="section-subtitle mb-1">Zi Wei Dou Shu</div>
              <h2 class="font-bold text-lg">ç´«å¾®å‘½ç›¤ Â· 12 å®®ç¸½è¦½</h2>
              <p class="text-[11px] text-slate-500 mt-1">
                é»ä»»ä¸€å®®ä½ï¼šå³å´é¡¯ç¤ºè³‡æ–™åº«è§£é‡‹ï¼‹æ˜Ÿæ›œèªªæ˜ï¼Œä¸¦è‡ªå‹•æ¨™ç¤ºä¸‰æ–¹å››æ­£ã€‚
              </p>
            </div>
            <div id="ziweiCoreMeta" class="text-[11px] text-slate-400 text-right"></div>
          </div>
          <div id="ziweiGrid" class="zw-grid-container"></div>
          <p class="text-[10px] text-slate-500 mt-2">
            æç¤ºï¼šä¸‰æ–¹å››æ­£ = æœ¬å®®ï¼‹å°å®®ï¼‹å…©å€‹ä¸‰åˆå®®ï¼ˆé»å®®ä½è‡ªå‹•é¡¯ç¤ºï¼‰ã€‚
          </p>
        </div>

        <aside class="glass p-6 md:p-7 border border-amber-500/35 overflow-y-auto max-h-[85vh]" id="palaceDetail">
          <div class="section-subtitle mb-1">Palace Detail</div>
          <h3 id="palaceTitle" class="text-2xl font-black text-amber-400 mb-1">è«‹é»é¸å·¦å´ä»»ä¸€å®®ä½</h3>
          <p id="palaceMeta" class="text-[11px] text-slate-400 mb-5">
            ä¸‰æ–¹å››æ­£æœƒä»¥é‡‘è‰²æ¡†ç·šæ¨™ç¤ºï¼Œæœ¬å®®ï¼‹å°å®®ï¼‹å…©å€‹ä¸‰åˆå®®ï¼Œå…±å››å®®ã€‚
          </p>

          <div class="space-y-5 text-sm" id="palaceContent">
            <p class="text-slate-500 text-xs italic">
              å·¦å´é»å®®ä½å¾Œï¼Œé€™è£¡æœƒé¡¯ç¤ºï¼š<br/>
              1ï¼‰è³‡æ–™åº«å®®ä½è§£é‡‹<br/>
              2ï¼‰è©²å®®ä½æ˜Ÿæ›œé€é¡†èªªæ˜ï¼ˆå« 2026 ä¸™åˆåŒ–ç¥¿ï¼åŒ–æ¬Šï¼åŒ–ç§‘ï¼åŒ–å¿Œï¼‰<br/>
              3ï¼‰ç©ºå®®æ™‚çš„ä¸‰æ–¹å››æ­£æç¤ºã€‚
            </p>
          </div>

          <div class="mt-7 pt-5 border-t border-slate-800">
            <div class="text-[10px] text-slate-500 uppercase font-bold tracking-[0.16em] mb-3">
              2026 æµæœˆç¯€å¥ Â· å¿«é€ŸæŒ‡æ®
            </div>
            <div id="monthlyRhythmBox" class="space-y-2 text-[11px]"></div>
          </div>
        </aside>
      </section>

      <!-- 2026 æµæœˆ -->
      <section id="monthsSection" class="glass p-6 md:p-8 space-y-4">
        <div>
          <div class="section-subtitle mb-1">2026 Monthly Flow</div>
          <h2 class="font-bold text-lg">2026 æµæœˆç´…ç¶ ç‡ˆï¼ˆåäºŒå€‹ç¯€å¥é»ï¼‰</h2>
          <p class="text-[11px] text-slate-400 mt-1">
            ğŸŸ¢ ç¶ ç‡ˆï¼šé©åˆæ¨é€²ï¼è«‡åˆä½œï¼æ”¶å‰²ã€€ï½œã€€ğŸ”´ ç´…ç‡ˆï¼šå®ˆè¦å‰‡ã€æ¸›å£“ã€ä¸è¦ç¡¬ä¸Šã€‚
          </p>
        </div>
        <div id="monthsList" class="space-y-2 text-sm"></div>
      </section>

      <!-- CTA -->
      <section id="consultSection" class="glass p-6 md:p-8 space-y-4">
        <div>
          <div class="section-subtitle mb-1">1:1 Consulting</div>
          <h2 class="font-bold text-xl md:text-2xl text-amber-300">
            æƒ³æŠŠé€™å¼µæˆ°ç•¥åœ°åœ–è®Šæˆã€Œå¯ä¿ç”¨ä¸€ç”Ÿã€çš„äººç”Ÿèªªæ˜æ›¸ï¼Ÿ
          </h2>
        </div>
        <p class="text-sm text-slate-200 leading-relaxed">
          ç›®å‰é€™å€‹ç³»çµ±ï¼Œæ˜¯ä½ ã€Œ2026 ä¸™åˆå¹´ã€çš„å³æ™‚æŒ‡æ®é¢æ¿ã€‚å¦‚æœä½ å¸Œæœ›æˆ‘æŠŠä½ çš„å‘½æ ¼çµ„æˆã€äººç”Ÿå¤§é‹ã€æµå¹´æµæœˆã€
          è·æ¶¯èˆ‡é‡‘éŒ¢æˆ°ç•¥åšæˆä¸€ä»½ <span class="font-semibold text-amber-300">50 é çš„äººç”Ÿä½¿ç”¨èªªæ˜æ›¸</span>ï¼Œ
          æ­¡è¿é ç´„ç·šä¸Šè«®è©¢ã€‚
        </p>
        <a
          href="https://forms.gle/UVCSq1udEC549gzYA"
          target="_blank"
          class="inline-flex items-center justify-center px-6 py-3 rounded-xl bg-gradient-to-r from-amber-400 to-yellow-500 text-black font-black text-sm tracking-[0.18em] uppercase shadow-xl hover:brightness-110 active:scale-[0.98] transition"
        >
          é ç´„æä¼¯å½¥è€å¸«ç·šä¸Šè«®è©¢
        </a>
      </section>
    </section>
  </main>

  <script>
    const API_BASE = "https://17gonplay-api.billeetw.workers.dev";

    /** ===== è³‡æ–™åº«å…§å®¹ï¼ˆå®®ä½ / æ˜Ÿæ›œ / åç¥ / äº”è¡Œï¼‰ ===== */
    let DB_CONTENT = {
      palaces: {},
      stars: {},
      tenGods: {},
      wuxing: {}
    };
    let dbLoaded = false;

    async function loadContentOnce() {
      if (dbLoaded) return;
      try {
        const resp = await fetch(`${API_BASE}/content/2026`);
        const data = await resp.json();
        if (data.ok) {
          DB_CONTENT = {
            palaces: data.palaces || {},
            stars: data.stars || {},
            tenGods: data.tenGods || {},
            wuxing: data.wuxing || {}
          };
          dbLoaded = true;
        }
      } catch (e) {
        console.error("loadContent error", e);
      }
    }

    /** ===== äº”è¡Œèªªæ˜é è¨­ ===== */
    const WUXING_MEANINGS_FALLBACK = {
      "æœ¨": {
        headline: "æœ¨ Â· æˆé•·ã€å»¶ä¼¸ã€è¦åŠƒ",
        content: "ä»£è¡¨ç™¼å±•ã€å­¸ç¿’èˆ‡å‘å¤–ä¼¸å±•çš„èƒ½åŠ›ã€‚æœ¨æ—ºçš„äººé©åˆé–‹å‰µèˆ‡ç­–åŠƒï¼Œä½†è¦æ³¨æ„ä¸è¦æ‹–å¤ªå¤šç·šåŒæ™‚é€²è¡Œã€‚"
      },
      "ç«": {
        headline: "ç« Â· è¡¨ç¾ã€è¡Œå‹•ã€æ›å…‰",
        content: "ä»£è¡¨ç†±æƒ…ã€å­˜åœ¨æ„Ÿèˆ‡è¡Œå‹•åŠ›ã€‚ç«å¼·çš„äººé©åˆå¸¶æ°£æ°›ã€åšå‰ç·šè¡åˆºï¼Œä½†è¦é¿å…æƒ…ç·’åŒ–èˆ‡éåº¦æ¶ˆè€—ã€‚"
      },
      "åœŸ": {
        headline: "åœŸ Â· çµæ§‹ã€æ‰¿æ“”ã€ç©©å®š",
        content: "ä»£è¡¨æ‰¿æ¥ã€è€åŠ›èˆ‡ç³»çµ±ã€‚åœŸå¼·çš„äººé©åˆåšç®¡ç†èˆ‡æ”¶æ–‚ï¼Œä½†è¦ç•™æ„ä¸è¦æŠŠä¸€åˆ‡éƒ½æ‰›åœ¨è‡ªå·±èº«ä¸Šã€‚"
      },
      "é‡‘": {
        headline: "é‡‘ Â· è¦å‰‡ã€å°ˆæ¥­ã€åˆ©æ½¤",
        content: "ä»£è¡¨é‚è¼¯ã€æ•ˆç‡èˆ‡æ±ºæ–·åŠ›ã€‚é‡‘æ—ºçš„äººé©åˆåšæ±ºç­–ã€è¨‚è¦å‰‡ï¼Œä½†è¦æ³¨æ„ä¸è¦éåº¦è‹›åˆ»è‡ªå·±èˆ‡ä»–äººã€‚"
      },
      "æ°´": {
        headline: "æ°´ Â· æµå‹•ã€è³‡è¨Šã€äººéš›",
        content: "ä»£è¡¨æµå‹•æ€§ã€è³‡è¨Šæ•´åˆèˆ‡æƒ…ç·’æ„ŸçŸ¥ã€‚æ°´åå¼±æ™‚ï¼Œè¦ç‰¹åˆ¥è£œå……å¤–ç•Œè³‡è¨Šï¼Œé¿å…é—œåœ¨è‡ªå·±çš„ä¸–ç•Œã€‚"
      }
    };

    function renderWuxingLegend() {
      const box = document.getElementById("wuxingLegend");
      box.innerHTML = "";
      ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(el => {
        const fromDb = DB_CONTENT.wuxing[el] || {};
        const src = {
          headline: fromDb.headline || WUXING_MEANINGS_FALLBACK[el].headline,
          content: fromDb.content || WUXING_MEANINGS_FALLBACK[el].content
        };
        box.innerHTML += `
          <div class="flex items-start gap-3">
            <div class="w-2 h-8 mt-1 rounded-full wuxing-${el}"></div>
            <div>
              <div class="text-xs font-semibold text-slate-100 mb-0.5">${src.headline}</div>
              <div class="text-[11px] text-slate-300 leading-relaxed">${src.content}</div>
            </div>
          </div>
        `;
      });
    }

    /** ===== äº”è¡Œæ¢ ===== */
    function renderBar(id, data, max) {
      const box = document.getElementById(id);
      if (!box) return;
      box.innerHTML = "";
      const maxVal = max || Math.max(...Object.values(data || {}).map(v => Number(v) || 0), 1);

      ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(e => {
        const v = Number(data?.[e] || 0);
        const w = maxVal ? Math.max(4, (v / maxVal) * 100) : 0;
        box.innerHTML += `
          <div class="mb-2 text-[11px]">
            <div class="flex justify-between mb-1">
              <span>${e}</span>
              <span>${v.toFixed(1)}</span>
            </div>
            <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
              <div class="h-full wuxing-${e}" style="width:${w}%;"></div>
            </div>
          </div>
        `;
      });
    }

    /** ===== ç´«å¾®ï¼šå‰ç«¯ iztro ç‰ˆæœ¬ ===== */
    const PALACE_ORDER_TRAD = ["å‘½å®®","å…„å¼Ÿ","å¤«å¦»","å­å¥³","è²¡å¸›","ç–¾å„","é·ç§»","åƒ•å½¹","å®˜ç¥¿","ç”°å®…","ç¦å¾·","çˆ¶æ¯"];
    const GRID_AREAS = [
      "1/1/2/2","1/2/2/3","1/3/2/4","1/4/2/5",
      "2/4/3/5","3/4/4/5","4/4/5/5",
      "4/3/5/4","4/2/5/3","4/1/5/2",
      "3/1/4/2","2/1/3/2"
    ];
    const PALACE_NAME_SIMPLIFIED_TO_TRAD = {
      "å‘½å®«":"å‘½å®®","å…„å¼Ÿ":"å…„å¼Ÿ","å¤«å¦»":"å¤«å¦»","å­å¥³":"å­å¥³",
      "è´¢å¸›":"è²¡å¸›","ç–¾å„":"ç–¾å„","è¿ç§»":"é·ç§»","ä»†å½¹":"åƒ•å½¹",
      "å®˜ç¦„":"å®˜ç¥¿","ç”°å®…":"ç”°å®…","ç¦å¾·":"ç¦å¾·","çˆ¶æ¯":"çˆ¶æ¯"
    };
    const STAR_WUXING_MAP = {
      "ç´«å¾®":"åœŸ","å¤©æ©Ÿ":"æœ¨","å¤ªé™½":"ç«","æ­¦æ›²":"é‡‘","å¤©åŒ":"æ°´",
      "å»‰è²":"ç«","å¤©åºœ":"åœŸ","å¤ªé™°":"æ°´","è²ªç‹¼":"æœ¨",
      "å·¨é–€":"æ°´","å¤©ç›¸":"æ°´","å¤©æ¢":"åœŸ","ä¸ƒæ®º":"é‡‘","ç ´è»":"æ°´"
    };

    let GLOBAL_LIUYUE = [];
    let GLOBAL_TENGOD_DOMINANT = "";

    function buildZiweiLocal(year, month, day, hour, minute) {
      if (!window.iztro) {
        console.warn("iztro not loaded");
        return null;
      }
      const iz = window.iztro.astrolabe.fromSolar(
        `${year}-${month}-${day}`,
        hour,
        minute,
        "male",
        true
      );

      const palacesMap = {};
      (iz.palaces || []).forEach(p => {
        const rawName = String(p.name || "");
        const tradName = PALACE_NAME_SIMPLIFIED_TO_TRAD[rawName] || rawName;
        const majors = Array.isArray(p.majorStars)
          ? p.majorStars.map(s => String(s.name || "")).filter(Boolean)
          : [];
        const minors = Array.isArray(p.minorStars)
          ? p.minorStars.map(s => String(s.name || "")).filter(Boolean)
          : [];
        const others = Array.isArray(p.otherStars)
          ? p.otherStars.map(s => String(s.name || "")).filter(Boolean)
          : [];
        const lucks = Array.isArray(p.luckStars)
          ? p.luckStars.map(s => String(s.name || "")).filter(Boolean)
          : [];
        palacesMap[tradName] = [...majors, ...minors, ...others, ...lucks];
      });

      // å˜—è©¦æŠ“å‘½å®®ä¸»æ˜Ÿï¼ˆæ‰¾ã€Œå‘½å®®ã€é‚£ä¸€æ ¼çš„ç¬¬ä¸€é¡†æ˜Ÿï¼‰
      const lifePalace = (iz.palaces || []).find(p => {
        const tradName = PALACE_NAME_SIMPLIFIED_TO_TRAD[p.name] || p.name;
        return tradName === "å‘½å®®";
      });
      const lifeStars = lifePalace?.majorStars || [];
      const lifeMainStar = lifeStars[0]?.name || "å‘½å®®";

      return {
        core: {
          // å‘½å®®ä¸»æ˜Ÿï¼ˆé¡¯ç¤ºåœ¨ä¸­å¤®ï¼‰
          lifeMainStar,
          wuxingju: iz.fiveElementsClass || "",
        },
        palacesMap
      };
    }

    function renderZiweiGrid(ziweiLocal, ziweiCoreFromServer) {
      const container = document.getElementById("ziweiGrid");
      const meta = document.getElementById("ziweiCoreMeta");
      if (!ziweiLocal) {
        container.innerHTML =
          '<div class="col-span-4 flex items-center justify-center text-xs text-slate-500">ï¼ˆç´«å¾®è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ iztro.min.js è·¯å¾‘ï¼‰</div>';
        return;
      }

      const palacesMap = ziweiLocal.palacesMap || {};
      container.innerHTML = "";

      PALACE_ORDER_TRAD.forEach((name, idx) => {
        const stars = palacesMap[name] || [];
        const isKey = ["å‘½å®®","å®˜ç¥¿","è²¡å¸›"].includes(name);
        const firstStar = stars[0];
        const wx = STAR_WUXING_MAP[firstStar] || "";
        const starsHtml = stars.length
          ? stars.map(s => `<span class="star-wx-${STAR_WUXING_MAP[s] || ""}">${s}</span>`).join("<br>")
          : '<span class="text-slate-500 text-[11px] italic">ç©ºå®®</span>';

        const palaceEl = document.createElement("div");
        palaceEl.className = `zw-palace ${isKey ? "zw-palace-key" : ""} ${wx ? "palace-glow-" + wx : ""}`;
        palaceEl.style.gridArea = GRID_AREAS[idx];
        palaceEl.innerHTML = `
          <div class="text-[10px] font-semibold text-slate-400 mb-1">${name}</div>
          <div class="text-[13px] font-black leading-snug tracking-wide">${starsHtml}</div>
        `;
        palaceEl.addEventListener("click", () => onPalaceClick(name, stars, idx));
        container.appendChild(palaceEl);
      });

      // ä¸­å¤® destiny coreï¼šç”¨å¾Œç«¯ core + å‰ç«¯å‘½å®®ä¸»æ˜Ÿ
      const coreLifeStar = ziweiLocal.core.lifeMainStar || "";
      const center = document.createElement("div");
      center.className = "zw-center-block";
      center.innerHTML = `
        <div class="text-[10px] tracking-[0.22em] text-slate-500 uppercase mb-1">Destiny Core</div>
        <div class="text-amber-400 font-black text-2xl tracking-widest mb-1">${coreLifeStar}</div>
        <div class="text-[11px] text-slate-300 mt-1">
          äº”è¡Œå±€ï¼š${ziweiCoreFromServer?.wuxingju || ziweiLocal.core.wuxingju || "â€”"}
        </div>
      `;
      container.appendChild(center);

      if (meta) {
        meta.textContent = `å‘½å®®ä¸»æ˜Ÿï¼š${coreLifeStar}ï½œäº”è¡Œå±€ï¼š${ziweiCoreFromServer?.wuxingju || ziweiLocal.core.wuxingju || "â€”"}`;
      }
    }

    function onPalaceClick(name, stars, index) {
      const titleEl = document.getElementById("palaceTitle");
      const metaEl = document.getElementById("palaceMeta");
      const contentEl = document.getElementById("palaceContent");
      const rhythmBox = document.getElementById("monthlyRhythmBox");

      titleEl.textContent = `2026 ${name} Â· ä½œæˆ°é¢æ¿`;
      metaEl.textContent = "ä¸‰æ–¹å››æ­£å·²æ¨™ç¤ºï¼šæœ¬å®®ï¼‹å°å®®ï¼‹å…©å€‹ä¸‰åˆå®®ï¼ˆå…±å››å®®ï¼‰ã€‚";

      const palaceDesc =
        DB_CONTENT.palaces[name] ||
        "ï¼ˆè³‡æ–™åº«å°šæœªå¡«å…¥æ­¤å®®ä½è§£é‡‹ï¼‰";

      // æ˜Ÿæ›œè§£é‡‹
      let starsHtml = "";
      if (stars.length === 0) {
        starsHtml = `
          <div class="p-3 rounded-xl bg-slate-900/70 border border-slate-700 text-[11px] text-slate-200 leading-relaxed">
            <div class="font-semibold text-amber-200 mb-1">ç©ºå®®</div>
            <div>
              ç©ºå®®ä¸ç­‰æ–¼æ²’æœ‰äº‹ä»¶ï¼Œé‡é»æ˜¯çœ‹ä¸‰æ–¹å››æ­£èˆ‡æµæœˆç¯€å¥å¦‚ä½•å¼•å‹•ï¼Œ
              ä»¥åŠè©²å®®å°æ‡‰çš„ã€Œåç¥ä¸»è»¸ã€åœ¨ä»Šå¹´å¦‚ä½•è¢«è§¸ç™¼ã€‚
            </div>
          </div>
        `;
      } else {
        starsHtml = stars.map(s => {
          const desc =
            DB_CONTENT.stars[s] ||
            "ï¼ˆè³‡æ–™åº«å°šæœªå¡«å…¥æ­¤æ˜Ÿæ›œè§£é‡‹ï¼Œå…ˆæŠŠå®ƒç•¶ä½œä½ çš„å›ºå®šèƒ½åŠ›ï¼è³‡æºï¼Œè§€å¯Ÿ 2026 å¦‚ä½•è¢«ç´…ç¶ ç‡ˆæœˆä»½æ¨å‹•ã€‚ï¼‰";
          return `
            <div class="p-3 rounded-xl bg-slate-900/70 border border-slate-700 text-[11px] leading-relaxed">
              <div class="font-semibold text-amber-200 mb-1">ã€${s}ã€‘</div>
              <div class="text-slate-200">${desc}</div>
            </div>
          `;
        }).join("");
      }

      contentEl.innerHTML = `
        <div class="space-y-3">
          <div>
            <div class="text-[10px] text-slate-500 font-bold mb-1 tracking-[0.16em] uppercase">è³‡æ–™åº«å®®ä½è§£é‡‹</div>
            <p class="text-[13px] leading-relaxed text-slate-100">${palaceDesc}</p>
          </div>
          <div>
            <div class="text-[10px] text-slate-500 font-bold mb-2 tracking-[0.16em] uppercase">æ˜Ÿæ›œè§£é‡‹ï¼ˆè³‡æ–™åº«ï¼‰</div>
            <div class="space-y-2">${starsHtml}</div>
          </div>
        </div>
      `;

      // ä¸‰æ–¹å››æ­£æ¨™è¨˜
      const mainIndex = index;
      const related = [mainIndex, (mainIndex + 6) % 12, (mainIndex + 4) % 12, (mainIndex + 8) % 12];
      document.querySelectorAll(".zw-palace").forEach((el, idx) => {
        el.classList.remove("is-active", "is-related");
        if (idx === mainIndex) el.classList.add("is-active");
        else if (related.includes(idx)) el.classList.add("is-related");
      });

      // æµæœˆç›’ï¼šç›´æ¥ç”¨ GLOBAL_LIUYUE åš quick reference
      rhythmBox.innerHTML = GLOBAL_LIUYUE.map(m => {
        const isRed = m.light === "RED";
        const tag = isRed ? "å®ˆè¦å‰‡" : "æ¨é€²";
        return `
          <div class="flex items-center justify-between p-2 rounded-lg bg-slate-900/70 border border-slate-700">
            <div class="flex items-center gap-2">
              <span class="month-dot ${isRed ? "bg-red-light" : "bg-green-light"}"></span>
              <span class="font-semibold">${m.gz}</span>
              <span class="text-[10px] text-slate-400">${m.range || ""}</span>
            </div>
            <div class="text-[10px] font-bold ${isRed ? "text-red-400" : "text-emerald-400"}">${tag}</div>
          </div>
        `;
      }).join("");
    }

    /** ===== 2026 æµæœˆå¡ç‰‡ ===== */
    function renderMonths(bounds) {
      GLOBAL_LIUYUE = bounds || [];
      const box = document.getElementById("monthsList");
      box.innerHTML = "";

      if (!bounds || !bounds.length) {
        box.innerHTML = '<p class="text-xs text-slate-500 italic">ï¼ˆæš«ç„¡æµæœˆè³‡æ–™ï¼‰</p>';
        return;
      }

      bounds.forEach(b => {
        const isRed = b.light === "RED";
        box.innerHTML += `
          <div class="flex items-center justify-between p-3 rounded-xl border ${isRed ? "border-red-500/60 bg-red-500/10" : "border-emerald-500/60 bg-emerald-500/10"}">
            <div>
              <div class="font-semibold text-sm">
                ${b.gz}
                <span class="text-[11px] text-slate-200 ml-1">${b.range || ""}</span>
              </div>
              <div class="text-[11px] text-slate-200 mt-0.5">
                æœ¬æ°£ï¼š${b.ssBranch || ""} Â· ${
                  isRed ? "å£“åŠ›æœˆï¼šå®ˆè¦å‰‡ã€èª¿æ•´ç¯€å¥ã€ä¸è¦ç¡¬æ’ã€‚"
                        : "ç©©é€²æœˆï¼šé©åˆæ¨é€²å°ˆæ¡ˆã€è«‡åˆä½œèˆ‡æ”¶å‰²æˆæœã€‚"
                }
              </div>
            </div>
            <span class="text-[11px] font-bold px-3 py-1 rounded-full bg-black/40">
              ${isRed ? "ğŸ”´ å£“åŠ›" : "ğŸŸ¢ ç©©é€²"}
            </span>
          </div>
        `;
      });
    }

    /** ===== åç¥æŒ‡ä»¤ ===== */
    function renderTenGodAdvice(dominant) {
      GLOBAL_TENGOD_DOMINANT = dominant || "";
      const box = document.getElementById("tenGodAdvice");
      const fromDb = DB_CONTENT.tenGods[dominant] || "";
      if (!dominant) {
        box.textContent = "åç¥ä¸»è»¸æš«æ™‚æœªè¾¨è­˜ï¼Œä¹‹å¾Œå¯ä»¥è£œä¸Šæ›´å®Œæ•´çš„å‘½ç›¤è³‡æ–™ä¾†å¼·åŒ–è§£è®€ã€‚";
        return;
      }
      if (fromDb) {
        box.textContent = fromDb;
      } else {
        box.textContent = `2026 ä¸™åˆå¹´å°ä½ çš„ã€Œ${dominant}ã€ä¸»è»¸ä¾†èªªï¼Œæ˜¯é‡æ–°æª¢æŸ¥æµç¨‹èˆ‡è³‡æºé…ç½®çš„ä¸€å¹´ã€‚å¯ä»¥å…ˆæŠŠæ‰€æœ‰æˆ°ç·šæ”¶æ–‚æˆå°‘æ•¸å¹¾æ¢å¯ä»¥ç©©å®šåŸ·è¡Œçš„ç¯€å¥ã€‚`;
      }
    }

    /** ===== ä¸»æµç¨‹ï¼šè¨ˆç®— ===== */
    async function calculate() {
      const btn = document.getElementById("btnLaunch");
      const hint = document.getElementById("hint");

      const vy = Number(document.getElementById("birthYear").value);
      const vm = Number(document.getElementById("birthMonth").value);
      const vd = Number(document.getElementById("birthDay").value);
      const vh = Number(document.getElementById("birthHour").value);
      const vmin = Number(document.getElementById("birthMinute").value);

      if (![vy, vm, vd, vh, vmin].every(n => Number.isFinite(n))) {
        hint.textContent = "è«‹å…ˆé¸å¥½å®Œæ•´çš„å‡ºç”Ÿå¹´æœˆæ—¥èˆ‡æ™‚é–“ã€‚";
        return;
      }

      const originalText = btn.innerText;
      try {
        btn.disabled = true;
        btn.innerText = "è¨ˆç®—ä¸­â€¦";
        hint.textContent = "æ­£åœ¨åŒæ­¥å…«å­—ï¼‹ç´«å¾®å‘½ç›¤ï¼‹2026 æµæœˆï¼Œè«‹ç¨å€™â€¦";

        // 1) å¾Œç«¯ç®—å…«å­—ï¼æµæœˆï¼åç¥
        const resp = await fetch(`${API_BASE}/compute/all`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({
            year: vy,
            month: vm,
            day: vd,
            hour: vh,
            minute: vmin
          })
        });
        const payload = await resp.json();
        if (!payload.ok) throw new Error(payload.error || "API error");

        const contract = payload.features;
        const bazi = contract.bazi;
        const serverZiwei = contract.ziwei || null;

        // 2) å‰ç«¯ iztro ç®—ç´«å¾®ï¼ˆåªç”¨é€™å€‹ä¾†ç•« 12 å®®æ˜Ÿæ›œï¼‰
        const ziweiLocal = buildZiweiLocal(vy, vm, vd, vh, vmin);

        // 3) è³‡æ–™åº«å…§å®¹ï¼ˆåªè¼‰ä¸€æ¬¡ï¼‰
        await loadContentOnce();

        // å¡«å››æŸ±
        const disp = bazi.display || {};
        document.getElementById("yG").innerText = disp.yG || "";
        document.getElementById("yZ").innerText = disp.yZ || "";
        document.getElementById("mG").innerText = disp.mG || "";
        document.getElementById("mZ").innerText = disp.mZ || "";
        document.getElementById("dG").innerText = disp.dG || "";
        document.getElementById("dZ").innerText = disp.dZ || "";
        document.getElementById("hG").innerText = disp.hG || "";
        document.getElementById("hZ").innerText = disp.hZ || "";

        document.getElementById("birthSummary").innerText =
          `${vy} / ${String(vm).padStart(2,"0")} / ${String(vd).padStart(2,"0")}  Â·  ${String(vh).padStart(2,"0")}:${String(vmin).padStart(2,"0")}`;

        // äº”è¡Œæ¢ & èªªæ˜
        renderBar("strategicWx", bazi.wuxing?.strategic || {}, bazi.wuxing?.maxStrategic || 1);
        renderWuxingLegend();

        // åç¥æŒ‡ä»¤
        const dominant = (bazi.tenGod?.dominant || "").trim();
        renderTenGodAdvice(dominant);

        // æµæœˆ
        renderMonths(bazi.liuyue2026?.bounds || []);

        // ç´«å¾®ç›¤
        renderZiweiGrid(ziweiLocal, serverZiwei?.core || null);
        // é è¨­é¸å‘½å®®
        const defaultStars = ziweiLocal?.palacesMap?.["å‘½å®®"] || [];
        onPalaceClick("å‘½å®®", defaultStars, 0);

        // é¡¯ç¤º workspaceï¼Œæ”¶åˆè¼¸å…¥å¡
        document.getElementById("workspace").classList.remove("hidden");
        document.getElementById("inputSection").classList.add("md:opacity-60");
        document.getElementById("workspace").scrollIntoView({ behavior: "smooth", block: "start" });
        hint.textContent = "";
      } catch (e) {
        console.error(e);
        alert("ç³»çµ±å¿™ç¢Œä¸­æˆ–è³‡æ–™æœ‰èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚\n\nè©³ç´°è¨Šæ¯ï¼š" + (e?.message || e));
        hint.textContent = "";
      } finally {
        btn.disabled = false;
        btn.innerText = originalText;
      }
    }

    /** ===== åˆå§‹åŒ–æ—¥æœŸé¸å–® ===== */
    function initSelectors() {
      const y = document.getElementById("birthYear");
      const m = document.getElementById("birthMonth");
      const d = document.getElementById("birthDay");
      const h = document.getElementById("birthHour");
      const min = document.getElementById("birthMinute");

      const thisYear = new Date().getFullYear();
      for (let i = thisYear; i >= 1940; i--) {
        y.add(new Option(i + " å¹´", i));
      }
      for (let i = 1; i <= 12; i++) {
        m.add(new Option(i + " æœˆ", i));
      }
      for (let i = 0; i < 24; i++) {
        h.add(new Option(String(i).padStart(2,"0") + " æ™‚", i));
      }
      ["00","15","30","45"].forEach(v => {
        min.add(new Option(v + " åˆ†", Number(v)));
      });

      y.value = "1990";
      m.value = "1";
      h.value = "12";
      min.value = 0;

      const updateDays = () => {
        const year = Number(y.value);
        const month = Number(m.value);
        const cur = d.value;
        d.innerHTML = "";
        const days = new Date(year, month, 0).getDate();
        for (let i = 1; i <= days; i++) {
          const opt = new Option(i + " æ—¥", i);
          if (String(i) === cur) opt.selected = true;
          d.add(opt);
        }
        if (!d.value) d.value = String(Math.min(Number(cur) || 1, days));
      };
      y.addEventListener("change", updateDays);
      m.addEventListener("change", updateDays);
      updateDays();
    }

    document.addEventListener("DOMContentLoaded", () => {
      initSelectors();
      document.getElementById("btnLaunch").addEventListener("click", calculate);
    });
  </script>
</body>
</html>
