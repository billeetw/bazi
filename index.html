<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¸€èµ·å‡ºä¾†ç© Â· 2026 æˆ°ç•¥å°èˆª</title>

  <!-- Tailwind (é–‹ç™¼ç”¨ï¼›ä¹‹å¾Œå¯ä»¥æ”¹æˆç·¨è­¯ç‰ˆ) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
      color: #e2e8f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }
    .glass {
      background: rgba(15,23,42,0.88);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 24px 60px rgba(15,23,42,0.85);
    }
    .bazi-char {
      font-size: 1.9rem;
      font-weight: 900;
      line-height: 1.05;
      letter-spacing: .08em;
    }
    .wuxing-æœ¨{background:#22c55e}
    .wuxing-ç«{background:#f97373}
    .wuxing-åœŸ{background:#eab308}
    .wuxing-é‡‘{background:#e5e7eb}
    .wuxing-æ°´{background:#60a5fa}

    /* Top sticky nav */
    .nav-bar {
      background: linear-gradient(90deg, #ef4444, #f97316, #ef4444);
      color: #fff;
      padding: 10px 16px;
      position: sticky;
      top: 0;
      z-index: 40;
      box-shadow: 0 4px 20px rgba(220,38,38,0.6);
    }

    /* Section title subtitle */
    .section-subtitle {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #94a3b8;
    }

    /* ============ äº”è¡Œæ˜Ÿæ›œé¡è‰² ============ */
    .star-wx-æœ¨ { color: #86efac; text-shadow: 0 0 5px rgba(34,197,94,0.5); }
    .star-wx-ç« { color: #fca5a5; text-shadow: 0 0 5px rgba(239,68,68,0.5); }
    .star-wx-åœŸ { color: #fde047; text-shadow: 0 0 5px rgba(234,179,8,0.5); }
    .star-wx-é‡‘ { color: #e2e8f0; text-shadow: 0 0 5px rgba(255,255,255,0.5); }
    .star-wx-æ°´ { color: #93c5fd; text-shadow: 0 0 5px rgba(59,130,246,0.5); }

    /* ============ ç´«å¾® 12 å®®æ ¼å®¹å™¨ ============ */
    .zw-grid-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 8px;
      width: 100%;
      max-width: 520px;
      aspect-ratio: 1/1;
      margin: 0 auto;
    }

    .zw-palace {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.85rem;
      padding: 8px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .zw-palace:hover {
      transform: translateY(-2px);
      border-color: rgba(248,250,252,0.8);
      box-shadow: 0 10px 30px rgba(15,23,42,0.7);
    }

    /* å®®ä½äº”è¡Œèƒ½é‡ç™¼å…‰ç‰¹æ•ˆ */
    .zw-palace::before {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      width: 150%; height: 150%;
      transform: translate(-50%, -50%);
      opacity: 0;
      transition: opacity 0.5s ease;
      z-index: -1;
      pointer-events: none;
    }
    [class*="palace-glow-"]::before { opacity: 1; }
    .palace-glow-æœ¨::before {
      background: radial-gradient(circle, rgba(34,197,94,0.18) 0%, transparent 70%);
    }
    .palace-glow-ç«::before {
      background: radial-gradient(circle, rgba(239,68,68,0.20) 0%, transparent 70%);
    }
    .palace-glow-åœŸ::before {
      background: radial-gradient(circle, rgba(234,179,8,0.20) 0%, transparent 70%);
    }
    .palace-glow-é‡‘::before {
      background: radial-gradient(circle, rgba(248,250,252,0.18) 0%, transparent 70%);
    }
    .palace-glow-æ°´::before {
      background: radial-gradient(circle, rgba(59,130,246,0.20) 0%, transparent 70%);
    }

    .zw-palace-key {
      border-color: rgba(251, 191, 36, 0.8);
      box-shadow: inset 0 0 16px rgba(251, 191, 36, 0.25);
    }

    /* ä¸­å¿ƒå€åŸŸï¼ˆå‘½èº«ï¼‹äº”è¡Œå±€ï¼‰ */
    .zw-center-block {
      grid-area: 2 / 2 / 4 / 4;
      background: radial-gradient(circle, #1e293b 35%, #020617 100%);
      border: 1px dashed rgba(148, 163, 184, 0.5);
      border-radius: 1.1rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 12px;
      z-index: 10;
    }
    .zw-center-block-badge {
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #64748b;
    }

    @media (max-width: 400px) {
      .bazi-char { font-size: 1.6rem; }
      .zw-palace div { font-size: 11px; }
    }
  </style>
</head>

<body class="pb-16">

  <!-- NAV BAR -->
  <div class="nav-bar flex items-center justify-between">
    <div class="flex items-center gap-2 text-xs">
      <span class="font-black tracking-[0.18em] text-[10px] uppercase">ä¸€èµ·å‡ºä¾†ç©</span>
      <span class="text-[10px] opacity-80">2026 æˆ°ç•¥å°èˆª</span>
    </div>
    <div class="hidden md:flex gap-3 text-[11px] font-medium">
      <a href="#bazi"   class="hover:underline">å››æŸ±</a>
      <a href="#ziwei"  class="hover:underline">ç´«å¾®å‘½ç›¤</a>
      <a href="#wuxing" class="hover:underline">äº”è¡Œ</a>
      <a href="#liuyue" class="hover:underline">2026 æµæœˆ</a>
      <a href="#cta"    class="hover:underline">é ç´„è«®è©¢</a>
    </div>
  </div>

  <main class="max-w-4xl mx-auto px-4 pt-6 space-y-8">

    <header class="text-center space-y-2">
      <p class="section-subtitle">2026 Strategic Astrolabe</p>
      <h1 class="text-3xl md:text-4xl font-black tracking-tight">
        2026 æµå¹´æˆ°ç•¥å ±å‘Š
      </h1>
      <p class="text-sm text-slate-400">
        ä¸€æ¬¡çœ‹æ‡‚ä½ çš„å…«å­—ç¯€å¥ï¼‹ç´«å¾®å‘½ç›¤ï¼Œå¹«ä½ æ‰¾åˆ°ä»Šå¹´æœ€é †çš„å‰é€²æ–¹å¼ã€‚
      </p>
    </header>

    <!-- è¼¸å…¥å€ -->
    <section class="glass p-6 rounded-2xl space-y-4">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="section-subtitle mb-1">Basic Info</div>
          <h2 class="text-lg font-bold">è¼¸å…¥ä½ çš„å‡ºç”Ÿè³‡æ–™</h2>
        </div>
        <div class="text-[10px] text-slate-400 text-right">
          ç›®å‰ç‰ˆæœ¬ï¼šåŒæ­¥è¨ˆç®—<br/>å…«å­—ï¼‹ç´«å¾®å‘½ç›¤
        </div>
      </div>

      <div class="grid grid-cols-3 gap-2 mb-2">
        <select id="birthYear"  class="bg-black/40 p-2 rounded text-sm"></select>
        <select id="birthMonth" class="bg-black/40 p-2 rounded text-sm" onchange="updateDays()"></select>
        <select id="birthDay"   class="bg-black/40 p-2 rounded text-sm"></select>
      </div>

      <div class="grid grid-cols-3 gap-2 mb-2">
        <select id="birthHour"   class="bg-black/40 p-2 rounded text-sm col-span-2"></select>
        <select id="birthMinute" class="bg-black/40 p-2 rounded text-sm"></select>
      </div>

      <div class="flex items-center justify-between gap-3">
        <button
          id="btnLaunch"
          class="flex-1 bg-amber-500 hover:bg-amber-400 text-black py-3 rounded-xl font-black text-sm tracking-[0.2em] uppercase transition disabled:opacity-60 disabled:cursor-not-allowed"
        >
          ç”Ÿæˆæˆ‘çš„ 2026 æˆ°ç•¥
        </button>
      </div>

      <p id="hint" class="text-xs text-slate-400 italic mt-1 min-h-[1.2em]"></p>
    </section>

    <!-- å ±å‘Šå€ -->
    <section id="report" class="space-y-8 hidden">

      <!-- å…«å­—å››æŸ± -->
      <section id="bazi" class="glass p-6 rounded-2xl space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="section-subtitle mb-1">Four Pillars</div>
            <h2 class="font-bold text-lg">å…«å­— Â· å››æŸ±ç¯€å¥</h2>
          </div>
          <div class="text-[11px] text-slate-400" id="metaInfo"></div>
        </div>

        <div class="grid grid-cols-4 text-center gap-2">
          <div>
            <div class="bazi-char" id="yG"></div>
            <div class="text-sm text-slate-300" id="yZ"></div>
            <div class="text-[10px] text-slate-500 mt-1">å¹´æŸ±</div>
          </div>
          <div>
            <div class="bazi-char" id="mG"></div>
            <div class="text-sm text-slate-300" id="mZ"></div>
            <div class="text-[10px] text-slate-500 mt-1">æœˆæŸ±</div>
          </div>
          <div>
            <div class="bazi-char text-amber-400" id="dG"></div>
            <div class="text-sm text-slate-300" id="dZ"></div>
            <div class="text-[10px] text-amber-300 mt-1">æ—¥ä¸»</div>
          </div>
          <div>
            <div class="bazi-char" id="hG"></div>
            <div class="text-sm text-slate-300" id="hZ"></div>
            <div class="text-[10px] text-slate-500 mt-1">æ™‚æŸ±</div>
          </div>
        </div>
      </section>

      <!-- ç´«å¾®å‘½ç›¤ Â· 12 å®®æ ¼ -->
      <section id="ziwei" class="glass p-6 rounded-2xl space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="section-subtitle mb-1">Zi Wei Dou Shu</div>
            <h2 class="font-bold text-lg">ç´«å¾®å‘½ç›¤ Â· 12 å®®ç¸½è¦½</h2>
          </div>
          <div id="ziweiSummary" class="text-[11px] text-slate-400"></div>
        </div>

        <div id="ziweiGrid" class="zw-grid-container">
          <!-- JS æœƒå¡«å…¥ -->
        </div>

        <div id="ziweiTend" class="text-xs text-slate-400 mt-3"></div>
      </section>

      <!-- äº”è¡Œèƒ½é‡ -->
      <section id="wuxing" class="glass p-6 rounded-2xl space-y-4">
        <div>
          <div class="section-subtitle mb-1">Five Elements</div>
          <h2 class="font-bold text-lg">äº”è¡Œèƒ½é‡é…ç½®</h2>
        </div>

        <div>
          <div class="text-xs text-slate-400 mb-1">è¡¨å±¤çµæ§‹ï¼ˆçœ‹èµ·ä¾†çš„å€‹æ€§ï½œå››æŸ±å¤©å¹²ï¼‰</div>
          <div id="surfaceWx" class="space-y-2"></div>
        </div>

        <div>
          <div class="text-xs text-slate-400 mb-1 mt-3">å¯¦æˆ°çµæ§‹ï¼ˆå¯¦éš›å‡ºæ‰‹æ–¹å¼ï½œå¤©å¹²ï¼‹è—å¹²ï¼‹æœˆä»¤åŠ æ¬Šï¼‰</div>
          <div id="strategicWx" class="space-y-2"></div>
        </div>
      </section>

      <!-- 2026 æµæœˆ -->
      <section id="liuyue" class="glass p-6 rounded-2xl space-y-4">
        <div>
          <div class="section-subtitle mb-1">2026 Monthly Flow</div>
          <h2 class="font-bold text-lg">2026 æµæœˆç¯€å¥ï¼ˆ12ï¼‰</h2>
          <p class="text-xs text-slate-400 mt-1">ğŸ”´ å£“åŠ›æœˆï¼šå…ˆå®ˆè¦å‰‡ï¼ğŸŸ¢ ç©©é€²æœˆï¼šé©åˆæ¨é€²å°ˆæ¡ˆ</p>
        </div>
        <div id="monthGrid" class="space-y-2"></div>
      </section>

      <!-- æˆ°ç•¥è§£è®€ -->
      <section id="analysis" class="glass p-6 rounded-2xl space-y-4">
        <div>
          <div class="section-subtitle mb-1">Strategic Reading</div>
          <h2 class="font-bold text-lg">2026 æˆ°ç•¥è§£è®€ï¼ˆåˆç‰ˆï¼‰</h2>
        </div>
        <div id="analysisBox" class="space-y-2 text-sm text-slate-100"></div>
      </section>

      <!-- CTA -->
      <section id="cta" class="glass p-6 rounded-2xl space-y-4">
        <div>
          <div class="section-subtitle mb-1">1:1 Consulting</div>
          <h2 class="font-bold text-lg">æƒ³æŠŠé€™ä»½æˆ°ç•¥è®Šæˆã€Œå¯ä¿ç”¨ä¸€ç”Ÿã€çš„èªªæ˜æ›¸ï¼Ÿ</h2>
        </div>
        <p class="text-sm text-slate-200">
          å¦‚æœä½ å¸Œæœ›æˆ‘æŠŠä½ çš„å‘½æ ¼çµ„æˆã€äººç”Ÿå¤§é‹ã€æµå¹´æµæœˆã€ç”Ÿæ¶¯è¦åŠƒå’Œæœ€é©åˆè‡ªå·±çš„äººç”Ÿç¯€å¥ï¼Œ
          åšæˆå¯ä¿ç”¨ä¸€ç”Ÿçš„ 50 é äººç”Ÿä½¿ç”¨èªªæ˜æ›¸ï¼Œæ­¡è¿é ç´„ç·šä¸Šè«®è©¢ã€‚
        </p>
        <a
          href="https://forms.gle/UVCSq1udEC549gzYA"
          target="_blank"
          class="inline-flex items-center justify-center px-4 py-3 rounded-xl bg-amber-400 text-black font-bold text-sm hover:bg-amber-300 transition shadow-lg shadow-amber-500/40"
        >
          é ç´„èˆ‡æä¼¯å½¥è€å¸«ç·šä¸Šè«®è©¢
        </a>
      </section>
    </section>
  </main>

  <!-- ========= iztroï¼šå‰ç«¯è¨ˆç®—ç´«å¾®ï¼Œè¼¸å‡º ziwei_features_v1 ========= -->
  <script type="module">
    import { astro } from "https://cdn.skypack.dev/iztro@2.4.7";

    // ç°¡é«”å®®å -> ç¹é«”å®®å
    const PALACE_NAME_MAP = {
      "å‘½å®«": "å‘½å®®",
      "å…„å¼Ÿ": "å…„å¼Ÿ",
      "å¤«å¦»": "å¤«å¦»",
      "å­å¥³": "å­å¥³",
      "è´¢å¸›": "è²¡å¸›",
      "ç–¾å„": "ç–¾å„",
      "è¿ç§»": "é·ç§»",
      "ä»†å½¹": "åƒ•å½¹",
      "å®˜ç¦„": "å®˜ç¥¿",
      "ç”°å®…": "ç”°å®…",
      "ç¦å¾·": "ç¦å¾·",
      "çˆ¶æ¯": "çˆ¶æ¯",
    };

    // å¾ˆç²—ç•¥çš„å‚¾å‘æ¨™è¨˜ï¼ˆå…ˆçµ¦ fallbackï¼Œä¹‹å¾Œä½ å¯ä»¥ç”¨è‡ªå·±çš„è¦å‰‡èª¿æ•´ï¼‰
    function roughTendencies(astrolabe) {
      return {
        risk: "mid",
        authority: "mid",
        mobility: "mid",
      };
    }

    /**
     * ä¾ç…§å…¬æ›†ï¼‹æ™‚ï¼Œä½¿ç”¨ iztro ç®—å‡ºä¸€ä»½ ziwei_features_v1
     * æœƒæ›åœ¨ window.buildZiweiFeaturesLocal çµ¦é module script ä½¿ç”¨
     */
    function buildZiweiFeaturesLocal(year, month, day, hour) {
      try {
        const solar = `${year}-${month}-${day}`;
        // iztro çš„æ™‚è¾°æ˜¯ 0â€“11ï¼ˆå­ä¸‘å¯…å¯...ï¼‰ï¼Œé€™è£¡ç”¨ã€Œå°æ™‚ / 2ã€ç²—ç•¥åˆ‡
        const timeIndex = Math.floor(hour / 2);
        const gender = "male"; // å…ˆå¯«æ­»ï¼Œä½ ä¹‹å¾Œå¯ä»¥å¾ UI åŠ é¸æ“‡

        const astrolabe = astro.astrolabeBySolarDate(solar, timeIndex, gender);

        const core = {
          minggong: (astrolabe.earthlyBranchOfSoulPalace || "") + "å‘½å®®",
          shengong: (astrolabe.earthlyBranchOfBodyPalace || "") + "èº«å®®",
          wuxingju: astrolabe.fiveElementsClass || "",
        };

        const mainStars = {};
        (astrolabe.palaces || []).forEach((p) => {
          const stars = (p.majorStars || []).map((s) => s.name);
          const simpName = p.name;
          const tradName = PALACE_NAME_MAP[p.name] || p.name;
          mainStars[simpName] = stars;
          mainStars[tradName] = stars;
        });

        return {
          version: "ziwei_features_v1",
          core,
          mainStars,
          tendencies: roughTendencies(astrolabe),
        };
      } catch (e) {
        console.error("buildZiweiFeaturesLocal error:", e);
        return undefined;
      }
    }

    // æ›åˆ° window çµ¦ä¸‹æ–¹ script ç”¨
    // @ts-ignore
    window.buildZiweiFeaturesLocal = buildZiweiFeaturesLocal;
  </script>

  <!-- ========= ä¸»è…³æœ¬ï¼šå…«å­— + ç´«å¾® + UI ========= -->
  <script>
    const API_BASE = "https://17gonplay-api.billeetw.workers.dev";

    /* ========= å·¥å…·ï¼šäº”è¡Œé•·æ¢ ========= */
    function renderBar(id, data, max) {
      const box = document.getElementById(id);
      if (!box) return;
      box.innerHTML = "";
      ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(e => {
        const v = Number(data?.[e] || 0);
        const w = max ? Math.max(2, (v / max) * 100) : 0;
        box.innerHTML += `
          <div class="mb-1">
            <div class="flex justify-between text-xs">
              <span>${e}</span>
              <span>${v.toFixed(1)}</span>
            </div>
            <div class="h-2 bg-white/10 rounded overflow-hidden">
              <div class="h-full wuxing-${e}" style="width:${w}%"></div>
            </div>
          </div>
        `;
      });
    }

    <script>
// ========= ç´«å¾® 12 å®®ï¼šå‰ç«¯æ¸²æŸ“å±¤ =========

// å‰ç«¯ã€Œæ¨™æº–ã€12 å®®åç¨±ï¼ˆä½ æ ¼å­ä¸Šè¦çœ‹åˆ°çš„é‚£ 12 å€‹å­—ï¼‰
const PALACE_ORDER = [
  "å‘½å®®","å…„å¼Ÿ","å¤«å¦»","å­å¥³",
  "è²¡å¸›","ç–¾å„","é·ç§»","åƒ•å½¹",
  "å®˜ç¥¿","ç”°å®…","ç¦å¾·","çˆ¶æ¯"
];

// å¾å¾Œç«¯/iztro å›ä¾†ï¼Œå¯èƒ½å‡ºç¾çš„å„ç¨®åå­— â†’ å°æ˜ åˆ°æ¨™æº–å®®å
const PALACE_ALIASES = {
  "å‘½å®®": ["å‘½å®®","å‘½"],
  "å…„å¼Ÿ": ["å…„å¼Ÿ","å…„å¼Ÿå®®"],
  "å¤«å¦»": ["å¤«å¦»","å¤«å¦»å®®"],
  "å­å¥³": ["å­å¥³","å­å¥³å®®"],
  "è²¡å¸›": ["è²¡å¸›","è²¡å¸›å®®","è²¡å¸›ä½"],
  "ç–¾å„": ["ç–¾å„","ç–¾å„å®®","ç–¾ç–¾ç—…"],
  "é·ç§»": ["é·ç§»","é·ç§»å®®","é·å¾™","é·ç§»ä½"],
  "åƒ•å½¹": ["åƒ•å½¹","ä»†å½¹","äº¤å‹","äº¤å‹å®®","æœ‹å‹"],
  "å®˜ç¥¿": ["å®˜ç¥¿","äº‹æ¥­","äº‹æ¥­å®®","å®˜ç¥¿å®®","å®˜ç¥¿ä½"],
  "ç”°å®…": ["ç”°å®…","ç”°å®…å®®","ä¸å‹•ç”¢","æˆ¿ç”¢"],
  "ç¦å¾·": ["ç¦å¾·","ç¦å¾·å®®","ç¦ç¥¿"],
  "çˆ¶æ¯": ["çˆ¶æ¯","çˆ¶æ¯å®®","çˆ¶æ¯ä½"]
};

// 12 å®®æ ¼å­åœ¨ grid ä¸­çš„ä½ç½®ï¼ˆä½ åŸæœ¬çš„é…ç½®å¯ä¿ç•™ï¼‰
const ZW_GRID_AREAS = [
  "1/1/2/2","1/2/2/3","1/3/2/4","1/4/2/5", // ä¸Šæ’ 4 æ ¼
  "2/4/3/5","3/4/4/5","4/4/5/5",          // å³å´ 3 æ ¼
  "4/3/5/4","4/2/5/3","4/1/5/2",          // ä¸‹æ’ 3 æ ¼
  "3/1/4/2","2/1/3/2"                     // å·¦å´ 2 æ ¼
];

// 14 ä¸»æ˜Ÿçš„äº”è¡Œï¼ˆç”¨ä¾†åšé¡è‰²ï¼‹å…‰æšˆï¼‰
// æœ‰ç¼ºä½ å¯ä»¥å†è‡ªå·±è£œ
const STAR_WUXING_MAP = {
  "ç´«å¾®": "åœŸ", "å¤©æ©Ÿ": "æœ¨", "å¤ªé™½": "ç«", "æ­¦æ›²": "é‡‘", "å¤©åŒ": "æ°´",
  "å»‰è²": "ç«", "å¤©åºœ": "åœŸ", "å¤ªé™°": "æ°´", "è²ªç‹¼": "æœ¨",
  "å·¨é–€": "æ°´", "å¤©ç›¸": "æ°´", "å¤©æ¢": "åœŸ", "ä¸ƒæ®º": "é‡‘", "ç ´è»": "æ°´",
  // å‰¯æ˜Ÿæƒ³åŠ ä¹Ÿè¡Œ
  "æ–‡æ˜Œ": "æœ¨", "æ–‡æ›²": "æ°´", "ç¥¿å­˜": "åœŸ"
};

// çµ¦ä¸€å€‹å·¥å…·ï¼šå¾ mainStars è£¡ï¼Œæ‰¾å‡ºå°æ‡‰æŸå€‹æ¨™æº–å®®åçš„ã€Œç¬¬ä¸€å€‹æœ‰æ±è¥¿çš„ keyã€
function pickStarsForPalace(ziweiMainStars, canonicalName) {
  const aliases = PALACE_ALIASES[canonicalName] || [canonicalName];
  for (const key of aliases) {
    const list = ziweiMainStars?.[key];
    if (Array.isArray(list) && list.length > 0) {
      return list;
    }
  }
  // å®Œå…¨æ²’æ‰¾åˆ° â†’ å›å‚³ç©ºé™£åˆ—ï¼Œå‰ç«¯å°±æœƒé¡¯ç¤ºã€Œç©ºå®®ã€
  return [];
}

// â­ ä¸»æ¸²æŸ“å‡½æ•¸ï¼š12 å®®ç´«å¾®æ–¹ç›¤
function renderZiwei(ziwei) {
  const container = document.getElementById("ziweiGrid"); // ç¢ºèªä½ çš„ HTML å®¹å™¨ id æ˜¯é€™å€‹
  const summary   = document.getElementById("ziweiSummary");
  const tendBox   = document.getElementById("ziweiTend");

  if (!container) return;

  if (!ziwei) {
    container.className = "zw-grid-container";
    container.innerHTML = `
      <div class="zw-center-block">
        <div class="zw-center-block-badge">Zi Wei Dou Shu</div>
        <div class="mt-2 text-sm text-slate-300">ï¼ˆç›®å‰å°šæœªå–å¾—ç´«å¾®è³‡æ–™ï¼Œä¹‹å¾Œå¯æ¥ iztro å®Œæ•´å‘½ç›¤ï¼‰</div>
      </div>
    `;
    if (summary) {
      summary.innerHTML = `<p class="text-xs text-slate-400">ç´«å¾®å‘½ç›¤å°šæœªå•Ÿç”¨ï¼Œç›®å‰åƒ…ä½¿ç”¨å…«å­—åš 2026 æˆ°ç•¥å°èˆªã€‚</p>`;
    }
    return;
  }

  const mainStarsData = ziwei.mainStars || {};
  container.className = "zw-grid-container";
  container.innerHTML = "";

  // ğŸ‘‰ Debug ç”¨ï¼šä½ å¯ä»¥æ‰“é–‹ console çœ‹çœŸæ­£æœ‰å“ªäº› key
  console.log("[Ziwei] mainStars keys:", Object.keys(mainStarsData));

  // 12 å®®æ ¼
  PALACE_ORDER.forEach((name, idx) => {
    const starsList = pickStarsForPalace(mainStarsData, name);
    const isKey = ["å‘½å®®","å®˜ç¥¿","è²¡å¸›"].includes(name);
    let palaceMainElement = ""; // ç”¨ä¾†æ±ºå®šå…‰æšˆäº”è¡Œ

    const starsHtml = starsList.length
      ? starsList.map((starName, i) => {
          const wx = STAR_WUXING_MAP[starName] || "";
          if (i === 0 && wx) palaceMainElement = wx;
          return `<span class="${wx ? "star-wx-" + wx : ""}">${starName}</span>`;
        }).join("<br>")
      : `<span class="text-slate-600 text-[11px] italic">ç©ºå®®</span>`;

    const glowClass = palaceMainElement ? `palace-glow-${palaceMainElement}` : "";

    container.innerHTML += `
      <div class="zw-palace ${isKey ? "zw-palace-key" : ""} ${glowClass}"
           style="grid-area:${ZW_GRID_AREAS[idx]}">
        <div class="text-[10px] font-bold text-slate-400 mb-1">${name}</div>
        <div class="text-[13px] font-black leading-snug tracking-wide">
          ${starsHtml}
        </div>
      </div>
    `;
  });

  // ä¸­é–“ core å€
  container.innerHTML += `
    <div class="zw-center-block">
      <div class="zw-center-block-badge">Destiny Core</div>
      <div class="mt-2 text-amber-400 font-black text-xl tracking-wider">
        ${ziwei.core?.minggong || "â€”"}
      </div>
      <div class="mt-1 text-[11px] text-slate-300">
        èº«å®®ï¼š${ziwei.core?.shengong || "â€”"}
      </div>
      <div class="mt-1 text-[10px] text-slate-400">
        ${ziwei.core?.wuxingju || "â€”"}å±€
      </div>
    </div>
  `;

  // å³å´æ‘˜è¦ï¼ˆå¦‚æœä½ æœ‰é€™å€‹å€å¡Šï¼‰
  if (summary) {
    summary.innerHTML = `
      <p class="text-sm">å‘½å®®è½åœ¨ï¼š<b>${ziwei.core?.minggong || "â€”"}</b>ï¼Œäº”è¡Œå±€ï¼š<b>${ziwei.core?.wuxingju || "â€”"}å±€</b>ã€‚</p>
      <p class="text-xs text-slate-400 mt-1">2026 å¹´å¯ä»¥æ­é…å…«å­—æµæœˆç¯€å¥ï¼Œä¸€èµ·çœ‹ã€Œå‘½å®®ï¼å®˜ç¥¿ï¼è²¡å¸›ã€é€™ä¸‰å€‹ä¸»æˆ°ç·šã€‚</p>
    `;
  }

  if (tendBox) {
    const t = ziwei.tendencies || {};
    tendBox.innerHTML = `
      <p class="text-xs text-slate-300">
        é¢¨éšªåå¥½ï¼š<b>${t.risk || "mid"}</b> ï½œ æ¬Šå¨æ„Ÿï¼š<b>${t.authority || "mid"}</b> ï½œ æµå‹•æ€§ï¼š<b>${t.mobility || "mid"}</b>
      </p>
    `;
  }
}
</script>


    /* ========= ä¸»æµç¨‹ï¼šåŒæ™‚ç®—å…«å­— + ç´«å¾® ========= */
    async function calculate() {
      const btn  = document.getElementById("btnLaunch");
      const hint = document.getElementById("hint");

      const vy   = Number(document.getElementById("birthYear").value);
      const vm   = Number(document.getElementById("birthMonth").value);
      const vd   = Number(document.getElementById("birthDay").value);
      const vh   = Number(document.getElementById("birthHour").value);
      const vmin = Number(document.getElementById("birthMinute").value);

      const originalText = btn.innerText;

      try {
        if (![vy, vm, vd, vh, vmin].every(n => Number.isFinite(n))) {
          throw new Error("è«‹å…ˆé¸å¥½å®Œæ•´çš„å‡ºç”Ÿå¹´æœˆæ—¥èˆ‡æ™‚é–“");
        }

        btn.disabled = true;
        btn.innerText = "è¨ˆç®—ä¸­â€¦";
        btn.classList.add("opacity-60","cursor-not-allowed");
        hint.innerText = "æ­£åœ¨è®€å–å…«å­—ï¼‹ç´«å¾®å‘½ç›¤ï¼Œè«‹ç¨å€™â€¦";

        // 1) å…ˆç”¨ iztro åœ¨å‰ç«¯ç®—ç´«å¾®ï¼Œçµ„æˆ ziwei_features_v1
        let ziweiFeatures = undefined;
        try {
          if (window.buildZiweiFeaturesLocal) {
            ziweiFeatures = window.buildZiweiFeaturesLocal(vy, vm, vd, vh);
          }
        } catch (e) {
          console.error("buildZiweiFeaturesLocal failed:", e);
        }

        // 2) å‘¼å« /compute/allï¼ˆæŠŠ ziwei ä¸€èµ·å¡é€²å»ï¼Œå¾Œç«¯å°±æœƒå¯«é€² contractï¼‰
        const resp = await fetch(`${API_BASE}/compute/all`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            year: vy,
            month: vm,
            day: vd,
            hour: vh,
            minute: vmin,
            ziwei: ziweiFeatures || undefined,
          }),
        });

        if (!resp.ok) {
          const txt = await resp.text().catch(() => "");
          throw new Error(`API HTTP ${resp.status} ${txt || ""}`.trim());
        }

        const payload = await resp.json();
        console.log("API payload:", payload);

        window.__payload  = payload;
        window.__contract = payload?.features;

        if (!payload?.ok) throw new Error(payload?.error || "API error");

        const contract = payload.features;
        if (!contract || contract.version !== "strategic_features_v1") {
          throw new Error("contract æ ¼å¼ä¸æ­£ç¢ºï¼ˆfeatures.version != strategic_features_v1ï¼‰");
        }

        const bazi  = contract.bazi;
        const ziwei = contract.ziwei || ziweiFeatures || null;

        if (!bazi) throw new Error("contract.bazi ä¸å­˜åœ¨");

        // === å…«å­—å››æŸ± ===
        const disp = bazi.display || {};
        document.getElementById("yG").innerText = disp.yG || "";
        document.getElementById("yZ").innerText = disp.yZ || "";
        document.getElementById("mG").innerText = disp.mG || "";
        document.getElementById("mZ").innerText = disp.mZ || "";
        document.getElementById("dG").innerText = disp.dG || "";
        document.getElementById("dZ").innerText = disp.dZ || "";
        document.getElementById("hG").innerText = disp.hG || "";
        document.getElementById("hZ").innerText = disp.hZ || "";

        document.getElementById("metaInfo").innerText =
          `${vy} / ${String(vm).padStart(2,"0")} / ${String(vd).padStart(2,"0")}  Â·  ${String(vh).padStart(2,"0")}:${String(vmin).padStart(2,"0")}`;

        // === ç´«å¾®å‘½ç›¤ ===
        renderZiwei(ziwei);

        // === äº”è¡Œ ===
        if (!bazi.wuxing?.surface || !bazi.wuxing?.strategic) {
          throw new Error("bazi.wuxing ç¼ºè³‡æ–™");
        }
        renderBar("surfaceWx",   bazi.wuxing.surface,   4);
        renderBar("strategicWx", bazi.wuxing.strategic, bazi.wuxing.maxStrategic || 1);

        // === æµæœˆ ===
        const bounds   = bazi.liuyue2026?.bounds || [];
        const mGrid    = document.getElementById("monthGrid");
        const redMonths = [];

        mGrid.innerHTML = "";
        if (bounds.length) {
          bounds.forEach(b => {
            const isRed = b.light === "RED";
            if (isRed) redMonths.push(b.gz);
            mGrid.innerHTML += `
              <div class="flex items-center justify-between p-3 rounded-xl border-l-4
                          ${isRed ? "border-red-500 bg-red-500/10" : "border-emerald-400 bg-emerald-500/10"}">
                <div>
                  <div class="font-bold text-sm">
                    ${b.gz}
                    <span class="text-[10px] text-slate-300 ml-1">${b.range || ""}</span>
                  </div>
                  <div class="text-[11px] text-slate-200 mt-0.5">
                    æœ¬æ°£ï¼š${b.ssBranch || ""} Â· ${
                      isRed ? "å£“åŠ›æœˆï¼šå®ˆè¦å‰‡ã€æ›æª”ã€ä¸è¦ç¡¬æ’"
                            : "ç©©é€²æœˆï¼šé©åˆæ¨é€²ã€æ”¶å‰²èˆ‡ä½ˆå±€"
                    }
                  </div>
                </div>
                <span class="text-[11px] font-bold px-3 py-1 rounded-full bg-black/40">
                  ${isRed ? "ğŸ”´ å£“åŠ›" : "ğŸŸ¢ ç©©é€²"}
                </span>
              </div>
            `;
          });
        } else {
          mGrid.innerHTML = `<div class="text-xs text-slate-400 italic">ï¼ˆæš«ç„¡æµæœˆè³‡æ–™ï¼‰</div>`;
        }

        // === æˆ°ç•¥è§£è®€ï¼ˆåˆç‰ˆï¼‰ ===
        const analysisBox = document.getElementById("analysisBox");
        const dominant    = (bazi.tenGod?.dominant || "").trim() || "æœªå®š";
        const dmElement   = bazi.dmElement || "ç«";

        const redText = redMonths.length
          ? `å£“åŠ›æœˆï¼š${redMonths.join("ã€")}ï¼ˆé€™å¹¾å€‹æœˆå…ˆå®ˆè¦å‰‡ï¼Œä¸è¦ç¡¬è¡ç›®æ¨™ï¼‰ã€‚`
          : "ä»Šå¹´å£“åŠ›æœˆåå°‘ï¼Œå¯ä»¥æ¯”è¼ƒç©©å®šåœ°å¾€å‰æ¨ã€‚";

        analysisBox.innerHTML = `
          <p>ä½ çš„æ—¥ä¸»äº”è¡Œä¸»å ´æ˜¯ã€Œ<b>${dmElement}</b>ã€ï¼Œ2026 å¹´åº¦ä¸»è»¸åå‘ã€Œ<b>${dominant}</b>ã€ã€‚</p>
          <p>${redText}</p>
          <p>å¯¦å‹™ç­–ç•¥å»ºè­°ï¼šæŠŠåŒæ™‚é€²è¡Œçš„æˆ°ç·šæ•¸é‡å£“ä½ï¼ŒæŠŠç¯€å¥è®Šæˆã€Œå›ºå®šçš„é€±ï¼æœˆæµç¨‹ã€ï¼Œè®“ä½ åœ¨å¥½æœˆæ”¾å¤§æˆæœï¼Œåœ¨å£“åŠ›æœˆä¹Ÿä¸æœƒæ•´å€‹æ•£æ‰ã€‚</p>
          <p class="text-[11px] text-slate-400 mt-3">ï¼ˆä¹‹å¾Œå¯ä»¥å†æ¥å°ˆé–€çš„ /render/reportï¼Œè®“é€™ä¸€æ®µæ›æˆå®Œæ•´æ•˜äº‹ç‰ˆï¼‰</p>
        `;

        // é¡¯ç¤ºå ±å‘Š
        document.getElementById("report").classList.remove("hidden");
        document.getElementById("report").scrollIntoView({ behavior:"smooth", block:"start" });

      } catch (e) {
        console.error(e);
        alert("ç³»çµ±å¿™ç¢Œä¸­æˆ–è³‡æ–™æœ‰èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚\n\nè©³ç´°è¨Šæ¯ï¼š" + (e?.message || e));
      } finally {
        btn.disabled = false;
        btn.innerText = originalText;
        btn.classList.remove("opacity-60","cursor-not-allowed");
        hint.innerText = "";
      }
    }

    /* ========= æ—¥æœŸä¸‹æ‹‰ ========= */
    function initSelectors() {
      const y   = document.getElementById("birthYear");
      const m   = document.getElementById("birthMonth");
      const d   = document.getElementById("birthDay");
      const h   = document.getElementById("birthHour");
      const min = document.getElementById("birthMinute");

      if (!y || !m || !d || !h || !min) return;

      const thisYear = new Date().getFullYear();
      for (let i = thisYear; i >= 1940; i--) {
        y.add(new Option(i + " å¹´", i));
      }
      for (let i = 1; i <= 12; i++) {
        m.add(new Option(i + " æœˆ", i));
      }
      for (let i = 0; i < 24; i++) {
        const label = String(i).padStart(2,"0") + " æ™‚";
        h.add(new Option(label, i));
      }
      ["00","15","30","45"].forEach(v => {
        min.add(new Option(v + " åˆ†", v));
      });

      y.value   = "1990";
      m.value   = "1";
      h.value   = "12";
      min.value = "00";

      updateDays();
    }

    function updateDays() {
      const y = document.getElementById("birthYear");
      const m = document.getElementById("birthMonth");
      const d = document.getElementById("birthDay");
      if (!y || !m || !d) return;

      const year = Number(y.value);
      const month = Number(m.value);
      const cur = d.value;

      d.innerHTML = "";
      const days = new Date(year, month, 0).getDate();
      for (let i = 1; i <= days; i++) {
        const opt = new Option(i + " æ—¥", i);
        d.add(opt);
      }
      if (Number(cur) > days) {
        d.value = String(days);
      } else if (cur) {
        d.value = cur;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initSelectors();
      document.getElementById("btnLaunch").addEventListener("click", calculate);
    });
  </script>
</body>
</html>
