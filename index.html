<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2026 æˆ°ç•¥å°èˆªï½œä¸€èµ·å‡ºä¾†ç©</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#0b0e14; color:#e2e8f0; font-family: system-ui,-apple-system; }
    .glass { background: rgba(255,255,255,.04); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,.08); }
    .bazi-char { font-size:1.8rem; font-weight:900; line-height:1.1; }
    .wuxing-æœ¨{background:#2ecc71}.wuxing-ç«{background:#e74c3c}
    .wuxing-åœŸ{background:#f1c40f}.wuxing-é‡‘{background:#ced4da}
    .wuxing-æ°´{background:#3498db}
  </style>
</head>

<body class="p-4">
  <h1 class="text-3xl font-black text-center mb-6">2026 æµå¹´æˆ°ç•¥å ±å‘Š</h1>

  <!-- è¼¸å…¥ -->
  <div class="glass p-6 rounded-xl max-w-xl mx-auto mb-10">
    <div class="grid grid-cols-3 gap-2 mb-3">
      <select id="birthYear" class="bg-black/40 p-2 rounded"></select>
      <select id="birthMonth" class="bg-black/40 p-2 rounded"></select>
      <select id="birthDay" class="bg-black/40 p-2 rounded"></select>
    </div>
    <div class="grid grid-cols-2 gap-2 mb-4">
      <select id="birthHour" class="bg-black/40 p-2 rounded"></select>
      <select id="birthMinute" class="bg-black/40 p-2 rounded"></select>
    </div>
    <button id="btnLaunch" class="w-full bg-amber-500 text-black py-3 rounded font-black">
      ç”Ÿæˆæˆ‘çš„ 2026 æˆ°ç•¥
    </button>

    <p id="hint" class="text-xs text-slate-400 mt-3 italic"></p>
  </div>

  <!-- å ±å‘Š -->
  <div id="report" class="hidden max-w-xl mx-auto space-y-10">

    <!-- å››æŸ± -->
    <div class="glass p-6 rounded-xl">
      <h2 class="font-black mb-3">å››æŸ±ï¼ˆé¡¯ç¤ºç”¨ï¼‰</h2>
      <div class="grid grid-cols-4 text-center">
        <div>
          <div id="yG" class="bazi-char"></div>
          <div id="yZ" class="text-sm text-slate-300"></div>
        </div>
        <div>
          <div id="mG" class="bazi-char"></div>
          <div id="mZ" class="text-sm text-slate-300"></div>
        </div>
        <div>
          <div id="dG" class="bazi-char text-amber-400"></div>
          <div id="dZ" class="text-sm text-slate-300"></div>
        </div>
        <div>
          <div id="hG" class="bazi-char"></div>
          <div id="hZ" class="text-sm text-slate-300"></div>
        </div>
      </div>
      <div id="meta" class="text-[11px] text-slate-500 mt-3"></div>
    </div>

    <!-- äº”è¡Œ -->
    <div class="glass p-6 rounded-xl">
      <h2 class="font-black mb-3">äº”è¡Œèƒ½é‡</h2>
      <div class="text-xs text-slate-400 mb-2">è¡¨å±¤ï¼ˆå¤©å¹²è¨ˆæ•¸ï¼‰</div>
      <div id="surfaceWx" class="space-y-2 mb-5"></div>

      <div class="text-xs text-slate-400 mb-2">å¯¦æˆ°ï¼ˆå¤©å¹²+è—å¹²+æœˆä»¤åŠ æ¬Šï¼‰</div>
      <div id="strategicWx" class="space-y-2"></div>
    </div>

    <!-- æµæœˆ -->
    <div class="glass p-6 rounded-xl">
      <h2 class="font-black mb-3">2026 æµæœˆç¯€å¥ï¼ˆ12ï¼‰</h2>
      <div id="monthGrid" class="space-y-2"></div>
    </div>

    <!-- åˆ†æ -->
    <div class="glass p-6 rounded-xl">
      <h2 class="font-black mb-3">æˆ°ç•¥è§£è®€ï¼ˆfallbackï¼‰</h2>
      <div id="analysisBox" class="space-y-2 text-sm text-slate-200"></div>
    </div>

  </div>

<script>
/* ========= åŸºæœ¬è¨­å®š ========= */
const API_BASE = "https://17gonplay-api.billeetw.workers.dev";

/* ========= å®‰å…¨å– DOM ========= */
const $ = (id) => document.getElementById(id);

/* ========= bars ========= */
function renderBar(id, data, max){
  const box = $(id);
  if (!box) return;
  box.innerHTML = "";
  ["æœ¨","ç«","åœŸ","é‡‘","æ°´"].forEach(e=>{
    const v = Number(data?.[e] ?? 0);
    const pct = max ? (v / max) * 100 : 0;
    const w = (v > 0 && pct < 2) ? 2 : Math.max(0, Math.min(100, pct));
    box.innerHTML += `
      <div>
        <div class="flex justify-between text-xs">
          <span>${e}</span><span>${v.toFixed(1)}</span>
        </div>
        <div class="h-2 bg-white/10 rounded overflow-hidden">
          <div class="h-full wuxing-${e}" style="width:${w}%"></div>
        </div>
      </div>`;
  });
}

/* ========= UI: selectors ========= */
function initSelectors(){
  const birthYear = $("birthYear");
  const birthMonth = $("birthMonth");
  const birthDay = $("birthDay");
  const birthHour = $("birthHour");
  const birthMinute = $("birthMinute");

  // å¹´
  for(let i=2026;i>=1940;i--){
    birthYear.add(new Option(`${i}`, i));
  }
  // æœˆ
  for(let i=1;i<=12;i++){
    birthMonth.add(new Option(`${i}`, i));
  }
  // æ™‚
  for(let i=0;i<24;i++){
    birthHour.add(new Option(String(i).padStart(2,"0"), i));
  }
  // åˆ†
  ["00","15","30","45"].forEach(v=>{
    birthMinute.add(new Option(v, Number(v)));
  });

  // é è¨­å€¼
  birthYear.value = "1990";
  birthMonth.value = "1";
  birthHour.value = "12";
  birthMinute.value = "0";

  // ç¶äº‹ä»¶
  birthYear.addEventListener("change", updateDays);
  birthMonth.addEventListener("change", updateDays);

  updateDays();
}

function updateDays(){
  const birthYear = $("birthYear");
  const birthMonth = $("birthMonth");
  const birthDay = $("birthDay");
  if (!birthYear || !birthMonth || !birthDay) return;

  const y = Number(birthYear.value);
  const m = Number(birthMonth.value);
  const days = new Date(y, m, 0).getDate();

  const cur = Number(birthDay.value || 1);
  birthDay.innerHTML = "";
  for(let i=1;i<=days;i++){
    birthDay.add(new Option(`${i}`, i));
  }
  birthDay.value = String(Math.min(cur, days));
}

/* ========= ä¸»æµç¨‹ ========= */
async function calculate(){
  const vy = Number($("birthYear")?.value);
  const vm = Number($("birthMonth")?.value);
  const vd = Number($("birthDay")?.value);
  const vh = Number($("birthHour")?.value);
  const vmin = Number($("birthMinute")?.value);

  try {
    $("hint").innerText = "è¨ˆç®—ä¸­â€¦";

    if (![vy,vm,vd,vh,vmin].every(n => Number.isFinite(n))) {
      throw new Error("è«‹å…ˆé¸å¥½å‡ºç”Ÿå¹´æœˆæ—¥èˆ‡æ™‚é–“");
    }

    // 1) Phase 0: /compute/all å– contract
    const resp = await fetch(`${API_BASE}/compute/all`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ year: vy, month: vm, day: vd, hour: vh, minute: vmin }),
    });

    if (!resp.ok) {
      const txt = await resp.text().catch(() => "");
      throw new Error(`API HTTP ${resp.status} ${txt || ""}`.trim());
    }

    const payload = await resp.json();

    // è®“ä½  console æŸ¥å¾—åˆ°
    window.__payload = payload;
    window.__contract = payload?.features;
    window.__bounds = payload?.features?.bazi?.liuyue2026?.bounds;

    if (!payload?.ok) throw new Error(payload?.error || "API error");

    const contract = payload.features;
    if (!contract || contract.version !== "strategic_features_v1") {
      throw new Error("contract æ ¼å¼ä¸æ­£ç¢ºï¼ˆfeatures.version != strategic_features_v1ï¼‰");
    }
    const bazi = contract.bazi;
    if (!bazi) throw new Error("contract.bazi ä¸å­˜åœ¨");

    // 2) é¡¯ç¤ºç”¨å››æŸ±ï¼š/compute/baziï¼ˆåªæ‹¿ pillars/display/metaï¼‰
    const dispResp = await fetch(`${API_BASE}/compute/bazi`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ year: vy, month: vm, day: vd, hour: vh, minute: vmin }),
    });
    const disp = await dispResp.json();
    if (!disp?.ok) throw new Error(disp?.error || "compute/bazi errorï¼ˆé¡¯ç¤ºç”¨ï¼‰");

    const bY = disp.pillars?.year || "";
    const bM = disp.pillars?.month || "";
    const bD = disp.pillars?.day || "";
    const bH = disp.pillars?.time || "";

    $("yG").innerText = bY[0] || ""; $("yZ").innerText = bY[1] || "";
    $("mG").innerText = bM[0] || ""; $("mZ").innerText = bM[1] || "";
    $("dG").innerText = bD[0] || ""; $("dZ").innerText = bD[1] || "";
    $("hG").innerText = bH[0] || ""; $("hZ").innerText = bH[1] || "";

    $("meta").innerText = `${disp.meta?.solarText || ""} / ${disp.meta?.lunarText || ""}`.trim();

    // 3) äº”è¡Œï¼šåƒ contract
    renderBar("surfaceWx", bazi.wuxing?.surface, 4);
    renderBar("strategicWx", bazi.wuxing?.strategic, bazi.wuxing?.maxStrategic || 1);

    // 4) æµæœˆï¼šåƒ contractï¼ˆ12ï¼‰
    const bounds = bazi.liuyue2026?.bounds;
    const monthGrid = $("monthGrid");
    monthGrid.innerHTML = "";

    if (Array.isArray(bounds) && bounds.length) {
      bounds.forEach(b => {
        const red = b.light === "RED";
        monthGrid.innerHTML += `
          <div class="p-3 rounded border-l-4 ${red?"border-red-500":"border-emerald-500"} bg-black/20">
            <div class="font-bold">
              ${b.gz} <span class="text-xs text-slate-400">${b.range || ""}</span>
            </div>
            <div class="text-xs text-slate-300">
              ${red?"ğŸ”´ å£“åŠ›":"ğŸŸ¢ ç©©é€²"}ï½œæœ¬æ°£ï¼š${b.ssBranch || ""}
            </div>
          </div>`;
      });
    } else {
      monthGrid.innerHTML = `<div class="text-xs text-slate-400 italic">ï¼ˆå°šæœªå–å¾—æµæœˆ boundsï¼‰</div>`;
    }

    // 5) åˆ†æ fallbackï¼šä¸ä¾è³´ render/report
    const dominant = (bazi.tenGod?.dominant || "").trim() || "æœªå®š";
    const redMonths = (bounds || []).filter(x => x.light === "RED").map(x => x.gz);

    $("analysisBox").innerHTML = `
      <p>å¹´åº¦ä¸»è»¸ï¼š<span class="text-amber-400 font-black">${dominant}</span></p>
      <p>${redMonths.length ? `å£“åŠ›æœˆï¼š${redMonths.join("ã€")}ï¼ˆå…ˆå®ˆè¦å‰‡ï¼Œä¸ç¡¬è¡ï¼‰` : "å£“åŠ›æœˆåå°‘ï¼šå¯ä»¥ç©©ç©©æ¨é€²ã€‚"}</p>
      <p class="text-xs text-slate-400 mt-2">ï¼ˆPhase 1 æœƒæ›æˆå¾Œç«¯ render/report çš„å®Œæ•´æ•˜äº‹ï¼‰</p>
    `;

    $("report").classList.remove("hidden");
    $("hint").innerText = `OKï¼šbounds=${Array.isArray(bounds)?bounds.length:0}`;
  } catch (e) {
    console.error(e);
    $("hint").innerText = "";
    alert("è¨ˆç®—å¤±æ•—ï¼š" + (e?.message || e));
  }
}

/* ========= ç¶å®š ========= */
document.addEventListener("DOMContentLoaded", () => {
  initSelectors();
  $("btnLaunch").addEventListener("click", calculate);
});
</script>
</body>
</html>

















