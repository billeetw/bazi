/**
 * server/logic/strategyEngine.js
 * 12 宮位 × 4 強度 × 4 四化 = 96 條戰略文案，僅供後端使用，不得暴露至前端。
 */

const STRENGTH = {
  命宮: {
    4: "系統效能全開。這局你是主角，世界會繞著你的意志轉動。",
    3: "狀態良好。你的主觀意願能有效轉化為行動。",
    2: "系統有些遲滯。你需要更多外部刺激才能啟動自己。",
    1: "偵測到核心內耗。這局你容易自我懷疑，練習「看見自己」是首要任務。",
  },
  兄弟: {
    4: "盟友極其強大。這是打團戰的最佳時機，眾人拾柴火焰高。",
    3: "夥伴關係穩定。適合與人協作，能產生 1+1>2 的效果。",
    2: "隊友幫不上忙。建議維持禮貌距離，重心回歸自己。",
    1: "盟友區能量低迷。這局沒人能幫你，靠自己最踏實。",
  },
  夫妻: {
    4: "感情能量充沛。伴侶能成為你最強的後盾與靈魂夥伴。",
    3: "關係和諧。這是一個可以讓你安心修整的避風港。",
    2: "互動有些吃力。需要花更多心力去校對彼此的需求。",
    1: "此處能量乾涸。別把安全感寄託在他人身上，先愛回自己。",
  },
  子女: {
    4: "產出效率極高。無論是作品、投資或下屬，都能帶來驚喜回報。",
    3: "養成體系健全。你的投入會按部就班地開花結果。",
    2: "產出不如預期。建議先優化流程，不要急著擴大投資。",
    1: "這裡容易損耗精力。對外擴張要極度謹慎，守住現有成果。",
  },
  財帛: {
    4: "提款路徑極短。只要你出手，財富轉換效率驚人。",
    3: "現金流運轉良好。這是一個適合累積資產的平穩期。",
    2: "投入多、回報少。這局你要練的是「精準」，而非「勤奮」。",
    1: "此處地形崎嶇。容易發生意外支出，請開啟防禦模式。",
  },
  疾厄: {
    4: "硬體素質極強。你可以承受高強度的運作而不會崩潰。",
    3: "體能穩定。只要按時保養，就能支撐你的野心。",
    2: "零件開始磨損。請注意身體發出的微小信號，別硬撐。",
    1: "硬體嚴重過載。系統隨時可能當機，請優先回血。",
  },
  遷移: {
    4: "世界對你敞開。出門就是主場，你的影響力能擴及遠方。",
    3: "外部機會多。多出門走走，資源都在家門口之外。",
    2: "外界阻力較大。環境不友善，建議回歸舒適圈作業。",
    1: "外部能量混亂。此時不宜變動環境，守在原地最安全。",
  },
  僕役: {
    4: "群眾能量極強。你擁有強大的社群吸附力，適合一呼百應。",
    3: "社群關係健康。朋友與粉絲能為你的戰略加分。",
    2: "應酬多但無益。請過濾無效社交，保護你的能量。",
    1: "容易被誤解或孤立。這局不求人知，專注修煉內功。",
  },
  官祿: {
    4: "事業如日中天。這是你的高光時刻，請把握機會擴張版圖。",
    3: "發展路徑清晰。只要持續投入，就能穩定攀升等級。",
    2: "升級路徑受阻。這局適合進修增能，而非盲目跳槽。",
    1: "舞台能量微弱。你在這感到懷才不遇，需要重新定位。",
  },
  田宅: {
    4: "存檔點極其穩固。你的家產與房產是這局最強的護城河。",
    3: "內部環境安定。資產正處於良性累積的過程中。",
    2: "家庭或資產不穩。建議優先整理內務，不要急著對外。",
    1: "存檔點受損。這是你最脆弱的地方，請花時間修補根基。",
  },
  福德: {
    4: "心態無敵。你具備極強的抗壓性與靈感，能從容面對一切。",
    3: "精神狀態健康。你懂得如何讓自己開心，情緒穩定。",
    2: "內心戲太多。你的精神內耗正在吃掉你的實戰能量。",
    1: "負面情緒超載。這是這局最難的副本，請尋求外部引導。",
  },
  父母: {
    4: "系統權限全開。長輩與體制會主動為你開路，盡情利用資源。",
    3: "適合在體制內發展。只要守規矩，系統就會給你回報。",
    2: "感覺被規則束縛。與權威溝通不順，請耐心磨合。",
    1: "容易挑戰規則而受損。別硬碰體制，學會迂迴通關。",
  },
};

const SIHUA = {
  命宮: { 祿: "系統自帶紅利，這局你天生好運，請保持樂觀去擴張邊界。", 權: "主觀意志極強，你是這局遊戲的絕對指揮官，直接下決定吧。", 科: "自帶名聲 Buff，你的個人品牌就是最棒的武器，愛惜羽毛。", 忌: "這局難度在於內耗。別跟自己過不去，你的必修課是學會放過。" },
  兄弟: { 祿: "隊友是你的提款機，這局適合打團戰，資源就在朋友那。", 權: "隊友很有主見但也很強，學會授權與配合，別急著爭當老大。", 科: "朋友圈裡有名望，遇到關卡多找朋友商量，名聲會幫你開路。", 忌: "容易被隊友拖累或產生誤會。這局適合單打，保持邊界感。" },
  夫妻: { 祿: "伴侶是你的貴人，這段關係會幫你獲取更多資源。", 權: "另一半控制欲較強，學會溝通與共處，別硬碰硬。", 科: "你的感情生活是你的門面，適合對外展現美好，建立公信力。", 忌: "情感副本難度較高。你的課題是處理期待落差，別在愛裡委屈。" },
  子女: { 祿: "投資與創意產出帶有紅利，適合多線嘗試新項目。", 權: "對下屬或子女控制欲強，這局你要練的是「適度放手」。", 科: "你的作品或才華容易被看見，適合發表成果，累積口碑。", 忌: "投資要極度保守。這是一個容易發生意外支出的雷區，請盯緊。" },
  財帛: { 祿: "提款路徑順暢。只要動手就能拿走資源，適合主動出擊。", 權: "賺錢靠實力與技術。你是辛苦得財，但掌控權在你手裡。", 科: "適合靠專業名聲或證照來賺錢，名氣越高，財路越穩。", 忌: "偵測到金庫滲漏。目前是系統清算期，不適合進行任何豪賭。" },
  疾厄: { 祿: "體質優良，修復力強。即使受損也能快速回血。", 權: "體力充沛但容易過載。你的硬體需要定期停機維護。", 科: "外貌或身形是你的加分項，多照顧身體，它會給你名聲回報。", 忌: "身心壓力容易顯現。這是這局遊戲最底層的考驗，不能逃避。" },
  遷移: { 祿: "主場在外地。出門就有紅利，別一直窩在家裡。", 權: "在外地擁有極強的開拓力，適合去更大的場域競爭。", 科: "適合在外建立個人品牌，外人對你的評價會比熟人高。", 忌: "出外阻力較大。目前的章節適合守成，不宜輕易更換環境。" },
  僕役: { 祿: "粉絲與群眾是你的能量來源。多接觸人群，你會得到驚喜。", 權: "你在社群中具備影響力，適合擔任領袖或指揮角色。", 科: "適合在公眾面前經營形象，貴人多來自你的社群評價。", 忌: "容易發生公關危機或被流言困擾。這局請低調作業。" },
  官祿: { 祿: "事業路徑最寬。這是一個順風局，請全速擴張你的影響力。", 權: "職場主導權在你手中。雖然壓力大，但你是制定規則的人。", 科: "適合靠頭銜、學位或專業名聲上位，這局你要的是地位。", 忌: "主線任務出現 Bug。目前適合處理遺留問題，不宜開啟新戰場。" },
  田宅: { 祿: "資產自動增值。家庭或房產是你的最強存檔點，適合置產。", 權: "家庭內部主導權強，適合整合家族資源來進行大動作。", 科: "家世或居住環境能為你加分，適合經營高品質的居家生活。", 忌: "資產面臨清算或家庭紛擾。這局要謹慎處理房產與遺產。" },
  福德: { 祿: "靈魂自帶紅利，你是一個天生的樂觀玩家，運氣藏在心態裡。", 權: "精神意志極強，這局只要你相信，你就能修改遊戲規則。", 科: "靈魂帶有修養與品味，適合投入身心靈或藝術領域來回血。", 忌: "精神容易陷入高壓或憂慮。你的課題是找回內心的平靜。" },
  父母: { 祿: "長輩與上司是你的天使。這局你天生有後台，多尋求支援。", 權: "與體制或長輩關係緊張，這局你要學會與權威共處。", 科: "適合在體制內建立名聲，長輩會是你的最佳宣傳渠道。", 忌: "容易與體制或文書產生衝突。這局請看清遊戲規則，別違規。" },
};

/**
 * 將分數 (0~max) 映射為強度等級 1~4
 * @param {number} score
 * @param {number} maxScore
 * @returns {1|2|3|4}
 */
function scoreToStrength(score, maxScore) {
  if (!maxScore || maxScore <= 0) return 1;
  const r = score / maxScore;
  if (r >= 0.85) return 4;
  if (r >= 0.55) return 3;
  if (r >= 0.25) return 2;
  return 1;
}

/**
 * 依宮位、強度、四化列表產生戰略一句話（金句拼接）
 * @param {string} palace - 宮位名稱，如 命宮、財帛
 * @param {1|2|3|4} strength - 強度 1~4
 * @param {string[]} sihuaList - 四化列表，如 ["祿","忌"]
 * @returns {string}
 */
function getStrategyNote(palace, strength, sihuaList) {
  const env = STRENGTH[palace] && STRENGTH[palace][strength] ? STRENGTH[palace][strength] : "";
  const sihuaTexts = SIHUA[palace] || {};
  const list = Array.isArray(sihuaList) ? sihuaList : [];
  const hasJi = list.includes("忌");
  const jiText = hasJi && sihuaTexts["忌"] ? sihuaTexts["忌"] : null;
  const goodTerrain = strength >= 3;
  const luQuanKe = list.filter((h) => h === "祿" || h === "權" || h === "科");
  let action = "";
  if (jiText) {
    action = (goodTerrain ? "。可惜" : "。但預警：") + jiText;
  } else if (luQuanKe.length) {
    const first = luQuanKe.map((h) => sihuaTexts[h]).filter(Boolean)[0];
    if (first) action = (goodTerrain ? "。在此基礎上，" : "。所幸，") + first;
  }
  if (!env) return action ? action.replace(/^[。，]/, "").trim() : "（暫無戰略提示）";
  if (!action) return env;
  return env + action;
}

export { STRENGTH, SIHUA, scoreToStrength, getStrategyNote };
