# 🧪 本地测试完整指南

## ✅ 测试前准备

### 1. 确认所有修复已保存

```bash
cd /Users/bill/bazi-project

# 检查关键文件的版本号
grep -E "(baziCore|fourTransformations|overlapAnalysis|calc\.js|ui\.js)\?v=" index.html
```

应该看到：
- `baziCore.js?v=3`
- `fourTransformations.js?v=3`
- `overlapAnalysis.js?v=3`
- `calc.js?v=3`
- `ui.js?v=3`

### 2. 检查语法

```bash
# 检查所有关键文件的语法
node -c js/calc/baziCore.js
node -c js/calc/fourTransformations.js
node -c js/calc/overlapAnalysis.js
node -c js/calc.js
node -c js/ui.js
```

如果所有命令都没有输出，说明语法正确。

## 🚀 启动本地服务器

### 方法 1：使用 Cloudflare Pages 开发服务器（推荐）

```bash
cd /Users/bill/bazi-project
npx wrangler pages dev . --port 8788
```

**访问地址**：
- 主页面：`http://localhost:8788/index.html`
- API 测试：`http://localhost:8788/api/auth/config`

### 方法 2：使用快速启动脚本

```bash
./start-dev.sh
```

## 🔍 测试步骤

### 1. 清除浏览器缓存

**重要**：必须清除缓存才能看到最新版本！

**Chrome/Edge:**
- `Ctrl + Shift + Delete` (Windows) 或 `Cmd + Shift + Delete` (Mac)
- 选择「缓存的图片和文件」
- 时间范围选择「全部时间」
- 点击「清除数据」

**或者使用无痕模式**：
- `Ctrl + Shift + N` (Windows) 或 `Cmd + Shift + N` (Mac)

### 2. 打开浏览器开发者工具

- 按 `F12` 或 `Cmd + Option + I` (Mac)
- 切换到「Console」标签
- 切换到「Network」标签

### 3. 访问页面

```
http://localhost:8788/index.html
```

### 4. 检查版本号

在「Network」标签中：
1. 刷新页面（`F5`）
2. 检查所有 JavaScript 文件的版本号：
   - ✅ `baziCore.js?v=3`（不是 `?v=1`）
   - ✅ `fourTransformations.js?v=3`（不是 `?v=1`）
   - ✅ `overlapAnalysis.js?v=3`（不是 `?v=1`）
   - ✅ `calc.js?v=3`（不是 `?v=2`）
   - ✅ `ui.js?v=3`（不是 `?v=2`）

### 5. 检查控制台错误

在「Console」标签中，确认**没有**以下错误：

❌ **不应该看到**：
- `SyntaxError: Unexpected token '{'`
- `Identifier 'mingBranch' has already been declared`
- `Cannot destructure property 'PALACE_DEFAULT'`
- `requires calc/baziCore.js to be loaded first`
- `requires calc/fourTransformations.js to be loaded first`

✅ **应该看到**：
- 可能有一些警告（warnings），但**不应该有错误（errors）**

### 6. 测试功能

1. **输入出生信息**：
   - 年：1990
   - 月：1
   - 日：1
   - 时：12
   - 分：0
   - 性别：选择「男」或「女」

2. **点击「啟動人生戰略引擎」**

3. **检查结果**：
   - ✅ 页面正常显示计算结果
   - ✅ 紫微盘正常显示
   - ✅ 宫位可以点击查看详情
   - ✅ 五行图表正常显示
   - ✅ 流月卡片正常显示

## 🐛 如果仍有问题

### 问题 1：版本号还是旧的

**解决**：
1. 确认服务器已重启
2. 强制刷新：`Ctrl + F5` (Windows) 或 `Cmd + Shift + R` (Mac)
3. 使用无痕模式测试

### 问题 2：仍有 JavaScript 错误

**检查**：
1. 确认所有文件都已保存
2. 检查 `index.html` 中的脚本加载顺序
3. 查看控制台的完整错误信息

### 问题 3：服务器启动失败

**检查**：
1. 确认端口 8788 未被占用
2. 检查 Node.js 版本：`node --version`（需要 v16+）
3. 检查 wrangler 是否安装：`npx wrangler --version`

### 问题 4：API 路由不工作

**确认**：
- 使用的是 `npx wrangler pages dev` 而不是 Python HTTP 服务器
- `functions/` 文件夹存在
- 检查 API 端点：`http://localhost:8788/api/auth/config`

## 📋 测试检查清单

- [ ] 所有文件版本号为 `?v=3`
- [ ] 控制台没有 JavaScript 错误
- [ ] 页面正常加载
- [ ] 表单可以输入
- [ ] 计算功能正常
- [ ] UI 组件正常显示
- [ ] 宫位点击功能正常
- [ ] 五行图表正常显示
- [ ] 流月卡片正常显示

## 🎯 快速测试命令

```bash
# 1. 启动服务器
cd /Users/bill/bazi-project
npx wrangler pages dev . --port 8788

# 2. 在浏览器访问
open http://localhost:8788/index.html
# 或手动打开：http://localhost:8788/index.html
```

## ✅ 测试通过标准

1. ✅ 所有 JavaScript 文件成功加载（状态码 200）
2. ✅ 版本号正确（`?v=3`）
3. ✅ 控制台没有错误
4. ✅ 页面功能正常
5. ✅ 计算功能正常
6. ✅ UI 组件正常显示

## 🎉 测试完成后

如果本地测试通过，就可以部署到生产环境了！

```bash
# 使用 Git 部署
git add .
git commit -m "fix: 修复 JavaScript 语法错误"
git push origin main
```
