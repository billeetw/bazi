/* calc.js
 * è² è²¬æ‰€æœ‰ã€Œè¨ˆç®—ï¼è³‡æ–™é‚è¼¯ã€ï¼ˆbazi / ziwei / liuyueï¼‰
 * ä¸ç›´æ¥ç¢° DOMï¼Œä¸åšäº‹ä»¶ç¶å®šã€‚
 *
 * ä»¥ window.Calc æš´éœ²çµ¦ ui.js ä½¿ç”¨ï¼ˆé¿å…å¼•å…¥æ‰“åŒ…å·¥å…·ï¼‰ã€‚
 */

(function () {
  "use strict";

  // ====== CONSTANTS / MAPS ======
  // é è¨­ã€Œå®®ä½é †åºã€ï¼ˆå¾å‘½å®®é–‹å§‹é€†è¡Œï¼‰ï¼šåªç”¨ä¾†åšä¸‰æ–¹å››æ­£ç­‰ã€Œå®®ä½é‚è¼¯ã€ï¼Œè·Ÿç•«æ ¼å­çš„ä½ç½®åˆ†é–‹
  const PALACE_DEFAULT = [
    "å‘½å®®", "å…„å¼Ÿ", "å¤«å¦»", "å­å¥³", "è²¡å¸›", "ç–¾å„",
    "é·ç§»", "åƒ•å½¹", "å®˜ç¥¿", "ç”°å®…", "ç¦å¾·", "çˆ¶æ¯",
  ];

  // å®®ä½ç°¡ç¹å°ç…§ï¼ˆæ‰¾æ˜Ÿæ›œã€æ‰¾è³‡æ–™åº«ç”¨ï¼‰
  const PALACE_KEY_MAP = {
    "å…„å¼Ÿ": ["å…„å¼Ÿ", "å…„å¼Ÿå®®"],
    "å‘½å®®": ["å‘½å®®", "å‘½å®«"],
    "å¤«å¦»": ["å¤«å¦»", "å¤«å¦»å®®"],
    "å­å¥³": ["å­å¥³", "å­å¥³å®®"],
    "è²¡å¸›": ["è²¡å¸›", "è´¢å¸›", "è²¡å¸›å®®", "è´¢å¸›å®«"],
    "ç–¾å„": ["ç–¾å„", "ç–¾å„å®®"],
    "é·ç§»": ["é·ç§»", "è¿ç§»", "é·ç§»å®®", "è¿ç§»å®«"],
    "åƒ•å½¹": ["åƒ•å½¹", "ä»†å½¹", "åƒ•å½¹å®®", "ä»†å½¹å®«"],
    "å®˜ç¥¿": ["å®˜ç¥¿", "å®˜ç¦„", "å®˜ç¥¿å®®", "å®˜ç¦„å®«"],
    "ç”°å®…": ["ç”°å®…", "ç”°å®…å®®"],
    "ç¦å¾·": ["ç¦å¾·", "ç¦å¾·å®®"],
    "çˆ¶æ¯": ["çˆ¶æ¯", "çˆ¶æ¯å®®"],
  };

  // 12 å®®ç›¤é¢ä½ç½®ï¼ˆ4x4 å¤–åœˆï¼‰â€” é€™æ˜¯ã€Œåœ°æ”¯åº§æ¨™ã€
  // ç´¢å¼•ï¼š0:å¯…(å·¦ä¸‹), 1:å¯, 2:è¾°, 3:å·³(å·¦ä¸Š), 4:åˆ, 5:æœª,
  //      6:ç”³(å³ä¸Š), 7:é…‰, 8:æˆŒ, 9:äº¥(å³ä¸‹),10:å­, 11:ä¸‘
  const gridAreas = [
    "4/1/5/2", // 0: å¯… (å·¦ä¸‹)
    "3/1/4/2", // 1: å¯
    "2/1/3/2", // 2: è¾°
    "1/1/2/2", // 3: å·³ (å·¦ä¸Š)
    "1/2/2/3", // 4: åˆ
    "1/3/2/4", // 5: æœª
    "1/4/2/5", // 6: ç”³ (å³ä¸Š)
    "2/4/3/5", // 7: é…‰
    "3/4/4/5", // 8: æˆŒ
    "4/4/5/5", // 9: äº¥ (å³ä¸‹)
    "4/3/5/4", // 10: å­
    "4/2/5/3", // 11: ä¸‘
  ];

  // å›ºå®šçš„ã€Œåœ°æ”¯ç’°ã€ï¼Œå°æ‡‰ä¸Šé¢ gridAreas çš„é †åº
  const BRANCH_RING = ["å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥", "å­", "ä¸‘"];

  const STAR_NAME_TRAD_MAP = {
    // 14 ä¸»æ˜Ÿ
    "ç´«å¾®": "ç´«å¾®", "ç´«è–‡": "ç´«å¾®",
    "å¤©æœº": "å¤©æ©Ÿ", "å¤©æ©Ÿ": "å¤©æ©Ÿ",
    "å¤ªé˜³": "å¤ªé™½", "å¤ªé™½": "å¤ªé™½",
    "å¤ªé˜´": "å¤ªé™°", "å¤ªé™°": "å¤ªé™°",
    "æ­¦æ›²": "æ­¦æ›²",
    "å¤©åŒ": "å¤©åŒ",
    "å»‰è´": "å»‰è²", "å»‰è²": "å»‰è²",
    "å¤©åºœ": "å¤©åºœ",
    "è´ªç‹¼": "è²ªç‹¼", "è²ªç‹¼": "è²ªç‹¼",
    "å·¨é—¨": "å·¨é–€", "å·¨é–€": "å·¨é–€",
    "å¤©ç›¸": "å¤©ç›¸",
    "å¤©æ¢": "å¤©æ¢",
    "ä¸ƒæ€": "ä¸ƒæ®º", "ä¸ƒæ®º": "ä¸ƒæ®º",
    "ç ´å†›": "ç ´è»", "ç ´è»": "ç ´è»",

    // å…­å‰æ˜Ÿ
    "å·¦è¾…": "å·¦è¼”", "å·¦è¼”": "å·¦è¼”",
    "å³å¼¼": "å³å¼¼",
    "æ–‡æ˜Œ": "æ–‡æ˜Œ",
    "æ–‡æ›²": "æ–‡æ›²",
    "å¤©é­": "å¤©é­",
    "å¤©é’º": "å¤©é‰", "å¤©é‰": "å¤©é‰",

    // å…­ç…æ˜Ÿ
    "æ“ç¾Š": "æ“ç¾Š",
    "é™€ç½—": "é™€ç¾…", "é™€ç¾…": "é™€ç¾…",
    "ç«æ˜Ÿ": "ç«æ˜Ÿ",
    "é“ƒæ˜Ÿ": "éˆ´æ˜Ÿ", "éˆ´æ˜Ÿ": "éˆ´æ˜Ÿ",
    "åœ°åŠ«": "åœ°åŠ«",
    "åœ°ç©º": "åœ°ç©º",

    // é‡è¦è¼”æ˜Ÿ
    "ç¦„å­˜": "ç¥¿å­˜", "ç¥¿å­˜": "ç¥¿å­˜",
    "å¤©é©¬": "å¤©é¦¬", "å¤©é¦¬": "å¤©é¦¬",
    "å¤©ä¼¤": "å¤©å‚·", "å¤©å‚·": "å¤©å‚·",
    "å¤©ä½¿": "å¤©ä½¿",
    "å¤©æ‰": "å¤©æ‰",
    "å¤©å¯¿": "å¤©å£½", "å¤©å£½": "å¤©å£½",
    "å¤©å®˜": "å¤©å®˜",
    "å¤©ç¦": "å¤©ç¦",
    "å¤©å·«": "å¤©å·«",
    "å¤©å–œ": "å¤©å–œ",
    "å¤©å§š": "å¤©å§š",
    "ç´…é¸": "ç´…é¸", "çº¢é¸¾": "ç´…é¸",
    "å¤©åˆ‘": "å¤©åˆ‘",
    "è§£ç¥": "è§£ç¥",

    // é›œæ›œèˆ‡ç¥ç…
    "å¤©å¨": "å¤©å»š", "å¤©å»š": "å¤©å»š",
    "æˆªè·¯": "æˆªè·¯",
    "å­¤è¾°": "å­¤è¾°",
    "å¯¡å®¿": "å¯¡å®¿",
    "ç©ºäº¡": "ç©ºäº¡",
    "ç ´ç¢": "ç ´ç¢",
    "å¤©è´µ": "å¤©è²´", "å¤©è²´": "å¤©è²´",
    "åç›–": "è¯è“‹", "è¯è“‹": "è¯è“‹",
    "å¤©å“­": "å¤©å“­",
    "å¤©è™š": "å¤©è™›", "å¤©è™›": "å¤©è™›",
    "å¤©å¾·": "å¤©å¾·",
    "æœˆå¾·": "æœˆå¾·",
    "æ—¬ç©º": "æ—¬ç©º",
    "å°è¾…": "å°è¼”", "å°è¼”": "å°è¼”",
    "å°è¯°": "å°èª¥", "å°èª¥": "å°èª¥",
    "é¾™æ± ": "é¾æ± ", "é¾æ± ": "é¾æ± ",
    "å‡¤é˜": "é³³é–£", "é³³é–£": "é³³é–£",
    "å¹´è§£": "å¹´è§£",
    "å’¸æ± ": "å’¸æ± ",
    "ä¸‰å°": "ä¸‰å°",
    "å…«åº§": "å…«åº§",
    "æ©å…‰": "æ©å…‰",
    "èœšå»‰": "èœšå»‰",
    "é˜´ç…": "é™°ç…", "é™°ç…": "é™°ç…",
    "å¤©æœˆ": "å¤©æœˆ",

    // åšå£«åäºŒç¥
    "åšå£«": "åšå£«",
    "åŠ›å£«": "åŠ›å£«",
    "é’é¾": "é’é¾", "é’é¾™": "é’é¾",
    "å°è€—": "å°è€—",
    "å°‡è»": "å°‡è»", "å°†å†›": "å°‡è»",
    "å¥æ›¸": "å¥æ›¸", "å¥ä¹¦": "å¥æ›¸",
    "å–œç¥": "å–œç¥",
    "ç—…ç¬¦": "ç—…ç¬¦",
    "å¤§è€—": "å¤§è€—",
    "ä¼å…µ": "ä¼å…µ",
    "å®˜åºœ": "å®˜åºœ",

    // é¡åˆ¥å‹æ˜Ÿæ›œ
    "ç”²ç´šä¸»æ˜Ÿ": "ç”²ç´šä¸»æ˜Ÿ",
    "å…­å‰æ˜Ÿ": "å…­å‰æ˜Ÿ",
    "å…­ç…æ˜Ÿ": "å…­ç…æ˜Ÿ",
    "å—æ–—ã€åŒ—æ–—æ˜Ÿ": "å—æ–—ã€åŒ—æ–—æ˜Ÿ",
    "ä¸­å¤©æ˜Ÿ": "ä¸­å¤©æ˜Ÿ",
    "è¼”åŠ©æ˜Ÿ": "è¼”åŠ©æ˜Ÿ",
    "ç¥¿å­˜èˆ‡å¤©é¦¬": "ç¥¿å­˜èˆ‡å¤©é¦¬",
  };

  // äº”è¡Œ map ç”¨ã€Œç¹é«”æ˜Ÿåã€
  const STAR_WUXING_MAP = {
    "ç´«å¾®": "åœŸ", "å¤©æ©Ÿ": "æœ¨", "å¤ªé™½": "ç«", "æ­¦æ›²": "é‡‘", "å¤©åŒ": "æ°´",
    "å»‰è²": "ç«", "å¤©åºœ": "åœŸ", "å¤ªé™°": "æ°´", "è²ªç‹¼": "æœ¨", "å·¨é–€": "æ°´",
    "å¤©ç›¸": "æ°´", "å¤©æ¢": "åœŸ", "ä¸ƒæ®º": "é‡‘", "ç ´è»": "æ°´",
  };

  // åœ°æ”¯è—å¹²ï¼ˆå‰ç«¯é¡¯ç¤ºç”¨ï¼Œä¹Ÿå¯ç”¨æ–¼å¯¦æˆ°çµæ§‹çš„è§£é‡‹ï¼‰
  const CANGGAN_DATA = {
    "å­": { "ç™¸": 1.0 },
    "ä¸‘": { "å·±": 0.6, "ç™¸": 0.3, "è¾›": 0.1 },
    "å¯…": { "ç”²": 0.6, "ä¸™": 0.3, "æˆŠ": 0.1 },
    "å¯": { "ä¹™": 1.0 },
    "è¾°": { "æˆŠ": 0.6, "ä¹™": 0.3, "ç™¸": 0.1 },
    "å·³": { "ä¸™": 0.6, "åºš": 0.3, "æˆŠ": 0.1 },
    "åˆ": { "ä¸": 0.7, "å·±": 0.3 },
    "æœª": { "å·±": 0.6, "ä¸": 0.3, "ä¹™": 0.1 },
    "ç”³": { "åºš": 0.6, "å£¬": 0.3, "æˆŠ": 0.1 },
    "é…‰": { "è¾›": 1.0 },
    "æˆŒ": { "æˆŠ": 0.6, "è¾›": 0.3, "ä¸": 0.1 },
    "äº¥": { "å£¬": 0.7, "ç”²": 0.3 },
  };

  // ====== PURE HELPERS ======
  function pad2(n) {
    return String(n).padStart(2, "0");
  }

  function toTraditionalStarName(name) {
    return STAR_NAME_TRAD_MAP[name] || name;
  }

  function getStarsForPalace(ziwei, palaceName) {
    if (!ziwei || !ziwei.mainStars) return [];
    const keys = PALACE_KEY_MAP[palaceName] || [palaceName];
    const all = [];
    keys.forEach((k) => {
      const list = ziwei.mainStars[k];
      if (Array.isArray(list)) list.forEach((s) => all.push(s));
    });
    return all;
  }

  function pctFromWx(wx) {
    const total = Object.values(wx || {}).reduce((s, v) => s + (Number(v) || 0), 0) || 1;
    const pct = {};
    ["æœ¨", "ç«", "åœŸ", "é‡‘", "æ°´"].forEach((k) => (pct[k] = (Number(wx?.[k] || 0) / total)));
    return { total, pct };
  }

  // ä¸‰æ–¹å››æ­£ï¼šæœ¬å®® + å°å®®( +6 ) + ä¸‰åˆ( +4, +8 )
  function computeRelatedPalaces(palaceRing, palaceName) {
    const ring = Array.isArray(palaceRing) && palaceRing.length === 12 ? palaceRing : PALACE_DEFAULT;
    const idx = ring.indexOf(palaceName);
    if (idx < 0) return { active: palaceName, related: [] };
    const relatedIdx = new Set([idx, (idx + 6) % 12, (idx + 4) % 12, (idx + 8) % 12]);
    const related = Array.from(relatedIdx).map((i) => ring[i]);
    return { active: palaceName, related };
  }

  // ä¾ã€Œå‘½å®®åœ°æ”¯ã€ï¼‹å›ºå®š PALACE_DEFAULT â†’ ç®—å‡ºæ¯ä¸€æ ¼è¦æ”¾å“ªå€‹å®®ä½ï¼ˆæ ¼å­ï¼åœ°æ”¯ã€å…§å®¹ï¼å®®ä½ï¼‰
  function buildSlotsFromZiwei(ziwei) {
    if (!ziwei) return [];

    // è‹¥å¾Œç«¯æ²’çµ¦æˆ–çµ¦äº†é 12 åœ°æ”¯çš„å€¼ï¼Œå°± fallback åˆ°ã€Œå¯…ã€
    let mingBranch = ziwei?.core?.minggongBranch || "å¯…";
    const shenBranch = ziwei?.core?.shengongBranch || null;

    let mingIdx = BRANCH_RING.indexOf(mingBranch);
    if (mingIdx < 0) {
      mingIdx = 0;
      mingBranch = BRANCH_RING[0];
    }

    const palaceOrder = PALACE_DEFAULT; // å‘½ã€å…„ã€å¤«ã€å­â€¦ é€™å€‹é †åºæ˜¯å›ºå®šçš„ã€Œå®®ä½é‚è¼¯ã€

    return BRANCH_RING.map((branch, idx) => {
      // è®“ã€Œå‘½å®®ã€å°é½Šå‘½å®®åœ°æ”¯æ‰€åœ¨çš„é‚£ä¸€æ ¼ï¼Œå…¶é¤˜å®®ä½ç…§é€†è¡Œé †åºæ’
      const palaceIndex = (mingIdx - idx + 12) % 12;
      const palaceName = palaceOrder[palaceIndex];

      const rawStars = getStarsForPalace(ziwei, palaceName);
      const stars = rawStars.map(toTraditionalStarName);

      let palaceMainElement = "";
      if (stars.length) {
        palaceMainElement = STAR_WUXING_MAP[stars[0]] || "";
      }

      return {
        index: idx,
        branch,
        palaceName,
        stars,
        isMing: branch === mingBranch,
        isShen: shenBranch ? branch === shenBranch : false,
        mainElement: palaceMainElement,
      };
    });
  }

  // å‹•æ…‹æˆ°è¡“æç¤ºï¼šä¿æŒã€Œè¨ˆç®—ã€æœ¬é«”ï¼›åç¥è§£é‡‹æ–‡å­—ç”± UI å‚³å…¥ï¼ˆé¿å… calc.js ä¾è³´ dbContentï¼‰
  function computeDynamicTactics(bazi, tenGodText) {
    const out = [];
    const dominant = (bazi?.tenGod?.dominant || "").trim();
    const wx = bazi?.wuxing?.strategic || null;
    if (!wx) return out;

    const { pct } = pctFromWx(wx);

    if (pct["ç«"] >= 0.35) out.push({ tone: "red", text: "ğŸ”¥ ç«ä½”æ¯”åé«˜ï¼šä»Šå¹´åšé‡å¤§æ±ºç­–å»ºè­°ã€Œå†·å» 48 å°æ™‚ã€ï¼Œå…ˆå¯«ä¸‹é¢¨éšªæ¸…å–®å†æ‹æ¿ã€‚" });
    if (pct["æ°´"] <= 0.10) out.push({ tone: "blue", text: "ğŸ’§ æ°´ä½”æ¯”åä½ï¼šéœ€è¦åˆ»æ„è£œå……è³‡è¨Šèˆ‡è³‡æºæµå‹•ï¼ˆè·¨ç•Œäº¤æµã€å»ºç«‹è³‡æ–™åº«ã€åšç¾é‡‘æµç·©è¡ï¼‰ã€‚" });
    if (pct["é‡‘"] >= 0.35) out.push({ tone: "slate", text: "âš”ï¸ é‡‘ä½”æ¯”åé«˜ï¼šåŸ·è¡Œæ¨™æº–å¼·ï¼Œä½†æ˜“è®“åˆä½œå£“åŠ›ä¸Šå‡ã€‚å»ºè­°ç”¨æµç¨‹å–ä»£æƒ…ç·’ï¼Œå…ˆå°é½Šè¦æ ¼å†è¦æ±‚é€Ÿåº¦ã€‚" });
    if (pct["åœŸ"] >= 0.40) out.push({ tone: "amber", text: "â›°ï¸ åœŸä½”æ¯”åé«˜ï¼šæ‰¿è¼‰åŠ›å¼·ä½†ç¯€å¥æ˜“éˆã€‚å»ºè­°æŠŠå¤§ç›®æ¨™æ‹†æˆé€±ç¯€é»ï¼Œç”¨å„€è¡¨æ¿æ¨é€²è€Œä¸æ˜¯é æ„å¿—åŠ›ã€‚" });
    if (pct["æœ¨"] >= 0.35) out.push({ tone: "green", text: "ğŸŒ² æœ¨ä½”æ¯”åé«˜ï¼šæ“´å¼µèˆ‡è¦åŠƒå¾ˆå¼·ï¼Œä½†æ³¨æ„æˆ°ç·šéå¤šã€‚å»ºè­°åšã€å‰ªæã€ï¼šç æ‰ 20% ä¸å¿…è¦ä»»å‹™ï¼Œæˆæœæœƒæ›´å¤§ã€‚" });

    if (dominant && tenGodText) {
      out.push({ tone: "amber", text: `ğŸ§­ åç¥ä¸»è»¸ï¼ˆ${dominant}ï¼‰ï¼š${tenGodText}` });
    } else if (dominant) {
      out.push({ tone: "amber", text: `ğŸ§­ åç¥ä¸»è»¸ï¼ˆ${dominant}ï¼‰ï¼šä»Šå¹´ç”¨ã€Œæµç¨‹åŒ–ã€è¦å‰‡åŒ–ã€æ–¹å¼æ¨é€²ï¼Œå£“åŠ›æœˆå…ˆå®ˆè¦å‰‡å†è«‡çªç ´ã€‚` });
    }

    return out;
  }

  // ====== EXPOSE ======
  const Calc = Object.freeze({
    PALACE_DEFAULT,
    PALACE_KEY_MAP,
    gridAreas,
    BRANCH_RING,
    STAR_WUXING_MAP,
    CANGGAN_DATA,

    pad2,
    toTraditionalStarName,
    getStarsForPalace,
    pctFromWx,
    computeRelatedPalaces,
    buildSlotsFromZiwei,
    computeDynamicTactics,
  });

  if (typeof window !== "undefined") {
    window.Calc = Calc;
  } else if (typeof globalThis !== "undefined") {
    // è®“ Node / æ¸¬è©¦ç’°å¢ƒä¹Ÿèƒ½å¼•ç”¨ï¼ˆéå¿…è¦ï¼Œä½†æ›´ç©©å®šï¼‰
    globalThis.Calc = Calc;
  }
})();

