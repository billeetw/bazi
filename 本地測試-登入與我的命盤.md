# 本地測試：登入與我的命盤

要測試 Google 登入與「我的命盤」功能，必須用 **Cloudflare Pages 開發伺服器**（會跑 Functions + D1），不能用單純的靜態 http-server。

## 1. 環境變數（.dev.vars）

在專案根目錄建立 `.dev.vars`（若尚未有），可從 `.dev.vars.example` 複製後填入：

```bash
cp .dev.vars.example .dev.vars
```

在 `.dev.vars` 中至少要有（登入與我的命盤用）：

- `GOOGLE_CLIENT_ID`：Google OAuth 用戶端 ID（與 Cloud Console 一致）
- `GOOGLE_CLIENT_SECRET`：Google OAuth 用戶端密鑰
- `JWT_SECRET`：至少 32 字元的隨機字串（用來簽 JWT）

後台用（可選）：

- `ADMIN_USER`、`ADMIN_PASSWORD`

## 2. D1 本地 migration（第一次或 schema 有改時）

```bash
npx wrangler d1 migrations apply consult-db --local
```

成功後本地會有 `users`、`user_charts` 表。

## 3. 啟動開發伺服器

```bash
./start-dev.sh
```

或：

```bash
npx wrangler pages dev . --port 8788
```

啟動後：

- 主頁：<http://localhost:8788/>
- API 設定：<http://localhost:8788/api/auth/config>

## 4. Google OAuth 設定（本地用）

在 [Google Cloud Console](https://console.cloud.google.com/) → APIs & Services → Credentials → 你的 OAuth 2.0 用戶端：

- **已授權的 JavaScript 來源** 加上：`http://localhost:8788`
- **已授權的重新導向 URI** 若有用到 redirect 也加上：`http://localhost:8788`（GSI code 流程通常用目前頁面 origin，可不加）

確保 `.dev.vars` 的 `GOOGLE_CLIENT_ID`、`GOOGLE_CLIENT_SECRET` 與此用戶端一致。

## 5. 測試流程

1. 開瀏覽器到 <http://localhost:8788/>
2. 點右上「登入」→ 應跳出 Google 登入視窗
3. 登入成功後應顯示「登入為 xxx」與「登出」
4. 上方應出現「我的命盤」區塊，下方表單區應出現「儲存到我的命盤」
5. 輸入出生資料後點「開啟 人生使用說明書」跑一次計算
6. 點「儲存到我的命盤」→ 輸入名稱（如「本人」）→ 送出，列表應出現該筆
7. 點列表另一筆（若有）或再存一筆，再點列表上的名稱，應帶入表單並重新計算
8. 點列表旁的「刪除」→ 確認後該筆應消失
9. 存滿 5 筆後再按「儲存到我的命盤」應出現「最多 5 筆…」提示
10. 點「登出」→ 「我的命盤」與「儲存到我的命盤」應隱藏

## 6. 若 API 回 401

- 表示 JWT 過期或無效，點「登出」再重新登入即可。
- 若尚未登入就呼叫 `/api/me/charts`，也會回 401。

## 7. 常見問題

- **登入按鈕沒反應**：檢查 Console 是否載入 GSI、`/api/auth/config` 是否回傳 `config.google.clientId`。
- **POST /api/auth/google 失敗**：檢查 `.dev.vars` 的 `GOOGLE_CLIENT_SECRET`、Google Console 的 redirect/origin 是否含 `http://localhost:8788`。
- **D1 錯誤（no such table）**：先執行步驟 2 的 migration。
