# 階段2優化計劃：拆分大文件

## 📊 當前狀態

### 文件規模
- **calc.js**: 2,573 行（88+ 個函數）
- **ui.js**: 2,423 行（34+ 個函數 + DOM 操作）
- **總計**: 4,996 行

### 階段1完成情況 ✅
- ✅ 提取重複代碼（utils.js）
- ✅ 提取配置常量（config.js）
- ✅ 優化全局狀態（state.js）

---

## 🎯 階段2目標

### 目標指標
- **單文件最大行數**: < 500 行（目前 2,573 行）
- **函數數量**: 每個模組 < 10 個
- **職責清晰**: 每個模組只負責一個領域
- **向後兼容**: 保持現有 API 不變

---

## 📋 階段2實施計劃

### 2.1 拆分 calc.js（優先級：高）

#### 建議拆分結構
```
js/
├── calc/
│   ├── ziwei-core.js        (~400 行) L1-L3: 基礎計算（主星、輔星、亮度、共鳴）
│   ├── ziwei-spatial.js     (~200 行) L4: 空間連動（三方四正）
│   ├── ziwei-subjective.js  (~150 行) L7: 主觀頻率修正（小限增益）
│   ├── ziwei-penalty.js     (~300 行) L8: 雜曜神煞（懲罰規則）
│   ├── ziwei-output.js      (~400 行) L9: 語義輸出（星等映射、戰略建議）
│   ├── bazi-core.js          (~300 行) 八字核心計算
│   ├── bazi-wuxing.js        (~200 行) 五行計算
│   ├── liuyue-rating.js      (~200 行) 流月星等計算
│   ├── tactics.js             (~200 行) 年度戰術建議生成
│   └── constants.js          (~300 行) 常數定義（宮位、星曜映射等）
└── calc.js                    (~200 行) 主入口（整合所有模組，保持 API）
```

#### 拆分策略
1. **保持向後兼容**：
   - `calc.js` 作為主入口，導入所有子模組
   - 保持 `window.Calc` 導出接口不變
   - 內部使用模組化結構

2. **模組職責劃分**：
   - **ziwei-core.js**: 基礎計算邏輯（L1-L3）
   - **ziwei-spatial.js**: 空間連動（L4）
   - **ziwei-subjective.js**: 主觀頻率修正（L7）
   - **ziwei-penalty.js**: 雜曜神煞處理（L8）
   - **ziwei-output.js**: 語義輸出（L9）
   - **bazi-core.js**: 八字計算
   - **bazi-wuxing.js**: 五行計算
   - **liuyue-rating.js**: 流月星等
   - **tactics.js**: 年度戰術建議
   - **constants.js**: 所有常數定義

3. **依賴管理**：
   - 使用 IIFE 模式，避免全局污染
   - 通過 `window.Calc` 統一導出
   - 子模組可以互相引用（通過主入口）

---

### 2.2 拆分 ui.js（優先級：中）

#### 建議拆分結構
```
js/
├── ui/
│   ├── components/
│   │   ├── palace-scores.js    (~300 行) 宮位強度渲染
│   │   ├── palace-detail.js     (~400 行) 宮位詳解（底部面板）
│   │   ├── liuyue-month.js      (~300 行) 流月卡片渲染
│   │   ├── wuxing-bars.js       (~200 行) 五行條形圖
│   │   ├── wuxing-radar.js      (~150 行) 五行雷達圖
│   │   └── summary-bar.js      (~100 行) 頂部摘要欄
│   ├── handlers/
│   │   ├── palace-click.js      (~200 行) 宮位點擊處理
│   │   ├── sheet-toggle.js      (~150 行) 底部面板切換
│   │   └── form-submit.js       (~300 行) 表單提交與計算流程
│   └── utils/
│       ├── dom-helpers.js        (~100 行) DOM 操作工具
│       └── render-helpers.js    (~150 行) 渲染輔助函數
└── ui.js                         (~200 行) 主入口（整合所有模組）
```

#### 拆分策略
1. **組件化**：
   - 每個 UI 組件獨立文件
   - 組件只負責渲染，不處理業務邏輯
   - 通過參數接收數據

2. **事件處理分離**：
   - 事件處理邏輯獨立到 handlers/
   - 避免在組件中直接綁定事件
   - 統一事件管理

3. **保持向後兼容**：
   - `ui.js` 作為主入口
   - 保持現有函數調用方式
   - 內部使用模組化結構

---

## 🚀 實施步驟

### 步驟 1: 拆分 calc.js（預計 1-2 週）

#### 1.1 提取常數模組（1-2 天）
- [ ] 創建 `js/calc/constants.js`
- [ ] 提取所有常數定義（PALACE_DEFAULT, STAR_NAME_TRAD_MAP 等）
- [ ] 更新 `calc.js` 引用

#### 1.2 拆分核心計算模組（2-3 天）
- [ ] 創建 `js/calc/ziwei-core.js`（L1-L3）
- [ ] 提取基礎計算函數
- [ ] 測試確保功能正常

#### 1.3 拆分空間連動模組（1 天）
- [ ] 創建 `js/calc/ziwei-spatial.js`（L4）
- [ ] 提取 `applySpatialAggregation` 相關邏輯
- [ ] 測試確保功能正常

#### 1.4 拆分主觀頻率修正模組（1 天）
- [ ] 創建 `js/calc/ziwei-subjective.js`（L7）
- [ ] 提取 `stageSubjectiveBoost` 相關邏輯
- [ ] 測試確保功能正常

#### 1.5 拆分雜曜神煞模組（2 天）
- [ ] 創建 `js/calc/ziwei-penalty.js`（L8）
- [ ] 提取雜曜神煞處理邏輯
- [ ] 測試確保功能正常

#### 1.6 拆分語義輸出模組（2 天）
- [ ] 創建 `js/calc/ziwei-output.js`（L9）
- [ ] 提取 `finalizeStarRating` 和相關映射邏輯
- [ ] 測試確保功能正常

#### 1.7 拆分八字和流月模組（2 天）
- [ ] 創建 `js/calc/bazi-core.js`
- [ ] 創建 `js/calc/bazi-wuxing.js`
- [ ] 創建 `js/calc/liuyue-rating.js`
- [ ] 創建 `js/calc/tactics.js`
- [ ] 測試確保功能正常

#### 1.8 整合主入口（1 天）
- [ ] 更新 `calc.js` 為主入口
- [ ] 導入所有子模組
- [ ] 保持 `window.Calc` 導出接口
- [ ] 全面測試

---

### 步驟 2: 拆分 ui.js（預計 1-2 週）

#### 2.1 提取渲染組件（3-4 天）
- [ ] 創建 `js/ui/components/palace-scores.js`
- [ ] 創建 `js/ui/components/palace-detail.js`
- [ ] 創建 `js/ui/components/liuyue-month.js`
- [ ] 創建 `js/ui/components/wuxing-bars.js`
- [ ] 創建 `js/ui/components/wuxing-radar.js`
- [ ] 創建 `js/ui/components/summary-bar.js`
- [ ] 測試每個組件

#### 2.2 提取事件處理（2-3 天）
- [ ] 創建 `js/ui/handlers/palace-click.js`
- [ ] 創建 `js/ui/handlers/sheet-toggle.js`
- [ ] 創建 `js/ui/handlers/form-submit.js`
- [ ] 測試事件處理邏輯

#### 2.3 提取工具函數（1 天）
- [ ] 創建 `js/ui/utils/dom-helpers.js`
- [ ] 創建 `js/ui/utils/render-helpers.js`
- [ ] 測試工具函數

#### 2.4 整合主入口（1 天）
- [ ] 更新 `ui.js` 為主入口
- [ ] 導入所有子模組
- [ ] 保持現有函數調用方式
- [ ] 全面測試

---

### 步驟 3: 更新文檔和測試（1 週）

#### 3.1 更新文檔
- [ ] 更新 `ARCHITECTURE_ASSESSMENT.md`
- [ ] 創建模組結構說明文檔
- [ ] 更新 API 文檔

#### 3.2 全面測試
- [ ] 功能測試（所有功能正常）
- [ ] 兼容性測試（向後兼容）
- [ ] 性能測試（確保無性能回退）

---

## 📊 預期效果

### 代碼組織
- **單文件最大行數**: 從 2,573 行降至 < 500 行
- **模組數量**: 從 2 個大文件拆分成 15+ 個小模組
- **職責清晰**: 每個模組只負責一個領域

### 可維護性
- ✅ 快速定位功能（知道在哪個模組）
- ✅ 減少 Git 衝突（不同開發者可以並行開發）
- ✅ 易於單元測試（每個模組獨立測試）

### 可擴展性
- ✅ 添加新功能只需修改對應模組
- ✅ 不影響其他模組
- ✅ 代碼重用性提高

---

## ⚠️ 風險評估

### 風險點
1. **向後兼容性**: 需要確保所有現有調用仍能正常工作
2. **依賴關係**: 模組間的依賴需要仔細管理
3. **測試覆蓋**: 需要全面測試確保無回歸

### 緩解措施
1. **漸進式遷移**: 先拆分，再逐步遷移調用
2. **保持 API**: 主入口保持現有 API 不變
3. **全面測試**: 每個步驟都進行測試

---

## 🎯 成功標準

### 技術指標
- [ ] 單文件 < 500 行
- [ ] 每個模組 < 10 個函數
- [ ] 所有功能正常運行
- [ ] 向後兼容 100%

### 質量指標
- [ ] 代碼可讀性提升
- [ ] 維護成本降低
- [ ] 新功能開發速度提升

---

## 📅 時間表

### 總計：3-4 週

- **第 1-2 週**: 拆分 calc.js
- **第 2-3 週**: 拆分 ui.js
- **第 3-4 週**: 測試和文檔更新

---

## 💡 建議

### 優先順序
1. **先拆分 calc.js**（計算邏輯更獨立，風險較低）
2. **再拆分 ui.js**（UI 邏輯較複雜，需要更多測試）

### 實施方式
- **漸進式**: 一次拆分一個模組，測試通過後再繼續
- **保持兼容**: 每個步驟都確保向後兼容
- **文檔先行**: 先規劃好結構，再開始拆分

---

**計劃日期**: 2026-02-04  
**預計開始**: 階段1完成後  
**狀態**: 📋 待開始
