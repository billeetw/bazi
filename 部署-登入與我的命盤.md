# 部署：登入與我的命盤

改好 `.dev.vars` 後，要讓**正式環境**也能登入與使用「我的命盤」，需完成以下步驟。

---

## 1. 設定正式環境變數（必做）

`.dev.vars` 只在本機有效，**不會**跟著程式碼部署。正式環境要在 Cloudflare 後台手動設：

1. 開啟 **Cloudflare Dashboard**：https://dash.cloudflare.com/
2. 左側選 **Workers & Pages** → 點你的專案 **bazi**
3. 上方選 **Settings** → 左側 **Environment variables**
4. 在 **Production**（或 Production + Preview）新增：

   | 變數名稱 | 值 | 備註 |
   |----------|-----|------|
   | `GOOGLE_CLIENT_ID` | 你的 Google 用戶端 ID | 與 .dev.vars 相同 |
   | `GOOGLE_CLIENT_SECRET` | 你的 Google 用戶端密鑰 | 與 .dev.vars 相同 |
   | `JWT_SECRET` | 至少 32 字元隨機字串 | 可與本機相同或另設一組 |

5. 儲存（Encrypt 可勾選，Cloudflare 會加密儲存）

---

## 2. 正式環境 D1 migration（第一次或 schema 有改時）

在專案根目錄執行（**不加** `--local`）：

```bash
npx wrangler d1 migrations apply consult-db
```

會對 **consult-db** 的正式資料庫套用 migrations（含 `users`、`user_charts`）。

---

## 3. Google OAuth 正式網址

在 [Google Cloud Console](https://console.cloud.google.com/) → APIs & Services → Credentials → 你的 OAuth 用戶端：

- **已授權的 JavaScript 來源** 加上正式網址，例如：
  - `https://www.17gonplay.com`
  - 或你的 Pages 網址：`https://bazi.pages.dev`（依實際專案網址）

---

## 4. 部署程式碼

在專案根目錄執行：

```bash
./deploy.sh
```

或：

```bash
npx wrangler pages deploy . --project-name=bazi
```

若專案有接 Git，也可以：

```bash
git add .
git commit -m "feat: 登入與我的命盤"
git push origin main
```

（若 Pages 已綁 Git，推送後會自動部署。）

---

## 5. 部署後檢查

1. 開啟正式網址（例如 https://www.17gonplay.com）
2. 點「登入」→ 應跳出 Google 登入
3. 登入後應看到「我的命盤」與「儲存到我的命盤」
4. 存一筆命盤、切換、刪除各試一次

若登入按鈕沒反應或出現「登入功能尚未設定」，請檢查：

- Cloudflare Pages → Settings → Environment variables 是否已設 `GOOGLE_CLIENT_ID`、`GOOGLE_CLIENT_SECRET`、`JWT_SECRET`
- Google OAuth 用戶端是否已加入該正式網址為「已授權的 JavaScript 來源」
