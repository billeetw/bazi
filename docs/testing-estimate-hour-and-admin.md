# 推算時辰與防濫用／專家後台 — 測試方式

## 一、本地啟動

```bash
# 若尚未跑過 migration 0009（user_ip），先跑一次
npx wrangler d1 migrations apply consult-db --local

# 啟動 Pages + Functions（需 .dev.vars 設 ADMIN_USER、ADMIN_PASSWORD）
npx wrangler pages dev . --port 8788
```

瀏覽器開：`http://localhost:8788`（或你設的 port）。

---

## 二、建議測試項目

### 階段一：防濫用

| 項目 | 怎麼測 |
|------|--------|
| **1.2 前端必填** | 開「推算時辰」問卷，故意不填完（例如少選 q1），按送出 → 應出現「請完成所有題目。」且不發請求。 |
| **1.1 後端頻率** | 登入後連續推算 5 次 → 第 6 次應回 429、「已達每日使用上限…」。同一帳號兩次推算間隔 < 30 秒 → 應回 429、「請稍後再試…」。 |

### 階段二：專家後台

| 項目 | 怎麼測 |
|------|--------|
| **2.1 / 2.2 異常監控** | 登入專家後台 → 「異常監控」→「載入監控」→ 應看到 24h Top 10、1h 列表、異常用戶說明；若有資料可看「依 IP 聚合」表格。 |
| **2.3 KV 快取** | 載入監控兩次：第二次應很快（讀 KV）；約 1 小時後再載入會重新查 D1。 |

### 階段三：IP 與後台

| 項目 | 怎麼測 |
|------|--------|
| **3.1 user_ip** | 跑過 migration 0009 後，用網站做一次推算 → 專家後台「載入推算紀錄」→ 該筆紀錄應有 IP 欄位（或為 -）。 |
| **3.2 IP 維度** | 「異常監控」→「載入監控」→ 若有帶 IP 的紀錄，應出現「過去 24h 依 IP 聚合」表格。 |

---

## 三、用 curl 測 API（可選）

**後台統計（需 Basic Auth）：**

```bash
# 將 YOUR_BASE64_AUTH 換成 echo -n "帳號:密碼" | base64 的結果
curl -s -u "你的後台帳號:你的後台密碼" http://localhost:8788/api/admin/estimate-hour-stats
```

預期：`{"ok":true,"last_24h_by_user":[...],"last_1h_by_user":[...],"anomaly_user_ids":[],"last_24h_by_ip":[...]}`

**推算時辰（需 JWT）：**  
一般用瀏覽器登入後在網站上操作即可；若要對正式環境測，用瀏覽器開發者工具看「推算時辰」送出時的請求與回應（429 時會看到錯誤訊息）。

---

## 四、正式環境

部署後到實際網址測：前端必填、頻率限制、專家後台「載入監控」與「載入推算紀錄」。WAF 限流（1.3）與 Bot Fight Mode（3.3）需在 Cloudflare 網域底下另設，設完後可用同 IP 短時間大量請求測限流。
