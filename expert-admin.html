<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>專家管理後台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%); color: #e2e8f0; font-family: system-ui, sans-serif; }
    .glass { background: rgba(15,23,42,0.88); backdrop-filter: blur(18px); border: 1px solid rgba(148,163,184,0.35); border-radius: 1.25rem; }
    .expert-question { margin-bottom: 1rem; }
    .expert-question .question-text { font-size: 0.875rem; margin-bottom: 0.25rem; }
    .expert-question select { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.25rem 0.5rem; color: #e2e8f0; width: 100%; max-width: 20rem; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-black text-emerald-400 mb-2">專家管理後台</h1>

    <div id="authWrap" class="hidden">
      <p class="text-sm text-amber-400">未登入或登入已過期，正在導回主選單…</p>
    </div>

    <div id="dashboardWrap" class="hidden">
      <div class="flex flex-wrap items-center gap-2 mb-6">
        <a href="admin.html" class="px-4 py-2 rounded-lg bg-slate-600 text-slate-200 text-sm hover:bg-slate-500 no-underline">← 返回主選單</a>
        <button type="button" id="logoutBtn" class="px-4 py-2 rounded-lg bg-slate-700 text-slate-200 text-sm hover:bg-slate-600">登出</button>
      </div>

      <div class="space-y-6">
        <!-- 獨立數據輸入：出生、問卷、經緯度 -->
        <div class="glass p-4 md:p-6">
          <h2 class="text-lg font-bold text-slate-200 mb-3">獨立數據輸入</h2>
          <p class="text-sm text-slate-400 mb-4">輸入出生資料、專家問卷與經緯度（選填），按下「執行」後取得命盤並產生戰略標籤、健康預警與 AI Prompt。</p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-xs text-slate-500 mb-1">出生年</label>
              <input type="number" id="birthYear" min="1900" max="2100" value="1990" class="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-slate-100 text-sm" />
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">月</label>
              <input type="number" id="birthMonth" min="1" max="12" value="6" class="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-slate-100 text-sm" />
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">日</label>
              <input type="number" id="birthDay" min="1" max="31" value="15" class="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-slate-100 text-sm" />
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">時（0–23）</label>
              <input type="number" id="birthHour" min="0" max="23" value="12" class="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-slate-100 text-sm" />
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">分</label>
              <input type="number" id="birthMinute" min="0" max="59" value="0" class="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-slate-100 text-sm" />
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">性別</label>
              <select id="birthGender" class="w-full bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-slate-100 text-sm">
                <option value="">—</option>
                <option value="M">男</option>
                <option value="F">女</option>
              </select>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-xs text-slate-500 mb-2">經緯度（選填）</label>
            <div class="flex gap-2 flex-wrap">
              <input type="text" id="geoLat" placeholder="緯度" class="flex-1 min-w-[8rem] bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-slate-100 text-sm" />
              <input type="text" id="geoLng" placeholder="經度" class="flex-1 min-w-[8rem] bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-slate-100 text-sm" />
            </div>
          </div>

          <details class="mb-4">
            <summary class="text-sm text-slate-400 cursor-pointer hover:text-slate-300">專家問卷（15 題，可選填）</summary>
            <div id="expertQuestionnaireWrap" class="mt-3 space-y-2 pl-2 border-l-2 border-slate-600"></div>
          </details>

          <button type="button" id="computeFromBirth" class="w-full py-4 rounded-xl bg-gradient-to-r from-emerald-600 to-emerald-500 text-white font-black tracking-wide hover:brightness-110 transition" onclick="if(typeof runComputeFromBirth==='function')runComputeFromBirth();else{var s=document.getElementById('loadStatus');if(s){s.textContent='請重新整理頁面後再試（若仍無反應請開開發者工具 F12 看 Console 錯誤）';s.classList.remove('hidden');}}">
            執行
          </button>
          <p id="loadStatus" class="text-xs text-slate-500 mt-2 hidden"></p>
        </div>

        <div class="glass p-4 md:p-6">
          <h2 class="text-lg font-bold text-slate-200 mb-2">戰略標籤</h2>
          <p id="strategyPlaceholder" class="text-sm text-slate-500">載入數據後將顯示戰略標籤（critical / high / medium / low）。</p>
          <div id="strategyTags" class="hidden mt-2 flex flex-wrap gap-2"></div>
        </div>

        <div class="glass p-4 md:p-6">
          <h2 class="text-lg font-bold text-slate-200 mb-2">健康預警</h2>
          <p id="healthPlaceholder" class="text-sm text-slate-500">載入數據後將顯示健康預警與建議。</p>
          <div id="healthContent" class="hidden text-sm text-slate-300"></div>
        </div>

        <div class="glass p-4 md:p-6">
          <h2 class="text-lg font-bold text-slate-200 mb-2">月度健康風險</h2>
          <p id="monthlyPlaceholder" class="text-sm text-slate-500">載入數據後將顯示 1–12 月健康風險心電圖。</p>
          <div id="monthlyChart" class="hidden mt-2"></div>
        </div>

        <div class="glass p-4 md:p-6">
          <h2 class="text-lg font-bold text-slate-200 mb-2">AI Prompt / 命書</h2>
          <p class="text-sm text-slate-400 mb-2">生成完整 AI Prompt 供一鍵生成命書使用。</p>
          <textarea id="aiPromptArea" class="w-full h-32 bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-slate-100 text-sm font-mono" placeholder="載入數據後可生成並複製 Prompt" readonly></textarea>
          <div class="flex flex-wrap gap-2 mt-2">
            <button type="button" id="copyPrompt" class="px-4 py-2 rounded-lg bg-amber-600/80 text-slate-900 text-sm font-medium hover:bg-amber-500">複製 Prompt</button>
            <button type="button" id="downloadPrompt" class="px-4 py-2 rounded-lg bg-slate-600 text-slate-200 text-sm hover:bg-slate-500">下載為文字檔</button>
          </div>
        </div>

        <div class="glass p-4 md:p-6">
          <h2 class="text-lg font-bold text-slate-200 mb-2">導出</h2>
          <p class="text-sm text-slate-400 mb-2">導出完整 JSON 或提交至後台 API。</p>
          <div class="flex flex-wrap gap-2">
            <button type="button" id="exportJson" class="px-4 py-2 rounded-lg bg-slate-600 text-slate-200 text-sm hover:bg-slate-500">導出 JSON</button>
            <button type="button" id="submitApi" class="px-4 py-2 rounded-lg bg-emerald-600/80 text-white text-sm font-medium hover:bg-emerald-500">提交到後台 API</button>
          </div>
          <p id="exportStatus" class="text-xs text-slate-500 mt-2 hidden"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function showDashboardIfAuth() {
      function run() {
        var auth = null;
        try { auth = sessionStorage.getItem('adminAuth'); } catch (e) {}
        var d = document.getElementById('dashboardWrap');
        var a = document.getElementById('authWrap');
        if (auth && d && a) {
          d.classList.remove('hidden');
          a.classList.add('hidden');
        } else if (!auth && a) {
          a.classList.remove('hidden');
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run);
      } else {
        run();
      }
    })();
  </script>
  <!-- 計算用腳本（依出生資料計算時需要） -->
  <script src="js/utils.js"></script>
  <script src="js/config.js"></script>
  <script src="js/state.js"></script>
  <script src="js/calc/constants.js"></script>
  <script src="js/calc/helpers.js"></script>
  <script src="js/calc/ziweiPipeline.js"></script>
  <script src="js/calc/ziweiOutput.js"></script>
  <script src="js/calc/baziCore.js"></script>
  <script src="js/calc/fourTransformations.js"></script>
  <script src="js/calc/overlapAnalysis.js"></script>
  <script src="js/calc/luckIndex.js"></script>
  <script src="js/calc/healthAnalysis.js"></script>
  <script src="js/calc/monthlyDetailedAnalysis.js"></script>
  <script src="js/calc/aiPromptGenerator.js"></script>
  <script src="js/calc/tactics.js"></script>
  <script src="js/calc.js"></script>
  <script src="js/calc/adminExport.js"></script>

  <script>
    var AUTH_KEY = 'adminAuth';
    var API_BASE = 'https://17gonplay-api.billeetw.workers.dev';

    function getStoredAuth() {
      try { return sessionStorage.getItem(AUTH_KEY); } catch { return null; }
    }
    function setStoredAuth(value) {
      try { if (value) sessionStorage.setItem(AUTH_KEY, value); else sessionStorage.removeItem(AUTH_KEY); } catch (_) {}
    }

    function authHeader() {
      var auth = getStoredAuth();
      return auth ? { Authorization: 'Basic ' + auth } : {};
    }

    function redirectToAdmin() {
      setStoredAuth('');
      window.location.href = 'admin.html';
    }

    function showAuthRequired() {
      document.getElementById('authWrap').classList.remove('hidden');
      document.getElementById('dashboardWrap').classList.add('hidden');
      setTimeout(redirectToAdmin, 1500);
    }

    function showDashboard() {
      document.getElementById('authWrap').classList.add('hidden');
      document.getElementById('dashboardWrap').classList.remove('hidden');
    }

    var currentData = null;

    // 專家問卷 15 題題目（與 expert-questionnaire.js 一致）
    var EXPERT_QUESTIONS = [
      { id: 'eq1', categoryName: '心理原型', text: '在面對重大決策時，你的核心驅動力來自？', options: [{ key: 'A', text: '邏輯分析與數據支撐' }, { key: 'B', text: '直覺感受與內在聲音' }, { key: 'C', text: '他人意見與社會共識' }, { key: 'D', text: '過往經驗與成功模式' }] },
      { id: 'eq2', categoryName: '心理原型', text: '你認為自己最核心的人格特質是？', options: [{ key: 'A', text: '執行力強，說到做到' }, { key: 'B', text: '觀察力敏銳，善於分析' }, { key: 'C', text: '創造力豐富，敢於突破' }, { key: 'D', text: '穩定可靠，承載力強' }] },
      { id: 'eq3', categoryName: '心理原型', text: '當你感到壓力時，內心的第一反應是？', options: [{ key: 'A', text: '立刻整理資訊，制定計劃' }, { key: 'B', text: '先退後觀察，等待時機' }, { key: 'C', text: '直接行動，邊做邊調整' }, { key: 'D', text: '尋求支持，與他人討論' }] },
      { id: 'eq4', categoryName: '心理原型', text: '你認為自己最擅長的領域是？', options: [{ key: 'A', text: '策略規劃與系統思考' }, { key: 'B', text: '人際連結與情感支持' }, { key: 'C', text: '創新突破與開拓新局' }, { key: 'D', text: '穩定執行與持續優化' }] },
      { id: 'eq5', categoryName: '心理原型', text: '你的人生目標更傾向於？', options: [{ key: 'A', text: '建立影響力與聲望' }, { key: 'B', text: '獲得內在平靜與智慧' }, { key: 'C', text: '創造價值與改變世界' }, { key: 'D', text: '建立穩定與安全感' }] },
      { id: 'eq6', categoryName: '行為偏好', text: '在團隊合作中，你更傾向於？', options: [{ key: 'A', text: '主導方向，制定規則' }, { key: 'B', text: '協調溝通，促進共識' }, { key: 'C', text: '執行任務，專注細節' }, { key: 'D', text: '提供創意，突破框架' }] },
      { id: 'eq7', categoryName: '行為偏好', text: '面對衝突時，你的處理方式是？', options: [{ key: 'A', text: '直接溝通，講道理訂規則' }, { key: 'B', text: '先避開，找適當時機再處理' }, { key: 'C', text: '快速解決，速戰速決' }, { key: 'D', text: '尋求第三方協助或調解' }] },
      { id: 'eq8', categoryName: '行為偏好', text: '學習新事物時，你更偏好？', options: [{ key: 'A', text: '系統性學習，建立完整架構' }, { key: 'B', text: '實作中學習，邊做邊學' }, { key: 'C', text: '與他人討論，從交流中學習' }, { key: 'D', text: '觀察模仿，從案例中學習' }] },
      { id: 'eq9', categoryName: '行為偏好', text: '完成一件大事後，你傾向於？', options: [{ key: 'A', text: '立即規劃下一步，持續推進' }, { key: 'B', text: '休息沉澱，整理經驗' }, { key: 'C', text: '分享成果，獲得認可' }, { key: 'D', text: '尋找新挑戰，開拓新領域' }] },
      { id: 'eq10', categoryName: '行為偏好', text: '面對不確定性時，你的第一反應是？', options: [{ key: 'A', text: '蒐集更多資訊，降低不確定性' }, { key: 'B', text: '先試一點，邊做邊調整' }, { key: 'C', text: '觀望等待，等局勢明朗' }, { key: 'D', text: '尋求他人建議，參考經驗' }] },
      { id: 'eq11', categoryName: '抗壓機制', text: '當你感到疲憊或壓力過大時，最有效的恢復方式是？', options: [{ key: 'A', text: '獨處靜心，整理思緒' }, { key: 'B', text: '運動或身體活動' }, { key: 'C', text: '與親友交流，獲得支持' }, { key: 'D', text: '轉換環境，暫時離開壓力源' }] },
      { id: 'eq12', categoryName: '抗壓機制', text: '面對失敗或挫折時，你的內在對話是？', options: [{ key: 'A', text: '分析原因，找出改進方法' }, { key: 'B', text: '接受現實，調整期待' }, { key: 'C', text: '重新出發，尋找新機會' }, { key: 'D', text: '尋求支持，與他人討論' }] },
      { id: 'eq13', categoryName: '抗壓機制', text: '當你感到能量耗盡時，你會優先？', options: [{ key: 'A', text: '減少工作量，保護核心任務' }, { key: 'B', text: '尋求協助，分擔責任' }, { key: 'C', text: '改變方法，提高效率' }, { key: 'D', text: '暫時休息，恢復後再戰' }] },
      { id: 'eq14', categoryName: '抗壓機制', text: '面對長期壓力時，你的應對策略是？', options: [{ key: 'A', text: '建立規律，維持穩定節奏' }, { key: 'B', text: '尋找意義，連結長期目標' }, { key: 'C', text: '適度調整，保持彈性' }, { key: 'D', text: '尋求專業協助或指導' }] },
      { id: 'eq15', categoryName: '抗壓機制', text: '你認為自己最需要加強的抗壓能力是？', options: [{ key: 'A', text: '情緒管理與內在穩定' }, { key: 'B', text: '時間管理與效率提升' }, { key: 'C', text: '人際支持與資源整合' }, { key: 'D', text: '目標設定與執行力' }] }
    ];

    function renderExpertQuestionnaire() {
      var wrap = document.getElementById('expertQuestionnaireWrap');
      if (!wrap) return;
      wrap.innerHTML = EXPERT_QUESTIONS.map(function (q) {
        var opts = q.options.map(function (o) { return '<option value="' + o.key + '">' + o.key + '. ' + o.text + '</option>'; }).join('');
        return '<div class="expert-question"><span class="text-xs text-slate-500">' + q.categoryName + '</span><p class="question-text">' + q.text + '</p><select data-qid="' + q.id + '"><option value="">—</option>' + opts + '</select></div>';
      }).join('');
    }

    function getQuestionnaireAnswers() {
      var out = {};
      EXPERT_QUESTIONS.forEach(function (q) {
        var sel = document.querySelector('select[data-qid="' + q.id + '"]');
        if (!sel || !sel.value) return;
        var opt = q.options.filter(function (o) { return o.key === sel.value; })[0];
        out[q.id] = { answer: sel.value, category: q.categoryName, questionText: q.text, optionText: opt ? opt.text : '' };
      });
      return out;
    }

    function getBirthFromForm() {
      return {
        year: parseInt(document.getElementById('birthYear').value, 10) || 1990,
        month: parseInt(document.getElementById('birthMonth').value, 10) || 6,
        day: parseInt(document.getElementById('birthDay').value, 10) || 15,
        hour: parseInt(document.getElementById('birthHour').value, 10) || 12,
        minute: parseInt(document.getElementById('birthMinute').value, 10) || 0,
        gender: (document.getElementById('birthGender').value || '').trim() || undefined
      };
    }

    function getGeoFromForm() {
      var lat = parseFloat(document.getElementById('geoLat').value);
      var lng = parseFloat(document.getElementById('geoLng').value);
      if (isNaN(lat) || isNaN(lng)) return null;
      return { longitude: lng, latitude: lat, accuracy: null, source: 'expert-admin', timestamp: new Date().toISOString() };
    }

    function mergeFormIntoCurrentData() {
      if (!currentData) return;
      var q = getQuestionnaireAnswers();
      if (Object.keys(q).length) {
        currentData.expertQuestionnaire = { answers: q, summary: { totalAnswered: Object.keys(q).length, totalQuestions: 15, completionRate: (Object.keys(q).length / 15) * 100 } };
        if (currentData.structuredData) currentData.structuredData.expertQuestionnaire = currentData.expertQuestionnaire;
      }
      var geo = getGeoFromForm();
      if (geo) {
        currentData.geolocation = geo;
        if (currentData.structuredData) currentData.structuredData.geolocation = geo;
      }
    }

    function runComputeFromBirth() {
      var statusEl = document.getElementById('loadStatus');
      var btn = document.getElementById('computeFromBirth');
      if (btn) { btn.textContent = '執行中…'; btn.disabled = true; }
      statusEl.classList.remove('hidden');
      statusEl.textContent = '正在呼叫後端取得命盤…';
      var birth = getBirthFromForm();
      var body = { year: birth.year, month: birth.month, day: birth.day, hour: birth.hour, minute: birth.minute };
      if (birth.gender) body.gender = birth.gender;

      var apiUrl = API_BASE + '/compute/all';

      fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
        .then(function (res) {
          return res.json().then(function (data) { return { ok: res.ok, status: res.status, data: data }; }).catch(function () {
          return { ok: false, status: res.status, data: { error: '後端回傳非 JSON（' + res.status + '）' } };
        });
        })
        .then(function (r) {
          if (!r.ok || !r.data || !r.data.features) {
            statusEl.textContent = r.data && r.data.error ? r.data.error : '後端未回傳命盤（HTTP ' + r.status + '）。請確認後端 API（' + apiUrl + '）可用。';
            if (btn) { btn.textContent = '執行'; btn.disabled = false; }
            return;
          }
          var contract = r.data.features;
          var bazi = contract.bazi;
          var ziwei = contract.ziwei;
          if (!bazi || !ziwei) {
            statusEl.textContent = '後端未回傳 bazi 或 ziwei。';
            if (btn) { btn.textContent = '執行'; btn.disabled = false; }
            return;
          }
          if (!window.Calc || typeof window.Calc.computeAllPalaceScores !== 'function') {
            statusEl.textContent = '計算模組未載入，請重新整理頁面後再試。';
            if (btn) { btn.textContent = '執行'; btn.disabled = false; }
            return;
          }
          window.contract = contract;
          var currentYear = new Date().getFullYear();
          var age = currentYear - birth.year;
          var horoscope = window.BaziCore && window.BaziCore.getHoroscopeFromAge ? window.BaziCore.getHoroscopeFromAge(age, ziwei, bazi, birth.gender) : { age: age, yearlyIndex: 0, activeLimitPalaceName: null };
          var qAnswers = getQuestionnaireAnswers();
          if (Object.keys(qAnswers).length) window.expertQuestionnaire = qAnswers;
          var geo = getGeoFromForm();
          if (geo) window.geolocationData = geo;
          statusEl.textContent = '命盤已取得，正在計算宮位、戰略標籤與健康…';
          return window.Calc.computeAllPalaceScores(ziwei, horoscope, { bazi: bazi, age: age, currentYear: currentYear, gender: birth.gender }).then(function () {
            if (window.AdminExport && window.AdminExport.exportCalculationResults) {
              currentData = window.AdminExport.exportCalculationResults({ birthInfo: birth });
            } else {
              currentData = {
                birthInfo: birth,
                strategicTags: window.AIPromptGenerator && window.structuredData ? (window.AIPromptGenerator.generateStrategicTags(window.structuredData, { includeDetails: true }) : null,
                healthWarning: window.healthWarning,
                monthlyHealthRisk: window.monthlyHealthRisk,
                monthlyRisks: window.monthlyHealthRisk,
                aiPrompt: window.aiPrompt,
                structuredData: window.structuredData
              };
            }
            mergeFormIntoCurrentData();
            renderLoadedData();
            statusEl.textContent = '執行完成。';
            if (btn) { btn.textContent = '執行'; btn.disabled = false; }
          });
        })
        .catch(function (err) {
          statusEl.textContent = '執行失敗：' + (err.message || String(err));
          if (btn) { btn.textContent = '執行'; btn.disabled = false; }
        });
    }

    function normalizeStrategicTags(data) {
      if (!data) return [];
      if (Array.isArray(data)) return data;
      if (data.details && Array.isArray(data.details)) return data.details;
      if (data.tags && Array.isArray(data.tags)) return data.tags.map(function (t) { return typeof t === 'string' ? { tag: t, priority: 'medium' } : t; });
      return [];
    }

    function normalizeMonthlyRisks(data) {
      if (Array.isArray(data)) return data;
      if (data && data.monthlyHealthRisk) return data.monthlyHealthRisk;
      return [];
    }

    function renderLoadedData() {
      if (!currentData) return;
      var tagsEl = document.getElementById('strategyTags');
      var tagsPh = document.getElementById('strategyPlaceholder');
      var healthEl = document.getElementById('healthContent');
      var healthPh = document.getElementById('healthPlaceholder');
      var monthlyEl = document.getElementById('monthlyChart');
      var monthlyPh = document.getElementById('monthlyPlaceholder');
      var promptArea = document.getElementById('aiPromptArea');

      var tagList = normalizeStrategicTags(currentData.strategicTags);
      if (tagList.length) {
        tagsPh.classList.add('hidden');
        tagsEl.classList.remove('hidden');
        tagsEl.innerHTML = tagList.map(function (t) {
          var cls = 'px-2 py-1 rounded text-xs ';
          var p = (t.priority || '').toLowerCase();
          if (p === 'critical') cls += 'bg-red-500/30 text-red-200';
          else if (p === 'high') cls += 'bg-amber-500/30 text-amber-200';
          else if (p === 'medium') cls += 'bg-yellow-500/20 text-yellow-200';
          else cls += 'bg-slate-500/30 text-slate-300';
          return '<span class="' + cls + '">' + (t.tag || t.label || t.description || '') + '</span>';
        }).join('');
      }

      if (currentData.healthWarning) {
        healthPh.classList.add('hidden');
        healthEl.classList.remove('hidden');
        healthEl.textContent = typeof currentData.healthWarning === 'string' ? currentData.healthWarning : JSON.stringify(currentData.healthWarning, null, 2);
      }

      var monthlyRisks = normalizeMonthlyRisks(currentData);
      if (monthlyRisks.length) {
        monthlyPh.classList.add('hidden');
        monthlyEl.classList.remove('hidden');
        var maxVal = Math.max.apply(null, monthlyRisks.slice(0, 12).map(function (r) { return r.score != null ? r.score : 0; })) || 1;
        monthlyEl.innerHTML = '<div class="flex items-end gap-1 h-24">' + monthlyRisks.slice(0, 12).map(function (r, i) {
          var score = r.score != null ? r.score : 0;
          var pct = maxVal > 0 ? (score / maxVal) * 100 : 0;
          var color = score >= 60 ? 'bg-red-500' : score >= 30 ? 'bg-amber-500' : 'bg-emerald-500';
          return '<div class="flex-1 flex flex-col items-center"><div class="w-full ' + color + ' rounded-t min-h-[4px]" style="height:' + Math.max(4, pct) + '%"></div><span class="text-xs text-slate-500 mt-1">' + (i + 1) + '月</span></div>';
        }).join('') + '</div>';
      }

      if (currentData.aiPrompt) {
        promptArea.value = currentData.aiPrompt;
      } else if (currentData.structuredData && window.AIPromptGenerator && window.AIPromptGenerator.generateAIPrompt) {
        try {
          promptArea.value = window.AIPromptGenerator.generateAIPrompt(currentData.structuredData, { targetLength: 1500, includeDetails: true });
        } catch (e) {
          promptArea.value = '【命盤數據】\n' + JSON.stringify(currentData.structuredData, null, 2);
        }
      } else if (currentData.overlapAnalysis || currentData.fourTransformations) {
        promptArea.value = '【命盤數據】\n' + JSON.stringify({ overlapAnalysis: currentData.overlapAnalysis, fourTransformations: currentData.fourTransformations }, null, 2);
      }
    }

    function copyPrompt() {
      var area = document.getElementById('aiPromptArea');
      if (!area.value) return;
      area.select();
      try {
        document.execCommand('copy');
        document.getElementById('exportStatus').textContent = '已複製到剪貼簿';
        document.getElementById('exportStatus').classList.remove('hidden');
        setTimeout(function () { document.getElementById('exportStatus').classList.add('hidden'); }, 2000);
      } catch (e) {
        document.getElementById('exportStatus').textContent = '複製失敗';
        document.getElementById('exportStatus').classList.remove('hidden');
      }
    }

    function downloadPrompt() {
      var area = document.getElementById('aiPromptArea');
      if (!area.value) return;
      var blob = new Blob([area.value], { type: 'text/plain;charset=utf-8' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ai-prompt-' + new Date().toISOString().slice(0, 10) + '.txt';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function exportJson() {
      var statusEl = document.getElementById('exportStatus');
      if (!currentData) {
        statusEl.textContent = '請先載入數據（從前端 / 貼上 JSON / 依出生計算）。';
        statusEl.classList.remove('hidden');
        return;
      }
      var blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'calculation-results-' + new Date().toISOString().slice(0, 10) + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
      statusEl.textContent = '已下載 JSON';
      statusEl.classList.remove('hidden');
      setTimeout(function () { statusEl.classList.add('hidden'); }, 2000);
    }

    function submitApi() {
      var statusEl = document.getElementById('exportStatus');
      if (!currentData) {
        statusEl.textContent = '請先載入數據。';
        statusEl.classList.remove('hidden');
        return;
      }
      statusEl.textContent = '提交中…';
      statusEl.classList.remove('hidden');
      fetch('/api/admin/calculation-results', {
        method: 'POST',
        headers: Object.assign({ 'Content-Type': 'application/json' }, authHeader()),
        body: JSON.stringify(currentData)
      })
        .then(function (res) {
          if (res.status === 401) {
            redirectToAdmin();
            return;
          }
          return res.json().then(function (data) {
            statusEl.textContent = data.error ? data.error : '已提交成功';
          });
        })
        .catch(function (err) {
          statusEl.textContent = err.message || '提交失敗';
        });
    }

    document.getElementById('computeFromBirth').addEventListener('click', runComputeFromBirth);
    document.getElementById('copyPrompt').addEventListener('click', copyPrompt);
    document.getElementById('downloadPrompt').addEventListener('click', downloadPrompt);
    document.getElementById('exportJson').addEventListener('click', exportJson);
    document.getElementById('submitApi').addEventListener('click', submitApi);
    document.getElementById('logoutBtn').addEventListener('click', redirectToAdmin);

    renderExpertQuestionnaire();

    (function init() {
      var auth = getStoredAuth();
      if (!auth) {
        showAuthRequired();
        return;
      }
      showDashboard();
      fetch('/api/admin/consultations', { headers: authHeader() })
        .then(function (res) {
          if (res.status === 401) {
            showAuthRequired();
          }
        })
        .catch(function () {});
    })();
  </script>
</body>
</html>
