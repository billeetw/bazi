<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°ˆå®¶å¾Œå°ç®¡ç†ç•Œé¢ - äººç”Ÿæˆ°ç•¥å¼•æ“ (ç¨ç«‹è¨ˆç®—ç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%, #000 100%); 
      color: #e2e8f0; 
      font-family: system-ui, sans-serif; 
    }
    .glass { 
      background: rgba(15,23,42,0.88); 
      backdrop-filter: blur(18px); 
      border: 1px solid rgba(148,163,184,0.35); 
      border-radius: 1.25rem; 
    }
    .tag { 
      display: inline-block; 
      padding: 0.25rem 0.75rem; 
      background: rgba(255, 191, 0, 0.1); 
      border: 1px solid rgba(255, 191, 0, 0.3); 
      border-radius: 0.5rem; 
      font-size: 0.875rem; 
      color: #FFBF00; 
      margin: 0.25rem; 
    }
    .tag.critical { 
      background: rgba(255, 0, 0, 0.1); 
      border-color: rgba(255, 0, 0, 0.3); 
      color: #ff6b6b; 
    }
    .tag.high { 
      background: rgba(255, 191, 0, 0.15); 
      border-color: rgba(255, 191, 0, 0.4); 
      color: #FFD700; 
    }
    .tag.medium { 
      background: rgba(255, 191, 0, 0.1); 
      border-color: rgba(255, 191, 0, 0.3); 
      color: #FFBF00; 
    }
    .tag.low { 
      background: rgba(148, 163, 184, 0.1); 
      border-color: rgba(148, 163, 184, 0.3); 
      color: #94a3b8; 
    }
    .chart-container {
      position: relative;
      height: 200px;
      margin-top: 1rem;
    }
    .chart-bar {
      position: absolute;
      bottom: 0;
      width: calc(100% / 12 - 0.5rem);
      background: linear-gradient(to top, rgba(255, 191, 0, 0.3), rgba(255, 191, 0, 0.6));
      border: 1px solid rgba(255, 191, 0, 0.4);
      border-radius: 0.25rem 0.25rem 0 0;
      transition: all 0.3s ease;
    }
    .chart-bar:hover {
      background: linear-gradient(to top, rgba(255, 191, 0, 0.5), rgba(255, 191, 0, 0.8));
      transform: translateY(-2px);
    }
    .chart-bar.critical {
      background: linear-gradient(to top, rgba(255, 0, 0, 0.3), rgba(255, 0, 0, 0.6));
      border-color: rgba(255, 0, 0, 0.4);
    }
    .chart-bar.warning {
      background: linear-gradient(to top, rgba(255, 165, 0, 0.3), rgba(255, 165, 0, 0.6));
      border-color: rgba(255, 165, 0, 0.4);
    }
    .chart-bar.normal {
      background: linear-gradient(to top, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.6));
      border-color: rgba(34, 197, 94, 0.4);
    }
    .chart-label {
      position: absolute;
      bottom: -1.5rem;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
      text-align: center;
      width: 100%;
    }
    .chart-line {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background: rgba(255, 191, 0, 0.5);
      border-top: 1px dashed rgba(255, 191, 0, 0.3);
    }
    .chart-line.warning-line {
      top: 30%;
      background: rgba(255, 165, 0, 0.5);
      border-top-color: rgba(255, 165, 0, 0.3);
    }
    .chart-line.critical-line {
      top: 60%;
      background: rgba(255, 0, 0, 0.5);
      border-top-color: rgba(255, 0, 0, 0.3);
    }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-black text-amber-400 mb-2">å°ˆå®¶å¾Œå°ç®¡ç†ç•Œé¢</h1>
    <p class="text-sm text-slate-500 mb-6">ç¨ç«‹è¨ˆç®—ç‰ˆæœ¬ - ç™»å…¥å¾Œå¯ç›´æ¥åœ¨æ­¤ç•Œé¢å®Œæˆæ‰€æœ‰é€²éšåŠŸèƒ½è¨ˆç®—ï¼Œç„¡éœ€ä¾è³´å‰ç«¯é é¢</p>

    <!-- ç™»å…¥å€åŸŸ -->
    <div id="loginWrap" class="glass p-6 max-w-sm">
      <p class="text-sm text-slate-400 mb-4">è«‹è¼¸å…¥å¾Œå°å¸³è™Ÿèˆ‡å¯†ç¢¼</p>
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-xs text-slate-500 mb-1">å¸³è™Ÿ</label>
          <input type="text" id="loginUser" autocomplete="username" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-slate-100" placeholder="å¸³è™Ÿ" required />
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">å¯†ç¢¼</label>
          <input type="password" id="loginPass" autocomplete="current-password" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-slate-100" placeholder="å¯†ç¢¼" required />
        </div>
        <p id="loginError" class="text-sm text-amber-400 hidden"></p>
        <button type="submit" id="loginBtn" class="w-full py-3 rounded-xl bg-gradient-to-r from-amber-600 to-amber-500 text-slate-950 font-bold">ç™»å…¥</button>
      </form>
    </div>

    <!-- ä¸»æ§åˆ¶å° -->
    <div id="dashboardWrap" class="hidden">
      <div class="flex flex-wrap items-center gap-2 mb-4">
        <button type="button" id="logoutBtn" class="px-4 py-2 rounded-lg bg-slate-700 text-slate-200 text-sm hover:bg-slate-600">ç™»å‡º</button>
        <button type="button" id="refreshBtn" class="px-4 py-2 rounded-lg bg-amber-600/80 text-slate-900 text-sm font-medium hover:bg-amber-500">é‡æ–°æ•´ç†é¡¯ç¤º</button>
        <button type="button" id="generateLifeBookBtn" class="px-4 py-2 rounded-lg bg-green-600/80 text-slate-100 text-sm font-medium hover:bg-green-500">ä¸€éµç”Ÿæˆå‘½æ›¸</button>
      </div>

      <!-- æ•¸æ“šè¼¸å…¥å€åŸŸ -->
      <section class="glass p-4 md:p-6 mb-6">
        <h2 class="text-lg font-black text-amber-300 mb-3">æ•¸æ“šè¼¸å…¥</h2>
        <div id="calculationStatus" class="mb-3 p-2 bg-blue-600/20 border border-blue-400/30 rounded-lg text-sm text-blue-300 hidden"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs text-slate-500 mb-1">å‡ºç”Ÿè³‡è¨Šï¼ˆå¿…å¡«ï¼‰</label>
            <div class="grid grid-cols-3 gap-2">
              <input type="number" id="birthYear" placeholder="å¹´" min="1900" max="2100" value="1972" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm" />
              <input type="number" id="birthMonth" placeholder="æœˆ" min="1" max="12" value="8" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm" />
              <input type="number" id="birthDay" placeholder="æ—¥" min="1" max="31" value="2" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm" />
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input type="number" id="birthHour" placeholder="æ™‚ (0-23)" min="0" max="23" value="15" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm" />
              <input type="number" id="birthMinute" placeholder="åˆ† (0-59)" min="0" max="59" value="30" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm" />
            </div>
            <select id="gender" class="w-full mt-2 bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm" required>
              <option value="">é¸æ“‡æ€§åˆ¥ï¼ˆå¿…å¡«ï¼‰</option>
              <option value="M" selected>ç”·</option>
              <option value="F">å¥³</option>
            </select>
            <button type="button" id="calculateBtn" class="w-full mt-2 py-2 rounded-lg bg-amber-600/80 text-slate-900 text-sm font-medium hover:bg-amber-500">è¨ˆç®—æ‰€æœ‰é€²éšåŠŸèƒ½</button>
            <p class="text-xs text-slate-500 mt-2">é»æ“Šã€Œè¨ˆç®—ã€å°‡è‡ªå‹•è¨ˆç®—ï¼šå››åŒ–ç³»çµ±ã€ç–Šå®®åˆ†æã€å¥½å‘½æŒ‡æ•¸ã€å¥åº·é è­¦ã€æˆ°ç•¥æ¨™ç±¤ã€AI Prompt</p>
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1 mt-4">ç¶“ç·¯åº¦æ ¡æº–ï¼ˆå¯é¸ï¼‰</label>
            <div id="geolocationContainer"></div>
          </div>
        </div>
      </section>

      <!-- ç•°å¸¸ç›£æ§ï¼ˆæ¨ç®—æ™‚è¾°ï¼‰ -->
      <section class="glass p-4 md:p-6 mb-6">
        <h2 class="text-lg font-black text-amber-300 mb-3">ç•°å¸¸ç›£æ§</h2>
        <p class="text-xs text-slate-500 mb-3">éå» 24h / 1h æ¨ç®—é »ç‡èˆ‡ç•°å¸¸ç”¨æˆ¶ï¼Œä¾›ç¬¬ä¸€æ™‚é–“ç™¼ç¾åˆ·é‡æˆ–è…³æœ¬ã€‚</p>
        <div class="mb-4">
          <button type="button" id="loadEstimateStatsBtn" class="px-4 py-2 rounded-lg bg-amber-600/80 text-slate-900 text-sm font-medium hover:bg-amber-500">è¼‰å…¥ç›£æ§</button>
        </div>
        <div id="estimateStats24hWrap" class="mb-4 hidden">
          <p class="text-xs text-slate-500 mb-2">éå» 24h æ¨ç®—æ¬¡æ•¸ Top 10</p>
          <div class="overflow-x-auto">
            <table class="w-full text-sm border border-white/10 rounded-lg overflow-hidden">
              <thead>
                <tr class="bg-white/5 text-left">
                  <th class="p-2 border-b border-white/10">ç”¨æˆ¶</th>
                  <th class="p-2 border-b border-white/10">user_id</th>
                  <th class="p-2 border-b border-white/10">æ¬¡æ•¸</th>
                </tr>
              </thead>
              <tbody id="estimateStats24hBody"></tbody>
            </table>
          </div>
        </div>
        <div id="estimateStats1hWrap" class="mb-4 hidden">
          <p class="text-xs text-slate-500 mb-2">éå» 1h æ¨ç®—æ¬¡æ•¸ï¼ˆ&gt;20 æ¬¡ç‚ºè­¦è¨Šï¼‰</p>
          <div class="overflow-x-auto">
            <table class="w-full text-sm border border-white/10 rounded-lg overflow-hidden">
              <thead>
                <tr class="bg-white/5 text-left">
                  <th class="p-2 border-b border-white/10">ç”¨æˆ¶</th>
                  <th class="p-2 border-b border-white/10">user_id</th>
                  <th class="p-2 border-b border-white/10">æ¬¡æ•¸</th>
                </tr>
              </thead>
              <tbody id="estimateStats1hBody"></tbody>
            </table>
          </div>
        </div>
        <div id="estimateStatsAnomalyWrap" class="text-sm text-slate-400 hidden"></div>
        <div id="estimateStatsIpWrap" class="mb-4 hidden">
          <p class="text-xs text-slate-500 mb-2">éå» 24h ä¾ IP èšåˆï¼ˆè«‹æ±‚æ•¸ï¼ç”¨æˆ¶æ•¸ï¼Œä¾›åŒ IP å¤šå¸³è™Ÿåˆ†æï¼‰</p>
          <div class="overflow-x-auto">
            <table class="w-full text-sm border border-white/10 rounded-lg overflow-hidden">
              <thead>
                <tr class="bg-white/5 text-left">
                  <th class="p-2 border-b border-white/10">IP</th>
                  <th class="p-2 border-b border-white/10">è«‹æ±‚æ•¸</th>
                  <th class="p-2 border-b border-white/10">ç”¨æˆ¶æ•¸</th>
                </tr>
              </thead>
              <tbody id="estimateStatsIpBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- æ¨ç®—æ™‚è¾°çµæœ -->
      <section class="glass p-4 md:p-6 mb-6">
        <h2 class="text-lg font-black text-amber-300 mb-3">æ¨ç®—æ™‚è¾°çµæœ</h2>
        <p class="text-xs text-slate-500 mb-3">æ™‚è¾°æ¨ç®—ç´€éŒ„èˆ‡å›é¥‹åˆ†æï¼Œä¾›æ¨¡å‹å„ªåŒ–èˆ‡æº–ç¢ºç‡æª¢è¦–ã€‚</p>
        <div class="flex flex-wrap items-end gap-3 mb-4">
          <div>
            <label class="block text-xs text-slate-500 mb-1">æ—¥æœŸèµ·</label>
            <input type="date" id="estimateLogsFrom" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-slate-200" />
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">æ—¥æœŸè¿„</label>
            <input type="date" id="estimateLogsTo" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-slate-200" />
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">å›é¥‹</label>
            <select id="estimateLogsFeedback" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-slate-200">
              <option value="all">å…¨éƒ¨</option>
              <option value="yes">å·²å›é¥‹</option>
              <option value="no">æœªå›é¥‹</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">æ­£ç¢ºèˆ‡å¦</label>
            <select id="estimateLogsCorrect" class="bg-black/40 border border-white/10 rounded-lg px-3 py-2 text-sm text-slate-200">
              <option value="all">å…¨éƒ¨</option>
              <option value="1">æ­£ç¢º</option>
              <option value="0">ä¸æ­£ç¢º</option>
            </select>
          </div>
          <button type="button" id="loadEstimateLogsBtn" class="px-4 py-2 rounded-lg bg-amber-600/80 text-slate-900 text-sm font-medium hover:bg-amber-500">è¼‰å…¥æ¨ç®—ç´€éŒ„</button>
          <button type="button" id="exportEstimateLogsCsvBtn" class="px-4 py-2 rounded-lg bg-blue-600/80 text-slate-100 text-sm font-medium hover:bg-blue-500 hidden">åŒ¯å‡º CSV</button>
          <button type="button" id="exportEstimateLogsJsonBtn" class="px-4 py-2 rounded-lg bg-slate-600/80 text-slate-100 text-sm font-medium hover:bg-slate-500 hidden">åŒ¯å‡º JSON</button>
        </div>
        <div id="estimateLogsSummary" class="mb-4 p-3 bg-black/30 rounded-lg text-sm text-slate-300 hidden"></div>
        <div id="estimateLogsHeatmapWrap" class="mb-4 overflow-x-auto hidden">
          <p class="text-xs text-slate-500 mb-2">å›é¥‹çŸ©é™£ï¼ˆæ©«è»¸ï¼ç³»çµ±æ¨ç®—æ™‚è¾°ï¼Œç¸±è»¸ï¼ç”¨æˆ¶å›é¥‹çœŸå¯¦æ™‚è¾°ï¼›åƒ…çµ±è¨ˆã€Œä¸æ­£ç¢ºã€ç­†æ•¸ï¼‰</p>
          <div id="estimateLogsHeatmap" class="inline-block min-w-0"></div>
        </div>
        <div id="estimateLogsTableWrap" class="overflow-x-auto hidden">
          <table class="w-full text-sm border border-white/10 rounded-lg overflow-hidden">
            <thead>
              <tr class="bg-white/5 text-left">
                <th class="p-2 border-b border-white/10">æ™‚é–“</th>
                <th class="p-2 border-b border-white/10">ç”¨æˆ¶</th>
                <th class="p-2 border-b border-white/10">IP</th>
                <th class="p-2 border-b border-white/10">æ¨ç®—çµæœ</th>
                <th class="p-2 border-b border-white/10">å›é¥‹</th>
                <th class="p-2 border-b border-white/10">çœŸå¯¦æ™‚è¾°</th>
                <th class="p-2 border-b border-white/10">ç­”æ¡ˆ</th>
              </tr>
            </thead>
            <tbody id="estimateLogsTableBody"></tbody>
          </table>
        </div>
        <div id="estimateLogsEmpty" class="text-sm text-slate-500 hidden">å°šç„¡è³‡æ–™ï¼Œè«‹æŒ‰ã€Œè¼‰å…¥æ¨ç®—ç´€éŒ„ã€ã€‚</div>
      </section>

      <!-- æˆ°ç•¥æ¨™ç±¤ -->
      <section class="glass p-4 md:p-6 mb-6">
        <h2 class="text-lg font-black text-amber-300 mb-3">æˆ°ç•¥æ¨™ç±¤</h2>
        <div id="strategicTagsContainer" class="text-sm text-slate-400">
          <p>å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—</p>
        </div>
      </section>

      <!-- æ ¸å¿ƒæ•¸æ“šæ‘˜è¦ -->
      <section class="glass p-4 md:p-6 mb-6">
        <h2 class="text-lg font-black text-amber-300 mb-3">æ ¸å¿ƒæ•¸æ“šæ‘˜è¦</h2>
        <div id="coreDataContainer" class="text-sm text-slate-400">
          <p>å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—</p>
        </div>
      </section>

      <!-- 15å®®ä½æˆ°ç•¥å°å¼•è…³æœ¬ -->
      <section class="glass p-4 md:p-6 mb-6">
        <h2 class="text-lg font-black text-amber-300 mb-3">ğŸ› ï¸ 15å®®ä½æˆ°ç•¥å°å¼•è…³æœ¬</h2>
        <div class="mb-3 text-xs text-slate-500">ç³»çµ±è‡ªå‹•ç”Ÿæˆ15å€‹æˆ°ç•¥æ”»å‹¢å•é¡Œï¼Œæ¯å€‹å•é¡Œå°æ‡‰ä¸€å€‹å‘½ç›¤é—œéµå®®ä½æˆ–æ™‚ç©ºåº§æ¨™</div>
        <div class="mb-3 flex items-center gap-2">
          <button type="button" id="generateSummaryBtn" class="px-4 py-2 rounded-lg bg-green-600/80 text-slate-100 text-sm font-medium hover:bg-green-500">ğŸ“‹ ç”Ÿæˆè«®è©¢ç²¾è¯æ‘˜è¦</button>
          <button type="button" id="exportSummaryBtn" class="px-4 py-2 rounded-lg bg-blue-600/80 text-slate-100 text-sm font-medium hover:bg-blue-500">ğŸ’¾ å°å‡ºè«®è©¢ç²¾è¯ JSON</button>
        </div>
        <div id="consultationScriptContainer" class="text-sm text-slate-400">
          <p>å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—</p>
        </div>
      </section>

      <!-- ç–Šå®®èˆ‡å¼•çˆ†åˆ†æ -->
      <section class="glass p-4 md:p-6 mb-6">
        <h2 class="text-lg font-black text-amber-300 mb-3">ç–Šå®®èˆ‡å¼•çˆ†åˆ†æ</h2>
        <div id="overlapAnalysisContainer" class="text-sm text-slate-400">
          <p>å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—</p>
        </div>
        <details class="mt-4">
          <summary class="cursor-pointer text-xs text-slate-500 hover:text-slate-300">ğŸ”§ å·¥ç¨‹åŒ–èª¿è©¦æ•¸æ“šï¼ˆé»æ“Šå±•é–‹ï¼‰</summary>
          <pre id="overlapDebugContainer" class="mt-2 p-3 bg-black/40 border border-white/10 rounded text-xs font-mono text-slate-400 overflow-auto max-h-96"></pre>
        </details>
      </section>

      <!-- å¥åº·é è­¦ -->
      <section class="glass p-4 md:p-6 mb-6">
        <h2 class="text-lg font-black text-amber-300 mb-3">å¥åº·é è­¦</h2>
        <div id="healthWarningContainer" class="text-sm text-slate-400">
          <p>å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—</p>
        </div>
      </section>

      <!-- æœˆåº¦å¥åº·é¢¨éšªå¿ƒé›»åœ– -->
      <section class="glass p-4 md:p-6 mb-6">
        <h2 class="text-lg font-black text-amber-300 mb-3">ç”Ÿå‘½å¥åº·å¿ƒé›»åœ–ï¼ˆ1-12æœˆï¼‰</h2>
        <div id="monthlyHealthChartContainer" class="text-sm text-slate-400">
          <p>å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—</p>
        </div>
      </section>

      <!-- AI Prompt -->
      <section class="glass p-4 md:p-6 mb-6">
        <h2 class="text-lg font-black text-amber-300 mb-3">AI Promptï¼ˆå‘½æ›¸ç”Ÿæˆï¼‰</h2>
        <div class="flex items-center gap-2 mb-3">
          <button type="button" id="copyPromptBtn" class="px-4 py-2 rounded-lg bg-blue-600/80 text-slate-100 text-sm font-medium hover:bg-blue-500">è¤‡è£½ Prompt</button>
          <button type="button" id="downloadPromptBtn" class="px-4 py-2 rounded-lg bg-blue-600/80 text-slate-100 text-sm font-medium hover:bg-blue-500">ä¸‹è¼‰ Prompt</button>
        </div>
        <textarea id="aiPromptTextarea" readonly class="w-full h-96 bg-black/40 border border-white/10 rounded-lg px-4 py-3 text-sm font-mono text-slate-300" placeholder="AI Prompt å°‡åœ¨é€™è£¡é¡¯ç¤º..."></textarea>
      </section>

      <!-- å®Œæ•´æ•¸æ“šå°å‡º -->
      <section class="glass p-4 md:p-6">
        <h2 class="text-lg font-black text-amber-300 mb-3">å®Œæ•´æ•¸æ“šå°å‡º</h2>
        <div class="flex items-center gap-2 mb-3">
          <button type="button" id="exportJsonBtn" class="px-4 py-2 rounded-lg bg-green-600/80 text-slate-100 text-sm font-medium hover:bg-green-500">å°å‡º JSON</button>
          <button type="button" id="exportToApiBtn" class="px-4 py-2 rounded-lg bg-purple-600/80 text-slate-100 text-sm font-medium hover:bg-purple-500">æäº¤åˆ°å¾Œå° API</button>
        </div>
        <pre id="exportDataContainer" class="w-full h-64 bg-black/40 border border-white/10 rounded-lg px-4 py-3 text-xs font-mono text-slate-300 overflow-auto" style="white-space: pre-wrap; word-wrap: break-word;">å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—</pre>
      </section>
    </div>
  </div>

  <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
  <script src="js/calc/constants.js?v=1"></script>
  <script src="js/calc/helpers.js?v=1"></script>
  <script src="js/calc/baziCore.js?v=1"></script>
  <script src="js/calc/ziweiPipeline.js?v=1"></script>
  <script src="js/calc/ziweiOutput.js?v=1"></script>
  <script src="js/calc/tactics.js?v=1"></script>
  <script src="js/calc/fourTransformations.js?v=1"></script>
  <script src="js/calc/overlapAnalysis.js?v=1"></script>
  <script src="js/calc/luckIndex.js?v=1"></script>
  <script src="js/calc/healthAnalysis.js?v=1"></script>
  <script src="js/calc/aiPromptGenerator.js?v=1"></script>
  <script src="js/calc/adminExport.js?v=1"></script>
  <script src="js/calc/consultationScriptEngine.js?v=1"></script>
  <script src="js/calc.js?v=1"></script>
  <script src="js/ui/services/api-service.js?v=1"></script>
  <script src="js/ui/components/geolocation-calibration.js?v=1"></script>

  <script>
    var AUTH_KEY = 'expertAdminAuth';

    function getStoredAuth() {
      try { return sessionStorage.getItem(AUTH_KEY); } catch { return null; }
    }
    function setStoredAuth(value) {
      try { if (value) sessionStorage.setItem(AUTH_KEY, value); else sessionStorage.removeItem(AUTH_KEY); } catch (_) {}
    }

    function showLogin() {
      document.getElementById('loginWrap').classList.remove('hidden');
      document.getElementById('dashboardWrap').classList.add('hidden');
      setStoredAuth('');
    }

    function showDashboard() {
      document.getElementById('loginWrap').classList.add('hidden');
      document.getElementById('dashboardWrap').classList.remove('hidden');
    }

    /**
     * ç²å–èªè­‰è«‹æ±‚é ­
     * æ³¨æ„ï¼šèªè­‰ä¿¡æ¯åƒ…ç”¨æ–¼ API è«‹æ±‚ï¼Œä¸æœƒè¨˜éŒ„åˆ°æ—¥èªŒ
     */
    function authHeader() {
      var auth = getStoredAuth();
      return auth ? { Authorization: 'Basic ' + auth } : {};
    }

    // åˆå§‹åŒ–ç¶“ç·¯åº¦çµ„ä»¶
    function initComponents() {
      // åˆå§‹åŒ–ç¶“ç·¯åº¦æ ¡æº–
      if (window.GeolocationCalibration) {
        const container = document.getElementById('geolocationContainer');
        if (container) {
          window.GeolocationCalibration.init(container, {
            onSuccess: function(data) {
              console.log('ç¶“ç·¯åº¦è¨­ç½®:', data);
              updateDisplay();
            }
          });
        }
      }
    }

    // æ›´æ–°é¡¯ç¤ºï¼ˆå¾å…¨å±€ç‹€æ…‹ç²å–æ•¸æ“šï¼‰
    function refreshDisplay() {
      updateDisplay();
    }

    // è¨ˆç®—æ•¸æ“šï¼ˆç¨ç«‹è¨ˆç®—ï¼Œä¸ä¾è³´å‰ç«¯é é¢ï¼‰
    async function calculateData() {
      const year = parseInt(document.getElementById('birthYear').value);
      const month = parseInt(document.getElementById('birthMonth').value);
      const day = parseInt(document.getElementById('birthDay').value);
      const hour = parseInt(document.getElementById('birthHour').value) || 0;
      const minute = parseInt(document.getElementById('birthMinute').value) || 0;
      const gender = document.getElementById('gender').value;

      if (!year || !month || !day) {
        alert('è«‹è¼¸å…¥å®Œæ•´çš„å‡ºç”Ÿæ—¥æœŸ');
        return;
      }

      if (!gender) {
        alert('è«‹é¸æ“‡æ€§åˆ¥');
        return;
      }

      try {
        const btn = document.getElementById('calculateBtn');
        btn.disabled = true;
        btn.textContent = 'è¨ˆç®—ä¸­...';

        // é¡¯ç¤ºè¨ˆç®—ç‹€æ…‹
        const statusEl = document.getElementById('calculationStatus');
        if (statusEl) {
          statusEl.textContent = 'æ­£åœ¨é€£ç·šå¾Œç«¯è¨ˆç®—ï¼ˆå…«å­—ï¼‹ç´«å¾®ï¼‹æµæœˆï¼‹åç¥ï¼‰â€¦';
          statusEl.classList.remove('hidden');
        }

        // 1. èª¿ç”¨å¾Œç«¯ API ç²å–åŸºç¤æ•¸æ“šï¼ˆå…«å­—ã€ç´«å¾®ã€æµæœˆï¼‰
        const apiService = window.UiServices?.ApiService;
        if (!apiService) {
          throw new Error('API æœå‹™æœªè¼‰å…¥');
        }

        const payload = await apiService.computeAll({
          year: year,
          month: month,
          day: day,
          hour: hour,
          minute: minute,
          gender: gender
        });

        if (!payload?.ok || !payload?.features) {
          throw new Error(payload?.error || 'è¨ˆç®—å¤±æ•—');
        }

        const contract = payload.features;
        if (contract.version !== 'strategic_features_v1') {
          throw new Error('features æ ¼å¼éŒ¯èª¤ï¼ˆä¸æ˜¯ strategic_features_v1ï¼‰');
        }
        contract.astrolabeLanguage = payload.language || 'zh-CN';

        // 2. å­˜å„²åŸºç¤æ•¸æ“šåˆ°å…¨å±€ç‹€æ…‹
        window.contract = contract;
        window.chartId = payload.chartId;

        // 3. è¨ˆç®—å¹´é½¡
        const birthDate = new Date(year, month - 1, day, hour, minute);
        const today = new Date();
        let age = today.getFullYear() - year;
        if (today.getMonth() < month - 1 || (today.getMonth() === month - 1 && today.getDate() < day)) {
          age--;
        }
        const currentYear = today.getFullYear();

        // 4. è¨ˆç®—å°é™
        const bazi = contract.bazi;
        const ziwei = contract.ziwei;
        const horoscope = window.BaziCore?.getHoroscopeFromAge(age, gender, ziwei, bazi) || null;

        // 5. è¨ˆç®—æ‰€æœ‰å®®ä½åˆ†æ•¸ï¼ˆé€™æœƒè§¸ç™¼æ‰€æœ‰é«˜ç´šè¨ˆç®—ï¼‰
        if (!window.Calc || !window.Calc.computeAllPalaceScores) {
          throw new Error('è¨ˆç®—æ¨¡çµ„æœªè¼‰å…¥');
        }

        if (statusEl) {
          statusEl.textContent = 'æ­£åœ¨è¨ˆç®—å®®ä½åˆ†æ•¸å’Œé€²éšåˆ†æâ€¦';
        }

        // è¼‰å…¥æ¬Šé‡æ•¸æ“š
        let weightsData;
        if (window.Calc && window.Calc.loadZiweiWeights) {
          weightsData = await window.Calc.loadZiweiWeights();
        } else {
          // Fallback: å˜—è©¦ç›´æ¥è¼‰å…¥
          const weightsResp = await fetch('data/ziweiWeights.json');
          if (weightsResp.ok) {
            weightsData = await weightsResp.json();
          } else {
            throw new Error('ç„¡æ³•è¼‰å…¥æ¬Šé‡æ•¸æ“š');
          }
        }

        // è¨ˆç®—æ‰€æœ‰å®®ä½åˆ†æ•¸ï¼ˆé€™æœƒè‡ªå‹•è§¸ç™¼å››åŒ–ã€ç–Šå®®ã€å¥½å‘½æŒ‡æ•¸ã€å¥åº·é è­¦ç­‰è¨ˆç®—ï¼‰
        if (!window.Calc || !window.Calc.computeAllPalaceScores) {
          throw new Error('è¨ˆç®—æ¨¡çµ„æœªæ­£ç¢ºè¼‰å…¥');
        }

        const scores = await window.Calc.computeAllPalaceScores(
          ziwei,
          horoscope,
          {
            bazi: bazi,
            age: age,
            weightsData: weightsData,
            gender: gender
          }
        );

        // 6. ç¢ºä¿æ‰€æœ‰æ•¸æ“šéƒ½å·²è¨ˆç®—å®Œæˆ
        // computeAllPalaceScores å…§éƒ¨å·²ç¶“æœƒèª¿ç”¨æ‰€æœ‰é«˜ç´šè¨ˆç®—æ¨¡çµ„
        // æ•¸æ“šå·²ç¶“å­˜å„²åœ¨ window.* ä¸­

        // 7. æ›´æ–°é¡¯ç¤º
        updateDisplay();

        if (statusEl) {
          statusEl.textContent = 'è¨ˆç®—å®Œæˆï¼';
          statusEl.classList.add('hidden');
        }

        alert('è¨ˆç®—å®Œæˆï¼æ‰€æœ‰é€²éšåŠŸèƒ½æ•¸æ“šå·²ç”Ÿæˆã€‚');

        btn.disabled = false;
        btn.textContent = 'è¨ˆç®—';
      } catch (err) {
        console.error('è¨ˆç®—å¤±æ•—:', err);
        alert('è¨ˆç®—å¤±æ•—ï¼š' + err.message);
        const statusEl = document.getElementById('calculationStatus');
        if (statusEl) {
          statusEl.textContent = 'è¨ˆç®—å¤±æ•—ï¼š' + err.message;
          statusEl.classList.remove('hidden');
        }
        document.getElementById('calculateBtn').disabled = false;
        document.getElementById('calculateBtn').textContent = 'è¨ˆç®—';
      }
    }

    // æ›´æ–°é¡¯ç¤º
    function updateDisplay() {
      if (!window.AdminExport) return;

      try {
        const exportData = window.AdminExport.exportCalculationResults();
        updateDisplayFromData(exportData);
      } catch (err) {
        console.error('æ›´æ–°é¡¯ç¤ºå¤±æ•—:', err);
      }
    }

    // å¾æ•¸æ“šæ›´æ–°é¡¯ç¤º
    function updateDisplayFromData(data) {
      // æ›´æ–°æˆ°ç•¥æ¨™ç±¤
      updateStrategicTags(data);
      
      // æ›´æ–°æ ¸å¿ƒæ•¸æ“šæ‘˜è¦
      updateCoreData(data);
      
      // æ›´æ–°è«®è©¢åŠ‡æœ¬ï¼ˆéœ€è¦åœ¨ç–Šå®®åˆ†æä¹‹å¾Œï¼Œå› ç‚ºä¾è³´ç–Šå®®æ•¸æ“šï¼‰
      updateConsultationScript(data);
      
      // æ›´æ–°ç–Šå®®åˆ†æ
      updateOverlapAnalysis(data);
      
      // æ›´æ–°å¥åº·é è­¦
      updateHealthWarning(data);
      
      // æ›´æ–°æœˆåº¦å¥åº·é¢¨éšªå¿ƒé›»åœ–
      updateMonthlyHealthChart(data);
      
      // æ›´æ–° AI Prompt
      updateAIPrompt(data);
      
      // æ›´æ–°å°å‡ºæ•¸æ“š
      updateExportData(data);
    }

    // æ›´æ–°æˆ°ç•¥æ¨™ç±¤é¡¯ç¤º
    function updateStrategicTags(data) {
      const container = document.getElementById('strategicTagsContainer');
      if (!container) return;

      if (data.strategicTags && data.strategicTags.tags) {
        const tags = data.strategicTags.tags;
        const details = data.strategicTags.details || [];
        
        let html = '<div class="flex flex-wrap gap-2">';
        details.forEach(detail => {
          const priorityClass = detail.priority || 'medium';
          html += `<span class="tag ${priorityClass}" title="${detail.description || ''}">${detail.tag}</span>`;
        });
        html += '</div>';
        
        if (data.strategicTags.summary) {
          html += `<div class="mt-3 text-xs text-slate-500">ç¸½æ¨™ç±¤æ•¸ï¼š${data.strategicTags.summary.totalTags}</div>`;
        }
        
        container.innerHTML = html;
      } else if (data.structuredData && window.AIPromptGenerator) {
        const tags = window.AIPromptGenerator.generateStrategicTags(data.structuredData);
        if (tags.length > 0) {
          container.innerHTML = '<div class="flex flex-wrap gap-2">' +
            tags.map(tag => `<span class="tag">${tag}</span>`).join('') +
            '</div>';
        } else {
          container.innerHTML = '<p class="text-slate-500">æš«ç„¡æˆ°ç•¥æ¨™ç±¤</p>';
        }
      } else {
        container.innerHTML = '<p class="text-slate-500">å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—</p>';
      }
    }

    // æ›´æ–°æ ¸å¿ƒæ•¸æ“šæ‘˜è¦
    function updateCoreData(data) {
      const container = document.getElementById('coreDataContainer');
      if (!container) return;

      if (data.structuredData && window.AIPromptGenerator) {
        const summary = window.AIPromptGenerator.generateCoreDataSummary(data.structuredData);
        container.innerHTML = '<pre class="whitespace-pre-wrap text-sm">' + summary + '</pre>';
      } else {
        container.innerHTML = '<p class="text-slate-500">å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—</p>';
      }
    }

    // æ›´æ–°15å®®ä½æˆ°ç•¥å°å¼•è…³æœ¬
    function updateConsultationScript(data) {
      const container = document.getElementById('consultationScriptContainer');
      
      if (!container) return;

      // æª¢æŸ¥å¿…è¦æ•¸æ“š
      if (!window.ConsultationScriptEngine) {
        container.innerHTML = '<p class="text-slate-500">è«®è©¢è…³æœ¬å¼•æ“æœªè¼‰å…¥</p>';
        return;
      }

      if (!data.ziwei || !data.fourTransformations || !data.overlapAnalysis) {
        container.innerHTML = '<p class="text-slate-500">è«‹å…ˆå®Œæˆè¨ˆç®—ä»¥ç”Ÿæˆè«®è©¢è…³æœ¬</p>';
        return;
      }

      try {
        // ç”Ÿæˆ15å€‹æˆ°ç•¥å°å¼•è…³æœ¬
        const script = window.ConsultationScriptEngine.generateConsultationScript({
          ziweiData: data.ziwei,
          overlapAnalysis: data.overlapAnalysis,
          fourTransformations: data.fourTransformations,
          currentYear: new Date().getFullYear()
        });

        if (script.error) {
          container.innerHTML = '<p class="text-red-400">ç”Ÿæˆå¤±æ•—ï¼š' + script.error + '</p>';
          return;
        }

        // å¾localStorageè¼‰å…¥å·²è¨˜éŒ„çš„å›ç­”
        const savedAnswers = JSON.parse(localStorage.getItem('consultationAnswers') || '{}');

        // é¡¯ç¤º15å€‹å•é¡Œï¼ˆå¯å±•é–‹/æ”¶åˆï¼‰
        let html = '';

        // æŒ‰ç¶­åº¦åˆ†çµ„é¡¯ç¤º
        const dimensions = {
          'æ ¸å¿ƒæœ¬è³ª': script.questions.filter(q => q.dimension === 'æ ¸å¿ƒæœ¬è³ª'),
          'ç©ºé–“é…ç½®': script.questions.filter(q => q.dimension === 'ç©ºé–“é…ç½®'),
          'æ™‚é–“åº§æ¨™': script.questions.filter(q => q.dimension === 'æ™‚é–“åº§æ¨™')
        };

        Object.keys(dimensions).forEach(dimensionName => {
          const dimensionQuestions = dimensions[dimensionName];
          
          html += `<div class="mb-6">
            <h3 class="text-md font-bold text-amber-400 mb-3">${dimensionName}ï¼ˆ${dimensionQuestions.length}é¡Œï¼‰</h3>`;

          dimensionQuestions.forEach((q, index) => {
            const savedAnswer = savedAnswers[q.id] || '';
            
            html += `<details class="mb-3 bg-black/20 rounded-lg border border-white/10">
              <summary class="cursor-pointer p-3 hover:bg-black/30 flex items-center justify-between">
                <span class="font-bold text-slate-200">${q.id}: ${q.title}</span>
                <span class="text-xs text-slate-400">${q.palace}</span>
              </summary>
              <div class="p-4 space-y-4">
                <!-- 50% ç›´æ“Š -->
                <div class="p-3 bg-red-900/20 border border-red-500/30 rounded">
                  <div class="text-xs font-bold text-red-300 mb-1">ğŸ¯ ç›´æ“Š (50%)</div>
                  <div class="text-sm text-slate-200">ã€Œ${q.hook50}ã€</div>
                </div>
                
                <!-- 30% å•Ÿç™¼ -->
                <div class="p-3 bg-blue-900/20 border border-blue-500/30 rounded">
                  <div class="text-xs font-bold text-blue-300 mb-1">ğŸ’­ å•Ÿç™¼ (30%)</div>
                  <div class="text-sm text-slate-200">ã€Œ${q.reflection30}ã€</div>
                </div>
                
                <!-- 20% æ¡é›† -->
                <div class="p-3 bg-green-900/20 border border-green-500/30 rounded">
                  <div class="text-xs font-bold text-green-300 mb-1">ğŸ“ æ¡é›† (20%)</div>
                  <div class="text-sm text-slate-200 mb-2">ã€Œ${q.capture20}ã€</div>
                  <textarea 
                    id="answer_${q.id}" 
                    class="w-full h-20 bg-black/40 border border-white/10 rounded px-3 py-2 text-sm text-slate-300" 
                    placeholder="è¨˜éŒ„ç”¨æˆ¶å›ç­”çš„20%é—œéµæ•¸æ“š..."
                  >${savedAnswer}</textarea>
                </div>
              </div>
            </details>`;
          });

          html += `</div>`;
        });

        container.innerHTML = html;

        // ç¶å®štextareaè‡ªå‹•ä¿å­˜
        script.questions.forEach(q => {
          const textarea = document.getElementById(`answer_${q.id}`);
          if (textarea) {
            textarea.addEventListener('blur', function() {
              const answers = JSON.parse(localStorage.getItem('consultationAnswers') || '{}');
              answers[q.id] = this.value;
              localStorage.setItem('consultationAnswers', JSON.stringify(answers));
            });
          }
        });

        // å­˜å„²åˆ°å…¨å±€ç‹€æ…‹
        window.consultationScript = script;
        window.consultationAnswers = savedAnswers;

      } catch (err) {
        console.error('ç”Ÿæˆè«®è©¢è…³æœ¬å¤±æ•—:', err);
        container.innerHTML = '<p class="text-red-400">ç”Ÿæˆè«®è©¢è…³æœ¬å¤±æ•—ï¼š' + err.message + '</p>';
      }
    }

    // ç”Ÿæˆè«®è©¢ç²¾è¯æ‘˜è¦
    function generateConsultationSummary() {
      if (!window.consultationScript || !window.ConsultationScriptEngine) {
        alert('è«‹å…ˆå®Œæˆè¨ˆç®—ä»¥ç”Ÿæˆè«®è©¢è…³æœ¬');
        return;
      }

      const answers = JSON.parse(localStorage.getItem('consultationAnswers') || '{}');
      const summary = window.ConsultationScriptEngine.generateConsultationSummary(
        window.consultationScript,
        answers
      );

      // é¡¯ç¤ºæ‘˜è¦
      const summaryText = JSON.stringify({
        consultationScript: window.consultationScript,
        answers: answers,
        summary: summary,
        birthInfo: {
          year: document.getElementById('birthYear')?.value,
          month: document.getElementById('birthMonth')?.value,
          day: document.getElementById('birthDay')?.value,
          hour: document.getElementById('birthHour')?.value,
          minute: document.getElementById('birthMinute')?.value,
          gender: document.getElementById('gender')?.value
        },
        timestamp: new Date().toISOString()
      }, null, 2);

      // é¡¯ç¤ºåœ¨å°å‡ºæ•¸æ“šå€åŸŸ
      const exportContainer = document.getElementById('exportDataContainer');
      if (exportContainer) {
        exportContainer.textContent = summaryText;
        exportContainer.scrollIntoView({ behavior: 'smooth' });
      }

      // å­˜å„²åˆ°å…¨å±€ç‹€æ…‹
      window.consultationSummary = summary;
      
      alert(`è«®è©¢ç²¾è¯æ‘˜è¦å·²ç”Ÿæˆï¼\nå·²å›ç­”ï¼š${summary.totalAnswered}/15\né—œéµæ´å¯Ÿï¼š${summary.keyInsights.length}å€‹\nè¡Œå‹•é …ç›®ï¼š${summary.actionItems.length}å€‹`);
    }

    // å°å‡ºè«®è©¢ç²¾è¯JSON
    function exportConsultationSummary() {
      if (!window.consultationScript) {
        alert('è«‹å…ˆå®Œæˆè¨ˆç®—ä»¥ç”Ÿæˆè«®è©¢è…³æœ¬');
        return;
      }

      const answers = JSON.parse(localStorage.getItem('consultationAnswers') || '{}');
      const summary = window.ConsultationScriptEngine.generateConsultationSummary(
        window.consultationScript,
        answers
      );

      const exportData = {
        consultationScript: window.consultationScript,
        answers: answers,
        summary: summary,
        birthInfo: {
          year: document.getElementById('birthYear')?.value,
          month: document.getElementById('birthMonth')?.value,
          day: document.getElementById('birthDay')?.value,
          hour: document.getElementById('birthHour')?.value,
          minute: document.getElementById('birthMinute')?.value,
          gender: document.getElementById('gender')?.value
        },
        timestamp: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `consultation_summary_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert('è«®è©¢ç²¾è¯ JSON å·²ä¸‹è¼‰ï¼');
    }

    // æ›´æ–°ç–Šå®®åˆ†æ
    function updateOverlapAnalysis(data) {
      const container = document.getElementById('overlapAnalysisContainer');
      const debugContainer = document.getElementById('overlapDebugContainer');
      
      if (!container) return;

      // å·¥ç¨‹åŒ–èª¿è©¦æ•¸æ“š
      if (debugContainer) {
        try {
          // æ”¶é›†æ‰€æœ‰å®®ä½çš„è©³ç´°æ•¸æ“š
          const palaceDetails = {};
          if (data.overlapAnalysis?.palaceMap) {
            const palaceMap = data.overlapAnalysis.palaceMap;
            const mapEntries = palaceMap instanceof Map ? Array.from(palaceMap.entries()) : Object.entries(palaceMap);
            
            mapEntries.forEach(([palaceName, palaceData]) => {
              palaceDetails[palaceName] = {
                luCount: palaceData.luCount || 0,
                quanCount: palaceData.quanCount || 0,
                keCount: palaceData.keCount || 0,
                jiCount: palaceData.jiCount || 0,
                riskLevel: palaceData.riskLevel || 'normal',
                opportunityLevel: palaceData.opportunityLevel || 'normal',
                transformations: {
                  benming: palaceData.transformations?.benming || null,
                  dalimit: palaceData.transformations?.dalimit || null,
                  liunian: palaceData.transformations?.liunian || null,
                  xiaoxian: palaceData.transformations?.xiaoxian || null
                }
              };
            });
          }

          const debugData = {
            // åŸºæœ¬ç‹€æ…‹
            hasOverlapAnalysis: !!data.overlapAnalysis,
            overlapAnalysisExists: data.overlapAnalysis !== null && data.overlapAnalysis !== undefined,
            
            // å››åŒ–ç³»çµ±æ•¸æ“šæª¢æŸ¥
            fourTransformations: {
              exists: !!data.fourTransformations,
              benming: data.fourTransformations?.benming || null,
              dalimit: data.fourTransformations?.dalimit || null,
              liunian: data.fourTransformations?.liunian || null,
              xiaoxian: data.fourTransformations?.xiaoxian || null
            },
            
            // ç–Šå®®åˆ†æçµ±è¨ˆ
            summary: data.overlapAnalysis?.summary || {},
            criticalRisks: data.overlapAnalysis?.criticalRisks || [],
            maxOpportunities: data.overlapAnalysis?.maxOpportunities || [],
            volatileAmbivalences: data.overlapAnalysis?.volatileAmbivalences || [],
            
            // å®®ä½æ˜ å°„å¤§å°
            palaceMapSize: data.overlapAnalysis?.palaceMap ? (data.overlapAnalysis.palaceMap instanceof Map ? data.overlapAnalysis.palaceMap.size : Object.keys(data.overlapAnalysis.palaceMap).length) : 0,
            
            // æ‰€æœ‰å®®ä½çš„è©³ç´°æ•¸æ“šï¼ˆé—œéµï¼ï¼‰
            palaceDetails: palaceDetails,
            
            // å…¨å±€ç‹€æ…‹æª¢æŸ¥
            windowOverlapAnalysis: typeof window !== 'undefined' ? !!window.overlapAnalysis : 'N/A',
            windowFourTransformations: typeof window !== 'undefined' ? !!window.fourTransformations : 'N/A'
          };
          
          debugContainer.textContent = JSON.stringify(debugData, (key, value) => {
            // è™•ç† Map å°è±¡
            if (value instanceof Map) {
              return Object.fromEntries(value);
            }
            return value;
          }, 2);
        } catch (err) {
          debugContainer.textContent = 'èª¿è©¦æ•¸æ“šæ ¼å¼åŒ–éŒ¯èª¤ï¼š' + err.message + '\n' + err.stack;
        }
      }

      // é¡¯ç¤ºç–Šå®®åˆ†æçµæœ
      if (data.overlapAnalysis) {
        const { criticalRisks, maxOpportunities, volatileAmbivalences, summary } = data.overlapAnalysis;
        let html = '';

        // çµ±è¨ˆæ‘˜è¦
        if (summary) {
          html += `<div class="mb-4 p-3 bg-black/20 rounded">
            <div class="text-xs font-bold mb-2">ğŸ“Š çµ±è¨ˆæ‘˜è¦ï¼š</div>
            <div class="text-xs space-y-1">
              <div>åŠ‡çƒˆéœ‡ç›ª/å‰å‡¶ä¸¦è¦‹ï¼š${summary.totalVolatileAmbivalences || 0} å€‹å®®ä½</div>
              <div>è¶…ç´šåœ°é›·å€ï¼š${summary.totalCriticalRisks || 0} å€‹å®®ä½</div>
              <div>å¤§ç™¼è²¡æ©Ÿæœƒï¼š${summary.totalMaxOpportunities || 0} å€‹å®®ä½</div>
            </div>
          </div>`;
        }

        // åŠ‡çƒˆéœ‡ç›ª/å‰å‡¶ä¸¦è¦‹ï¼ˆæœ€é«˜å„ªå…ˆç´šï¼‰
        if (volatileAmbivalences && volatileAmbivalences.length > 0) {
          html += '<div class="mb-4">';
          html += '<div class="text-sm font-bold text-yellow-400 mb-2">âš¡ åŠ‡çƒˆéœ‡ç›ª/å‰å‡¶ä¸¦è¦‹ï¼ˆæˆæ•—ä¸€ç·šé–“ï¼‰</div>';
          volatileAmbivalences.forEach(volatile => {
            html += `<div class="mb-3 p-3 bg-yellow-900/20 border border-yellow-500/30 rounded">
              <div class="font-bold text-yellow-300">${volatile.palace}å®®</div>
              <div class="text-xs mt-1">${volatile.description}</div>
              <div class="text-xs mt-2 text-amber-200">ğŸ“Œ ${volatile.note}</div>
              <div class="text-xs mt-1 text-slate-400">åŒ–å¿Œï¼š${volatile.jiCount}é‡ | åŒ–ç¥¿ï¼š${volatile.luCount}é‡</div>
            </div>`;
          });
          html += '</div>';
        }

        // è¶…ç´šåœ°é›·å€
        if (criticalRisks && criticalRisks.length > 0) {
          html += '<div class="mb-4">';
          html += '<div class="text-sm font-bold text-red-400 mb-2">âš ï¸ è¶…ç´šåœ°é›·å€ï¼ˆå¿…é ˆçµ•å°é¿é–‹ï¼‰</div>';
          criticalRisks.forEach(risk => {
            html += `<div class="mb-2 p-2 bg-red-900/20 border border-red-500/30 rounded">
              <div class="font-bold text-red-300">${risk.palace}å®®</div>
              <div class="text-xs mt-1">${risk.description}</div>
              <div class="text-xs mt-1 text-slate-400">åŒ–å¿Œï¼š${risk.jiCount}é‡</div>
            </div>`;
          });
          html += '</div>';
        }

        // å¤§ç™¼è²¡æ©Ÿæœƒ
        if (maxOpportunities && maxOpportunities.length > 0) {
          html += '<div class="mb-4">';
          html += '<div class="text-sm font-bold text-green-400 mb-2">âœ¨ å¤§ç™¼è²¡æ©Ÿæœƒï¼ˆå»ºè­°ç©æ¥µæŠŠæ¡ï¼‰</div>';
          maxOpportunities.forEach(opp => {
            html += `<div class="mb-2 p-2 bg-green-900/20 border border-green-500/30 rounded">
              <div class="font-bold text-green-300">${opp.palace}å®®</div>
              <div class="text-xs mt-1">${opp.description}</div>
              <div class="text-xs mt-1 text-slate-400">åŒ–ç¥¿ï¼š${opp.luCount}é‡</div>
            </div>`;
          });
          html += '</div>';
        }

        // ç–Šå®®è©•è«–
        if (window.OverlapAnalysis && data.overlapAnalysis) {
          try {
            const report = window.OverlapAnalysis.generateOverlapReport(data.overlapAnalysis);
            if (report.comments && report.comments.length > 0) {
              html += '<div class="mt-4">';
              html += '<div class="text-sm font-bold mb-2">ğŸ“Š ç–Šå®®è©•è«–</div>';
              report.comments.forEach(comment => {
                html += `<div class="mb-1 text-xs">${comment}</div>`;
              });
              html += '</div>';
            }
          } catch (err) {
            console.warn('ç”Ÿæˆç–Šå®®è©•è«–å¤±æ•—:', err);
          }
        }

        // è©³ç´°å®®ä½æ•¸æ“šï¼ˆå¦‚æœæ²’æœ‰å…¶ä»–æ•¸æ“šï¼Œé¡¯ç¤ºè©³ç´°ä¿¡æ¯ï¼‰
        if (!volatileAmbivalences?.length && !criticalRisks?.length && !maxOpportunities?.length) {
          html += '<div class="text-xs text-slate-500 mb-4">';
          html += '<p>æœªæª¢æ¸¬åˆ°ç–Šå®®æƒ…æ³ï¼ˆ2é‡ä»¥ä¸ŠåŒ–å¿Œæˆ–åŒ–ç¥¿ï¼‰ã€‚</p>';
          html += '<p class="mt-2">æç¤ºï¼šå±•é–‹ä¸‹æ–¹ã€Œå·¥ç¨‹åŒ–èª¿è©¦æ•¸æ“šã€æŸ¥çœ‹æ‰€æœ‰å®®ä½çš„å››åŒ–åˆ†å¸ƒã€‚</p>';
          html += '</div>';
          
          // é¡¯ç¤ºæ‰€æœ‰å®®ä½çš„å››åŒ–çµ±è¨ˆï¼ˆå³ä½¿æ²’æœ‰ç–Šå®®ï¼‰
          // æ”¹é€²ï¼šæ¨™æ³¨ç”Ÿå¹´ã€å¤§é™ã€å°é™ï¼Œè¨ˆç®—æ¬Šé‡ï¼Œæ¨™å‡ºå¼·å¼±å’Œæ³¨æ„äº‹é …
          if (data.overlapAnalysis?.palaceMap && data.fourTransformations) {
            html += '<div class="mt-4 p-3 bg-black/20 rounded">';
            html += '<div class="text-xs font-bold mb-2">ğŸ“‹ æ‰€æœ‰å®®ä½å››åŒ–çµ±è¨ˆï¼ˆå«ç”Ÿå¹´ã€å¤§é™ã€å°é™ï¼‰ï¼š</div>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">';
            
            const palaceMap = data.overlapAnalysis.palaceMap;
            const mapEntries = palaceMap instanceof Map ? Array.from(palaceMap.entries()) : Object.entries(palaceMap);
            
            // æ¬Šé‡é…ç½®ï¼ˆç”¨æ–¼è¨ˆç®—å®®ä½å¼·å¼±ï¼‰
            const WEIGHTS = {
              benming: 1.0,   // æœ¬å‘½å››åŒ–
              dalimit: 1.5,   // å¤§é™å››åŒ–ï¼ˆé€™åå¹´æœ€æœ‰æ„Ÿï¼‰
              liunian: 2.0,   // æµå¹´å››åŒ–ï¼ˆç•¶ä¸‹åæ‡‰æœ€ç›´æ¥ï¼‰
              xiaoxian: 1.0   // å°é™å››åŒ–ï¼ˆå€‹äººåŒ–å¹´åº¦å½±éŸ¿ï¼‰
            };
            
            // å››åŒ–é¡å‹æ¬Šé‡ï¼ˆç”¨æ–¼è¨ˆç®—å¼·å¼±ï¼‰
            const TRANSFORMATION_WEIGHTS = {
              'ç¥¿': 1.0,  // æ­£é¢
              'æ¬Š': 0.8,  // æ­£é¢ä½†å¸¶å£“åŠ›
              'ç§‘': 0.6,  // ä¸­æ€§åæ­£é¢
              'å¿Œ': -1.5  // è² é¢ï¼ˆæ¬Šé‡æ›´é«˜ï¼‰
            };
            
            mapEntries.forEach(([palaceName, palaceData]) => {
              const hasAny = (palaceData.luCount || 0) + (palaceData.quanCount || 0) + 
                            (palaceData.keCount || 0) + (palaceData.jiCount || 0) > 0;
              if (hasAny) {
                const transformations = palaceData.transformations || {};
                
                // è¨ˆç®—åŠ æ¬Šåˆ†æ•¸
                let weightedScore = 0;
                let detailParts = [];
                
                // çµ±è¨ˆå„å±¤ç´šçš„å››åŒ–
                const sihuaBreakdown = {
                  benming: { ç¥¿: [], æ¬Š: [], ç§‘: [], å¿Œ: [] },
                  dalimit: { ç¥¿: [], æ¬Š: [], ç§‘: [], å¿Œ: [] },
                  liunian: { ç¥¿: [], æ¬Š: [], ç§‘: [], å¿Œ: [] },
                  xiaoxian: { ç¥¿: [], æ¬Š: [], ç§‘: [], å¿Œ: [] }
                };
                
                // æ”¶é›†å„å±¤ç´šçš„å››åŒ–ä¿¡æ¯
                ['benming', 'dalimit', 'liunian', 'xiaoxian'].forEach(layer => {
                  const layerData = transformations[layer];
                  if (layerData && layerData.star) {
                    const type = layerData.type;
                    const star = layerData.star;
                    if (sihuaBreakdown[layer] && sihuaBreakdown[layer][type]) {
                      sihuaBreakdown[layer][type].push(star);
                      // è¨ˆç®—åŠ æ¬Šåˆ†æ•¸
                      weightedScore += WEIGHTS[layer] * TRANSFORMATION_WEIGHTS[type];
                    }
                  }
                });
                
                // ç”Ÿæˆè©³ç´°æ¨™æ³¨
                const sihuaLabels = [];
                if (sihuaBreakdown.benming.ç¥¿.length > 0) {
                  sihuaLabels.push(`ç”Ÿå¹´${sihuaBreakdown.benming.ç¥¿.join('ã€')}åŒ–ç¥¿`);
                }
                if (sihuaBreakdown.benming.æ¬Š.length > 0) {
                  sihuaLabels.push(`ç”Ÿå¹´${sihuaBreakdown.benming.æ¬Š.join('ã€')}åŒ–æ¬Š`);
                }
                if (sihuaBreakdown.benming.ç§‘.length > 0) {
                  sihuaLabels.push(`ç”Ÿå¹´${sihuaBreakdown.benming.ç§‘.join('ã€')}åŒ–ç§‘`);
                }
                if (sihuaBreakdown.benming.å¿Œ.length > 0) {
                  sihuaLabels.push(`ç”Ÿå¹´${sihuaBreakdown.benming.å¿Œ.join('ã€')}åŒ–å¿Œ`);
                }
                if (sihuaBreakdown.dalimit.ç¥¿.length > 0) {
                  sihuaLabels.push(`å¤§é™${sihuaBreakdown.dalimit.ç¥¿.join('ã€')}åŒ–ç¥¿`);
                }
                if (sihuaBreakdown.dalimit.æ¬Š.length > 0) {
                  sihuaLabels.push(`å¤§é™${sihuaBreakdown.dalimit.æ¬Š.join('ã€')}åŒ–æ¬Š`);
                }
                if (sihuaBreakdown.dalimit.ç§‘.length > 0) {
                  sihuaLabels.push(`å¤§é™${sihuaBreakdown.dalimit.ç§‘.join('ã€')}åŒ–ç§‘`);
                }
                if (sihuaBreakdown.dalimit.å¿Œ.length > 0) {
                  sihuaLabels.push(`å¤§é™${sihuaBreakdown.dalimit.å¿Œ.join('ã€')}åŒ–å¿Œ`);
                }
                if (sihuaBreakdown.liunian.ç¥¿.length > 0) {
                  sihuaLabels.push(`æµå¹´${sihuaBreakdown.liunian.ç¥¿.join('ã€')}åŒ–ç¥¿`);
                }
                if (sihuaBreakdown.liunian.æ¬Š.length > 0) {
                  sihuaLabels.push(`æµå¹´${sihuaBreakdown.liunian.æ¬Š.join('ã€')}åŒ–æ¬Š`);
                }
                if (sihuaBreakdown.liunian.ç§‘.length > 0) {
                  sihuaLabels.push(`æµå¹´${sihuaBreakdown.liunian.ç§‘.join('ã€')}åŒ–ç§‘`);
                }
                if (sihuaBreakdown.liunian.å¿Œ.length > 0) {
                  sihuaLabels.push(`æµå¹´${sihuaBreakdown.liunian.å¿Œ.join('ã€')}åŒ–å¿Œ`);
                }
                if (sihuaBreakdown.xiaoxian.ç¥¿.length > 0) {
                  sihuaLabels.push(`å°é™${sihuaBreakdown.xiaoxian.ç¥¿.join('ã€')}åŒ–ç¥¿`);
                }
                if (sihuaBreakdown.xiaoxian.æ¬Š.length > 0) {
                  sihuaLabels.push(`å°é™${sihuaBreakdown.xiaoxian.æ¬Š.join('ã€')}åŒ–æ¬Š`);
                }
                if (sihuaBreakdown.xiaoxian.ç§‘.length > 0) {
                  sihuaLabels.push(`å°é™${sihuaBreakdown.xiaoxian.ç§‘.join('ã€')}åŒ–ç§‘`);
                }
                if (sihuaBreakdown.xiaoxian.å¿Œ.length > 0) {
                  sihuaLabels.push(`å°é™${sihuaBreakdown.xiaoxian.å¿Œ.join('ã€')}åŒ–å¿Œ`);
                }
                
                // åˆ¤æ–·å®®ä½å¼·å¼±
                let strengthLevel = 'normal';
                let strengthText = 'ä¸€èˆ¬';
                let strengthColor = 'text-slate-400';
                
                if (weightedScore >= 3.0) {
                  strengthLevel = 'very-strong';
                  strengthText = 'æ¥µå¼·';
                  strengthColor = 'text-green-300 font-bold';
                } else if (weightedScore >= 1.5) {
                  strengthLevel = 'strong';
                  strengthText = 'å¼·';
                  strengthColor = 'text-green-400';
                } else if (weightedScore >= 0.5) {
                  strengthLevel = 'moderate';
                  strengthText = 'ä¸­ç­‰';
                  strengthColor = 'text-yellow-400';
                } else if (weightedScore >= -1.0) {
                  strengthLevel = 'weak';
                  strengthText = 'å¼±';
                  strengthColor = 'text-orange-400';
                } else {
                  strengthLevel = 'very-weak';
                  strengthText = 'æ¥µå¼±';
                  strengthColor = 'text-red-400 font-bold';
                }
                
                // ç”Ÿæˆæ³¨æ„äº‹é …
                const warnings = [];
                const opportunities = [];
                
                if (palaceData.jiCount >= 2) {
                  warnings.push(`âš ï¸ ${palaceData.jiCount}é‡åŒ–å¿Œç–ŠåŠ ï¼Œéœ€ç‰¹åˆ¥æ³¨æ„`);
                } else if (palaceData.jiCount === 1) {
                  warnings.push(`âš ï¸ æœ‰åŒ–å¿Œï¼Œéœ€è¬¹æ…`);
                }
                
                if (palaceData.luCount >= 2) {
                  opportunities.push(`ğŸ’° ${palaceData.luCount}é‡åŒ–ç¥¿ç–ŠåŠ ï¼Œæ©Ÿæœƒå¤§`);
                } else if (palaceData.luCount === 1) {
                  opportunities.push(`ğŸ’° æœ‰åŒ–ç¥¿ï¼Œæœ‰æ©Ÿæœƒ`);
                }
                
                if (palaceData.quanCount >= 2) {
                  warnings.push(`âš¡ ${palaceData.quanCount}é‡åŒ–æ¬Šç–ŠåŠ ï¼Œå£“åŠ›å¤§`);
                }
                
                if (palaceData.keCount >= 1) {
                  opportunities.push(`âœ¨ æœ‰åŒ–ç§‘ï¼Œæœ‰è²´äºº`);
                }
                
                // æ ¹æ“šåŠ æ¬Šåˆ†æ•¸ç”Ÿæˆç¶œåˆå»ºè­°
                let advice = '';
                if (weightedScore >= 2.0) {
                  advice = 'ğŸ’¡ ä»Šå¹´æ­¤å®®ä½èƒ½é‡æ¥µå¼·ï¼Œé©åˆç©æ¥µè¡Œå‹•';
                } else if (weightedScore >= 0.5) {
                  advice = 'ğŸ’¡ ä»Šå¹´æ­¤å®®ä½èƒ½é‡æ­£é¢ï¼Œå¯æŠŠæ¡æ©Ÿæœƒ';
                } else if (weightedScore >= -0.5) {
                  advice = 'ğŸ’¡ ä»Šå¹´æ­¤å®®ä½èƒ½é‡å¹³ç©©ï¼Œä¿æŒç¾ç‹€';
                } else if (weightedScore >= -2.0) {
                  advice = 'ğŸ’¡ ä»Šå¹´æ­¤å®®ä½èƒ½é‡åå¼±ï¼Œéœ€è¬¹æ…æ‡‰å°';
                } else {
                  advice = 'ğŸ’¡ ä»Šå¹´æ­¤å®®ä½èƒ½é‡æ¥µå¼±ï¼Œå»ºè­°é˜²å®ˆç‚ºä¸»';
                }
                
                html += `<div class="p-3 bg-black/10 rounded border border-white/5">
                  <div class="font-bold text-sm mb-2">${palaceName}</div>
                  
                  <!-- å››åŒ–çµ±è¨ˆ -->
                  <div class="mb-2 space-y-1">
                    <div class="text-green-400">ç¥¿:${palaceData.luCount || 0}</div>
                    <div class="text-blue-400">æ¬Š:${palaceData.quanCount || 0}</div>
                    <div class="text-purple-400">ç§‘:${palaceData.keCount || 0}</div>
                    <div class="text-red-400">å¿Œ:${palaceData.jiCount || 0}</div>
                  </div>
                  
                  <!-- ä¾†æºæ¨™æ³¨ -->
                  ${sihuaLabels.length > 0 ? `
                  <div class="mb-2 text-xs text-slate-300 border-t border-white/10 pt-2">
                    <div class="font-semibold mb-1">ä¾†æºï¼š</div>
                    <div class="space-y-0.5">${sihuaLabels.map(label => `<div>â€¢ ${label}</div>`).join('')}</div>
                  </div>
                  ` : ''}
                  
                  <!-- å¼·å¼±æ¨™ç¤º -->
                  <div class="mb-2 text-xs">
                    <div class="font-semibold mb-1">å¼·å¼±ï¼š</div>
                    <div class="${strengthColor}">${strengthText}ï¼ˆåŠ æ¬Šåˆ†æ•¸: ${weightedScore.toFixed(2)}ï¼‰</div>
                  </div>
                  
                  <!-- æ³¨æ„äº‹é … -->
                  ${warnings.length > 0 || opportunities.length > 0 ? `
                  <div class="mb-2 text-xs border-t border-white/10 pt-2">
                    <div class="font-semibold mb-1">æ³¨æ„äº‹é …ï¼š</div>
                    ${warnings.map(w => `<div class="text-red-300">${w}</div>`).join('')}
                    ${opportunities.map(o => `<div class="text-green-300">${o}</div>`).join('')}
                  </div>
                  ` : ''}
                  
                  <!-- ç¶œåˆå»ºè­° -->
                  <div class="text-xs border-t border-white/10 pt-2">
                    <div class="text-slate-300">${advice}</div>
                  </div>
                </div>`;
              }
            });
            
            html += '</div>';
            html += '</div>';
          }
        }

        container.innerHTML = html || '<p class="text-slate-500">ç–Šå®®åˆ†ææ•¸æ“šç‚ºç©º</p>';
      } else {
        container.innerHTML = '<p class="text-slate-500">å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—</p>';
        if (debugContainer) {
          debugContainer.textContent = 'overlapAnalysis: null æˆ– undefined';
        }
      }
    }

    // æ›´æ–°å¥åº·é è­¦
    function updateHealthWarning(data) {
      const container = document.getElementById('healthWarningContainer');
      if (!container) return;

      if (data.healthWarning) {
        const warning = data.healthWarning;
        let html = '';

        if (warning.semanticInterpretation) {
          const sem = warning.semanticInterpretation;
          html += `<div class="mb-3">
            <div class="text-lg font-bold ${sem.semanticLevel === 'critical' ? 'text-red-400' : sem.semanticLevel === 'warning' ? 'text-amber-400' : 'text-green-400'}">
              ${sem.semanticLabel}
            </div>
            <div class="text-sm text-slate-300 mt-1">${sem.semanticDescription}</div>
            <div class="text-sm text-slate-400 mt-2">${sem.strategicAdvice}</div>
          </div>`;
        }

        if (warning.warnings && warning.warnings.length > 0) {
          html += '<div class="mt-4"><div class="text-sm font-bold mb-2">è©³ç´°è­¦å‘Šï¼š</div>';
          warning.warnings.forEach(w => {
            html += `<div class="mb-2 p-2 bg-black/20 rounded">
              <div class="font-bold ${w.severity === 'critical' ? 'text-red-400' : 'text-amber-400'}">${w.element}æ°£${w.type === 'weak' ? 'åå¼±' : 'éæ—º'}</div>
              <div class="text-sm text-slate-300">${w.risk}</div>
            </div>`;
          });
          html += '</div>';
        }

        container.innerHTML = html || '<p class="text-slate-500">å¥åº·ç‹€æ…‹æ­£å¸¸</p>';
      } else {
        container.innerHTML = '<p class="text-slate-500">å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—</p>';
      }
    }

    // æ›´æ–°æœˆåº¦å¥åº·é¢¨éšªå¿ƒé›»åœ–
    function updateMonthlyHealthChart(data) {
      const container = document.getElementById('monthlyHealthChartContainer');
      if (!container) return;

      if (data.monthlyHealthRisk && Array.isArray(data.monthlyHealthRisk) && data.monthlyHealthRisk.length > 0) {
        const maxRisk = Math.max(...data.monthlyHealthRisk.map(m => m.riskScore || 0), 100);
        
        let html = '<div class="chart-container">';
        
        // æ·»åŠ è­¦æˆ’ç·š
        html += '<div class="chart-line warning-line" style="top: 30%;" title="é»ƒè‰²é è­¦ç·šï¼ˆ30åˆ†ï¼‰"></div>';
        html += '<div class="chart-line critical-line" style="top: 60%;" title="ç´…è‰²è­¦æˆ’ç·šï¼ˆ60åˆ†ï¼‰"></div>';
        
        // æ·»åŠ æœˆä»½æŸ±ç‹€åœ–
        data.monthlyHealthRisk.forEach((month, index) => {
          const height = maxRisk > 0 ? (month.riskScore / maxRisk * 100) : 0;
          const left = (index * 100 / 12) + '%';
          const width = (100 / 12 - 1) + '%';
          const riskClass = month.riskLevel === 'critical' ? 'critical' : 
                          month.riskLevel === 'warning' ? 'warning' : 'normal';
          
          html += `<div class="chart-bar ${riskClass}" style="left: ${left}; width: ${width}; height: ${height}%;" 
                          title="${month.monthName}: ${month.riskScore.toFixed(1)}åˆ† (${month.riskLevel})">
                    <div class="chart-label">${month.month}</div>
                  </div>`;
        });
        
        html += '</div>';
        html += '<div class="mt-8 text-xs text-slate-500">';
        html += '<div>ç¶ è‰²ï¼šæ­£å¸¸ï¼ˆ0-30åˆ†ï¼‰</div>';
        html += '<div>æ©™è‰²ï¼šè­¦å‘Šï¼ˆ30-60åˆ†ï¼‰</div>';
        html += '<div>ç´…è‰²ï¼šåš´é‡ï¼ˆ60-100åˆ†ï¼‰</div>';
        html += '</div>';
        
        container.innerHTML = html;
      } else {
        container.innerHTML = '<p class="text-slate-500">å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—</p>';
      }
    }

    // æ›´æ–° AI Prompt
    function updateAIPrompt(data) {
      const textarea = document.getElementById('aiPromptTextarea');
      if (!textarea) return;

      if (data.aiPrompt) {
        textarea.value = data.aiPrompt;
      } else if (data.structuredData && window.AIPromptGenerator) {
        const prompt = window.AIPromptGenerator.generateAIPrompt(data.structuredData, {
          targetLength: 1500,
          includeDetails: true
        });
        textarea.value = prompt;
      } else {
        textarea.value = 'å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—';
      }
    }

    // æ›´æ–°å°å‡ºæ•¸æ“š
    function updateExportData(data) {
      const container = document.getElementById('exportDataContainer');
      if (!container) return;

      try {
        container.textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        container.textContent = 'å°å‡ºæ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼š' + err.message;
      }
    }

    // è¤‡è£½ Prompt
    function copyPrompt() {
      const textarea = document.getElementById('aiPromptTextarea');
      if (textarea && textarea.value) {
        textarea.select();
        document.execCommand('copy');
        alert('Prompt å·²è¤‡è£½åˆ°å‰ªè²¼æ¿');
      }
    }

    // ä¸‹è¼‰ Prompt
    function downloadPrompt() {
      const textarea = document.getElementById('aiPromptTextarea');
      if (textarea && textarea.value) {
        const blob = new Blob([textarea.value], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ai-prompt-' + new Date().toISOString().split('T')[0] + '.txt';
        a.click();
        URL.revokeObjectURL(url);
      }
    }

    // å°å‡º JSON
    function exportJson() {
      if (!window.AdminExport) {
        alert('å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—');
        return;
      }

      try {
        const data = window.AdminExport.exportCalculationResults();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'calculation-results-' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert('å°å‡ºå¤±æ•—ï¼š' + err.message);
      }
    }

    // æäº¤åˆ°å¾Œå° API
    async function submitToApi() {
      if (!window.AdminExport) {
        alert('å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—');
        return;
      }

      const auth = getStoredAuth();
      if (!auth) {
        alert('è«‹å…ˆç™»å…¥');
        return;
      }

      try {
        const data = window.AdminExport.exportCalculationResults();
        const response = await fetch('/api/admin/calculation-results', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...authHeader()
          },
          body: JSON.stringify(data)
        });

        if (response.status === 401) {
          showLogin();
          alert('è«‹é‡æ–°ç™»å…¥');
          return;
        }

        const result = await response.json();
        if (result.ok) {
          alert('æ•¸æ“šå·²æˆåŠŸæäº¤åˆ°å¾Œå°');
        } else {
          alert('æäº¤å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (err) {
        alert('æäº¤å¤±æ•—ï¼š' + err.message);
      }
    }

    // ä¸€éµç”Ÿæˆå‘½æ›¸
    function generateLifeBook() {
      if (!window.AdminExport) {
        alert('å°šæœªè¨ˆç®—ï¼Œè«‹å…ˆè¼¸å…¥å‡ºç”Ÿè³‡è¨Šä¸¦è¨ˆç®—');
        return;
      }

      const textarea = document.getElementById('aiPromptTextarea');
      if (!textarea || !textarea.value || textarea.value.includes('å°šæœªè¨ˆç®—')) {
        alert('è«‹å…ˆå®Œæˆè¨ˆç®—ä¸¦ç”Ÿæˆ AI Prompt');
        return;
      }

      // é€™è£¡å¯ä»¥æ•´åˆåˆ°å¯¦éš›çš„ AI æœå‹™ï¼ˆä¾‹å¦‚ OpenAI APIï¼‰
      alert('ä¸€éµç”Ÿæˆå‘½æ›¸åŠŸèƒ½ï¼š\n\n1. å·²ç”Ÿæˆ AI Prompt\n2. è«‹å°‡ Prompt è¤‡è£½åˆ° AI æœå‹™ï¼ˆå¦‚ ChatGPTï¼‰\n3. æˆ–æ•´åˆåˆ°å¾ŒçºŒçš„ AI API èª¿ç”¨æµç¨‹\n\næç¤ºï¼šPrompt å·²æº–å‚™å¥½ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨');
    }

    // ç•°å¸¸ç›£æ§ï¼šlast_24h_by_user, last_1h_by_user, anomaly_user_idsï¼ˆä¾›æ¨ç®—æ™‚è¾°è¡¨æ ¼ç´…è‰²æ¨™ç¤ºï¼‰
    var lastAnomalyUserIds = [];

    // æ¨ç®—æ™‚è¾°çµæœï¼šè¼‰å…¥ã€æ‘˜è¦ã€ç†±åœ–ã€è¡¨æ ¼ã€åŒ¯å‡º
    var lastEstimateLogs = [];

    function buildEstimateLogsParams() {
      var from = document.getElementById('estimateLogsFrom').value || '';
      var to = document.getElementById('estimateLogsTo').value || '';
      var feedback = document.getElementById('estimateLogsFeedback').value || 'all';
      var correct = document.getElementById('estimateLogsCorrect').value || 'all';
      var params = new URLSearchParams();
      if (from) params.set('from', from);
      if (to) params.set('to', to);
      params.set('feedback', feedback);
      params.set('correct', correct);
      params.set('page', '1');
      params.set('pageSize', '200');
      return params.toString();
    }

    function renderEstimateLogsSummary(logs) {
      var el = document.getElementById('estimateLogsSummary');
      if (!el) return;
      var total = logs.length;
      var withFeedback = logs.filter(function (l) { return l.feedback_correct !== null && l.feedback_correct !== undefined; }).length;
      var correctCount = logs.filter(function (l) { return l.feedback_correct === 1; }).length;
      var incorrectCount = logs.filter(function (l) { return l.feedback_correct === 0; }).length;
      var accuracy = withFeedback > 0 ? (correctCount / withFeedback * 100).toFixed(1) : '-';
      el.innerHTML = 'ç¸½ç­†æ•¸ï¼š' + total + 'ã€€å·²å›é¥‹ï¼š' + withFeedback + 'ã€€æ­£ç¢ºï¼š' + correctCount + 'ã€€ä¸æ­£ç¢ºï¼š' + incorrectCount + 'ã€€æº–ç¢ºç‡ï¼ˆæ­£ç¢º/å·²å›é¥‹ï¼‰ï¼š' + accuracy + '%';
      el.classList.remove('hidden');
    }

    function renderEstimateLogsHeatmap(logs) {
      var wrap = document.getElementById('estimateLogsHeatmapWrap');
      var container = document.getElementById('estimateLogsHeatmap');
      if (!wrap || !container) return;
      var BRANCHES = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
      var incorrect = logs.filter(function (l) { return l.feedback_correct === 0 && l.feedback_actual_branch; });
      var grid = {};
      BRANCHES.forEach(function (est) {
        grid[est] = {};
        BRANCHES.forEach(function (act) { grid[est][act] = 0; });
      });
      incorrect.forEach(function (l) {
        var est = l.estimated_branch || '';
        var act = l.feedback_actual_branch || '';
        if (grid[est] && grid[est][act] !== undefined) grid[est][act]++;
      });
      var maxVal = 0;
      BRANCHES.forEach(function (est) {
        BRANCHES.forEach(function (act) { if (grid[est][act] > maxVal) maxVal = grid[est][act]; });
      });
      var table = '<table class="border border-white/20 text-xs"><thead><tr><th class="p-1 border border-white/10 bg-white/5"></th>';
      BRANCHES.forEach(function (b) { table += '<th class="p-1 border border-white/10 bg-white/5 w-8 text-center">' + b + '</th>'; });
      table += '</tr></thead><tbody>';
      BRANCHES.forEach(function (act) {
        table += '<tr><th class="p-1 border border-white/10 bg-white/5">' + act + '</th>';
        BRANCHES.forEach(function (est) {
          var n = grid[est][act] || 0;
          var intensity = maxVal > 0 ? (n / maxVal) : 0;
          var bg = n === 0 ? 'bg-white/5' : 'background: rgba(255, 191, 0, ' + (0.2 + intensity * 0.6) + ');';
          table += '<td class="p-1 border border-white/10 text-center" style="' + (n ? bg : '') + '">' + (n || '') + '</td>';
        });
        table += '</tr>';
      });
      table += '</tbody></table>';
      container.innerHTML = table;
      wrap.classList.remove('hidden');
    }

    function renderEstimateLogsTable(logs) {
      var wrap = document.getElementById('estimateLogsTableWrap');
      var tbody = document.getElementById('estimateLogsTableBody');
      var emptyEl = document.getElementById('estimateLogsEmpty');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (logs.length === 0) {
        if (wrap) wrap.classList.add('hidden');
        if (emptyEl) { emptyEl.classList.remove('hidden'); emptyEl.textContent = 'å°šç„¡è³‡æ–™ï¼Œè«‹æŒ‰ã€Œè¼‰å…¥æ¨ç®—ç´€éŒ„ã€ã€‚'; }
        return;
      }
      if (wrap) wrap.classList.remove('hidden');
      if (emptyEl) emptyEl.classList.add('hidden');
      var anomalySet = {};
      lastAnomalyUserIds.forEach(function (id) { anomalySet[id] = true; });
      logs.forEach(function (l) {
        var feedbackText = l.feedback_correct === null || l.feedback_correct === undefined ? 'æœªå›é¥‹' : (l.feedback_correct === 1 ? 'æ­£ç¢º' : 'ä¸æ­£ç¢º');
        var actualText = (l.feedback_actual_branch || '') + (l.feedback_actual_half === 'lower' ? 'ä¸‹' : l.feedback_actual_half === 'upper' ? 'ä¸Š' : '');
        var userText = (l.user_email || l.user_name || l.user_id || '').toString().trim() || '-';
        var answersShort = '';
        try {
          var a = JSON.parse(l.answers_json || '{}');
          answersShort = Object.keys(a).slice(0, 5).map(function (k) { return k + ':' + (Array.isArray(a[k]) ? a[k].join(',') : a[k]); }).join('; ') || '-';
        } catch (_) { answersShort = '-'; }
        var tr = document.createElement('tr');
        tr.className = 'border-b border-white/10 hover:bg-white/5' + (anomalySet[l.user_id] ? ' bg-red-900/30' : '');
        var ipText = (l.user_ip != null && l.user_ip !== '') ? l.user_ip : '-';
        tr.innerHTML = '<td class="p-2">' + (l.created_at || '-') + '</td><td class="p-2">' + userText + '</td><td class="p-2 font-mono text-xs">' + ipText + '</td><td class="p-2">' + (l.estimated_branch || '') + (l.estimated_half === 'lower' ? 'ä¸‹' : 'ä¸Š') + '</td><td class="p-2">' + feedbackText + '</td><td class="p-2">' + actualText + '</td><td class="p-2 max-w-[200px] truncate" title="' + (l.answers_json || '').replace(/"/g, '&quot;') + '">' + answersShort + '</td>';
        tbody.appendChild(tr);
      });
    }

    async function loadEstimateStats() {
      var btn = document.getElementById('loadEstimateStatsBtn');
      if (btn) btn.disabled = true;
      try {
        var res = await fetch('/api/admin/estimate-hour-stats', { headers: authHeader() });
        if (res.status === 401) {
          showLogin();
          alert('è«‹é‡æ–°ç™»å…¥');
          return;
        }
        if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
        var data = await res.json();
        if (!data.ok) throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤');
        lastAnomalyUserIds = data.anomaly_user_ids || [];
        var t24 = document.getElementById('estimateStats24hBody');
        var t1 = document.getElementById('estimateStats1hBody');
        var wrap24 = document.getElementById('estimateStats24hWrap');
        var wrap1 = document.getElementById('estimateStats1hWrap');
        var wrapAnomaly = document.getElementById('estimateStatsAnomalyWrap');
        if (t24 && Array.isArray(data.last_24h_by_user)) {
          t24.innerHTML = '';
          data.last_24h_by_user.forEach(function (r) {
            var tr = document.createElement('tr');
            tr.className = 'border-b border-white/10';
            tr.innerHTML = '<td class="p-2">' + (r.user_email || '-') + '</td><td class="p-2 font-mono text-xs">' + (r.user_id || '-') + '</td><td class="p-2">' + r.count + '</td>';
            t24.appendChild(tr);
          });
          wrap24.classList.remove('hidden');
        }
        if (t1 && Array.isArray(data.last_1h_by_user)) {
          t1.innerHTML = '';
          data.last_1h_by_user.forEach(function (r) {
            var tr = document.createElement('tr');
            tr.className = 'border-b border-white/10' + (r.count > 20 ? ' bg-red-900/30' : '');
            tr.innerHTML = '<td class="p-2">' + (r.user_email || '-') + '</td><td class="p-2 font-mono text-xs">' + (r.user_id || '-') + '</td><td class="p-2">' + r.count + '</td>';
            t1.appendChild(tr);
          });
          wrap1.classList.remove('hidden');
        }
        if (wrapAnomaly) {
          if (lastAnomalyUserIds.length > 0) {
            wrapAnomaly.textContent = 'ç•°å¸¸ç”¨æˆ¶ï¼ˆ24h æˆ– 1h å…§ >10 æ¬¡ï¼‰ï¼š' + lastAnomalyUserIds.join(', ');
            wrapAnomaly.classList.remove('hidden');
          } else {
            wrapAnomaly.textContent = 'ç„¡ç•°å¸¸ç”¨æˆ¶ï¼ˆ24h/1h å…§çš†ç„¡ >10 æ¬¡ï¼‰ã€‚';
            wrapAnomaly.classList.remove('hidden');
          }
        }
        var ipBody = document.getElementById('estimateStatsIpBody');
        var ipWrap = document.getElementById('estimateStatsIpWrap');
        if (ipBody && Array.isArray(data.last_24h_by_ip) && data.last_24h_by_ip.length > 0) {
          ipBody.innerHTML = '';
          data.last_24h_by_ip.forEach(function (r) {
            var tr = document.createElement('tr');
            tr.className = 'border-b border-white/10';
            tr.innerHTML = '<td class="p-2 font-mono text-xs">' + (r.ip || '-') + '</td><td class="p-2">' + r.request_count + '</td><td class="p-2">' + r.user_count + '</td>';
            ipBody.appendChild(tr);
          });
          ipWrap.classList.remove('hidden');
        } else if (ipWrap) {
          ipWrap.classList.add('hidden');
        }
        if (lastEstimateLogs.length > 0) renderEstimateLogsTable(lastEstimateLogs);
      } catch (err) {
        alert('è¼‰å…¥ç›£æ§å¤±æ•—ï¼š' + (err.message || err));
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function loadEstimateHourLogs() {
      var btn = document.getElementById('loadEstimateLogsBtn');
      if (btn) btn.disabled = true;
      try {
        var qs = buildEstimateLogsParams();
        var res = await fetch('/api/admin/estimate-hour-logs?' + qs, { headers: authHeader() });
        if (res.status === 401) {
          showLogin();
          alert('è«‹é‡æ–°ç™»å…¥');
          return;
        }
        if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—');
        var data = await res.json();
        if (!data.ok || !Array.isArray(data.logs)) throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤');
        lastEstimateLogs = data.logs;
        renderEstimateLogsSummary(data.logs);
        renderEstimateLogsHeatmap(data.logs);
        renderEstimateLogsTable(data.logs);
        document.getElementById('exportEstimateLogsCsvBtn').classList.remove('hidden');
        document.getElementById('exportEstimateLogsJsonBtn').classList.remove('hidden');
      } catch (err) {
        alert('è¼‰å…¥æ¨ç®—ç´€éŒ„å¤±æ•—ï¼š' + (err.message || err));
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    function exportEstimateLogsCsv() {
      if (lastEstimateLogs.length === 0) { alert('è«‹å…ˆè¼‰å…¥æ¨ç®—ç´€éŒ„'); return; }
      var headers = ['id', 'created_at', 'user_id', 'user_email', 'user_name', 'user_ip', 'estimated_branch', 'estimated_half', 'feedback_correct', 'feedback_actual_branch', 'feedback_actual_half', 'feedback_at'];
      for (var i = 1; i <= 19; i++) headers.push('q' + i);
      var rows = [headers.join(',')];
      lastEstimateLogs.forEach(function (l) {
        var a = {};
        try { a = JSON.parse(l.answers_json || '{}'); } catch (_) {}
        var cells = [l.id, l.created_at, l.user_id, (l.user_email || '').replace(/,/g, ' '), (l.user_name || '').replace(/,/g, ' '), l.user_ip || '', l.estimated_branch, l.estimated_half, l.feedback_correct === null ? '' : l.feedback_correct, l.feedback_actual_branch || '', l.feedback_actual_half || '', l.feedback_at || ''];
        for (var i = 1; i <= 19; i++) {
          var v = a['q' + i];
          cells.push(v === undefined ? '' : (Array.isArray(v) ? v.join(';') : String(v)).replace(/,/g, ' ').replace(/"/g, '""'));
        }
        rows.push(cells.map(function (c) { return '"' + String(c).replace(/"/g, '""') + '"'; }).join(','));
      });
      var blob = new Blob(['\uFEFF' + rows.join('\n')], { type: 'text/csv;charset=utf-8' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'estimate-hour-logs-' + new Date().toISOString().slice(0, 10) + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function exportEstimateLogsJson() {
      if (lastEstimateLogs.length === 0) { alert('è«‹å…ˆè¼‰å…¥æ¨ç®—ç´€éŒ„'); return; }
      var blob = new Blob([JSON.stringify({ ok: true, logs: lastEstimateLogs, total: lastEstimateLogs.length }, null, 2)], { type: 'application/json' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'estimate-hour-logs-' + new Date().toISOString().slice(0, 10) + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // äº‹ä»¶ç¶å®š
    document.getElementById('loginForm').addEventListener('submit', function (e) {
      e.preventDefault();
      var user = (document.getElementById('loginUser').value || '').trim();
      var pass = document.getElementById('loginPass').value || '';
      var btn = document.getElementById('loginBtn');
      var errEl = document.getElementById('loginError');

      errEl.classList.add('hidden');
      btn.disabled = true;

      // æ³¨æ„ï¼šèªè­‰ä¿¡æ¯åƒ…å­˜å„²åœ¨ sessionStorageï¼Œä¸æœƒè¨˜éŒ„åˆ°æ—¥èªŒ
      var auth = btoa(unescape(encodeURIComponent(user + ':' + pass)));
      setStoredAuth(auth);

      fetch('/api/admin/calculation-results', { headers: { Authorization: 'Basic ' + auth } })
        .then(function (res) {
          if (res.status === 401) {
            setStoredAuth('');
            errEl.textContent = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
            errEl.classList.remove('hidden');
            btn.disabled = false;
            return;
          }
          if (!res.ok) return res.json().then(function (d) { throw new Error(d.error || 'å¤±æ•—'); });
          showDashboard();
          initComponents();
          btn.disabled = false;
        })
        .catch(function (err) {
          setStoredAuth('');
          errEl.textContent = err.message || 'ç™»å…¥å¤±æ•—';
          errEl.classList.remove('hidden');
          btn.disabled = false;
        });
    });

    document.getElementById('logoutBtn').addEventListener('click', function () {
      showLogin();
      document.getElementById('loginPass').value = '';
    });

    document.getElementById('refreshBtn').addEventListener('click', refreshDisplay);
    document.getElementById('calculateBtn').addEventListener('click', calculateData);
    document.getElementById('copyPromptBtn').addEventListener('click', copyPrompt);
    document.getElementById('downloadPromptBtn').addEventListener('click', downloadPrompt);
    document.getElementById('exportJsonBtn').addEventListener('click', exportJson);
    document.getElementById('exportToApiBtn').addEventListener('click', submitToApi);
    document.getElementById('generateLifeBookBtn').addEventListener('click', generateLifeBook);
    document.getElementById('loadEstimateStatsBtn').addEventListener('click', loadEstimateStats);
    document.getElementById('loadEstimateLogsBtn').addEventListener('click', loadEstimateHourLogs);
    document.getElementById('exportEstimateLogsCsvBtn').addEventListener('click', exportEstimateLogsCsv);
    document.getElementById('exportEstimateLogsJsonBtn').addEventListener('click', exportEstimateLogsJson);
    
    // ç¶å®šè«®è©¢ç²¾è¯æ‘˜è¦æŒ‰éˆ•
    const generateSummaryBtn = document.getElementById('generateSummaryBtn');
    const exportSummaryBtn = document.getElementById('exportSummaryBtn');
    if (generateSummaryBtn) {
      generateSummaryBtn.addEventListener('click', generateConsultationSummary);
    }
    if (exportSummaryBtn) {
      exportSummaryBtn.addEventListener('click', exportConsultationSummary);
    }

    // åˆå§‹åŒ–
    if (getStoredAuth()) {
      showDashboard();
      initComponents();
    }
  </script>
</body>
</html>
